function doGet() {
  return HtmlService.createHtmlOutputFromFile('index')
    .setTitle('Staff Salary Management System')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// ========== CONSTANTS & CONFIGURATION ==========

const SHEET_NAMES = {
  STAFF: 'Staff',
  USERS: 'Users',
  HOLIDAYS: 'Holidays',
  DAILY_ATTENDANCE: 'DailyAttendance',
  LEAVES: 'Leaves',
  SALARY_RECEIPTS: 'SalaryReceipts',
  NOTICES: 'Notices',
  TASKS: 'Tasks',
  ATTENDANCE_TIMING: 'AttendanceTimingConfig',
  TIMING_LOGS: 'TimingConfigLogs',
  QR_LOG: 'QR_Attendance_Log',
  QR_TRACKING: 'QR_Attendance_Tracking'
};

const ATTENDANCE_CODES = {
  PRESENT: 'P',
  ABSENT: 'A',
  LATE: 'L',
  HALF_DAY: 'HD',
  FULL_DAY_LEAVE: 'FD',
  HOLIDAY: 'H'
};

const USER_ROLES = {
  ADMIN: 'Admin',
  PRINCIPAL: 'Principal',
  STAFF: 'Staff'
};

const STAFF_TYPES = {
  TEACHING: 'Teaching',
  NON_TEACHING: 'Non-Teaching'
};

const DEFAULT_PASSWORD = 'staff123';

// ========== UTILITY FUNCTIONS ==========

function getScriptTimezone() {
  return Session.getScriptTimeZone();
}

function formatDate(date, format = 'yyyy-MM-dd') {
  if (!date) return '';
  if (!(date instanceof Date)) date = new Date(date);
  return Utilities.formatDate(date, getScriptTimezone(), format);
}

function formatDateTime(date) {
  if (!date) return '';
  if (!(date instanceof Date)) date = new Date(date);
  return Utilities.formatDate(date, getScriptTimezone(), 'yyyy-MM-dd HH:mm:ss');
}

function parseDateSafe(dateValue) {
  if (!dateValue) return null;
  if (dateValue instanceof Date) return dateValue;
  try {
    return new Date(dateValue);
  } catch (e) {
    return null;
  }
}

function getMonthNumber(monthName) {
  const months = {
    'January': 1, 'February': 2, 'March': 3, 'April': 4, 'May': 5, 'June': 6,
    'July': 7, 'August': 8, 'September': 9, 'October': 10, 'November': 11, 'December': 12
  };
  return months[monthName] || 1;
}

function getMonthName(monthNumber) {
  const months = [
    'January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'
  ];
  return months[monthNumber - 1] || 'January';
}

function getColumnLetter(columnNumber) {
  let letter = '';
  while (columnNumber > 0) {
    const remainder = (columnNumber - 1) % 26;
    letter = String.fromCharCode(65 + remainder) + letter;
    columnNumber = Math.floor((columnNumber - 1) / 26);
  }
  return letter;
}

function calculateWorkingDays(startDate, endDate) {
  let count = 0;
  const currentDate = new Date(startDate);
  const finalDate = new Date(endDate);
  
  while (currentDate <= finalDate) {
    if (currentDate.getDay() !== 0) count++;
    currentDate.setDate(currentDate.getDate() + 1);
  }
  
  return count;
}

function isSameMonthOrAfter(date1, date2) {
  const year1 = date1.getFullYear(), month1 = date1.getMonth();
  const year2 = date2.getFullYear(), month2 = date2.getMonth();
  return (year1 > year2) || (year1 === year2 && month1 >= month2);
}

function getMonthInfo(month, year) {
  try {
    const monthIndex = getMonthNumber(month) - 1;
    const totalDays = new Date(year, monthIndex + 1, 0).getDate();
    let sundays = 0;
    
    for (let day = 1; day <= totalDays; day++) {
      const date = new Date(year, monthIndex, day);
      if (date.getDay() === 0) sundays++;
    }
    
    return { totalDays, sundays };
  } catch (error) {
    console.error('Error getting month info:', error);
    return { totalDays: 30, sundays: 4 };
  }
}

function generateId(sheetName, prefix, length = 3) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(sheetName);
    
    if (!sheet || sheet.getLastRow() <= 1) return prefix + '1'.padStart(length, '0');
    
    const ids = sheet.getRange(2, 1, sheet.getLastRow() - 1, 1).getValues();
    let maxNumber = 0;
    
    for (let i = 0; i < ids.length; i++) {
      const id = ids[i][0];
      if (typeof id === 'string' && id.startsWith(prefix)) {
        const numberPart = id.replace(prefix, '');
        const number = parseInt(numberPart);
        if (!isNaN(number) && number > maxNumber) maxNumber = number;
      }
    }
    
    return prefix + (maxNumber + 1).toString().padStart(length, '0');
  } catch (error) {
    console.error('Error generating ID:', error);
    return prefix + '1'.padStart(length, '0');
  }
}

// ========== INITIALIZATION ==========

function initializeApp() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const results = [];
    
    // Initialize all sheets
    results.push(initializeStaffSheet(ss));
    results.push(initializeUsersSheet(ss));
    results.push(initializeHolidaysSheet(ss));
    results.push(initializeDailyAttendanceSheet(ss));
    results.push(initializeLeavesSheet(ss));
    results.push(initializeSalaryReceiptsSheet(ss));
    results.push(initializeNoticesSheet(ss));
    results.push(initializeTasksSheet(ss));
    results.push(initializeAttendanceTimingSheet(ss));
    results.push(initializeQRAttendanceSheets(ss));
    
    const errors = results.filter(r => !r.success);
    
    if (errors.length > 0) {
      return { 
        success: true, 
        warning: true,
        message: 'Application initialized with some warnings',
        errors: errors.map(e => e.message)
      };
    }
    
    return { success: true, message: 'Application initialized successfully!' };
  } catch (error) {
    console.error('Initialization error:', error);
    return { success: false, message: 'Initialization failed: ' + error.message };
  }
}

function initializeStaffSheet(ss) {
  try {
    let sheet = ss.getSheetByName(SHEET_NAMES.STAFF);
    if (sheet) return { success: true, message: 'Staff sheet already exists' };
    
    sheet = ss.insertSheet(SHEET_NAMES.STAFF);
    const headers = [
      'Staff ID', 'Name', 'Department', 'Designation', 'Staff Type', 
      'Basic Salary', 'Join Date', 'Email', 'Phone', 'Bank Account', 
      'IFSC Code', 'Status', 'Photo URL', 'Password', 'Created Date', 'Last Modified'
    ];
    
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
    sheet.setFrozenRows(1);
    
    return { success: true, message: 'Staff sheet created' };
  } catch (error) {
    return { success: false, message: 'Error creating Staff sheet: ' + error.message };
  }
}

function initializeUsersSheet(ss) {
  try {
    let sheet = ss.getSheetByName(SHEET_NAMES.USERS);
    if (sheet) return { success: true, message: 'Users sheet already exists' };
    
    sheet = ss.insertSheet(SHEET_NAMES.USERS);
    const headers = ['User ID', 'Username', 'Password', 'Role', 'Status', 'Created Date', 'Last Login'];
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
    
    // Create default admin users
    const defaultUsers = [
      ['USER001', 'admin', 'admin', USER_ROLES.ADMIN, 'Active', new Date(), ''],
      ['USER002', 'principal', 'principal', USER_ROLES.PRINCIPAL, 'Active', new Date(), '']
    ];
    
    sheet.getRange(2, 1, defaultUsers.length, headers.length).setValues(defaultUsers);
    sheet.setFrozenRows(1);
    
    return { success: true, message: 'Users sheet created with default users' };
  } catch (error) {
    return { success: false, message: 'Error creating Users sheet: ' + error.message };
  }
}

function initializeHolidaysSheet(ss) {
  try {
    let sheet = ss.getSheetByName(SHEET_NAMES.HOLIDAYS);
    if (sheet) return { success: true, message: 'Holidays sheet already exists' };
    
    sheet = ss.insertSheet(SHEET_NAMES.HOLIDAYS);
    const headers = ['Holiday ID', 'Holiday Name', 'Start Date', 'End Date', 'Number of Days', 'Reason', 'Added By', 'Added Date'];
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
    sheet.setFrozenRows(1);
    
    return { success: true, message: 'Holidays sheet created' };
  } catch (error) {
    return { success: false, message: 'Error creating Holidays sheet: ' + error.message };
  }
}

function initializeDailyAttendanceSheet(ss) {
  try {
    let sheet = ss.getSheetByName(SHEET_NAMES.DAILY_ATTENDANCE);
    if (sheet) return { success: true, message: 'DailyAttendance sheet already exists' };
    
    sheet = ss.insertSheet(SHEET_NAMES.DAILY_ATTENDANCE);
    const headers = [
      'Date', 'Staff ID', 'Name', 'Department', 'Status', 'Holiday Name', 
      'Remarks', 'Submitted By', 'Submitted Date', 'Login Time', 'Logout Time', 
      'Total Hours', 'QR Scanned By', 'Timing Config Used'
    ];
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
    sheet.setFrozenRows(1);
    
    return { success: true, message: 'DailyAttendance sheet created' };
  } catch (error) {
    return { success: false, message: 'Error creating DailyAttendance sheet: ' + error.message };
  }
}

function initializeLeavesSheet(ss) {
  try {
    let sheet = ss.getSheetByName(SHEET_NAMES.LEAVES);
    if (sheet) return { success: true, message: 'Leaves sheet already exists' };
    
    sheet = ss.insertSheet(SHEET_NAMES.LEAVES);
    const headers = [
      'Leave ID', 'Staff ID', 'Staff Name', 'Department', 'Leave Type', 
      'Start Date', 'End Date', 'Number of Days', 'Reason', 'Applied Date', 
      'Status', 'Approved By', 'Approved Date', 'Remarks'
    ];
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
    sheet.setFrozenRows(1);
    
    return { success: true, message: 'Leaves sheet created' };
  } catch (error) {
    return { success: false, message: 'Error creating Leaves sheet: ' + error.message };
  }
}

function initializeSalaryReceiptsSheet(ss) {
  try {
    let sheet = ss.getSheetByName(SHEET_NAMES.SALARY_RECEIPTS);
    if (sheet) return { success: true, message: 'SalaryReceipts sheet already exists' };
    
    sheet = ss.insertSheet(SHEET_NAMES.SALARY_RECEIPTS);
    const headers = [
      'Receipt ID', 'Staff ID', 'Staff Name', 'Month', 'Year', 'Net Salary', 
      'Confirmed Date', 'Confirmation Method', 'Payment Method', 'Signature', 'Remarks'
    ];
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
    sheet.setFrozenRows(1);
    
    return { success: true, message: 'SalaryReceipts sheet created' };
  } catch (error) {
    return { success: false, message: 'Error creating SalaryReceipts sheet: ' + error.message };
  }
}

function initializeNoticesSheet(ss) {
  try {
    let sheet = ss.getSheetByName(SHEET_NAMES.NOTICES);
    if (sheet) return { success: true, message: 'Notices sheet already exists' };
    
    sheet = ss.insertSheet(SHEET_NAMES.NOTICES);
    const headers = [
      'Notice ID', 'Title', 'Message', 'Priority', 'Target Audience', 
      'Sender', 'Sent Date', 'Expiry Date', 'Status', 'Read By', 'Acknowledged By'
    ];
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
    sheet.setFrozenRows(1);
    
    return { success: true, message: 'Notices sheet created' };
  } catch (error) {
    return { success: false, message: 'Error creating Notices sheet: ' + error.message };
  }
}

function initializeTasksSheet(ss) {
  try {
    let sheet = ss.getSheetByName(SHEET_NAMES.TASKS);
    if (sheet) return { success: true, message: 'Tasks sheet already exists' };
    
    sheet = ss.insertSheet(SHEET_NAMES.TASKS);
    const headers = [
      'Task ID', 'Title', 'Description', 'Assigned To', 'Assigned By', 
      'Assigned Date', 'Due Date', 'Priority', 'Status', 'Completion Date', 
      'Remarks', 'Acknowledged'
    ];
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
    sheet.setFrozenRows(1);
    
    return { success: true, message: 'Tasks sheet created' };
  } catch (error) {
    return { success: false, message: 'Error creating Tasks sheet: ' + error.message };
  }
}

function initializeAttendanceTimingSheet(ss) {
  try {
    let sheet = ss.getSheetByName(SHEET_NAMES.ATTENDANCE_TIMING);
    if (sheet) return { success: true, message: 'AttendanceTimingConfig sheet already exists' };
    
    sheet = ss.insertSheet(SHEET_NAMES.ATTENDANCE_TIMING);
    const headers = ['Start Hour', 'Start Minute', 'End Hour', 'End Minute', 'Is Enabled', 'Last Modified', 'Modified By'];
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
    
    // Set default config (9:00 AM to 10:30 AM)
    sheet.getRange(2, 1, 1, headers.length).setValues([[9, 0, 10, 30, true, new Date(), 'System']]);
    sheet.setFrozenRows(1);
    
    return { success: true, message: 'AttendanceTimingConfig sheet created' };
  } catch (error) {
    return { success: false, message: 'Error creating AttendanceTimingConfig sheet: ' + error.message };
  }
}

function initializeQRAttendanceSheets(ss) {
  try {
    // Initialize QR Log sheet
    let qrLogSheet = ss.getSheetByName(SHEET_NAMES.QR_LOG);
    if (!qrLogSheet) {
      qrLogSheet = ss.insertSheet(SHEET_NAMES.QR_LOG);
      const logHeaders = ['Date', 'Staff ID', 'Name', 'Department', 'Action', 'Time', 'Status', 'Scanned By', 'Total Hours', 'Attendance Status'];
      qrLogSheet.getRange(1, 1, 1, logHeaders.length).setValues([logHeaders]).setFontWeight('bold');
      qrLogSheet.setFrozenRows(1);
    }
    
    // Initialize QR Tracking sheet
    let qrTrackingSheet = ss.getSheetByName(SHEET_NAMES.QR_TRACKING);
    if (!qrTrackingSheet) {
      qrTrackingSheet = ss.insertSheet(SHEET_NAMES.QR_TRACKING);
      const trackingHeaders = ['Date', 'Staff ID', 'Name', 'Department', 'Login Time', 'Logout Time', 'Total Minutes', 'Status', 'Attendance Code', 'Remarks'];
      qrTrackingSheet.getRange(1, 1, 1, trackingHeaders.length).setValues([trackingHeaders]).setFontWeight('bold');
      qrTrackingSheet.setFrozenRows(1);
    }
    
    return { success: true, message: 'QR Attendance sheets initialized' };
  } catch (error) {
    return { success: false, message: 'Error initializing QR sheets: ' + error.message };
  }
}

// ========== USER AUTHENTICATION ==========

function authenticateUser(username, password) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const usersSheet = ss.getSheetByName(SHEET_NAMES.USERS);
    
    if (!usersSheet || usersSheet.getLastRow() <= 1) {
      initializeUsersSheet(ss);
      return { 
        success: false, 
        message: 'Default users created. Please login with admin/admin or principal/principal' 
      };
    }
    
    const data = usersSheet.getRange(2, 1, usersSheet.getLastRow() - 1, 7).getValues();
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      if (row[1] === username && row[2] === password && row[4] === 'Active') {
        // Update last login
        usersSheet.getRange(i + 2, 7).setValue(new Date());
        
        return {
          success: true,
          user: {
            userId: row[0],
            username: row[1],
            role: row[3],
            displayName: row[1]
          }
        };
      }
    }
    
    return { success: false, message: 'Invalid username or password' };
  } catch (error) {
    console.error('Authentication error:', error);
    return { success: false, message: 'Authentication error: ' + error.message };
  }
}

function authenticateStaff(staffId, password) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const staffSheet = ss.getSheetByName(SHEET_NAMES.STAFF);
    
    if (!staffSheet || staffSheet.getLastRow() <= 1) {
      return { success: false, message: 'Staff database not found or empty' };
    }
    
    const data = staffSheet.getDataRange().getValues();
    const headers = data[0];
    
    const staffIdCol = headers.indexOf('Staff ID');
    const nameCol = headers.indexOf('Name');
    const deptCol = headers.indexOf('Department');
    const designationCol = headers.indexOf('Designation');
    const staffTypeCol = headers.indexOf('Staff Type');
    const basicSalaryCol = headers.indexOf('Basic Salary');
    const joinDateCol = headers.indexOf('Join Date');
    const emailCol = headers.indexOf('Email');
    const phoneCol = headers.indexOf('Phone');
    const bankCol = headers.indexOf('Bank Account');
    const ifscCol = headers.indexOf('IFSC Code');
    const photoCol = headers.indexOf('Photo URL');
    const passwordCol = headers.indexOf('Password');
    const statusCol = headers.indexOf('Status');
    
    if (staffIdCol === -1) return { success: false, message: 'Staff ID column not found' };
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const currentStaffId = row[staffIdCol] ? row[staffIdCol].toString().trim() : '';
      
      if (currentStaffId && currentStaffId.toUpperCase() === staffId.toUpperCase()) {
        // Check status
        if (statusCol !== -1 && row[statusCol] && row[statusCol].toString().toLowerCase() !== 'active') {
          return { success: false, message: 'Staff account is not active' };
        }
        
        // Validate password
        const storedPassword = passwordCol !== -1 ? (row[passwordCol] || '').toString() : '';
        const defaultPassword = staffId.toLowerCase();
        
        if (password !== storedPassword && password !== defaultPassword && password !== DEFAULT_PASSWORD) {
          return { success: false, message: 'Invalid password' };
        }
        
        // Process photo URL
        let photoUrl = photoCol !== -1 ? (row[photoCol] || '') : '';
        if (photoUrl && photoUrl.includes('drive.google.com')) {
          photoUrl = convertToDirectImageUrl(photoUrl);
        }
        
        const staffData = {
          staffId: currentStaffId,
          name: nameCol !== -1 ? (row[nameCol] || '') : '',
          department: deptCol !== -1 ? (row[deptCol] || '') : '',
          designation: designationCol !== -1 ? (row[designationCol] || '') : '',
          staffType: staffTypeCol !== -1 ? (row[staffTypeCol] || '') : '',
          basicSalary: basicSalaryCol !== -1 ? (parseFloat(row[basicSalaryCol]) || 0) : 0,
          joinDate: joinDateCol !== -1 ? formatDate(row[joinDateCol]) : '',
          email: emailCol !== -1 ? (row[emailCol] || '') : '',
          phone: phoneCol !== -1 ? (row[phoneCol] || '') : '',
          bankAccount: bankCol !== -1 ? (row[bankCol] || '') : '',
          ifscCode: ifscCol !== -1 ? (row[ifscCol] || '') : '',
          photoUrl: photoUrl,
          status: statusCol !== -1 ? (row[statusCol] || 'Active') : 'Active'
        };
        
        return { success: true, staff: staffData, message: 'Login successful' };
      }
    }
    
    return { success: false, message: 'Staff ID not found' };
  } catch (error) {
    console.error('Staff authentication error:', error);
    return { success: false, message: 'Authentication error: ' + error.toString() };
  }
}

function changeStaffPassword(staffId, currentPassword, newPassword) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    // Verify current password
    const authResult = authenticateStaff(staffId, currentPassword);
    if (!authResult.success) {
      return { success: false, message: 'Current password is incorrect' };
    }
    
    // Update password in Staff sheet
    const staffSheet = ss.getSheetByName(SHEET_NAMES.STAFF);
    if (!staffSheet || staffSheet.getLastRow() <= 1) {
      return { success: false, message: 'Staff sheet not found' };
    }
    
    const staffData = staffSheet.getDataRange().getValues();
    const headers = staffData[0];
    const passwordCol = headers.indexOf('Password');
    const staffIdCol = headers.indexOf('Staff ID');
    
    if (passwordCol === -1 || staffIdCol === -1) {
      return { success: false, message: 'Required columns not found' };
    }
    
    for (let i = 1; i < staffData.length; i++) {
      const row = staffData[i];
      const currentStaffId = row[staffIdCol] ? row[staffIdCol].toString().trim() : '';
      
      if (currentStaffId === staffId) {
        const rowNumber = i + 1;
        staffSheet.getRange(rowNumber, passwordCol + 1).setValue(newPassword);
        
        // Update password in Users sheet
        updateUserPassword(staffId, newPassword);
        
        return { success: true, message: 'Password changed successfully!' };
      }
    }
    
    return { success: false, message: 'Staff not found in database' };
  } catch (error) {
    console.error('Password change error:', error);
    return { success: false, message: 'Error changing password: ' + error.message };
  }
}

function updateUserPassword(username, newPassword) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const usersSheet = ss.getSheetByName(SHEET_NAMES.USERS);
    
    if (!usersSheet || usersSheet.getLastRow() <= 1) return false;
    
    const usersData = usersSheet.getRange(2, 1, usersSheet.getLastRow() - 1, 6).getValues();
    
    for (let i = 0; i < usersData.length; i++) {
      const row = usersData[i];
      if (row[1] === username) {
        const rowNumber = i + 2;
        usersSheet.getRange(rowNumber, 3).setValue(newPassword);
        return true;
      }
    }
    
    // Create new user if not found
    return createStaffUserAccount(username, newPassword).success;
  } catch (error) {
    console.error('Error updating user password:', error);
    return false;
  }
}

function createStaffUserAccount(staffId, password) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let usersSheet = ss.getSheetByName(SHEET_NAMES.USERS);
    
    if (!usersSheet) {
      usersSheet = ss.insertSheet(SHEET_NAMES.USERS);
      const headers = ['User ID', 'Username', 'Password', 'Role', 'Status', 'Created Date', 'Last Login'];
      usersSheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
    }
    
    // Check if user already exists
    const existingData = usersSheet.getRange(2, 1, usersSheet.getLastRow() - 1, 6).getValues();
    for (let i = 0; i < existingData.length; i++) {
      if (existingData[i][1] === staffId) {
        return { success: true, message: 'User already exists' };
      }
    }
    
    const userId = generateId(SHEET_NAMES.USERS, 'USER', 3);
    const lastRow = usersSheet.getLastRow() + 1;
    
    usersSheet.getRange(lastRow, 1, 1, 7).setValues([[
      userId,
      staffId,
      password,
      USER_ROLES.STAFF,
      'Active',
      new Date(),
      ''
    ]]);
    
    return { success: true, message: 'Staff user account created successfully!' };
  } catch (error) {
    console.error('Error creating staff user:', error);
    return { success: false, message: 'Error creating staff user account: ' + error.message };
  }
}

function getAllUsers() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const usersSheet = ss.getSheetByName(SHEET_NAMES.USERS);
    
    if (!usersSheet || usersSheet.getLastRow() <= 1) return [];
    
    const data = usersSheet.getRange(2, 1, usersSheet.getLastRow() - 1, 7).getValues();
    return data.map(row => ({
      userId: row[0],
      username: row[1],
      role: row[3],
      status: row[4],
      createdDate: formatDate(row[5]),
      lastLogin: row[6] ? formatDateTime(row[6]) : ''
    })).filter(user => user.userId && user.username);
  } catch (error) {
    console.error('Error getting users:', error);
    return [];
  }
}

function addUser(userData) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const usersSheet = ss.getSheetByName(SHEET_NAMES.USERS);
    
    if (!usersSheet) {
      return { success: false, message: 'Users sheet not found' };
    }
    
    // Check for duplicate username
    const existingUsers = getAllUsers();
    if (existingUsers.some(u => u.username === userData.username)) {
      return { success: false, message: 'Username already exists!' };
    }
    
    const userId = generateId(SHEET_NAMES.USERS, 'USER', 3);
    const lastRow = usersSheet.getLastRow() + 1;
    
    usersSheet.getRange(lastRow, 1, 1, 7).setValues([[
      userId,
      userData.username,
      userData.password,
      userData.role,
      'Active',
      new Date(),
      ''
    ]]);
    
    return { success: true, message: 'User added successfully!' };
  } catch (error) {
    console.error('Error adding user:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function deleteUser(userId) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const usersSheet = ss.getSheetByName(SHEET_NAMES.USERS);
    
    if (!usersSheet || usersSheet.getLastRow() <= 1) {
      return { success: false, message: 'Users sheet not found' };
    }
    
    const data = usersSheet.getRange(2, 1, usersSheet.getLastRow() - 1, 7).getValues();
    
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === userId) {
        usersSheet.deleteRow(i + 2);
        return { success: true, message: 'User deleted successfully!' };
      }
    }
    
    return { success: false, message: 'User ID not found!' };
  } catch (error) {
    console.error('Error deleting user:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

// Add this function after your existing addStaff function
function addStaffToAttendanceSheets(staffId, joinDate) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const staffResponse = getStaffById(staffId);
    if (!staffResponse.success) {
      return { success: false, message: 'Staff not found' };
    }
    
    const staff = staffResponse.staff;
    const joinDateObj = new Date(joinDate);
    const joinMonth = joinDateObj.getMonth();
    const joinYear = joinDateObj.getFullYear();
    
    // Get all existing attendance sheets
    const sheets = ss.getSheets();
    const attendanceSheets = sheets.filter(sheet => 
      sheet.getName().startsWith('Attendance_')
    );
    
    let addedCount = 0;
    
    attendanceSheets.forEach(sheet => {
      const sheetName = sheet.getName();
      const [_, month, year] = sheetName.split('_');
      const sheetYear = parseInt(year);
      const sheetMonth = getMonthNumber(month) - 1; // Convert to 0-based month
      
      // Check if this sheet is for a month after the join date
      if (sheetYear > joinYear || (sheetYear === joinYear && sheetMonth >= joinMonth)) {
        // Add staff to this attendance sheet
        const result = addStaffToMonthlyAttendanceSheet(sheet, staff, joinDateObj, sheetMonth, sheetYear);
        if (result.success) {
          addedCount++;
        }
      }
    });
    
    return { 
      success: true, 
      message: `Staff added to ${addedCount} monthly attendance sheets`,
      count: addedCount 
    };
    
  } catch (error) {
    console.error('Error adding staff to attendance sheets:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

// Helper function to add staff to a specific monthly attendance sheet
function addStaffToMonthlyAttendanceSheet(sheet, staff, joinDate, sheetMonth, sheetYear) {
  try {
    const sheetName = sheet.getName();
    const monthInfo = getMonthInfo(getMonthName(sheetMonth + 1), sheetYear);
    const totalDays = monthInfo.totalDays;
    
    // Get holiday data for this month
    const holidays = getHolidaysForMonth(getMonthName(sheetMonth + 1), sheetYear);
    const holidayMap = {};
    
    // Create holiday map for quick lookup
    const holidayDates = getHolidayDatesForMonth(getMonthName(sheetMonth + 1), sheetYear);
    holidayDates.forEach(h => {
      const dateStr = formatDate(h.date);
      holidayMap[dateStr] = h;
    });
    
    // Check if staff already exists in this sheet
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === staff.staffId) {
        return { success: false, message: 'Staff already exists in this sheet' };
      }
    }
    
    // Find the last row and add new staff
    const lastRow = sheet.getLastRow() + 1;
    
    // Add basic info
    sheet.getRange(lastRow, 1, 1, 5).setValues([[
      staff.staffId, 
      staff.name, 
      staff.department, 
      staff.designation, 
      staff.staffType
    ]]);
    
    // Add totals
    sheet.getRange(lastRow, 6).setValue(totalDays); // Total Days
    sheet.getRange(lastRow, 7).setValue(monthInfo.sundays); // Sundays
    sheet.getRange(lastRow, 8).setValue(holidays.length); // Holidays
    sheet.getRange(lastRow, 9).setValue(totalDays - monthInfo.sundays - holidays.length); // Working Days
    
    // Fill daily attendance
    for (let day = 1; day <= totalDays; day++) {
      const currentDate = new Date(sheetYear, sheetMonth, day);
      const dateStr = formatDate(currentDate);
      const dayOfWeek = currentDate.getDay();
      const column = 9 + day;
      
      let statusCode = '';
      
      // Check if before joining date
      if (currentDate < joinDate) {
        statusCode = ATTENDANCE_CODES.FULL_DAY_LEAVE; // Before joining
      } 
      // Check if Sunday
      else if (dayOfWeek === 0) {
        statusCode = ATTENDANCE_CODES.HOLIDAY;
      }
      // Check if holiday
      else if (holidayMap[dateStr]) {
        statusCode = ATTENDANCE_CODES.HOLIDAY;
      }
      else {
        statusCode = '-'; // Working day - not marked yet
      }
      
      sheet.getRange(lastRow, column).setValue(statusCode);
    }
    
    // Add formulas for summary
    const lastDayCol = 9 + totalDays;
    
    sheet.getRange(lastRow, lastDayCol + 1).setFormula(
      `=COUNTIF(J${lastRow}:${getColumnLetter(9 + totalDays)}${lastRow},"P")+COUNTIF(J${lastRow}:${getColumnLetter(9 + totalDays)}${lastRow},"L")`
    );
    
    sheet.getRange(lastRow, lastDayCol + 2).setFormula(
      `=COUNTIF(J${lastRow}:${getColumnLetter(9 + totalDays)}${lastRow},"${ATTENDANCE_CODES.ABSENT}")`
    );
    
    sheet.getRange(lastRow, lastDayCol + 3).setFormula(
      `=COUNTIF(J${lastRow}:${getColumnLetter(9 + totalDays)}${lastRow},"${ATTENDANCE_CODES.LATE}")`
    );
    
    sheet.getRange(lastRow, lastDayCol + 4).setFormula(
      `=COUNTIF(J${lastRow}:${getColumnLetter(9 + totalDays)}${lastRow},"${ATTENDANCE_CODES.HALF_DAY}")`
    );
    
    sheet.getRange(lastRow, lastDayCol + 5).setFormula(
      `=COUNTIF(J${lastRow}:${getColumnLetter(9 + totalDays)}${lastRow},"${ATTENDANCE_CODES.FULL_DAY_LEAVE}")`
    );
    
    sheet.getRange(lastRow, lastDayCol + 6).setFormula(
      `=COUNTIF(J${lastRow}:${getColumnLetter(9 + totalDays)}${lastRow},"${ATTENDANCE_CODES.HOLIDAY}")`
    );
    
    sheet.getRange(lastRow, lastDayCol + 7).setFormula(
      `=IF(F${lastRow}>0,ROUND((${getColumnLetter(lastDayCol + 1)}${lastRow})/F${lastRow}*100,1)&"%","0%")`
    );
    
    // Apply data validation
    const dailyRange = sheet.getRange(lastRow, 10, 1, totalDays);
    const validationValues = [...Object.values(ATTENDANCE_CODES), '-'];
    const validationRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(validationValues, true)
      .build();
    dailyRange.setDataValidation(validationRule);
    
    return { success: true, message: 'Staff added successfully' };
    
  } catch (error) {
    console.error('Error adding staff to monthly sheet:', error);
    return { success: false, message: error.message };
  }
}

// Modified addStaff function to include attendance sheet update
function addStaff(staffData) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let staffSheet = ss.getSheetByName(SHEET_NAMES.STAFF);
    
    if (!staffSheet) {
      staffSheet = initializeStaffSheet(ss).sheet;
    }
    
    const staffId = generateId(SHEET_NAMES.STAFF, 'STAFF', 3);
    let photoUrl = '';
    
    if (staffData.photoData) {
      photoUrl = saveStaffPhoto(staffData.photoData, staffData.photoName || 'photo.jpg', staffId);
    }
    
    const defaultPassword = staffId.toLowerCase();
    const lastRow = staffSheet.getLastRow() + 1;
    const joinDate = parseDateSafe(staffData.joinDate) || new Date();
    
    staffSheet.getRange(lastRow, 1, 1, 16).setValues([[
      staffId,
      staffData.name,
      staffData.department,
      staffData.designation,
      staffData.staffType,
      Math.round(parseFloat(staffData.basicSalary) || 0),
      joinDate,
      staffData.email || '',
      staffData.phone || '',
      staffData.bankAccount || '',
      staffData.ifscCode || '',
      'Active',
      photoUrl,
      defaultPassword,
      new Date(),
      new Date()
    ]]);
    
    // Create user account
    createStaffUserAccount(staffId, defaultPassword);
    
    // NEW: Add staff to all relevant attendance sheets
    const attendanceResult = addStaffToAttendanceSheets(staffId, joinDate);
    
    return { 
      success: true, 
      staffId: staffId, 
      message: `Staff added successfully! ${attendanceResult.message}`, 
      photoUrl: photoUrl,
      attendanceUpdate: attendanceResult
    };
  } catch (error) {
    console.error('Error adding staff:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

// Optional: Function to add a single staff member to a specific month's attendance sheet
function addStaffToSpecificMonthSheet(staffId, month, year) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = `Attendance_${month}_${year}`;
    const attendanceSheet = ss.getSheetByName(sheetName);
    
    if (!attendanceSheet) {
      return { success: false, message: 'Attendance sheet not found for ' + month + ' ' + year };
    }
    
    const staffResponse = getStaffById(staffId);
    if (!staffResponse.success) {
      return { success: false, message: 'Staff not found' };
    }
    
    const staff = staffResponse.staff;
    const joinDate = new Date(staff.joinDate);
    const sheetMonth = getMonthNumber(month) - 1;
    const sheetYear = parseInt(year);
    
    return addStaffToMonthlyAttendanceSheet(attendanceSheet, staff, joinDate, sheetMonth, sheetYear);
    
  } catch (error) {
    console.error('Error adding staff to specific month:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function getAllStaff(includeInactive = false) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const staffSheet = ss.getSheetByName(SHEET_NAMES.STAFF);
    
    if (!staffSheet || staffSheet.getLastRow() <= 1) return [];
    
    const data = staffSheet.getDataRange().getValues();
    const headers = data[0];
    
    const colIndex = {
      staffId: headers.indexOf('Staff ID'),
      name: headers.indexOf('Name'),
      department: headers.indexOf('Department'),
      designation: headers.indexOf('Designation'),
      staffType: headers.indexOf('Staff Type'),
      basicSalary: headers.indexOf('Basic Salary'),
      joinDate: headers.indexOf('Join Date'),
      email: headers.indexOf('Email'),
      phone: headers.indexOf('Phone'),
      bankAccount: headers.indexOf('Bank Account'),
      ifscCode: headers.indexOf('IFSC Code'),
      status: headers.indexOf('Status'),
      photoUrl: headers.indexOf('Photo URL')
    };
    
    if (colIndex.staffId === -1 || colIndex.name === -1) return [];
    
    const staffList = [];
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const staffId = row[colIndex.staffId] ? row[colIndex.staffId].toString().trim() : '';
      const name = row[colIndex.name] ? row[colIndex.name].toString().trim() : '';
      const status = colIndex.status !== -1 ? (row[colIndex.status] || 'Active') : 'Active';
      
      if (staffId && name && (includeInactive || status === 'Active')) {
        let photoUrl = colIndex.photoUrl !== -1 ? (row[colIndex.photoUrl] || '') : '';
        if (photoUrl && photoUrl.includes('drive.google.com')) {
          photoUrl = convertToDirectImageUrl(photoUrl);
        }
        
        staffList.push({
          staffId: staffId,
          name: name,
          department: colIndex.department !== -1 ? (row[colIndex.department] || '') : '',
          designation: colIndex.designation !== -1 ? (row[colIndex.designation] || '') : '',
          staffType: colIndex.staffType !== -1 ? (row[colIndex.staffType] || '') : '',
          basicSalary: colIndex.basicSalary !== -1 ? (parseFloat(row[colIndex.basicSalary]) || 0) : 0,
          joinDate: colIndex.joinDate !== -1 ? formatDate(row[colIndex.joinDate]) : '',
          email: colIndex.email !== -1 ? (row[colIndex.email] || '') : '',
          phone: colIndex.phone !== -1 ? (row[colIndex.phone] || '') : '',
          bankAccount: colIndex.bankAccount !== -1 ? (row[colIndex.bankAccount] || '') : '',
          ifscCode: colIndex.ifscCode !== -1 ? (row[colIndex.ifscCode] || '') : '',
          status: status,
          photoUrl: photoUrl
        });
      }
    }
    
    // Sort by Staff ID numerically
    staffList.sort((a, b) => {
      const idA = a.staffId || '';
      const idB = b.staffId || '';
      
      // Extract numeric part
      const numA = parseInt(idA.replace(/\D/g, '')) || 0;
      const numB = parseInt(idB.replace(/\D/g, '')) || 0;
      
      if (numA !== numB) {
        return numA - numB;
      }
      
      return idA.localeCompare(idB);
    });
    
    return staffList;
  } catch (error) {
    console.error('Error getting staff:', error);
    return [];
  }
}

function getStaffById(staffId) {
  try {
    const staffList = getAllStaff(true);
    const staff = staffList.find(s => s.staffId === staffId);
    
    if (staff) {
      return { success: true, staff: staff };
    }
    
    return { success: false, message: 'Staff ID not found' };
  } catch (error) {
    console.error('Error getting staff by ID:', error);
    return { success: false, message: 'Error retrieving staff data: ' + error.message };
  }
}

function updateStaff(staffId, staffData) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const staffSheet = ss.getSheetByName(SHEET_NAMES.STAFF);
    
    if (!staffSheet || staffSheet.getLastRow() <= 1) {
      return { success: false, message: 'Staff sheet not found' };
    }
    
    const data = staffSheet.getRange(2, 1, staffSheet.getLastRow() - 1, 16).getValues();
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      if (row[0] === staffId) {
        const rowNumber = i + 2;
        
        let photoUrl = row[12] || '';
        if (staffData.photoData) {
          photoUrl = saveStaffPhoto(staffData.photoData, staffData.photoName || 'photo.jpg', staffId);
        }
        
        staffSheet.getRange(rowNumber, 2, 1, 15).setValues([[
          staffData.name,
          staffData.department,
          staffData.designation,
          staffData.staffType,
          Math.round(parseFloat(staffData.basicSalary) || 0),
          parseDateSafe(staffData.joinDate) || new Date(),
          staffData.email || '',
          staffData.phone || '',
          staffData.bankAccount || '',
          staffData.ifscCode || '',
          staffData.status || 'Active',
          photoUrl,
          staffData.password || row[13],
          row[14] || new Date(),
          new Date() // Last Modified
        ]]);
        
        return { success: true, message: 'Staff updated successfully!' };
      }
    }
    
    return { success: false, message: 'Staff ID not found!' };
  } catch (error) {
    console.error('Error updating staff:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function deleteStaff(staffId) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const staffSheet = ss.getSheetByName(SHEET_NAMES.STAFF);
    
    if (!staffSheet || staffSheet.getLastRow() <= 1) {
      return { success: false, message: 'Staff sheet not found' };
    }
    
    const data = staffSheet.getRange(2, 1, staffSheet.getLastRow() - 1, 16).getValues();
    
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === staffId) {
        staffSheet.deleteRow(i + 2);
        return { success: true, message: 'Staff deleted successfully!' };
      }
    }
    
    return { success: false, message: 'Staff ID not found!' };
  } catch (error) {
    console.error('Error deleting staff:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function getAllStaffForTasks() {
  try {
    const staffList = getAllStaff();
    const staffOptions = [];
    
    // Add "All Staff" option
    staffOptions.push({ 
      staffId: 'All Staff', 
      name: 'All Staff', 
      displayText: 'All Staff', 
      type: 'group' 
    });
    
    // Group by staff type
    const teachingStaff = staffList.filter(staff => staff.staffType === STAFF_TYPES.TEACHING);
    const nonTeachingStaff = staffList.filter(staff => staff.staffType === STAFF_TYPES.NON_TEACHING);
    
    if (teachingStaff.length > 0) {
      staffOptions.push({ 
        staffId: 'Teaching Staff', 
        name: 'Teaching Staff', 
        displayText: 'Teaching Staff', 
        type: 'group' 
      });
      
      teachingStaff.forEach(staff => {
        if (staff.staffId && staff.name) {
          staffOptions.push({
            staffId: staff.staffId,
            name: staff.name,
            displayText: `${staff.staffId} - ${staff.name} (${staff.department})`,
            type: 'individual',
            department: staff.department
          });
        }
      });
    }
    
    if (nonTeachingStaff.length > 0) {
      staffOptions.push({ 
        staffId: 'Non-Teaching Staff', 
        name: 'Non-Teaching Staff', 
        displayText: 'Non-Teaching Staff', 
        type: 'group' 
      });
      
      nonTeachingStaff.forEach(staff => {
        if (staff.staffId && staff.name) {
          staffOptions.push({
            staffId: staff.staffId,
            name: staff.name,
            displayText: `${staff.staffId} - ${staff.name} (${staff.department})`,
            type: 'individual',
            department: staff.department
          });
        }
      });
    }
    
    return staffOptions;
  } catch (error) {
    console.error('Error getting staff for tasks:', error);
    return [];
  }
}

function getDepartments() {
  return ['Primary', 'Pre-Primary', 'Administration', 'Support Staff', 'Management'];
}

function getDesignations() {
  return ['Principal', 'Vice Principal', 'Asst - Teacher', 'Driver', 'Cleaner', 'Peon', 'Aaya', 'Security'];
}

// ========== PHOTO HANDLING ==========

function saveStaffPhoto(photoData, photoName, staffId) {
  try {
    if (!photoData) return '';
    
    // Extract base64 data
    const base64Data = photoData.replace(/^data:image\/\w+;base64,/, '');
    const blob = Utilities.newBlob(
      Utilities.base64Decode(base64Data), 
      'image/jpeg', 
      `${staffId}_${photoName || 'photo.jpg'}`
    );
    
    // Get or create Staff Photos folder
    const folders = DriveApp.getFoldersByName('Staff Photos');
    const folder = folders.hasNext() ? folders.next() : DriveApp.createFolder('Staff Photos');
    
    // Save file and set permissions
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    return getDirectImageUrl(file.getId());
  } catch (error) {
    console.error('Error saving staff photo:', error);
    return '';
  }
}

function getDirectImageUrl(fileId) {
  try {
    return `https://lh3.googleusercontent.com/d/${fileId}`;
  } catch (error) {
    try {
      return DriveApp.getFileById(fileId).getUrl();
    } catch (e) {
      return '';
    }
  }
}

function convertToDirectImageUrl(driveUrl) {
  try {
    if (!driveUrl) return '';
    
    // Extract file ID from various Google Drive URL formats
    const patterns = [
      /[-\w]{25,}/,
      /\/d\/([-\w]+)/,
      /id=([-\w]+)/
    ];
    
    for (const pattern of patterns) {
      const match = driveUrl.match(pattern);
      if (match) {
        const fileId = match[1] || match[0];
        return `https://lh3.googleusercontent.com/d/${fileId}`;
      }
    }
    
    return driveUrl;
  } catch (error) {
    console.error('Error converting URL:', error);
    return driveUrl;
  }
}

// ========== HOLIDAY MANAGEMENT ==========

function addHoliday(holidayData) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const holidaysSheet = ss.getSheetByName(SHEET_NAMES.HOLIDAYS);
    
    if (!holidaysSheet) {
      return { success: false, message: 'Holidays sheet not found' };
    }
    
    const holidayId = generateId(SHEET_NAMES.HOLIDAYS, 'HOL', 3);
    const startDate = parseDateSafe(holidayData.startDate);
    const endDate = parseDateSafe(holidayData.endDate);
    
    if (!startDate || !endDate) {
      return { success: false, message: 'Invalid dates provided' };
    }
    
    const numberOfDays = calculateWorkingDays(startDate, endDate);
    
    const lastRow = holidaysSheet.getLastRow() + 1;
    holidaysSheet.getRange(lastRow, 1, 1, 8).setValues([[
      holidayId,
      holidayData.holidayName,
      startDate,
      endDate,
      numberOfDays,
      holidayData.reason || '',
      holidayData.addedBy || 'System',
      new Date()
    ]]);
    
    holidaysSheet.getRange(lastRow, 3, 1, 2).setNumberFormat('yyyy-mm-dd');
    
    // Auto-update attendance sheets
    autoUpdateAttendanceForHolidayChanges();
    
    return { 
      success: true, 
      holidayId: holidayId, 
      message: 'Holiday added successfully!', 
      numberOfDays: numberOfDays 
    };
  } catch (error) {
    console.error('Error adding holiday:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function getAllHolidays() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const holidaysSheet = ss.getSheetByName(SHEET_NAMES.HOLIDAYS);
    
    if (!holidaysSheet || holidaysSheet.getLastRow() <= 1) return [];
    
    const data = holidaysSheet.getRange(2, 1, holidaysSheet.getLastRow() - 1, 8).getValues();
    
    return data
      .filter(row => row[0] && row[1])
      .map(row => ({
        holidayId: row[0],
        holidayName: row[1],
        startDate: formatDate(row[2]),
        endDate: formatDate(row[3]),
        numberOfDays: row[4] || 0,
        reason: row[5] || '',
        addedBy: row[6] || '',
        addedDate: formatDate(row[7])
      }))
      .sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
  } catch (error) {
    console.error('Error getting holidays:', error);
    return [];
  }
}

function deleteHoliday(holidayId) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const holidaysSheet = ss.getSheetByName(SHEET_NAMES.HOLIDAYS);
    
    if (!holidaysSheet || holidaysSheet.getLastRow() <= 1) {
      return { success: false, message: 'No holidays found!' };
    }
    
    const data = holidaysSheet.getRange(2, 1, holidaysSheet.getLastRow() - 1, 8).getValues();
    
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === holidayId) {
        holidaysSheet.deleteRow(i + 2);
        autoUpdateAttendanceForHolidayChanges();
        return { success: true, message: 'Holiday deleted successfully!' };
      }
    }
    
    return { success: false, message: 'Holiday ID not found!' };
  } catch (error) {
    console.error('Error deleting holiday:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function getHolidaysForMonth(month, year) {
  try {
    const holidays = getAllHolidays();
    const targetMonth = getMonthNumber(month);
    const targetYear = parseInt(year);
    
    return holidays.filter(holiday => {
      const startDate = new Date(holiday.startDate);
      const endDate = new Date(holiday.endDate);
      
      return (startDate.getMonth() + 1 === targetMonth && startDate.getFullYear() === targetYear) ||
             (endDate.getMonth() + 1 === targetMonth && endDate.getFullYear() === targetYear);
    });
  } catch (error) {
    console.error('Error getting holidays for month:', error);
    return [];
  }
}

function getHolidayForDate(date) {
  try {
    const holidays = getAllHolidays();
    const checkDate = new Date(date);
    
    for (const holiday of holidays) {
      const holidayStart = new Date(holiday.startDate);
      const holidayEnd = new Date(holiday.endDate);
      
      if (checkDate >= holidayStart && checkDate <= holidayEnd) {
        return { 
          holidayName: holiday.holidayName, 
          reason: holiday.reason 
        };
      }
    }
    
    return null;
  } catch (error) {
    console.error('Error getting holiday for date:', error);
    return null;
  }
}

function getHolidayDatesForMonth(month, year) {
  try {
    const holidays = getHolidaysForMonth(month, year);
    const targetMonth = getMonthNumber(month);
    const targetYear = parseInt(year);
    const holidayDates = [];
    
    holidays.forEach(holiday => {
      const startDate = new Date(holiday.startDate);
      const endDate = new Date(holiday.endDate);
      const currentDate = new Date(startDate);
      
      while (currentDate <= endDate) {
        if (currentDate.getMonth() + 1 === targetMonth && currentDate.getFullYear() === targetYear) {
          holidayDates.push({
            date: new Date(currentDate),
            holidayName: holiday.holidayName,
            reason: holiday.reason
          });
        }
        currentDate.setDate(currentDate.getDate() + 1);
      }
    });
    
    return holidayDates;
  } catch (error) {
    console.error('Error getting holiday dates:', error);
    return [];
  }
}

function autoUpdateAttendanceForHolidayChanges() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheets = ss.getSheets();
    const attendanceSheets = sheets.filter(sheet => 
      sheet.getName().startsWith('Attendance_')
    );
    
    let totalUpdates = 0;
    
    attendanceSheets.forEach(sheet => {
      const sheetName = sheet.getName();
      const [_, month, year] = sheetName.split('_');
      if (month && year) {
        const updates = updateAttendanceSheetForHolidays(month, parseInt(year));
        totalUpdates += updates;
      }
    });
    
    return { 
      success: true, 
      message: `Auto-updated ${totalUpdates} attendance sheets`, 
      sheetsUpdated: totalUpdates 
    };
  } catch (error) {
    console.error('Error auto-updating attendance:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function updateAttendanceSheetForHolidays(month, year) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = `Attendance_${month}_${year}`;
    const attendanceSheet = ss.getSheetByName(sheetName);
    
    if (!attendanceSheet) return 0;
    
    const monthInfo = getMonthInfo(month, year);
    const totalDays = monthInfo.totalDays;
    const holidayDates = getHolidayDatesForMonth(month, year);
    const holidayMap = {};
    
    holidayDates.forEach(holiday => {
      const dateStr = formatDate(holiday.date);
      holidayMap[dateStr] = holiday;
    });
    
    const data = attendanceSheet.getDataRange().getValues();
    let updatesMade = 0;
    
    // Update daily columns
    for (let day = 1; day <= totalDays; day++) {
      const date = new Date(year, getMonthNumber(month) - 1, day);
      const dateStr = formatDate(date);
      const dayOfWeek = date.getDay();
      const column = 9 + day;
      
      const shouldBeHoliday = (dayOfWeek === 0) || holidayMap[dateStr];
      
      for (let row = 1; row < data.length; row++) {
        const currentValue = data[row][column - 1];
        
        if (shouldBeHoliday) {
          if (currentValue !== ATTENDANCE_CODES.HOLIDAY) {
            attendanceSheet.getRange(row + 1, column).setValue(ATTENDANCE_CODES.HOLIDAY);
            updatesMade++;
          }
        } else {
          if (currentValue === ATTENDANCE_CODES.HOLIDAY && !holidayMap[dateStr] && dayOfWeek !== 0) {
            attendanceSheet.getRange(row + 1, column).setValue('');
            updatesMade++;
          }
        }
      }
      
      // Update header
      let header = `${day} (${date.toLocaleDateString('en-US', { weekday: 'short' })})`;
      if (holidayMap[dateStr]) {
        header += ` - ${holidayMap[dateStr].holidayName}`;
      } else if (date.getDay() === 0) {
        header += ' - Sunday';
      }
      attendanceSheet.getRange(1, column).setValue(header);
    }
    
    // Update summary columns
    if (updatesMade > 0 && data.length > 1) {
      const sundays = monthInfo.sundays;
      const publicHolidays = Object.keys(holidayMap).length;
      const workingDays = totalDays - sundays - publicHolidays;
      
      attendanceSheet.getRange(2, 7, data.length - 1, 1).setValue(sundays);
      attendanceSheet.getRange(2, 8, data.length - 1, 1).setValue(publicHolidays);
      attendanceSheet.getRange(2, 9, data.length - 1, 1).setValue(workingDays);
    }
    
    return updatesMade;
  } catch (error) {
    console.error('Error updating attendance sheet:', error);
    return 0;
  }
}

// ========== ATTENDANCE MANAGEMENT ==========

function createMonthlyAttendanceSheet(month, year) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = `Attendance_${month}_${year}`;
    
    let attendanceSheet = ss.getSheetByName(sheetName);
    if (attendanceSheet) {
      return { success: false, message: 'Attendance sheet for this month already exists!' };
    }
    
    const staffList = getAllStaff();
    if (staffList.length === 0) {
      return { success: false, message: 'No staff members found! Please add staff first.' };
    }
    
    const monthInfo = getMonthInfo(month, year);
    const totalDays = monthInfo.totalDays;
    const sundays = monthInfo.sundays;
    const holidays = getHolidaysForMonth(month, year);
    const totalHolidays = holidays.reduce((sum, holiday) => sum + holiday.numberOfDays, 0);
    
    // Filter staff employed during this month
    const monthStart = new Date(year, getMonthNumber(month) - 1, 1);
    const eligibleStaff = staffList.filter(staff => {
      const joinDate = new Date(staff.joinDate);
      return isSameMonthOrAfter(monthStart, joinDate);
    });
    
    if (eligibleStaff.length === 0) {
      return { 
        success: false, 
        message: 'No staff members were employed during ' + month + ' ' + year 
      };
    }
    
    attendanceSheet = ss.insertSheet(sheetName);
    
    // Create headers
    const headers = [
      'Staff ID', 'Name', 'Department', 'Designation', 'Staff Type', 
      'Total Days', 'Sundays', 'Holidays', 'Working Days'
    ];
    
    for (let day = 1; day <= totalDays; day++) {
      const date = new Date(year, getMonthNumber(month) - 1, day);
      const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
      headers.push(`${day} (${dayName})`);
    }
    
    headers.push('Present Days', 'Absent Days', 'Late Coming Days', 'Half Day Leave', 'Full Day Leave', 'Holiday Days', 'Attendance %');
    
    attendanceSheet.getRange(1, 1, 1, headers.length)
      .setValues([headers])
      .setFontWeight('bold')
      .setBackground('#f0f0f0');
    
    // Set column backgrounds
    attendanceSheet.getRange(1, 1, 1, 9).setBackground('#e6f7ff');
    attendanceSheet.getRange(1, 10, 1, totalDays).setBackground('#fff0e6');
    attendanceSheet.getRange(1, 10 + totalDays, 1, 7).setBackground('#e6ffe6');
    
    // Add staff data
    const holidayDates = getHolidayDatesForMonth(month, year);
    const holidayMap = {};
    holidayDates.forEach(h => {
      const dateStr = formatDate(h.date);
      holidayMap[dateStr] = h;
    });
    
    eligibleStaff.forEach((staff, index) => {
      const row = index + 2;
      const joinDate = new Date(staff.joinDate);
      
      // Basic info
      attendanceSheet.getRange(row, 1, 1, 5).setValues([[
        staff.staffId, staff.name, staff.department, staff.designation, staff.staffType
      ]]);
      
      attendanceSheet.getRange(row, 6).setValue(totalDays);
      attendanceSheet.getRange(row, 7).setValue(sundays);
      attendanceSheet.getRange(row, 8).setValue(totalHolidays);
      attendanceSheet.getRange(row, 9).setValue(totalDays - sundays - totalHolidays);
      
      // Daily attendance - MODIFIED: All days start with "-" instead of "P"
      for (let day = 1; day <= totalDays; day++) {
        const date = new Date(year, getMonthNumber(month) - 1, day);
        const dateStr = formatDate(date);
        const dayOfWeek = date.getDay();
        const column = 9 + day;
        let statusCode = '';
        
        if (date < joinDate) {
          // Before joining date - leave
          statusCode = ATTENDANCE_CODES.FULL_DAY_LEAVE;
        } else if (dayOfWeek === 0 || holidayMap[dateStr]) {
          // Sunday or holiday - marked as holiday
          statusCode = ATTENDANCE_CODES.HOLIDAY;
        } else {
          // Regular working day - start with "-" (blank/not marked)
          statusCode = '-';
        }
        
        attendanceSheet.getRange(row, column).setValue(statusCode);
      }
      
      // Summary formulas
      const lastDayCol = 9 + totalDays;
      
      // Present Days: COUNTIF excluding blank and holiday
      attendanceSheet.getRange(row, lastDayCol + 1).setFormula(
        `=COUNTIF(J${row}:${getColumnLetter(9 + totalDays)}${row},"P")+COUNTIF(J${row}:${getColumnLetter(9 + totalDays)}${row},"L")`
      );
      
      // Absent Days: COUNTIF with "A"
      attendanceSheet.getRange(row, lastDayCol + 2).setFormula(
        `=COUNTIF(J${row}:${getColumnLetter(9 + totalDays)}${row},"${ATTENDANCE_CODES.ABSENT}")`
      );
      
      // Late Coming Days: COUNTIF with "L"
      attendanceSheet.getRange(row, lastDayCol + 3).setFormula(
        `=COUNTIF(J${row}:${getColumnLetter(9 + totalDays)}${row},"${ATTENDANCE_CODES.LATE}")`
      );
      
      // Half Day Leave: COUNTIF with "HD"
      attendanceSheet.getRange(row, lastDayCol + 4).setFormula(
        `=COUNTIF(J${row}:${getColumnLetter(9 + totalDays)}${row},"${ATTENDANCE_CODES.HALF_DAY}")`
      );
      
      // Full Day Leave: COUNTIF with "FD"
      attendanceSheet.getRange(row, lastDayCol + 5).setFormula(
        `=COUNTIF(J${row}:${getColumnLetter(9 + totalDays)}${row},"${ATTENDANCE_CODES.FULL_DAY_LEAVE}")`
      );
      
      // Holiday Days: COUNTIF with "H"
      attendanceSheet.getRange(row, lastDayCol + 6).setFormula(
        `=COUNTIF(J${row}:${getColumnLetter(9 + totalDays)}${row},"${ATTENDANCE_CODES.HOLIDAY}")`
      );
      
      // Attendance %: (Present Days + Late Days) / Working Days
      attendanceSheet.getRange(row, lastDayCol + 7).setFormula(
        `=IF(F${row}>0,ROUND((${getColumnLetter(lastDayCol + 1)}${row})/F${row}*100,1)&"%","0%")`
      );
    });
    
    // Formatting
    attendanceSheet.setColumnWidths(1, headers.length, 80);
    attendanceSheet.setColumnWidth(2, 150);
    attendanceSheet.setColumnWidth(3, 120);
    attendanceSheet.setFrozenRows(1);
    attendanceSheet.setFrozenColumns(2);
    
    // Data validation for daily attendance (including "-" as an option)
    const lastDataRow = eligibleStaff.length + 1;
    const dailyRange = attendanceSheet.getRange(2, 10, lastDataRow, totalDays);
    const validationValues = [...Object.values(ATTENDANCE_CODES), '-'];
    const validationRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(validationValues, true)
      .build();
    dailyRange.setDataValidation(validationRule);
    
    return { 
      success: true, 
      message: `Monthly attendance sheet "${sheetName}" created successfully with ${eligibleStaff.length} staff members!`,
      totalDays: totalDays,
      sundays: sundays,
      holidays: totalHolidays,
      workingDays: totalDays - sundays - totalHolidays,
      staffAdded: eligibleStaff.length,
      totalStaff: staffList.length
    };
  } catch (error) {
    console.error('Error creating monthly attendance sheet:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

// Helper function to auto-create attendance sheet for current month
function createCurrentMonthAttendanceSheet() {
  const now = new Date();
  const month = getMonthName(now.getMonth() + 1);
  const year = now.getFullYear();
  return createMonthlyAttendanceSheet(month, year);
}

// Helper function to auto-create attendance sheet for next month
function createNextMonthAttendanceSheet() {
  const now = new Date();
  let month = now.getMonth() + 2; // Next month
  let year = now.getFullYear();
  
  if (month > 12) {
    month = 1;
    year++;
  }
  
  return createMonthlyAttendanceSheet(getMonthName(month), year);
}

function getAttendanceSummaryForMonth(month, year) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = `Attendance_${month}_${year}`;
    const monthlySheet = ss.getSheetByName(sheetName);
    
    if (!monthlySheet || monthlySheet.getLastRow() <= 1) {
      return { success: false, message: 'Monthly attendance sheet not found!', data: {} };
    }
    
    const data = monthlySheet.getDataRange().getValues();
    const headerRow = data[0];
    
    const colIndex = {
      present: headerRow.indexOf('Present Days'),
      absent: headerRow.indexOf('Absent Days'),
      late: headerRow.indexOf('Late Coming Days'),
      halfDay: headerRow.indexOf('Half Day Leave'),
      fullDay: headerRow.indexOf('Full Day Leave'),
      holiday: headerRow.indexOf('Holiday Days'),
      percentage: headerRow.indexOf('Attendance %')
    };
    
    const summaryData = {};
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const staffId = row[0];
      
      if (staffId) {
        summaryData[staffId] = {
          name: row[1],
          department: row[2],
          designation: row[3],
          staffType: row[4],
          presentDays: row[colIndex.present] || 0,
          absentDays: row[colIndex.absent] || 0,
          lateDays: row[colIndex.late] || 0,
          halfDayLeave: row[colIndex.halfDay] || 0,
          fullDayLeave: row[colIndex.fullDay] || 0,
          holidayDays: row[colIndex.holiday] || 0,
          attendancePercentage: row[colIndex.percentage] || '0%'
        };
      }
    }
    
    return { success: true, data: summaryData };
  } catch (error) {
    console.error('Error getting attendance summary:', error);
    return { success: false, message: 'Error: ' + error.message, data: {} };
  }
}

function getMonthlyAttendanceData(month, year) {
  return getAttendanceSummaryForMonth(month, year);
}

function getMonthlyAttendanceSheets() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheets = ss.getSheets();
    return sheets
      .filter(sheet => sheet.getName().startsWith('Attendance_'))
      .map(sheet => sheet.getName());
  } catch (error) {
    console.error('Error getting monthly attendance sheets:', error);
    return [];
  }
}

// ========== ATTENDANCE TIMING CONFIGURATION ==========

function getAttendanceTimingConfig() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const configSheet = ss.getSheetByName(SHEET_NAMES.ATTENDANCE_TIMING);
    
    if (!configSheet || configSheet.getLastRow() <= 1) {
      return {
        success: true,
        config: {
          startHour: 9,
          startMinute: 0,
          endHour: 10,
          endMinute: 30,
          isEnabled: true,
          lastModified: new Date().toISOString(),
          modifiedBy: 'System'
        }
      };
    }
    
    const data = configSheet.getRange(2, 1, 1, 7).getValues()[0];
    
    return {
      success: true,
      config: {
        startHour: data[0] || 9,
        startMinute: data[1] || 0,
        endHour: data[2] || 10,
        endMinute: data[3] || 30,
        isEnabled: data[4] !== false,
        lastModified: data[5] ? formatDateTime(data[5]) : new Date().toISOString(),
        modifiedBy: data[6] || 'System'
      }
    };
  } catch (error) {
    console.error('Error getting timing config:', error);
    return {
      success: false,
      message: 'Error retrieving timing configuration',
      config: {
        startHour: 9,
        startMinute: 0,
        endHour: 10,
        endMinute: 30,
        isEnabled: true,
        lastModified: new Date().toISOString(),
        modifiedBy: 'System'
      }
    };
  }
}

function updateAttendanceTimingConfig(configData, modifiedBy) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let configSheet = ss.getSheetByName(SHEET_NAMES.ATTENDANCE_TIMING);
    
    if (!configSheet) {
      configSheet = ss.insertSheet(SHEET_NAMES.ATTENDANCE_TIMING);
      const headers = ['Start Hour', 'Start Minute', 'End Hour', 'End Minute', 'Is Enabled', 'Last Modified', 'Modified By'];
      configSheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
    }
    
    // Validate times
    const startTotalMinutes = configData.startHour * 60 + configData.startMinute;
    const endTotalMinutes = configData.endHour * 60 + configData.endMinute;
    
    if (startTotalMinutes >= endTotalMinutes) {
      return { success: false, message: 'End time must be after start time' };
    }
    
    if (configData.startHour < 0 || configData.startHour > 23 || 
        configData.endHour < 0 || configData.endHour > 23 ||
        configData.startMinute < 0 || configData.startMinute > 59 || 
        configData.endMinute < 0 || configData.endMinute > 59) {
      return { 
        success: false, 
        message: 'Invalid time values. Hours must be 0-23, minutes must be 0-59' 
      };
    }
    
    // Clear and update
    configSheet.clearContents();
    configSheet.getRange(1, 1, 1, 7)
      .setValues([['Start Hour', 'Start Minute', 'End Hour', 'End Minute', 'Is Enabled', 'Last Modified', 'Modified By']])
      .setFontWeight('bold');
    
    const lastModified = new Date();
    configSheet.getRange(2, 1, 1, 7).setValues([[
      configData.startHour,
      configData.startMinute,
      configData.endHour,
      configData.endMinute,
      configData.isEnabled,
      lastModified,
      modifiedBy
    ]]);
    
    logTimingConfigChange(configData, modifiedBy);
    
    return { 
      success: true, 
      message: 'Attendance timing configuration updated successfully!',
      config: {
        ...configData,
        lastModified: formatDateTime(lastModified),
        modifiedBy: modifiedBy
      }
    };
  } catch (error) {
    console.error('Error updating timing config:', error);
    return { success: false, message: 'Error updating timing configuration: ' + error.message };
  }
}

function logTimingConfigChange(configData, modifiedBy) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let logSheet = ss.getSheetByName(SHEET_NAMES.TIMING_LOGS);
    
    if (!logSheet) {
      logSheet = ss.insertSheet(SHEET_NAMES.TIMING_LOGS);
      const headers = ['Timestamp', 'Modified By', 'Start Time', 'End Time', 'Is Enabled', 'Changes'];
      logSheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
    }
    
    const startTime = `${configData.startHour.toString().padStart(2, '0')}:${configData.startMinute.toString().padStart(2, '0')}`;
    const endTime = `${configData.endHour.toString().padStart(2, '0')}:${configData.endMinute.toString().padStart(2, '0')}`;
    
    logSheet.appendRow([
      new Date(),
      modifiedBy,
      startTime,
      endTime,
      configData.isEnabled ? 'Yes' : 'No',
      `Configuration updated by ${modifiedBy}`
    ]);
  } catch (error) {
    console.error('Error logging timing config change:', error);
  }
}

function getTimingConfigLogs(limit = 50) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const logSheet = ss.getSheetByName(SHEET_NAMES.TIMING_LOGS);
    
    if (!logSheet || logSheet.getLastRow() <= 1) return [];
    
    const data = logSheet.getRange(2, 1, Math.min(logSheet.getLastRow() - 1, limit), 6).getValues();
    
    return data
      .map(row => ({
        timestamp: row[0] ? formatDateTime(row[0]) : '',
        modifiedBy: row[1] || '',
        startTime: row[2] || '',
        endTime: row[3] || '',
        isEnabled: row[4] || '',
        changes: row[5] || ''
      }))
      .reverse();
  } catch (error) {
    console.error('Error getting timing logs:', error);
    return [];
  }
}

function canSubmitAttendanceNow(userRole) {
  try {
    const currentTime = new Date();
    const currentHours = currentTime.getHours();
    const currentMinutes = currentTime.getMinutes();
    const currentTimeString = formatDateTime(currentTime).split(' ')[1];
    
    const configResponse = getAttendanceTimingConfig();
    const config = configResponse.config;
    
    // Admin always allowed if config is disabled
    if (!config.isEnabled && userRole === USER_ROLES.ADMIN) {
      return {
        allowed: true,
        message: 'Timing restrictions are disabled. Attendance can be submitted anytime.',
        currentTime: currentTimeString,
        config: config
      };
    }
    
    // Only admin can submit attendance
    if (userRole !== USER_ROLES.ADMIN) {
      return {
        allowed: false,
        message: 'Only admin users can submit attendance.',
        currentTime: currentTimeString,
        config: config
      };
    }
    
    // Check if within allowed window
    const currentTotalMinutes = currentHours * 60 + currentMinutes;
    const startTotalMinutes = config.startHour * 60 + config.startMinute;
    const endTotalMinutes = config.endHour * 60 + config.endMinute;
    
    const isWithinWindow = currentTotalMinutes >= startTotalMinutes && 
                          currentTotalMinutes <= endTotalMinutes;
    
    if (!isWithinWindow) {
      const startTimeStr = `${config.startHour.toString().padStart(2, '0')}:${config.startMinute.toString().padStart(2, '0')}`;
      const endTimeStr = `${config.endHour.toString().padStart(2, '0')}:${config.endMinute.toString().padStart(2, '0')}`;
      
      return {
        allowed: false,
        message: `Attendance submission allowed only between ${startTimeStr} and ${endTimeStr}. Current time: ${currentTimeString}`,
        currentTime: currentTimeString,
        allowedWindow: `${startTimeStr} - ${endTimeStr}`,
        config: config
      };
    }
    
    // Calculate time remaining
    const remainingMinutes = endTotalMinutes - currentTotalMinutes;
    const hours = Math.floor(remainingMinutes / 60);
    const minutes = remainingMinutes % 60;
    const timeRemaining = hours > 0 
      ? `${hours} hour${hours > 1 ? 's' : ''} and ${minutes} minute${minutes > 1 ? 's' : ''}`
      : `${minutes} minute${minutes > 1 ? 's' : ''}`;
    
    return {
      allowed: true,
      message: 'Attendance submission is allowed.',
      currentTime: currentTimeString,
      timeRemaining: timeRemaining,
      config: config
    };
  } catch (error) {
    console.error('Error checking submission availability:', error);
    return {
      allowed: false,
      message: 'Error checking submission availability.',
      currentTime: 'Unknown',
      config: { startHour: 9, startMinute: 0, endHour: 10, endMinute: 30, isEnabled: true }
    };
  }
}

function getTodayAttendanceStatus() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const dailyAttendanceSheet = ss.getSheetByName(SHEET_NAMES.DAILY_ATTENDANCE);
    
    if (!dailyAttendanceSheet || dailyAttendanceSheet.getLastRow() <= 1) {
      return { submitted: false, message: 'No attendance submitted today.' };
    }
    
    const today = formatDate(new Date());
    const data = dailyAttendanceSheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[0]) {
        const rowDate = formatDate(row[0]);
        if (rowDate === today) {
          return {
            submitted: true,
            message: `Attendance already submitted today by ${row[7] || 'Unknown'} at ${row[9] || 'Unknown time'}`,
            submittedBy: row[7],
            submissionTime: row[9]
          };
        }
      }
    }
    
    return { submitted: false, message: 'No attendance submitted for today.' };
  } catch (error) {
    console.error('Error checking today attendance:', error);
    return { submitted: false, message: 'Error checking attendance status.' };
  }
}

// ========== QR ATTENDANCE FUNCTIONS ==========

function getQRTrackingSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(SHEET_NAMES.QR_TRACKING);
  
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAMES.QR_TRACKING);
    const headers = ['Date', 'Staff ID', 'Name', 'Department', 'Login Time', 'Logout Time', 'Total Minutes', 'Status', 'Attendance Code', 'Remarks'];
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
    sheet.setFrozenRows(1);
  }
  
  return sheet;
}

function getQRLogSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(SHEET_NAMES.QR_LOG);
  
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAMES.QR_LOG);
    const headers = ['Date', 'Staff ID', 'Name', 'Department', 'Action', 'Time', 'Status', 'Scanned By', 'Total Hours', 'Attendance Status'];
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
    sheet.setFrozenRows(1);
  }
  
  return sheet;
}

function markLogin(staffId, scannedBy) {
  try {
    const staffResponse = getStaffById(staffId);
    if (!staffResponse.success) {
      return { success: false, message: 'Invalid staff ID' };
    }
    
    const staff = staffResponse.staff;
    const now = new Date();
    const currentHours = now.getHours();
    const currentMinutes = now.getMinutes();
    const currentTotalMinutes = currentHours * 60 + currentMinutes;
    
    // Get timing config for reference
    const configResponse = getAttendanceTimingConfig();
    const config = configResponse.config;
    
    // Define time thresholds in minutes
    const BEFORE_WARNING = 9 * 60 + 30; // 09:30 AM
    const WARNING_START = 9 * 60 + 30;   // 09:30 AM
    const WARNING_END = 9 * 60 + 45;     // 09:45 AM
    const LATE_START = 9 * 60 + 45;      // 09:45 AM
    const LATE_END = 11 * 60 + 30;       // 11:30 AM
    
    // Check for existing login without logout
    const qrTrackingSheet = getQRTrackingSheet();
    const data = qrTrackingSheet.getDataRange().getValues();
    const todayStr = formatDate(now);
    
    for (let i = data.length - 1; i >= 1; i--) {
      const row = data[i];
      const rowDate = row[0] instanceof Date ? formatDate(row[0]) : String(row[0]);
      
      if (row[1] === staffId && rowDate === todayStr && (!row[5] || row[5] === '')) {
        return { 
          success: false, 
          message: 'Staff already logged in today without logout. Please logout first.' 
        };
      }
    }
    
    // Determine login status based on time
    let status = '';
    let attendanceCode = '';
    let statusMessage = '';
    let warningMessage = '';
    
    if (currentTotalMinutes < BEFORE_WARNING) {
      // Before 09:30 AM - Present
      status = 'Present';
      attendanceCode = ATTENDANCE_CODES.PRESENT;
      statusMessage = 'Present (Before 9:30 AM)';
      warningMessage = 'Login successful - On Time';
    } 
    else if (currentTotalMinutes >= WARNING_START && currentTotalMinutes < WARNING_END) {
      // 09:30 AM to 09:45 AM - Warning (but counted as Present)
      status = 'Present (Warning)';
      attendanceCode = ATTENDANCE_CODES.PRESENT;
      statusMessage = 'Present with Warning (9:30-9:45 AM)';
      warningMessage = ' Warning: You are late. Please be on time tomorrow. This login is still marked as Present.';
    }
    else if (currentTotalMinutes >= LATE_START && currentTotalMinutes < LATE_END) {
      // 09:45 AM to 11:30 AM - Late
      status = 'Late';
      attendanceCode = ATTENDANCE_CODES.LATE;
      statusMessage = 'Late Coming (9:45-11:30 AM)';
      warningMessage = ' Late Login: Marked as Late Coming (L)';
    }
    else if (currentTotalMinutes >= LATE_END) {
      // After 11:30 AM - Half Day
      status = 'Half Day';
      attendanceCode = ATTENDANCE_CODES.HALF_DAY;
      statusMessage = 'Half Day (After 11:30 AM)';
      warningMessage = ' Very Late: Marked as Half Day (HD)';
    }
    
    const loginTime = Utilities.formatDate(now, getScriptTimezone(), 'HH:mm:ss');
    const loginDate = formatDate(now);
    
    // Add login record to tracking sheet
    const lastTrackingRow = qrTrackingSheet.getLastRow() + 1;
    qrTrackingSheet.getRange(lastTrackingRow, 1, 1, 10).setValues([[
      loginDate,
      staffId,
      staff.name,
      staff.department,
      loginTime,
      '', // Logout Time
      '', // Total Minutes
      status,
      attendanceCode,
      `Login recorded at ${loginTime} - ${statusMessage}`
    ]]);
    
    // Log to QR_Attendance_Log
    const qrLogSheet = getQRLogSheet();
    const lastLogRow = qrLogSheet.getLastRow() + 1;
    qrLogSheet.getRange(lastLogRow, 1, 1, 10).setValues([[
      loginDate,
      staffId,
      staff.name,
      staff.department,
      'Login',
      loginTime,
      status,
      scannedBy || staffId,
      '', // Total Hours
      attendanceCode
    ]]);
    
    // Add color coding based on status (optional - for visual tracking)
    try {
      if (attendanceCode === ATTENDANCE_CODES.LATE) {
        qrTrackingSheet.getRange(lastTrackingRow, 8, 1, 2).setBackground('#ffeb9c'); // Light yellow for late
      } else if (attendanceCode === ATTENDANCE_CODES.HALF_DAY) {
        qrTrackingSheet.getRange(lastTrackingRow, 8, 1, 2).setBackground('#ffc7ce'); // Light red for half day
      }
    } catch (e) {
      // Ignore formatting errors
    }
    
    return { 
      success: true,
      staffId: staffId,
      staffName: staff.name,
      department: staff.department,
      loginTime: loginTime,
      status: status,
      attendanceCode: attendanceCode,
      statusMessage: statusMessage,
      warningMessage: warningMessage,
      message: warningMessage || `Login recorded successfully as ${status}`
    };
  } catch (error) {
    console.error('Login error:', error);
    return { success: false, message: 'Error recording login: ' + error.message };
  }
}

function markLogout(staffId, scannedBy) {
  try {
    const staffResponse = getStaffById(staffId);
    if (!staffResponse.success) {
      return { success: false, message: 'Invalid staff ID' };
    }
    
    const staff = staffResponse.staff;
    const now = new Date();
    const logoutTime = Utilities.formatDate(now, getScriptTimezone(), 'HH:mm:ss');
    const logoutDate = formatDate(now);
    const dayOfWeek = now.getDay(); // 0 = Sunday, 6 = Saturday
    
    const qrTrackingSheet = getQRTrackingSheet();
    const data = qrTrackingSheet.getDataRange().getValues();
    
    // Find the most recent login without logout for today
    let loginRow = -1;
    let loginTimeStr = '';
    let loginDataRow = null;
    let loginDepartment = '';
    
    for (let i = data.length - 1; i >= 1; i--) {
      const row = data[i];
      const rowDate = row[0] instanceof Date ? formatDate(row[0]) : String(row[0]);
      const rowLoginTime = row[4] instanceof Date 
        ? Utilities.formatDate(row[4], getScriptTimezone(), 'HH:mm:ss') 
        : String(row[4] || '');
      
      if (row[1] === staffId && rowDate === logoutDate && (!row[5] || row[5] === '')) {
        loginRow = i;
        loginTimeStr = rowLoginTime;
        loginDataRow = row;
        loginDepartment = String(row[3] || '');
        break;
      }
    }
    
    if (loginRow === -1) {
      // Check if already logged out
      for (let i = data.length - 1; i >= 1; i--) {
        const row = data[i];
        const rowDate = row[0] instanceof Date ? formatDate(row[0]) : String(row[0]);
        
        if (row[1] === staffId && rowDate === logoutDate && row[5] && row[5] !== '') {
          return { 
            success: false, 
            message: 'Staff already logged out today at ' + row[5] 
          };
        }
      }
      
      return { 
        success: false, 
        message: 'No active login found for today. Please login first.' 
      };
    }
    
    if (!loginTimeStr) {
      return { 
        success: false, 
        message: 'Login time not found in record' 
      };
    }
    
    // Calculate total minutes worked
    const loginParts = loginTimeStr.split(':');
    const logoutParts = logoutTime.split(':');
    
    if (loginParts.length !== 3 || logoutParts.length !== 3) {
      return { 
        success: false, 
        message: 'Invalid time format' 
      };
    }
    
    const loginMinutes = parseInt(loginParts[0]) * 60 + parseInt(loginParts[1]);
    const logoutMinutes = parseInt(logoutParts[0]) * 60 + parseInt(logoutParts[1]);
    let totalMinutes = logoutMinutes - loginMinutes;
    
    // Handle negative time (if logout is next day)
    if (totalMinutes < 0) {
      totalMinutes = totalMinutes + (24 * 60);
    }
    
    // Validate logout time based on department and day
    const logoutCheck = validateLogoutTime(staff.department, logoutParts, dayOfWeek);
    
    // Determine attendance status
    let attendanceStatus = '';
    let attendanceCode = '';
    let statusMessage = '';
    
    // Check if this is a Sunday or Holiday first
    const isSunday = dayOfWeek === 0;
    const holidayInfo = getHolidayForDate(now);
    const isHoliday = !!holidayInfo;
    
    if (isSunday || isHoliday) {
      attendanceStatus = isSunday ? 'Sunday' : 'Holiday';
      attendanceCode = ATTENDANCE_CODES.HOLIDAY;
      statusMessage = isSunday ? 'Sunday - No Work' : `Holiday: ${holidayInfo?.holidayName || 'Holiday'}`;
    }
    else if (!logoutCheck.isValid) {
      // Invalid logout time - mark as Half Day
      attendanceStatus = 'Half Day';
      attendanceCode = ATTENDANCE_CODES.HALF_DAY;
      statusMessage = logoutCheck.message;
    } 
    else {
      // Valid logout - check hours worked
      if (totalMinutes >= 6 * 60) { // 6+ hours
        attendanceStatus = 'Present';
        attendanceCode = ATTENDANCE_CODES.PRESENT;
        statusMessage = 'Full Day Present';
      } else if (totalMinutes >= 3 * 60) { // 3-6 hours
        attendanceStatus = 'Half Day';
        attendanceCode = ATTENDANCE_CODES.HALF_DAY;
        statusMessage = 'Half Day (3-6 hours)';
      } else { // Less than 3 hours
        attendanceStatus = 'Absent';
        attendanceCode = ATTENDANCE_CODES.ABSENT;
        statusMessage = 'Absent (Less than 3 hours)';
      }
    }
    
    // Check if it was late login (override if needed)
    const loginHour = parseInt(loginParts[0]);
    const loginMinute = parseInt(loginParts[1]);
    const configResponse = getAttendanceTimingConfig();
    const config = configResponse.config;
    const startTimeMinutes = config.startHour * 60 + config.startMinute;
    const lateThresholdMinutes = startTimeMinutes + 15;
    
    if (attendanceStatus === 'Present' && (loginHour * 60 + loginMinute) > lateThresholdMinutes && !isSunday && !isHoliday) {
      attendanceStatus = 'Late';
      attendanceCode = ATTENDANCE_CODES.LATE;
      statusMessage = 'Late Present';
    }
    
    // Update tracking sheet
    const rowNumber = loginRow + 1;
    qrTrackingSheet.getRange(rowNumber, 6).setValue(logoutTime);
    qrTrackingSheet.getRange(rowNumber, 7).setValue(totalMinutes);
    qrTrackingSheet.getRange(rowNumber, 8).setValue(attendanceStatus);
    qrTrackingSheet.getRange(rowNumber, 9).setValue(attendanceCode);
    qrTrackingSheet.getRange(rowNumber, 10).setValue(
      `${logoutCheck.message || `Logout recorded at ${logoutTime}`}`
    );
    
    // Log to QR_Attendance_Log
    const qrLogSheet = getQRLogSheet();
    const lastLogRow = qrLogSheet.getLastRow() + 1;
    const totalHoursFormatted = `${Math.floor(totalMinutes / 60)}h ${totalMinutes % 60}m`;
    
    qrLogSheet.getRange(lastLogRow, 1, 1, 10).setValues([[
      logoutDate,
      staffId,
      staff.name,
      staff.department,
      'Logout',
      logoutTime,
      statusMessage,
      scannedBy || staffId,
      totalHoursFormatted,
      attendanceStatus
    ]]);
    
    // Update monthly attendance sheet
    updateAttendanceFromQR(
      staffId, logoutDate, attendanceCode, loginTimeStr, 
      logoutTime, totalMinutes, staff.department, dayOfWeek
    );
    
    return { 
      success: true,
      staffId: staffId,
      staffName: staff.name,
      department: staff.department,
      loginTime: loginTimeStr,
      logoutTime: logoutTime,
      totalHours: totalHoursFormatted,
      totalMinutes: totalMinutes,
      status: statusMessage,
      attendanceStatus: attendanceStatus,
      attendanceCode: attendanceCode,
      logoutValidation: {
        isValid: logoutCheck.isValid,
        message: logoutCheck.message,
        expectedLogoutTime: logoutCheck.expectedLogoutTime
      },
      message: `Logout recorded successfully. ${statusMessage} (${totalHoursFormatted})`
    };
  } catch (error) {
    console.error('Logout error:', error);
    return { success: false, message: 'Error recording logout: ' + error.message };
  }
}

function validateLogoutTime(department, logoutParts, dayOfWeek) {
  try {
    const logoutHour = parseInt(logoutParts[0]);
    const logoutMinute = parseInt(logoutParts[1]);
    const logoutTotalMinutes = logoutHour * 60 + logoutMinute;
    
    // 1:30 PM in minutes = 13 * 60 + 30 = 810 minutes
    const targetTimeMinutes = 13 * 60 + 30;
    const departmentLower = (department || '').toLowerCase();
    
    // Saturday (day 6) - all departments must logout at 1:30 PM only
    if (dayOfWeek === 6) {
      // Allow 15 minutes grace period
      if (Math.abs(logoutTotalMinutes - targetTimeMinutes) <= 15) {
        return {
          isValid: true,
          message: `Saturday logout at ${logoutHour}:${logoutMinute.toString().padStart(2, '0')} - Valid`,
          expectedLogoutTime: "13:30"
        };
      } else {
        return {
          isValid: false,
          message: `Saturday logout must be at 1:30 PM only. Current: ${logoutHour}:${logoutMinute.toString().padStart(2, '0')}`,
          expectedLogoutTime: "13:30"
        };
      }
    }
    
    // Pre-Primary department - must logout after 1:30 PM
    if (departmentLower.includes('pre-primary')) {
      // For Pre-Primary, they must logout after 1:30 PM to get Full Day Present
      if (logoutTotalMinutes >= targetTimeMinutes) {
        const maxTimeMinutes = 19 * 60; // 7:00 PM
        if (logoutTotalMinutes <= maxTimeMinutes) {
          return {
            isValid: true,
            message: `Pre-Primary logout at ${logoutHour}:${logoutMinute.toString().padStart(2, '0')} - Valid (After 1:30 PM)`,
            expectedLogoutTime: "after 13:30"
          };
        } else {
          return {
            isValid: true,
            message: `Pre-Primary late logout at ${logoutHour}:${logoutMinute.toString().padStart(2, '0')}`,
            expectedLogoutTime: "after 13:30"
          };
        }
      } else {
        // Logout before 1:30 PM - consider as Half Day
        return {
          isValid: false,
          message: `Pre-Primary staff must logout after 1:30 PM. Current: ${logoutHour}:${logoutMinute.toString().padStart(2, '0')} - Marking as Half Day`,
          expectedLogoutTime: "after 13:30"
        };
      }
    }
    
    // Other departments
    if (logoutTotalMinutes < 12 * 60) { // Before 12:00 PM
      return {
        isValid: true,
        message: `Early logout at ${logoutHour}:${logoutMinute.toString().padStart(2, '0')} - Please verify`,
        expectedLogoutTime: "normal working hours"
      };
    }
    
    return {
      isValid: true,
      message: `Logout at ${logoutHour}:${logoutMinute.toString().padStart(2, '0')} - Valid`,
      expectedLogoutTime: "any time"
    };
  } catch (error) {
    console.error('Error validating logout time:', error);
    return {
      isValid: true,
      message: "Logout validation skipped due to error",
      expectedLogoutTime: "unknown"
    };
  }
}

/**
 * Function to process end-of-day attendance and mark missing logouts as half day
 * This should be run as a time-driven trigger at the end of each day (e.g., 11:59 PM)
 */
function processEndOfDayAttendance() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const qrTrackingSheet = getQRTrackingSheet();
    const qrLogSheet = getQRLogSheet();
    const today = formatDate(new Date());
    const dayOfWeek = new Date().getDay();
    
    // Get all data from tracking sheet
    const data = qrTrackingSheet.getDataRange().getValues();
    let processedCount = 0;
    let halfDayCount = 0;
    
    for (let i = data.length - 1; i >= 1; i--) {
      const row = data[i];
      const rowDate = row[0] instanceof Date ? formatDate(row[0]) : String(row[0]);
      
      // Check for today's records with login but no logout
      if (rowDate === today && row[1] && (!row[5] || row[5] === '')) {
        const staffId = row[1];
        const staffName = row[2];
        const department = row[3];
        const loginTime = row[4];
        
        // Calculate total minutes (from login to midnight)
        const loginParts = loginTime.split(':');
        const loginMinutes = parseInt(loginParts[0]) * 60 + parseInt(loginParts[1]);
        const midnightMinutes = 24 * 60;
        let totalMinutes = midnightMinutes - loginMinutes;
        
        // Check if this is a Sunday or Holiday
        const isSunday = dayOfWeek === 0;
        const holidayInfo = getHolidayForDate(new Date());
        const isHoliday = !!holidayInfo;
        
        let attendanceStatus = '';
        let attendanceCode = '';
        let statusMessage = '';
        
        if (isSunday || isHoliday) {
          attendanceStatus = isSunday ? 'Sunday' : 'Holiday';
          attendanceCode = ATTENDANCE_CODES.HOLIDAY;
          statusMessage = isSunday ? 'Sunday - No Work' : `Holiday: ${holidayInfo?.holidayName || 'Holiday'}`;
        } else {
          // Auto-mark as half day if less than 6 hours
          if (totalMinutes >= 6 * 60) {
            attendanceStatus = 'Present';
            attendanceCode = ATTENDANCE_CODES.PRESENT;
            statusMessage = 'Full Day Present (Auto-processed)';
          } else if (totalMinutes >= 3 * 60) {
            attendanceStatus = 'Half Day';
            attendanceCode = ATTENDANCE_CODES.HALF_DAY;
            statusMessage = 'Half Day (Auto-processed - Missing Logout)';
            halfDayCount++;
          } else {
            attendanceStatus = 'Absent';
            attendanceCode = ATTENDANCE_CODES.ABSENT;
            statusMessage = 'Absent (Auto-processed - Less than 3 hours)';
          }
        }
        
        // Update the row in tracking sheet
        const rowNumber = i + 1;
        qrTrackingSheet.getRange(rowNumber, 6).setValue('Auto-Processed');
        qrTrackingSheet.getRange(rowNumber, 7).setValue(totalMinutes);
        qrTrackingSheet.getRange(rowNumber, 8).setValue(attendanceStatus);
        qrTrackingSheet.getRange(rowNumber, 9).setValue(attendanceCode);
        qrTrackingSheet.getRange(rowNumber, 10).setValue('Auto-processed - Missing logout');
        
        // Log to QR_Attendance_Log
        const lastLogRow = qrLogSheet.getLastRow() + 1;
        const totalHoursFormatted = `${Math.floor(totalMinutes / 60)}h ${totalMinutes % 60}m`;
        
        qrLogSheet.getRange(lastLogRow, 1, 1, 10).setValues([[
          today,
          staffId,
          staffName,
          department,
          'Auto-Logout',
          '23:59:59',
          statusMessage,
          'System',
          totalHoursFormatted,
          attendanceStatus
        ]]);
        
        // Update monthly attendance sheet
        updateAttendanceFromQR(
          staffId, today, attendanceCode, loginTime, 
          '23:59:59', totalMinutes, department, dayOfWeek
        );
        
        processedCount++;
      }
    }
    
    return {
      success: true,
      message: `Processed ${processedCount} staff members. Marked ${halfDayCount} as half day due to missing logout.`,
      processedCount: processedCount,
      halfDayCount: halfDayCount
    };
  } catch (error) {
    console.error('Error processing end-of-day attendance:', error);
    return {
      success: false,
      message: 'Error processing end-of-day attendance: ' + error.message
    };
  }
}

/**
 * Setup function to create time-driven triggers for automatic end-of-day processing
 * Run this once to set up daily triggers
 */
function setupEndOfDayTrigger() {
  try {
    // Delete existing triggers for this function
    const triggers = ScriptApp.getProjectTriggers();
    triggers.forEach(trigger => {
      if (trigger.getHandlerFunction() === 'processEndOfDayAttendance') {
        ScriptApp.deleteTrigger(trigger);
      }
    });
    
    // Create new trigger to run at 11:45 PM every day
    ScriptApp.newTrigger('processEndOfDayAttendance')
      .timeBased()
      .atHour(23)
      .nearMinute(45)
      .everyDays(1)
      .create();
    
    return {
      success: true,
      message: 'End-of-day attendance processing trigger set up successfully. Will run daily at 11:45 PM.'
    };
  } catch (error) {
    console.error('Error setting up trigger:', error);
    return {
      success: false,
      message: 'Error setting up trigger: ' + error.message
    };
  }
}

function updateAttendanceFromQR(staffId, dateStr, statusCode, loginTime, logoutTime, totalMinutes, department, dayOfWeek) {
  try {
    const date = new Date(dateStr);
    const month = getMonthName(date.getMonth() + 1);
    const year = date.getFullYear();
    const day = date.getDate();
    
    // Skip Sunday and holidays
    if (dayOfWeek === 0) {
      return { success: false, message: 'Sunday - attendance not updated' };
    }
    
    const holidayInfo = getHolidayForDate(dateStr);
    if (holidayInfo) {
      return { success: false, message: 'Holiday - attendance not updated' };
    }
    
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = `Attendance_${month}_${year}`;
    const monthlySheet = ss.getSheetByName(sheetName);
    
    if (!monthlySheet) {
      return { success: false, message: 'Monthly attendance sheet not found' };
    }
    
    const data = monthlySheet.getDataRange().getValues();
    const targetColumn = 9 + day;
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[0] === staffId) {
        monthlySheet.getRange(i + 1, targetColumn).setValue(statusCode);
        
        const note = `QR Attendance:
- Department: ${department}
- Day: ${dayOfWeek === 6 ? 'Saturday' : 'Weekday'}
- Login: ${loginTime}
- Logout: ${logoutTime}
- Total: ${Math.floor(totalMinutes / 60)}h ${totalMinutes % 60}m
- Status: ${statusCode}`;
        
        monthlySheet.getRange(i + 1, targetColumn).setNote(note);
        return { success: true, message: 'Monthly attendance updated' };
      }
    }
    
    return { success: false, message: 'Staff not found in monthly sheet' };
  } catch (error) {
    console.error('Error updating attendance from QR:', error);
    return { success: false, message: 'Error updating attendance: ' + error.message };
  }
}

function getLogoutRules() {
  return {
    rules: [
      {
        department: "Pre-Primary",
        rule: "Must logout after 1:30 PM on regular days to get Full Day Present",
        expectedLogout: "After 13:30",
        saturdayRule: "Saturday: Must logout at 1:30 PM only"
      },
      {
        department: "All Departments",
        rule: "Saturday: Must logout at 1:30 PM only",
        expectedLogout: "13:30",
        saturdayRule: "Strictly at 1:30 PM"
      },
      {
        department: "Other Departments",
        rule: "Regular working hours apply",
        expectedLogout: "Any time",
        saturdayRule: "Saturday: Must logout at 1:30 PM only"
      }
    ],
    note: "Missing logout at end of day will be automatically marked as Half Day."
  };
}

function getTodayLogoutRequirements(staffId) {
  try {
    const staffResponse = getStaffById(staffId);
    if (!staffResponse.success) {
      return { success: false, message: 'Staff not found' };
    }
    
    const staff = staffResponse.staff;
    const now = new Date();
    const dayOfWeek = now.getDay();
    const isSaturday = dayOfWeek === 6;
    const isPrePrimary = staff.department && staff.department.toLowerCase().includes('pre-primary');
    
    let requiredLogout = '';
    let message = '';
    
    if (isSaturday) {
      requiredLogout = '13:30';
      message = 'Today is Saturday. All staff must logout at 1:30 PM.';
    } else if (isPrePrimary) {
      requiredLogout = 'After 13:30';
      message = 'Pre-Primary staff must logout after 1:30 PM to get Full Day Present.';
    } else {
      requiredLogout = 'Normal working hours';
      message = 'Standard logout time applies. Missing logout will be marked as Half Day.';
    }
    
    return {
      success: true,
      staffId: staffId,
      department: staff.department,
      isSaturday: isSaturday,
      isPrePrimary: isPrePrimary,
      requiredLogout: requiredLogout,
      message: message,
      currentTime: Utilities.formatDate(now, getScriptTimezone(), 'HH:mm:ss'),
      note: "Missing logout at end of day will be automatically processed as Half Day"
    };
  } catch (error) {
    console.error('Error getting logout requirements:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function getQRAttendanceSummary(staffId, month, year) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const qrLogSheet = ss.getSheetByName(SHEET_NAMES.QR_LOG);
    
    if (!qrLogSheet || qrLogSheet.getLastRow() <= 1) {
      return { success: false, message: 'No QR attendance data found' };
    }
    
    const data = qrLogSheet.getDataRange().getValues();
    const targetMonth = getMonthNumber(month);
    const targetYear = parseInt(year);
    
    const attendanceDays = {};
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const rowDate = new Date(row[0]);
      
      if (row[1] === staffId && 
          rowDate.getMonth() + 1 === targetMonth && 
          rowDate.getFullYear() === targetYear) {
        
        const dateStr = formatDate(rowDate);
        
        if (row[4] === 'Logout' || row[4] === 'Auto-Logout') {
          attendanceDays[dateStr] = {
            loginTime: row[5] || 'N/A',
            logoutTime: row[5] || 'N/A',
            totalHours: row[8] || 'N/A',
            attendanceStatus: row[9] || 'N/A',
            status: row[6] || 'N/A'
          };
        }
      }
    }
    
    return { success: true, data: attendanceDays };
  } catch (error) {
    console.error('Error getting QR attendance summary:', error);
    return { success: false, message: 'Error getting QR attendance: ' + error.message };
  }
}

function generateAllStaffQRCodes() {
  try {
    const staffList = getAllStaff();
    return { 
      success: true, 
      message: `QR codes ready for ${staffList.length} staff members`, 
      count: staffList.length 
    };
  } catch (error) {
    console.error('Error generating QR codes:', error);
    return { success: false, message: 'Error generating QR codes: ' + error.message };
  }
}

// ========== SALARY MANAGEMENT ==========

function generateSalarySheet(month, year) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = `${month}_${year}`;
    
    let salarySheet = ss.getSheetByName(sheetName);
    if (salarySheet) {
      return { success: false, message: 'Salary sheet for this month already exists!' };
    }
    
    salarySheet = ss.insertSheet(sheetName);
    
    const headers = [
      'Staff ID', 'Name', 'Department', 'Designation', 'Staff Type',
      'Basic Salary', 'Per Day Salary', 'Total Days', 'Present Days', 'Absent Days',
      'Late Coming Days', 'Half Day Leave', 'Full Day Leave',
      'Arrears', 'Loan', 'TD', 'DA', 'Earning Leave', 'Other Allowance',
      'Leave Bonus', 'Leave Bonus Amount',
      'Loss of Payment', 'Late Coming Penalty', 'Loan Recovery', 'Student Fees',
      'Penalty', 'Other Deduction',
      'Total Earnings', 'Total Deductions', 'Net Salary',
      'Earnings Submitted By', 'Deductions Submitted By'
    ];
    
    salarySheet.getRange(1, 1, 1, headers.length)
      .setValues([headers])
      .setFontWeight('bold');
    
    // Color coding headers
    salarySheet.getRange(1, 1, 1, 6).setBackground('#e6f7ff');
    salarySheet.getRange(1, 7, 1, 7).setBackground('#f0f8ff');
    salarySheet.getRange(1, 14, 1, 7).setBackground('#e6f7ff');
    salarySheet.getRange(1, 21, 1, 1).setBackground('#e6ffe6');
    salarySheet.getRange(1, 22, 1, 6).setBackground('#fff0e6');
    salarySheet.getRange(1, 28, 1, 3).setBackground('#e6ffe6');
    salarySheet.getRange(1, 31, 1, 2).setBackground('#f0f0f0');
    
    const staffData = getAllStaff();
    if (staffData.length === 0) {
      ss.deleteSheet(salarySheet);
      return { success: false, message: 'No staff members found! Please add staff first.' };
    }
    
    const attendanceResponse = getAttendanceSummaryForMonth(month, year);
    const attendanceData = attendanceResponse.success ? attendanceResponse.data : {};
    
    const monthInfo = getMonthInfo(month, year);
    const totalDays = monthInfo.totalDays;
    
    staffData.forEach((staff, index) => {
      const row = index + 2;
      const perDaySalary = Math.round(staff.basicSalary / totalDays);
      
      const staffAttendance = attendanceData[staff.staffId] || {
        presentDays: totalDays,
        absentDays: 0,
        lateDays: 0,
        halfDayLeave: 0,
        fullDayLeave: 0,
        holidayDays: 0
      };
      
      // Basic info
      salarySheet.getRange(row, 1, 1, 5).setValues([[
        staff.staffId,
        staff.name,
        staff.department,
        staff.designation,
        staff.staffType
      ]]);
      
      salarySheet.getRange(row, 6).setValue(staff.basicSalary);
      salarySheet.getRange(row, 7).setValue(perDaySalary);
      salarySheet.getRange(row, 8).setValue(totalDays);
      salarySheet.getRange(row, 9).setValue(staffAttendance.presentDays);
      salarySheet.getRange(row, 10).setValue(staffAttendance.absentDays);
      salarySheet.getRange(row, 11).setValue(staffAttendance.lateDays);
      salarySheet.getRange(row, 12).setValue(staffAttendance.halfDayLeave);
      salarySheet.getRange(row, 13).setValue(staffAttendance.fullDayLeave);
      
      // Initialize earnings and deductions to 0
      salarySheet.getRange(row, 14, 1, 7).setValues([[0, 0, 0, 0, 0, 0, 0]]);
      salarySheet.getRange(row, 21, 1, 1).setValue(0);
      salarySheet.getRange(row, 22, 1, 6).setValues([[0, 0, 0, 0, 0, 0]]);
      
      // Auto-calculate based on attendance
      autoCalculateSalaryDeductions(salarySheet, row, staff, staffAttendance, perDaySalary);
      
      // Formulas for totals
      salarySheet.getRange(row, 28).setFormula(`=ROUND(F${row}+SUM(N${row}:T${row})+U${row})`);
      salarySheet.getRange(row, 29).setFormula(`=ROUND(SUM(V${row}:AA${row}))`);
      salarySheet.getRange(row, 30).setFormula(`=MAX(0, ROUND(AB${row}-AC${row}))`);
      
      salarySheet.getRange(row, 31, 1, 2).setValues([['', '']]);
    });
    
    // Formatting
    salarySheet.setColumnWidths(1, headers.length, 100);
    salarySheet.setColumnWidth(2, 150);
    salarySheet.setColumnWidth(3, 150);
    
    const lastDataRow = staffData.length + 1;
    const currencyColumns = [6, 7, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30];
    currencyColumns.forEach(col => {
      salarySheet.getRange(2, col, lastDataRow - 1, 1).setNumberFormat('#,##0');
    });
    
    salarySheet.getRange(2, 8, lastDataRow - 1, 6).setNumberFormat('0');
    salarySheet.setFrozenRows(1);
    
    return { 
      success: true, 
      message: `Salary sheet "${sheetName}" generated successfully!`,
      totalDays: totalDays
    };
  } catch (error) {
    console.error('Error generating salary sheet:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function autoCalculateSalaryDeductions(sheet, rowNum, staff, attendance, perDaySalary) {
  try {
    let lossOfPay = 0;
    let latePenalty = 0;
    let leaveBonusAmount = 0;
    
    const absentDays = attendance.absentDays || 0;
    const lateDays = attendance.lateDays || 0;
    const halfDayLeave = attendance.halfDayLeave || 0;
    const fullDayLeave = attendance.fullDayLeave || 0;
    const presentDays = attendance.presentDays || 0;
    
    const absentPenalty = Math.round(absentDays * (perDaySalary + (perDaySalary * 0.1)));
    const totalHalfDayEquivalent = Math.floor(halfDayLeave / 2);
    const remainingHalfDays = halfDayLeave % 2;
    const totalLeaveDays = fullDayLeave + totalHalfDayEquivalent;
    
    if (presentDays === 0) {
      lossOfPay = staff.basicSalary;
      leaveBonusAmount = 0;
    } else if (staff.staffType === STAFF_TYPES.TEACHING) {
      if (fullDayLeave > 6) {
        lossOfPay += Math.round(fullDayLeave * perDaySalary);
        lossOfPay += Math.round(halfDayLeave * (perDaySalary / 2));
      } else {
        if (totalLeaveDays === 0 && absentDays === 0 && remainingHalfDays === 0) {
          leaveBonusAmount = perDaySalary;
        } else if (totalLeaveDays > 1) {
          lossOfPay += Math.round((totalLeaveDays - 1) * perDaySalary);
        }
        if (totalLeaveDays >= 1 && remainingHalfDays > 0) {
          lossOfPay += Math.round(remainingHalfDays * (perDaySalary / 2));
        }
        if (totalLeaveDays === 0 && halfDayLeave > 2) {
          lossOfPay += Math.round((halfDayLeave - 2) * (perDaySalary / 2));
        }
      }
      lossOfPay += absentPenalty;
    } else {
      if (fullDayLeave > 6) {
        lossOfPay += Math.round(fullDayLeave * perDaySalary);
        lossOfPay += Math.round(halfDayLeave * (perDaySalary / 2));
      } else {
        lossOfPay = absentPenalty + 
                   Math.round(halfDayLeave * (perDaySalary / 2)) + 
                   Math.round(fullDayLeave * perDaySalary);
      }
    }
    
    latePenalty = Math.round(lateDays * (perDaySalary * 0.1));
    
    sheet.getRange(rowNum, 21).setValue(leaveBonusAmount); // Leave Bonus Amount
    sheet.getRange(rowNum, 22).setValue(lossOfPay); // Loss of Payment
    sheet.getRange(rowNum, 23).setValue(latePenalty); // Late Coming Penalty
  } catch (error) {
    console.error('Error auto-calculating salary:', error);
  }
}

function getSalaryDataForMonth(month, year) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = `${month}_${year}`;
    const salarySheet = ss.getSheetByName(sheetName);
    
    if (!salarySheet || salarySheet.getLastRow() <= 1) {
      return { success: false, message: 'Salary sheet not found for ' + month + ' ' + year };
    }
    
    const data = salarySheet.getDataRange().getValues();
    const headers = data[0];
    
    const colIndex = {
      staffId: headers.indexOf('Staff ID'),
      name: headers.indexOf('Name'),
      department: headers.indexOf('Department'),
      basicSalary: headers.indexOf('Basic Salary'),
      perDaySalary: headers.indexOf('Per Day Salary'),
      presentDays: headers.indexOf('Present Days'),
      absentDays: headers.indexOf('Absent Days'),
      lateDays: headers.indexOf('Late Coming Days'),
      halfDayLeave: headers.indexOf('Half Day Leave'),
      fullDayLeave: headers.indexOf('Full Day Leave'),
      arrears: headers.indexOf('Arrears'),
      loan: headers.indexOf('Loan'),
      td: headers.indexOf('TD'),
      da: headers.indexOf('DA'),
      earningLeave: headers.indexOf('Earning Leave'),
      otherAllowance: headers.indexOf('Other Allowance'),
      leaveBonus: headers.indexOf('Leave Bonus'),
      leaveBonusAmount: headers.indexOf('Leave Bonus Amount'),
      lossOfPay: headers.indexOf('Loss of Payment'),
      latePenalty: headers.indexOf('Late Coming Penalty'),
      loanRecovery: headers.indexOf('Loan Recovery'),
      studentFees: headers.indexOf('Student Fees'),
      penalty: headers.indexOf('Penalty'),
      otherDeduction: headers.indexOf('Other Deduction'),
      totalEarnings: headers.indexOf('Total Earnings'),
      totalDeductions: headers.indexOf('Total Deductions'),
      netSalary: headers.indexOf('Net Salary'),
      earningsSubmitted: headers.indexOf('Earnings Submitted By'),
      deductionsSubmitted: headers.indexOf('Deductions Submitted By')
    };
    
    const salaryData = {};
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const staffId = row[colIndex.staffId];
      
      if (staffId) {
        salaryData[staffId] = {
          name: row[colIndex.name],
          department: row[colIndex.department],
          basicSalary: row[colIndex.basicSalary] || 0,
          perDaySalary: row[colIndex.perDaySalary] || 0,
          presentDays: row[colIndex.presentDays] || 0,
          absentDays: row[colIndex.absentDays] || 0,
          lateDays: row[colIndex.lateDays] || 0,
          halfDayLeave: row[colIndex.halfDayLeave] || 0,
          fullDayLeave: row[colIndex.fullDayLeave] || 0,
          arrears: row[colIndex.arrears] || 0,
          loan: row[colIndex.loan] || 0,
          td: row[colIndex.td] || 0,
          da: row[colIndex.da] || 0,
          earningLeave: row[colIndex.earningLeave] || 0,
          otherAllowance: row[colIndex.otherAllowance] || 0,
          leaveBonus: row[colIndex.leaveBonus] || 0,
          leaveBonusAmount: row[colIndex.leaveBonusAmount] || 0,
          lossOfPay: row[colIndex.lossOfPay] || 0,
          latePenalty: row[colIndex.latePenalty] || 0,
          loanRecovery: row[colIndex.loanRecovery] || 0,
          studentFees: row[colIndex.studentFees] || 0,
          penalty: row[colIndex.penalty] || 0,
          otherDeduction: row[colIndex.otherDeduction] || 0,
          totalEarnings: row[colIndex.totalEarnings] || 0,
          totalDeductions: row[colIndex.totalDeductions] || 0,
          netSalary: row[colIndex.netSalary] || 0,
          earningsSubmitted: !!row[colIndex.earningsSubmitted],
          deductionsSubmitted: !!row[colIndex.deductionsSubmitted]
        };
      }
    }
    
    return { success: true, data: salaryData };
  } catch (error) {
    console.error('Error getting salary data:', error);
    return { success: false, message: 'Error: ' + error.message, data: {} };
  }
}

function getAllSalarySheets() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheets = ss.getSheets();
    const excludeSheets = Object.values(SHEET_NAMES);
    
    return sheets
      .filter(sheet => {
        const name = sheet.getName();
        return name.includes('_') && !excludeSheets.includes(name);
      })
      .map(sheet => sheet.getName());
  } catch (error) {
    console.error('Error getting salary sheets:', error);
    return [];
  }
}

function submitEarningsForAllStaff(month, year, earningsData) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = `${month}_${year}`;
    const salarySheet = ss.getSheetByName(sheetName);
    
    if (!salarySheet || salarySheet.getLastRow() <= 1) {
      return { success: false, message: 'Salary sheet not found for ' + month + ' ' + year };
    }
    
    const data = salarySheet.getDataRange().getValues();
    const headers = data[0];
    
    const staffIdCol = headers.indexOf('Staff ID');
    const arrearsCol = headers.indexOf('Arrears');
    const loanCol = headers.indexOf('Loan');
    const tdCol = headers.indexOf('TD');
    const daCol = headers.indexOf('DA');
    const earningLeaveCol = headers.indexOf('Earning Leave');
    const otherAllowanceCol = headers.indexOf('Other Allowance');
    const leaveBonusCol = headers.indexOf('Leave Bonus');
    const earningsSubmittedCol = headers.indexOf('Earnings Submitted By');
    
    let updatedCount = 0;
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const staffId = row[staffIdCol];
      
      if (staffId && earningsData[staffId]) {
        const earnings = earningsData[staffId];
        const rowNumber = i + 1;
        
        salarySheet.getRange(rowNumber, arrearsCol + 1).setValue(earnings.arrears || 0);
        salarySheet.getRange(rowNumber, loanCol + 1).setValue(earnings.loan || 0);
        salarySheet.getRange(rowNumber, tdCol + 1).setValue(earnings.td || 0);
        salarySheet.getRange(rowNumber, daCol + 1).setValue(earnings.da || 0);
        salarySheet.getRange(rowNumber, earningLeaveCol + 1).setValue(earnings.earningLeave || 0);
        salarySheet.getRange(rowNumber, otherAllowanceCol + 1).setValue(earnings.otherAllowance || 0);
        salarySheet.getRange(rowNumber, leaveBonusCol + 1).setValue(earnings.leaveBonus || 0);
        salarySheet.getRange(rowNumber, earningsSubmittedCol + 1).setValue('Admin');
        
        updatedCount++;
      }
    }
    
    return { 
      success: true, 
      message: `Earnings submitted for ${updatedCount} staff members successfully!`, 
      count: updatedCount 
    };
  } catch (error) {
    console.error('Error submitting earnings:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function submitDeductionsForAllStaff(month, year, deductionsData) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = `${month}_${year}`;
    const salarySheet = ss.getSheetByName(sheetName);
    
    if (!salarySheet || salarySheet.getLastRow() <= 1) {
      return { success: false, message: 'Salary sheet not found for ' + month + ' ' + year };
    }
    
    const data = salarySheet.getDataRange().getValues();
    const headers = data[0];
    
    const staffIdCol = headers.indexOf('Staff ID');
    const loanRecoveryCol = headers.indexOf('Loan Recovery');
    const studentFeesCol = headers.indexOf('Student Fees');
    const penaltyCol = headers.indexOf('Penalty');
    const otherDeductionCol = headers.indexOf('Other Deduction');
    const deductionsSubmittedCol = headers.indexOf('Deductions Submitted By');
    
    let updatedCount = 0;
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const staffId = row[staffIdCol];
      
      if (staffId && deductionsData[staffId]) {
        const deductions = deductionsData[staffId];
        const rowNumber = i + 1;
        
        salarySheet.getRange(rowNumber, loanRecoveryCol + 1).setValue(deductions.loanRecovery || 0);
        salarySheet.getRange(rowNumber, studentFeesCol + 1).setValue(deductions.studentFees || 0);
        salarySheet.getRange(rowNumber, penaltyCol + 1).setValue(deductions.penalty || 0);
        salarySheet.getRange(rowNumber, otherDeductionCol + 1).setValue(deductions.otherDeduction || 0);
        salarySheet.getRange(rowNumber, deductionsSubmittedCol + 1).setValue('Admin');
        
        updatedCount++;
      }
    }
    
    return { 
      success: true, 
      message: `Deductions submitted for ${updatedCount} staff members successfully!`, 
      count: updatedCount 
    };
  } catch (error) {
    console.error('Error submitting deductions:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function generateAllTeachingStaffSlips(month, year) {
  try {
    const staffList = getAllStaff();
    const teachingStaff = staffList.filter(staff => staff.staffType === STAFF_TYPES.TEACHING);
    const slips = [];
    
    for (const staff of teachingStaff) {
      const slipData = getSalarySlipData(staff.staffId, month, year);
      if (slipData.success) slips.push(slipData);
    }
    
    return { 
      success: true, 
      message: `Generated ${slips.length} payment slips for teaching staff`, 
      data: slips 
    };
  } catch (error) {
    console.error('Error generating teaching staff slips:', error);
    return { success: false, message: 'Error generating slips: ' + error.message };
  }
}

function validateLeavePolicy(staffId, month, year) {
  try {
    const attendanceResponse = getAttendanceSummaryForMonth(month, year);
    if (!attendanceResponse.success) {
      return { success: false, message: 'Attendance data not found' };
    }
    
    const attendanceData = attendanceResponse.data[staffId];
    if (!attendanceData) {
      return { success: false, message: 'Attendance data not found for staff' };
    }
    
    const fullDayLeave = attendanceData.fullDayLeave || 0;
    const halfDayLeave = attendanceData.halfDayLeave || 0;
    const exceedsLimit = fullDayLeave > 6;
    
    return {
      success: true,
      fullDayLeave: fullDayLeave,
      halfDayLeave: halfDayLeave,
      exceedsLimit: exceedsLimit,
      message: exceedsLimit 
        ? `Staff has taken ${fullDayLeave} full days leave (exceeds 6 days limit). No paid leave will be applied.`
        : `Staff has taken ${fullDayLeave} full days leave (within 6 days limit). Standard policy applies.`
    };
  } catch (error) {
    console.error('Error validating leave policy:', error);
    return { success: false, message: 'Error validating leave policy: ' + error.message };
  }
}

function checkLeavePolicyForAllStaff(month, year) {
  try {
    const staffList = getAllStaff();
    const attendanceResponse = getAttendanceSummaryForMonth(month, year);
    if (!attendanceResponse.success) {
      return { success: false, message: 'Attendance data not found' };
    }
    
    const attendanceData = attendanceResponse.data;
    const policyResults = [];
    
    staffList.forEach(staff => {
      const staffAttendance = attendanceData[staff.staffId];
      if (staffAttendance) {
        const fullDayLeave = staffAttendance.fullDayLeave || 0;
        policyResults.push({
          staffId: staff.staffId,
          name: staff.name,
          department: staff.department,
          staffType: staff.staffType,
          fullDayLeave: fullDayLeave,
          halfDayLeave: staffAttendance.halfDayLeave || 0,
          exceedsLimit: fullDayLeave > 6,
          status: fullDayLeave > 6 ? 'No Paid Leave' : 'Standard Policy'
        });
      }
    });
    
    policyResults.sort((a, b) => {
      if (a.exceedsLimit && !b.exceedsLimit) return -1;
      if (!a.exceedsLimit && b.exceedsLimit) return 1;
      return b.fullDayLeave - a.fullDayLeave;
    });
    
    return {
      success: true,
      month: month,
      year: year,
      totalStaff: policyResults.length,
      staffExceedingLimit: policyResults.filter(r => r.exceedsLimit).length,
      results: policyResults
    };
  } catch (error) {
    console.error('Error checking leave policy:', error);
    return { success: false, message: 'Error checking leave policy: ' + error.message };
  }
}

function generateLeavePolicyReport(month, year) {
  try {
    const policyCheck = checkLeavePolicyForAllStaff(month, year);
    if (!policyCheck.success) return policyCheck;
    
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const reportName = `LeavePolicyReport_${month}_${year}`;
    
    let reportSheet = ss.getSheetByName(reportName);
    if (reportSheet) ss.deleteSheet(reportSheet);
    
    reportSheet = ss.insertSheet(reportName);
    
    const headers = ['Staff ID', 'Name', 'Department', 'Staff Type', 'Full Day Leaves', 'Half Day Leaves', 'Leave Policy Status', 'Remarks'];
    reportSheet.getRange(1, 1, 1, headers.length)
      .setValues([headers])
      .setFontWeight('bold');
    
    policyCheck.results.forEach((result, index) => {
      const row = index + 2;
      reportSheet.getRange(row, 1, 1, headers.length).setValues([[
        result.staffId,
        result.name,
        result.department,
        result.staffType,
        result.fullDayLeave,
        result.halfDayLeave,
        result.status,
        result.exceedsLimit ? 'Exceeded 6 full days leave limit. No paid leave applied.' : 'Within leave policy limits.'
      ]]);
      
      if (result.exceedsLimit) {
        reportSheet.getRange(row, 1, 1, headers.length).setBackground('#ffcccc');
      }
    });
    
    const summaryRow = policyCheck.results.length + 3;
    reportSheet.getRange(summaryRow, 1).setValue('Summary:').setFontWeight('bold');
    reportSheet.getRange(summaryRow + 1, 1).setValue(`Total Staff: ${policyCheck.totalStaff}`);
    reportSheet.getRange(summaryRow + 2, 1).setValue(`Staff Exceeding Limit: ${policyCheck.staffExceedingLimit}`);
    reportSheet.getRange(summaryRow + 3, 1).setValue(`Month: ${month} ${year}`);
    
    reportSheet.setColumnWidths(1, headers.length, 120);
    reportSheet.getRange(2, 5, policyCheck.results.length, 2).setNumberFormat('0');
    reportSheet.setFrozenRows(1);
    
    return {
      success: true,
      message: 'Leave policy report generated successfully!',
      reportName: reportName,
      totalStaff: policyCheck.totalStaff,
      staffExceedingLimit: policyCheck.staffExceedingLimit,
      sheetUrl: ss.getUrl() + '#gid=' + reportSheet.getSheetId()
    };
  } catch (error) {
    console.error('Error generating leave policy report:', error);
    return { success: false, message: 'Error generating report: ' + error.message };
  }
}

function validateSalaryCalculation(staffId, month, year) {
  try {
    const salaryResponse = getSalaryDataForMonth(month, year);
    if (!salaryResponse.success) {
      return { success: false, message: 'Salary data not found' };
    }
    
    const salaryData = salaryResponse.data[staffId];
    if (!salaryData) {
      return { success: false, message: 'Salary data not found for staff' };
    }
    
    const attendanceResponse = getAttendanceSummaryForMonth(month, year);
    const attendanceData = attendanceResponse.success ? attendanceResponse.data[staffId] : null;
    
    const presentDays = attendanceData ? attendanceData.presentDays : 0;
    const netSalary = salaryData.netSalary || 0;
    
    let isValid = true;
    let issues = [];
    
    if (presentDays === 0 && netSalary !== 0) {
      isValid = false;
      issues.push(`Present days are 0 but net salary is ${netSalary}. Should be 0.`);
    }
    if (netSalary < 0) {
      isValid = false;
      issues.push(`Net salary is negative: ${netSalary}`);
    }
    
    return {
      success: true,
      isValid: isValid,
      staffId: staffId,
      presentDays: presentDays,
      netSalary: netSalary,
      issues: issues,
      message: isValid ? 'Salary calculation is valid' : 'Salary calculation has issues'
    };
  } catch (error) {
    console.error('Error validating salary:', error);
    return { success: false, message: 'Error validating salary: ' + error.message };
  }
}

function validateAllStaffSalaries(month, year) {
  try {
    const staffList = getAllStaff();
    const validationResults = [];
    let totalIssues = 0;
    
    staffList.forEach(staff => {
      const validation = validateSalaryCalculation(staff.staffId, month, year);
      if (!validation.isValid) totalIssues++;
      validationResults.push(validation);
    });
    
    return {
      success: true,
      month: month,
      year: year,
      totalStaff: staffList.length,
      staffWithIssues: totalIssues,
      results: validationResults
    };
  } catch (error) {
    console.error('Error validating all salaries:', error);
    return { success: false, message: 'Error validating salaries: ' + error.message };
  }
}

function correctStaffSalary(staffId, month, year) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = `${month}_${year}`;
    const salarySheet = ss.getSheetByName(sheetName);
    
    if (!salarySheet) return { success: false, message: 'Salary sheet not found' };
    
    const data = salarySheet.getDataRange().getValues();
    const headers = data[0];
    
    const staffIdCol = headers.indexOf('Staff ID');
    const presentDaysCol = headers.indexOf('Present Days');
    const netSalaryCol = headers.indexOf('Net Salary');
    const lossOfPayCol = headers.indexOf('Loss of Payment');
    const basicSalaryCol = headers.indexOf('Basic Salary');
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[staffIdCol] === staffId) {
        const rowNumber = i + 1;
        const presentDays = row[presentDaysCol] || 0;
        const basicSalary = row[basicSalaryCol] || 0;
        
        if (presentDays === 0) {
          const previousNet = row[netSalaryCol] || 0;
          salarySheet.getRange(rowNumber, netSalaryCol + 1).setValue(0);
          salarySheet.getRange(rowNumber, lossOfPayCol + 1).setValue(basicSalary);
          
          return {
            success: true,
            message: `Salary corrected for ${staffId}. Net salary set to 0 (no present days).`,
            previousNetSalary: previousNet,
            newNetSalary: 0
          };
        }
        break;
      }
    }
    
    return { success: false, message: 'Staff not found in salary sheet' };
  } catch (error) {
    console.error('Error correcting salary:', error);
    return { success: false, message: 'Error correcting salary: ' + error.message };
  }
}

// ========== LEAVE MANAGEMENT ==========

function applyForLeave(leaveData) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let leavesSheet = ss.getSheetByName(SHEET_NAMES.LEAVES);
    
    if (!leavesSheet) {
      leavesSheet = initializeLeavesSheet(ss).sheet;
    }
    
    const staffResponse = getStaffById(leaveData.staffId);
    if (!staffResponse.success) {
      return { success: false, message: 'Staff not found' };
    }
    const staff = staffResponse.staff;
    
    const startDate = parseDateSafe(leaveData.startDate);
    const endDate = parseDateSafe(leaveData.endDate);
    
    if (!startDate || !endDate) {
      return { success: false, message: 'Invalid dates provided' };
    }
    
    const numberOfDays = calculateWorkingDays(startDate, endDate);
    const leaveId = generateId(SHEET_NAMES.LEAVES, 'LEAVE', 3);
    
    const lastRow = leavesSheet.getLastRow() + 1;
    leavesSheet.getRange(lastRow, 1, 1, 14).setValues([[
      leaveId,
      leaveData.staffId,
      staff.name,
      staff.department,
      leaveData.leaveType,
      startDate,
      endDate,
      numberOfDays,
      leaveData.reason || '',
      new Date(),
      'Pending',
      '',
      '',
      ''
    ]]);
    
    leavesSheet.getRange(lastRow, 6, 1, 2).setNumberFormat('yyyy-mm-dd');
    leavesSheet.getRange(lastRow, 10, 1, 1).setNumberFormat('yyyy-mm-dd HH:mm:ss');
    
    return { 
      success: true, 
      leaveId: leaveId, 
      message: 'Leave application submitted successfully!', 
      numberOfDays: numberOfDays 
    };
  } catch (error) {
    console.error('Error applying for leave:', error);
    return { success: false, message: 'Error submitting leave application: ' + error.message };
  }
}

function approveLeave(leaveId, approvedBy) {
  return updateLeaveStatus(leaveId, 'Approved', approvedBy, '');
}

function rejectLeave(leaveId, approvedBy, remarks) {
  return updateLeaveStatus(leaveId, 'Rejected', approvedBy, remarks);
}

function updateLeaveStatus(leaveId, status, approvedBy, remarks = '') {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const leavesSheet = ss.getSheetByName(SHEET_NAMES.LEAVES);
    
    if (!leavesSheet || leavesSheet.getLastRow() <= 1) {
      return { success: false, message: 'No leaves found' };
    }
    
    const data = leavesSheet.getRange(2, 1, leavesSheet.getLastRow() - 1, 14).getValues();
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      if (row[0] === leaveId) {
        const rowNumber = i + 2;
        
        leavesSheet.getRange(rowNumber, 11).setValue(status);
        leavesSheet.getRange(rowNumber, 12).setValue(approvedBy);
        leavesSheet.getRange(rowNumber, 13).setValue(new Date());
        leavesSheet.getRange(rowNumber, 14).setValue(remarks || '');
        leavesSheet.getRange(rowNumber, 13).setNumberFormat('yyyy-mm-dd');
        
        // Update attendance if approved
        if (status === 'Approved') {
          const staffId = row[1];
          const startDate = row[5];
          const endDate = row[6];
          const leaveType = row[4];
          
          const attendanceUpdateResult = updateAttendanceForApprovedLeave(staffId, startDate, endDate, leaveType);
          return { 
            success: true, 
            message: `Leave approved successfully! ${attendanceUpdateResult.message}`,
            attendanceUpdate: attendanceUpdateResult 
          };
        }
        
        return { success: true, message: `Leave ${status.toLowerCase()} successfully!` };
      }
    }
    
    return { success: false, message: 'Leave ID not found!' };
  } catch (error) {
    console.error('Error updating leave status:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function updateAttendanceForApprovedLeave(staffId, startDate, endDate, leaveType) {
  try {
    const staffResponse = getStaffById(staffId);
    if (!staffResponse.success) {
      return { success: false, message: 'Staff not found' };
    }
    
    const currentDate = new Date(startDate);
    const finalDate = new Date(endDate);
    let updatedDays = 0;
    
    while (currentDate <= finalDate) {
      if (currentDate.getDay() !== 0) {
        const dateStr = formatDate(currentDate);
        const month = getMonthName(currentDate.getMonth() + 1);
        const year = currentDate.getFullYear();
        
        const monthlyUpdate = updateMonthlyAttendanceForLeave(staffId, dateStr, month, year, leaveType);
        if (monthlyUpdate.success) updatedDays++;
        
        updateDailyAttendanceForLeave(staffId, dateStr, leaveType);
      }
      currentDate.setDate(currentDate.getDate() + 1);
    }
    
    return { 
      success: true, 
      message: `Attendance updated for ${updatedDays} days.`, 
      updatedDays: updatedDays 
    };
  } catch (error) {
    console.error('Error updating attendance for leave:', error);
    return { success: false, message: 'Error updating attendance: ' + error.message };
  }
}

function updateMonthlyAttendanceForLeave(staffId, dateStr, month, year, leaveType) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = `Attendance_${month}_${year}`;
    const monthlySheet = ss.getSheetByName(sheetName);
    
    if (!monthlySheet) {
      return { success: false, message: 'Monthly attendance sheet not found' };
    }
    
    const date = new Date(dateStr);
    const day = date.getDate();
    const data = monthlySheet.getDataRange().getValues();
    const targetColumn = 9 + day;
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[0] === staffId) {
        let attendanceCode = leaveType.toLowerCase().includes('half') 
          ? ATTENDANCE_CODES.HALF_DAY 
          : ATTENDANCE_CODES.FULL_DAY_LEAVE;
        
        monthlySheet.getRange(i + 1, targetColumn).setValue(attendanceCode);
        return { success: true, message: `Updated ${dateStr} as ${attendanceCode}` };
      }
    }
    
    return { success: false, message: 'Staff not found in monthly sheet' };
  } catch (error) {
    console.error('Error updating monthly attendance for leave:', error);
    return { success: false, message: error.message };
  }
}

function updateDailyAttendanceForLeave(staffId, dateStr, leaveType) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const dailyAttendanceSheet = ss.getSheetByName(SHEET_NAMES.DAILY_ATTENDANCE);
    
    if (!dailyAttendanceSheet) {
      return { success: false, message: 'Daily attendance sheet not found' };
    }
    
    const data = dailyAttendanceSheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[0] && row[1] === staffId) {
        const rowDate = formatDate(row[0]);
        if (rowDate === dateStr) {
          let status = leaveType.toLowerCase().includes('half') ? 'halfday' : 'fullday';
          dailyAttendanceSheet.getRange(i + 1, 5).setValue(status);
          dailyAttendanceSheet.getRange(i + 1, 7).setValue(`Approved ${leaveType}`);
          return { success: true, message: 'Daily attendance updated' };
        }
      }
    }
    
    // Create new entry if not found
    const staffResponse = getStaffById(staffId);
    if (staffResponse.success) {
      const staff = staffResponse.staff;
      const lastRow = dailyAttendanceSheet.getLastRow() + 1;
      let status = leaveType.toLowerCase().includes('half') ? 'halfday' : 'fullday';
      
      dailyAttendanceSheet.getRange(lastRow, 1, 1, 9).setValues([[
        new Date(dateStr),
        staffId,
        staff.name,
        staff.department,
        status,
        '',
        `Approved ${leaveType}`,
        'System',
        new Date()
      ]]);
      
      return { success: true, message: 'New daily attendance entry created' };
    }
    
    return { success: false, message: 'Staff not found' };
  } catch (error) {
    console.error('Error updating daily attendance for leave:', error);
    return { success: false, message: error.message };
  }
}

function getStaffLeaves(staffId) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const leavesSheet = ss.getSheetByName(SHEET_NAMES.LEAVES);
    
    if (!leavesSheet || leavesSheet.getLastRow() <= 1) return [];
    
    const data = leavesSheet.getRange(2, 1, leavesSheet.getLastRow() - 1, 14).getValues();
    
    return data
      .filter(row => row[1] === staffId)
      .map(row => ({
        leaveId: row[0],
        staffId: row[1],
        staffName: row[2],
        department: row[3],
        leaveType: row[4],
        startDate: formatDate(row[5]),
        endDate: formatDate(row[6]),
        numberOfDays: row[7] || 0,
        reason: row[8] || '',
        appliedDate: formatDateTime(row[9]),
        status: row[10] || 'Pending',
        approvedBy: row[11] || '',
        approvedDate: formatDate(row[12]),
        remarks: row[13] || ''
      }))
      .sort((a, b) => new Date(b.appliedDate) - new Date(a.appliedDate));
  } catch (error) {
    console.error('Error getting staff leaves:', error);
    return [];
  }
}

function getAllLeaves() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const leavesSheet = ss.getSheetByName(SHEET_NAMES.LEAVES);
    
    if (!leavesSheet || leavesSheet.getLastRow() <= 1) return [];
    
    const data = leavesSheet.getRange(2, 1, leavesSheet.getLastRow() - 1, 14).getValues();
    
    return data
      .filter(row => row[0] && row[1])
      .map(row => ({
        leaveId: row[0],
        staffId: row[1],
        staffName: row[2],
        department: row[3],
        leaveType: row[4],
        startDate: formatDate(row[5]),
        endDate: formatDate(row[6]),
        numberOfDays: row[7] || 0,
        reason: row[8] || '',
        appliedDate: formatDateTime(row[9]),
        status: row[10] || 'Pending',
        approvedBy: row[11] || '',
        approvedDate: formatDate(row[12]),
        remarks: row[13] || ''
      }))
      .sort((a, b) => new Date(b.appliedDate) - new Date(a.appliedDate));
  } catch (error) {
    console.error('Error getting all leaves:', error);
    return [];
  }
}

function getAllLeavesForAdmin() {
  return getAllLeaves();
}

// ========== SALARY RECEIPT MANAGEMENT ==========

function confirmSalaryReceipt(staffId, month, year, paymentMethod, signature) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let salaryReceiptSheet = ss.getSheetByName(SHEET_NAMES.SALARY_RECEIPTS);
    
    if (!salaryReceiptSheet) {
      salaryReceiptSheet = initializeSalaryReceiptsSheet(ss).sheet;
    }
    
    // Check if already confirmed
    if (salaryReceiptSheet.getLastRow() > 1) {
      const data = salaryReceiptSheet.getRange(2, 1, salaryReceiptSheet.getLastRow() - 1, 11).getValues();
      const alreadyConfirmed = data.some(row => 
        row[1] === staffId && row[3] === month && parseInt(row[4]) === parseInt(year)
      );
      
      if (alreadyConfirmed) {
        return { success: false, message: 'Salary receipt already confirmed for ' + month + ' ' + year };
      }
    }
    
    const salaryResponse = getSalaryDataForMonth(month, year);
    if (!salaryResponse.success) {
      return { success: false, message: 'Salary data not found for ' + month + ' ' + year };
    }
    
    const salaryData = salaryResponse.data[staffId];
    if (!salaryData) {
      return { success: false, message: 'Salary data not found for staff ' + staffId };
    }
    
    const receiptId = generateId(SHEET_NAMES.SALARY_RECEIPTS, 'RECEIPT', 3);
    const lastRow = salaryReceiptSheet.getLastRow() + 1;
    const staffResponse = getStaffById(staffId);
    const staffName = staffResponse.success ? staffResponse.staff.name : 'Unknown';
    
    salaryReceiptSheet.getRange(lastRow, 1, 1, 11).setValues([[
      receiptId,
      staffId,
      staffName,
      month,
      year,
      salaryData.netSalary,
      new Date(),
      'Online Portal',
      paymentMethod,
      signature || '',
      'Salary receipt confirmed by staff via online portal'
    ]]);
    
    salaryReceiptSheet.getRange(lastRow, 7, 1, 1).setNumberFormat('yyyy-mm-dd HH:mm:ss');
    salaryReceiptSheet.getRange(lastRow, 6, 1, 1).setNumberFormat('#,##0');
    
    return { 
      success: true, 
      message: 'Salary receipt confirmed successfully!', 
      receiptId: receiptId, 
      netSalary: salaryData.netSalary 
    };
  } catch (error) {
    console.error('Error confirming salary receipt:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function getStaffSalaryReceipts(staffId) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const salaryReceiptSheet = ss.getSheetByName(SHEET_NAMES.SALARY_RECEIPTS);
    
    if (!salaryReceiptSheet || salaryReceiptSheet.getLastRow() <= 1) return [];
    
    const data = salaryReceiptSheet.getRange(2, 1, salaryReceiptSheet.getLastRow() - 1, 11).getValues();
    
    return data
      .filter(row => row[1] === staffId)
      .map(row => ({
        receiptId: row[0],
        staffId: row[1],
        staffName: row[2],
        month: row[3],
        year: row[4],
        netSalary: row[5] || 0,
        confirmedDate: formatDateTime(row[6]),
        confirmationMethod: row[7] || '',
        paymentMethod: row[8] || '',
        signature: row[9] || '',
        remarks: row[10] || ''
      }))
      .sort((a, b) => new Date(b.confirmedDate) - new Date(a.confirmedDate));
  } catch (error) {
    console.error('Error getting staff salary receipts:', error);
    return [];
  }
}

function getStaffSalarySlips(staffId) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheets = ss.getSheets();
    const excludeSheets = Object.values(SHEET_NAMES);
    
    const salarySheets = sheets.filter(sheet => {
      const name = sheet.getName();
      return name.includes('_') && !excludeSheets.includes(name);
    });
    
    const staffSlips = [];
    const monthOrder = ['January', 'February', 'March', 'April', 'May', 'June', 
                        'July', 'August', 'September', 'October', 'November', 'December'];
    
    for (const sheet of salarySheets) {
      const sheetName = sheet.getName();
      const [month, year] = sheetName.split('_');
      
      const salaryResponse = getSalaryDataForMonth(month, year);
      if (salaryResponse.success && salaryResponse.data[staffId]) {
        const salaryData = salaryResponse.data[staffId];
        staffSlips.push({
          month: month,
          year: year,
          netSalary: salaryData.netSalary,
          totalEarnings: salaryData.totalEarnings,
          totalDeductions: salaryData.totalDeductions,
          status: salaryData.earningsSubmitted && salaryData.deductionsSubmitted ? 'Processed' : 'Pending'
        });
      }
    }
    
    return staffSlips.sort((a, b) => {
      if (a.year !== b.year) return parseInt(b.year) - parseInt(a.year);
      return monthOrder.indexOf(b.month) - monthOrder.indexOf(a.month);
    });
  } catch (error) {
    console.error('Error getting staff salary slips:', error);
    return [];
  }
}

function getSalarySlipData(staffId, month, year) {
  try {
    const staffResponse = getStaffById(staffId);
    if (!staffResponse.success) {
      return { success: false, message: 'Staff not found' };
    }
    const staff = staffResponse.staff;
    
    const salaryResponse = getSalaryDataForMonth(month, year);
    if (!salaryResponse.success) {
      return { success: false, message: 'Salary data not found for ' + month + ' ' + year };
    }
    
    const salaryData = salaryResponse.data[staffId];
    if (!salaryData) {
      return { success: false, message: 'Salary data not found for staff ' + staffId };
    }
    
    const attendanceResponse = getAttendanceSummaryForMonth(month, year);
    const attendanceData = attendanceResponse.success ? attendanceResponse.data[staffId] : null;
    const monthInfo = getMonthInfo(month, year);
    const perDaySalary = Math.round(staff.basicSalary / monthInfo.totalDays);
    const fullDayLeave = attendanceData ? attendanceData.fullDayLeave : 0;
    
    let leaveBonusAmount = 0;
    if (fullDayLeave <= 6) {
      leaveBonusAmount = salaryData.leaveBonusAmount || 0;
    }
    const totalLeaveBonus = (salaryData.leaveBonus || 0) + leaveBonusAmount;
    
    const totalEarnings = staff.basicSalary + 
                         (salaryData.arrears || 0) + 
                         (salaryData.loan || 0) + 
                         (salaryData.td || 0) + 
                         (salaryData.da || 0) + 
                         (salaryData.earningLeave || 0) + 
                         (salaryData.otherAllowance || 0) + 
                         totalLeaveBonus;
    
    const totalDeductions = (salaryData.lossOfPay || 0) + 
                           (salaryData.latePenalty || 0) +
                           (salaryData.loanRecovery || 0) + 
                           (salaryData.studentFees || 0) +
                           (salaryData.penalty || 0) + 
                           (salaryData.otherDeduction || 0);
    
    const netSalary = totalEarnings - totalDeductions;
    
    return {
      success: true,
      staff: staff,
      month: month,
      year: year,
      receiptNumber: `SLIP${month.substring(0,3).toUpperCase()}${year}${staffId}`,
      calculation: {
        totalDays: monthInfo.totalDays,
        presentDays: attendanceData ? attendanceData.presentDays : monthInfo.totalDays,
        absentDays: attendanceData ? attendanceData.absentDays : 0,
        lateDays: attendanceData ? attendanceData.lateDays : 0,
        halfDayLeave: attendanceData ? attendanceData.halfDayLeave : 0,
        fullDayLeave: fullDayLeave,
        basicSalary: staff.basicSalary,
        netSalary: netSalary,
        totalEarnings: totalEarnings,
        totalDeductions: totalDeductions,
        arrears: salaryData.arrears || 0,
        loanEarning: salaryData.loan || 0,
        td: salaryData.td || 0,
        da: salaryData.da || 0,
        earningLeave: salaryData.earningLeave || 0,
        otherAllowance: salaryData.otherAllowance || 0,
        leaveBonus: totalLeaveBonus,
        manualLeaveBonus: salaryData.leaveBonus || 0,
        autoLeaveBonus: leaveBonusAmount,
        lossOfPay: salaryData.lossOfPay || 0,
        latePenalty: salaryData.latePenalty || 0,
        loanRecovery: salaryData.loanRecovery || 0,
        studentFees: salaryData.studentFees || 0,
        penalty: salaryData.penalty || 0,
        otherDeduction: salaryData.otherDeduction || 0,
        perDaySalary: perDaySalary,
        leavePolicyApplied: fullDayLeave > 6 ? 'No paid leave (exceeded 6 full days)' : 'Standard policy'
      }
    };
  } catch (error) {
    console.error('Error generating salary slip:', error);
    return { success: false, message: 'Error generating salary slip: ' + error.message };
  }
}

function getStaffPaymentConfirmations(staffId) {
  return getStaffSalaryReceipts(staffId);
}

function getAvailableSalaryMonthsForStaff(staffId) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheets = ss.getSheets();
    const excludeSheets = Object.values(SHEET_NAMES);
    
    const salarySheets = sheets.filter(sheet => {
      const name = sheet.getName();
      return name.includes('_') && !excludeSheets.includes(name);
    });
    
    const currentDate = new Date();
    const currentYear = currentDate.getFullYear();
    const currentMonth = currentDate.getMonth() + 1;
    
    const confirmedReceipts = getStaffPaymentConfirmations(staffId);
    const confirmedMonths = {};
    confirmedReceipts.forEach(receipt => {
      confirmedMonths[`${receipt.month}_${receipt.year}`] = true;
    });
    
    const availableMonths = [];
    const monthOrder = ['January', 'February', 'March', 'April', 'May', 'June', 
                        'July', 'August', 'September', 'October', 'November', 'December'];
    
    for (const sheet of salarySheets) {
      const sheetName = sheet.getName();
      const [month, year] = sheetName.split('_');
      
      const monthNumber = getMonthNumber(month);
      const isFutureMonth = (parseInt(year) > currentYear) || 
                           (parseInt(year) === currentYear && monthNumber > currentMonth);
      
      if (!isFutureMonth && !confirmedMonths[sheetName]) {
        const salaryResponse = getSalaryDataForMonth(month, year);
        if (salaryResponse.success && salaryResponse.data[staffId]) {
          const salaryData = salaryResponse.data[staffId];
          if (salaryData.earningsSubmitted && salaryData.deductionsSubmitted) {
            availableMonths.push({ 
              month: month, 
              year: year, 
              netSalary: salaryData.netSalary, 
              display: `${month} ${year}` 
            });
          }
        }
      }
    }
    
    return availableMonths.sort((a, b) => {
      if (a.year !== b.year) return parseInt(b.year) - parseInt(a.year);
      return monthOrder.indexOf(b.month) - monthOrder.indexOf(a.month);
    });
  } catch (error) {
    console.error('Error getting available salary months:', error);
    return [];
  }
}

function getStaffPaymentHistory(staffId) {
  try {
    const receipts = getStaffSalaryReceipts(staffId);
    const slips = getStaffSalarySlips(staffId);
    const paymentHistory = [];
    
    receipts.forEach(receipt => {
      paymentHistory.push({
        type: 'Receipt',
        month: receipt.month,
        year: receipt.year,
        amount: receipt.netSalary,
        date: receipt.confirmedDate,
        status: 'Confirmed'
      });
    });
    
    slips.forEach(slip => {
      const isConfirmed = receipts.some(receipt => 
        receipt.month === slip.month && receipt.year === slip.year
      );
      
      if (!isConfirmed) {
        paymentHistory.push({
          type: 'Slip',
          month: slip.month,
          year: slip.year,
          amount: slip.netSalary,
          date: '',
          status: slip.status
        });
      }
    });
    
    const monthOrder = ['January', 'February', 'March', 'April', 'May', 'June', 
                        'July', 'August', 'September', 'October', 'November', 'December'];
    
    return paymentHistory.sort((a, b) => {
      if (a.year !== b.year) return parseInt(b.year) - parseInt(a.year);
      return monthOrder.indexOf(b.month) - monthOrder.indexOf(a.month);
    });
  } catch (error) {
    console.error('Error getting payment history:', error);
    return [];
  }
}

// ========== NOTICE & TASK MANAGEMENT ==========

function addNotice(noticeData) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let noticesSheet = ss.getSheetByName(SHEET_NAMES.NOTICES);
    
    if (!noticesSheet) {
      noticesSheet = initializeNoticesSheet(ss).sheet;
    }
    
    const noticeId = generateId(SHEET_NAMES.NOTICES, 'NOTICE', 3);
    const lastRow = noticesSheet.getLastRow() + 1;
    
    noticesSheet.getRange(lastRow, 1, 1, 11).setValues([[
      noticeId,
      noticeData.title,
      noticeData.message,
      noticeData.priority || 'Normal',
      noticeData.targetAudience || 'All Staff',
      noticeData.sender || 'System',
      new Date(),
      parseDateSafe(noticeData.expiryDate) || new Date(new Date().setMonth(new Date().getMonth() + 1)),
      'Active',
      '',
      ''
    ]]);
    
    noticesSheet.getRange(lastRow, 7, 1, 2).setNumberFormat('yyyy-mm-dd HH:mm:ss');
    
    return { success: true, noticeId: noticeId, message: 'Notice sent successfully!' };
  } catch (error) {
    console.error('Error adding notice:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function getAllNotices() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const noticesSheet = ss.getSheetByName(SHEET_NAMES.NOTICES);
    
    if (!noticesSheet || noticesSheet.getLastRow() <= 1) return [];
    
    const data = noticesSheet.getRange(2, 1, noticesSheet.getLastRow() - 1, 11).getValues();
    
    return data
      .map(row => ({
        noticeId: row[0],
        title: row[1],
        message: row[2],
        priority: row[3],
        targetAudience: row[4],
        sender: row[5],
        sentDate: formatDateTime(row[6]),
        expiryDate: formatDate(row[7]),
        status: row[8],
        readBy: row[9] || '',
        acknowledgedBy: row[10] || ''
      }))
      .sort((a, b) => new Date(b.sentDate) - new Date(a.sentDate));
  } catch (error) {
    console.error('Error getting all notices:', error);
    return [];
  }
}

function getNoticesForStaff(staffId) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const noticesSheet = ss.getSheetByName(SHEET_NAMES.NOTICES);
    
    if (!noticesSheet || noticesSheet.getLastRow() <= 1) return [];
    
    const data = noticesSheet.getRange(2, 1, noticesSheet.getLastRow() - 1, 11).getValues();
    const currentDate = new Date();
    const isTeaching = isTeachingStaff(staffId);
    
    return data
      .filter(row => {
        const expiryDate = row[7];
        const status = row[8];
        const targetAudience = row[4];
        
        if (status !== 'Active' || (expiryDate && new Date(expiryDate) <= currentDate)) {
          return false;
        }
        
        if (targetAudience === 'All Staff' || targetAudience === staffId) {
          return true;
        }
        if (targetAudience === 'Teaching Staff' && isTeaching) {
          return true;
        }
        if (targetAudience === 'Non-Teaching Staff' && !isTeaching) {
          return true;
        }
        return false;
      })
      .map(row => {
        const readBy = row[9] ? row[9].split(',') : [];
        const acknowledgedBy = row[10] ? row[10].split(',') : [];
        
        return {
          noticeId: row[0],
          title: row[1],
          message: row[2],
          priority: row[3],
          targetAudience: row[4],
          sender: row[5],
          sentDate: formatDateTime(row[6]),
          expiryDate: formatDate(row[7]),
          status: row[8],
          isRead: readBy.includes(staffId),
          isAcknowledged: acknowledgedBy.includes(staffId)
        };
      })
      .sort((a, b) => new Date(b.sentDate) - new Date(a.sentDate));
  } catch (error) {
    console.error('Error getting notices for staff:', error);
    return [];
  }
}

function markNoticeAsRead(noticeId, staffId) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const noticesSheet = ss.getSheetByName(SHEET_NAMES.NOTICES);
    
    if (!noticesSheet || noticesSheet.getLastRow() <= 1) {
      return { success: false, message: 'No notices found' };
    }
    
    const data = noticesSheet.getRange(2, 1, noticesSheet.getLastRow() - 1, 11).getValues();
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      if (row[0] === noticeId) {
        const rowNumber = i + 2;
        const readBy = row[9] ? row[9].split(',') : [];
        
        if (!readBy.includes(staffId)) {
          readBy.push(staffId);
          noticesSheet.getRange(rowNumber, 10).setValue(readBy.join(','));
        }
        
        return { success: true, message: 'Notice marked as read' };
      }
    }
    
    return { success: false, message: 'Notice ID not found' };
  } catch (error) {
    console.error('Error marking notice as read:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function acknowledgeNotice(noticeId, staffId) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const noticesSheet = ss.getSheetByName(SHEET_NAMES.NOTICES);
    
    if (!noticesSheet || noticesSheet.getLastRow() <= 1) {
      return { success: false, message: 'No notices found' };
    }
    
    const data = noticesSheet.getRange(2, 1, noticesSheet.getLastRow() - 1, 11).getValues();
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      if (row[0] === noticeId) {
        const rowNumber = i + 2;
        const acknowledgedBy = row[10] ? row[10].split(',') : [];
        
        if (!acknowledgedBy.includes(staffId)) {
          acknowledgedBy.push(staffId);
          noticesSheet.getRange(rowNumber, 11).setValue(acknowledgedBy.join(','));
        }
        
        return { success: true, message: 'Notice acknowledged' };
      }
    }
    
    return { success: false, message: 'Notice ID not found' };
  } catch (error) {
    console.error('Error acknowledging notice:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function addTask(taskData) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let tasksSheet = ss.getSheetByName(SHEET_NAMES.TASKS);
    
    if (!tasksSheet) {
      tasksSheet = initializeTasksSheet(ss).sheet;
    }
    
    const taskId = generateId(SHEET_NAMES.TASKS, 'TASK', 3);
    const lastRow = tasksSheet.getLastRow() + 1;
    
    tasksSheet.getRange(lastRow, 1, 1, 12).setValues([[
      taskId,
      taskData.title,
      taskData.description || '',
      taskData.assignedTo,
      taskData.assignedBy || 'System',
      new Date(),
      parseDateSafe(taskData.dueDate) || new Date(new Date().setDate(new Date().getDate() + 7)),
      taskData.priority || 'Normal',
      'Assigned',
      '',
      '',
      'No'
    ]]);
    
    tasksSheet.getRange(lastRow, 6, 1, 1).setNumberFormat('yyyy-mm-dd HH:mm:ss');
    tasksSheet.getRange(lastRow, 7, 1, 1).setNumberFormat('yyyy-mm-dd');
    
    return { success: true, taskId: taskId, message: 'Task assigned successfully!' };
  } catch (error) {
    console.error('Error adding task:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function getAllTasks() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const tasksSheet = ss.getSheetByName(SHEET_NAMES.TASKS);
    
    if (!tasksSheet || tasksSheet.getLastRow() <= 1) return [];
    
    const data = tasksSheet.getRange(2, 1, tasksSheet.getLastRow() - 1, 12).getValues();
    
    return data
      .map(row => ({
        taskId: row[0],
        title: row[1],
        description: row[2],
        assignedTo: row[3],
        assignedBy: row[4],
        assignedDate: formatDateTime(row[5]),
        dueDate: formatDate(row[6]),
        priority: row[7],
        status: row[8],
        completionDate: formatDate(row[9]),
        remarks: row[10] || '',
        acknowledged: row[11] === 'Yes'
      }))
      .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
  } catch (error) {
    console.error('Error getting all tasks:', error);
    return [];
  }
}

function getTasksForStaff(staffId) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const tasksSheet = ss.getSheetByName(SHEET_NAMES.TASKS);
    
    if (!tasksSheet || tasksSheet.getLastRow() <= 1) return [];
    
    const data = tasksSheet.getRange(2, 1, tasksSheet.getLastRow() - 1, 12).getValues();
    
    return data
      .filter(row => {
        const assignedTo = row[3];
        return assignedTo === staffId || assignedTo === 'All Staff';
      })
      .map(row => ({
        taskId: row[0],
        title: row[1],
        description: row[2],
        assignedTo: row[3],
        assignedBy: row[4],
        assignedDate: formatDateTime(row[5]),
        dueDate: formatDate(row[6]),
        priority: row[7],
        status: row[8],
        completionDate: formatDate(row[9]),
        remarks: row[10] || '',
        acknowledged: row[11] === 'Yes'
      }))
      .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
  } catch (error) {
    console.error('Error getting tasks for staff:', error);
    return [];
  }
}

function acknowledgeTask(taskId, staffId) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const tasksSheet = ss.getSheetByName(SHEET_NAMES.TASKS);
    
    if (!tasksSheet || tasksSheet.getLastRow() <= 1) {
      return { success: false, message: 'No tasks found' };
    }
    
    const data = tasksSheet.getRange(2, 1, tasksSheet.getLastRow() - 1, 12).getValues();
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      if (row[0] === taskId && (row[3] === staffId || row[3] === 'All Staff')) {
        const rowNumber = i + 2;
        tasksSheet.getRange(rowNumber, 12).setValue('Yes');
        return { success: true, message: 'Task acknowledged' };
      }
    }
    
    return { success: false, message: 'Task ID not found or not assigned to you' };
  } catch (error) {
    console.error('Error acknowledging task:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function updateTaskStatus(taskId, status, remarks = '') {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const tasksSheet = ss.getSheetByName(SHEET_NAMES.TASKS);
    
    if (!tasksSheet || tasksSheet.getLastRow() <= 1) {
      return { success: false, message: 'No tasks found' };
    }
    
    const data = tasksSheet.getRange(2, 1, tasksSheet.getLastRow() - 1, 12).getValues();
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      if (row[0] === taskId) {
        const rowNumber = i + 2;
        
        tasksSheet.getRange(rowNumber, 9).setValue(status);
        
        if (remarks) {
          tasksSheet.getRange(rowNumber, 11).setValue(remarks);
        }
        
        if (status === 'Completed') {
          tasksSheet.getRange(rowNumber, 10).setValue(new Date());
          tasksSheet.getRange(rowNumber, 10).setNumberFormat('yyyy-mm-dd');
        }
        
        return { success: true, message: 'Task status updated' };
      }
    }
    
    return { success: false, message: 'Task ID not found' };
  } catch (error) {
    console.error('Error updating task status:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function isTeachingStaff(staffId) {
  try {
    const staffResponse = getStaffById(staffId);
    if (staffResponse.success) {
      return staffResponse.staff.staffType === STAFF_TYPES.TEACHING;
    }
    return false;
  } catch (error) {
    console.error('Error checking staff type:', error);
    return false;
  }
}

// ========== STAFF DASHBOARD DATA ==========

function getStaffDashboardData(staffId) {
  try {
    const staffResponse = getStaffById(staffId);
    if (!staffResponse.success) {
      return { success: false, message: 'Staff not found' };
    }
    
    const staff = staffResponse.staff;
    const now = new Date();
    const currentMonth = getMonthName(now.getMonth() + 1);
    const currentYear = now.getFullYear();
    
    // Attendance data
    let attendanceData = null;
    let presentDays = 0, absentDays = 0, lateDays = 0, attendancePercentage = '0%';
    
    try {
      const attendanceResponse = getAttendanceSummaryForMonth(currentMonth, currentYear);
      if (attendanceResponse.success && attendanceResponse.data[staffId]) {
        attendanceData = attendanceResponse.data[staffId];
        presentDays = attendanceData.presentDays || 0;
        absentDays = attendanceData.absentDays || 0;
        lateDays = attendanceData.lateDays || 0;
        attendancePercentage = attendanceData.attendancePercentage || '0%';
      }
    } catch (attError) {
      console.error('Error fetching attendance for dashboard:', attError);
    }
    
    // Leaves data
    let leaves = [], pendingLeaves = 0, approvedLeaves = 0;
    try {
      leaves = getStaffLeaves(staffId);
      pendingLeaves = leaves.filter(leave => leave.status === 'Pending').length;
      approvedLeaves = leaves.filter(leave => leave.status === 'Approved').length;
    } catch (leaveError) {
      console.error('Error fetching leaves for dashboard:', leaveError);
    }
    
    // Salary data
    let salaryReceipts = [], recentReceipts = [];
    try {
      salaryReceipts = getStaffSalaryReceipts(staffId);
      recentReceipts = salaryReceipts.slice(0, 3);
    } catch (receiptError) {
      console.error('Error fetching receipts for dashboard:', receiptError);
    }
    
    let currentSalary = null, netSalary = 0, paymentConfirmed = false;
    try {
      const currentSalaryResponse = getSalaryDataForMonth(currentMonth, currentYear);
      if (currentSalaryResponse.success && currentSalaryResponse.data[staffId]) {
        currentSalary = currentSalaryResponse.data[staffId];
        netSalary = currentSalary.netSalary || 0;
        const currentMonthReceipt = salaryReceipts.find(receipt => 
          receipt.month === currentMonth && parseInt(receipt.year) === currentYear
        );
        paymentConfirmed = !!currentMonthReceipt;
      }
    } catch (salaryError) {
      console.error('Error fetching salary for dashboard:', salaryError);
    }
    
    // Notices
    let recentNotices = [];
    try {
      recentNotices = getNoticesForStaff(staffId).slice(0, 5);
    } catch (noticeError) {
      console.error('Error fetching notices for dashboard:', noticeError);
    }
    
    // Tasks
    let pendingTasks = [];
    try {
      pendingTasks = getTasksForStaff(staffId)
        .filter(task => task.status !== 'Completed')
        .slice(0, 5);
    } catch (taskError) {
      console.error('Error fetching tasks for dashboard:', taskError);
    }
    
    const dashboardData = {
      profile: staff,
      attendance: {
        presentDays: presentDays,
        absentDays: absentDays,
        lateDays: lateDays,
        attendancePercentage: attendancePercentage
      },
      leaves: {
        total: leaves.length,
        pending: pendingLeaves,
        approved: approvedLeaves,
        recent: leaves.slice(0, 5)
      },
      salary: {
        netSalary: netSalary,
        paymentConfirmed: paymentConfirmed,
        recentReceipts: recentReceipts
      },
      notices: recentNotices,
      tasks: pendingTasks,
      currentMonth: currentMonth,
      currentYear: currentYear,
      lastUpdated: new Date().toISOString()
    };
    
    return { success: true, data: dashboardData };
  } catch (error) {
    console.error('Error loading dashboard data:', error);
    return { 
      success: false, 
      message: 'Error loading dashboard data: ' + error.message, 
      data: null 
    };
  }
}

function updateStaffProfile(staffId, profileData) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const staffSheet = ss.getSheetByName(SHEET_NAMES.STAFF);
    
    if (!staffSheet || staffSheet.getLastRow() <= 1) {
      return { success: false, message: 'Staff sheet not found' };
    }
    
    const data = staffSheet.getDataRange().getValues();
    const headers = data[0];
    
    const colIndex = {
      staffId: headers.indexOf('Staff ID'),
      email: headers.indexOf('Email'),
      phone: headers.indexOf('Phone'),
      bankAccount: headers.indexOf('Bank Account'),
      ifscCode: headers.indexOf('IFSC Code'),
      photoUrl: headers.indexOf('Photo URL')
    };
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[colIndex.staffId] === staffId) {
        const rowNumber = i + 1;
        
        if (profileData.email !== undefined) {
          staffSheet.getRange(rowNumber, colIndex.email + 1).setValue(profileData.email);
        }
        if (profileData.phone !== undefined) {
          staffSheet.getRange(rowNumber, colIndex.phone + 1).setValue(profileData.phone);
        }
        if (profileData.bankAccount !== undefined) {
          staffSheet.getRange(rowNumber, colIndex.bankAccount + 1).setValue(profileData.bankAccount);
        }
        if (profileData.ifscCode !== undefined) {
          staffSheet.getRange(rowNumber, colIndex.ifscCode + 1).setValue(profileData.ifscCode);
        }
        
        if (profileData.photoData) {
          const photoUrl = saveStaffPhoto(
            profileData.photoData, 
            profileData.photoName || 'profile.jpg', 
            staffId
          );
          staffSheet.getRange(rowNumber, colIndex.photoUrl + 1).setValue(photoUrl);
        }
        
        return { success: true, message: 'Profile updated successfully!' };
      }
    }
    
    return { success: false, message: 'Staff ID not found!' };
  } catch (error) {
    console.error('Error updating staff profile:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

function checkLoginEligibility() {
  try {
    const now = new Date();
    const currentHours = now.getHours();
    const currentMinutes = now.getMinutes();
    const currentTotalMinutes = currentHours * 60 + currentMinutes;
    
    // Define time thresholds
    const BEFORE_WARNING = 9 * 60 + 30;  // 09:30 AM
    const WARNING_START = 9 * 60 + 30;   // 09:30 AM
    const WARNING_END = 9 * 60 + 45;     // 09:45 AM
    const LATE_START = 9 * 60 + 45;      // 09:45 AM
    const LATE_END = 11 * 60 + 30;       // 11:30 AM
    
    const currentTimeStr = Utilities.formatDate(now, getScriptTimezone(), 'HH:mm:ss');
    
    let eligible = true;
    let status = '';
    let message = '';
    let warningType = 'none';
    
    if (currentTotalMinutes < BEFORE_WARNING) {
      // Before 9:30 AM - All good
      eligible = true;
      status = 'On Time';
      message = 'Login eligible - On Time';
      warningType = 'none';
    }
    else if (currentTotalMinutes >= WARNING_START && currentTotalMinutes < WARNING_END) {
      // 9:30 AM to 9:45 AM - Warning period
      eligible = true;
      status = 'Warning Period';
      message = ' You are logging in during warning period (9:30-9:45 AM). You will still be marked Present but please be on time tomorrow.';
      warningType = 'warning';
    }
    else if (currentTotalMinutes >= LATE_START && currentTotalMinutes < LATE_END) {
      // 9:45 AM to 11:30 AM - Late
      eligible = true;
      status = 'Late';
      message = ' Late Login: You will be marked as Late Coming (L) for today.';
      warningType = 'late';
    }
    else if (currentTotalMinutes >= LATE_END) {
      // After 11:30 AM - Half Day
      eligible = true;
      status = 'Half Day';
      message = ' Very Late: You will be marked as Half Day (HD) for today.';
      warningType = 'halfday';
    }
    
    // Check if it's Sunday
    const dayOfWeek = now.getDay();
    if (dayOfWeek === 0) {
      eligible = false;
      status = 'Sunday';
      message = 'Today is Sunday. Attendance not required.';
      warningType = 'holiday';
    }
    
    // Check for holidays
    const holidayInfo = getHolidayForDate(now);
    if (holidayInfo) {
      eligible = false;
      status = 'Holiday';
      message = `Today is a holiday: ${holidayInfo.holidayName}. Attendance not required.`;
      warningType = 'holiday';
    }
    
    return {
      success: true,
      eligible: eligible,
      currentTime: currentTimeStr,
      status: status,
      message: message,
      warningType: warningType,
      thresholds: {
        onTime: 'Before 09:30',
        warning: '09:30 - 09:45',
        late: '09:45 - 11:30',
        halfDay: 'After 11:30'
      }
    };
  } catch (error) {
    console.error('Error checking login eligibility:', error);
    return {
      success: false,
      eligible: true,
      message: 'Error checking eligibility, but login allowed.',
      warningType: 'none'
    };
  }
}

function getLoginStatusSummary() {
  try {
    const now = new Date();
    const currentHours = now.getHours();
    const currentMinutes = now.getMinutes();
    const currentTotalMinutes = currentHours * 60 + currentMinutes;
    
    // Define thresholds
    const thresholds = {
      onTime: { start: 0, end: 9 * 60 + 30, status: 'Present', code: ATTENDANCE_CODES.PRESENT, message: 'On Time' },
      warning: { start: 9 * 60 + 30, end: 9 * 60 + 45, status: 'Present (Warning)', code: ATTENDANCE_CODES.PRESENT, message: 'Warning Period - Still Present' },
      late: { start: 9 * 60 + 45, end: 11 * 60 + 30, status: 'Late', code: ATTENDANCE_CODES.LATE, message: 'Late Coming' },
      halfDay: { start: 11 * 60 + 30, end: 24 * 60, status: 'Half Day', code: ATTENDANCE_CODES.HALF_DAY, message: 'Half Day' }
    };
    
    let currentStatus = 'After Hours';
    let currentCode = '';
    let currentMessage = 'Login not available at this time';
    
    for (const [key, threshold] of Object.entries(thresholds)) {
      if (currentTotalMinutes >= threshold.start && currentTotalMinutes < threshold.end) {
        currentStatus = threshold.status;
        currentCode = threshold.code;
        currentMessage = threshold.message;
        break;
      }
    }
    
    // Check for Sunday/holiday
    const dayOfWeek = now.getDay();
    const holidayInfo = getHolidayForDate(now);
    
    if (dayOfWeek === 0 || holidayInfo) {
      currentStatus = dayOfWeek === 0 ? 'Sunday' : 'Holiday';
      currentMessage = dayOfWeek === 0 ? 'Today is Sunday' : `Today is ${holidayInfo?.holidayName || 'Holiday'}`;
      currentCode = ATTENDANCE_CODES.HOLIDAY;
    }
    
    return {
      success: true,
      currentTime: Utilities.formatDate(now, getScriptTimezone(), 'HH:mm:ss'),
      currentDate: formatDate(now),
      currentStatus: currentStatus,
      currentCode: currentCode,
      currentMessage: currentMessage,
      thresholds: {
        onTime: 'Before 09:30',
        warning: '09:30 - 09:45',
        late: '09:45 - 11:30',
        halfDay: 'After 11:30'
      },
      note: "Missing logout at end of day will be automatically marked as Half Day"
    };
  } catch (error) {
    console.error('Error getting login status summary:', error);
    return {
      success: false,
      currentTime: 'Unknown',
      currentStatus: 'Unknown',
      message: 'Error getting status'
    };
  }
}

// Add this function to your Code.gs file
function getAllStaffIds() {
  try {
    const staffList = getAllStaff();
    return staffList.map(staff => staff.staffId);
  } catch (error) {
    console.error('Error getting staff IDs:', error);
    return [];
  }
}

// ========== AUTOMATED MONTHLY ATTENDANCE SHEET CREATION ==========

/**
 * Creates attendance sheet for the current month
 * This function is designed to be triggered automatically
 */
function createCurrentMonthAttendanceSheetAuto() {
  try {
    const now = new Date();
    const month = getMonthName(now.getMonth() + 1);
    const year = now.getFullYear();
    
    console.log(`Attempting to auto-create attendance sheet for ${month} ${year}`);
    
    // Check if sheet already exists
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = `Attendance_${month}_${year}`;
    const existingSheet = ss.getSheetByName(sheetName);
    
    if (existingSheet) {
      const message = `Attendance sheet for ${month} ${year} already exists. Skipping creation.`;
      console.log(message);
      return { success: true, message: message, skipped: true };
    }
    
    // Create the attendance sheet
    const result = createMonthlyAttendanceSheet(month, year);
    
    // Log the result
    if (result.success) {
      console.log(`Successfully auto-created attendance sheet for ${month} ${year}`);
      
      // Optional: Send notification to admin
      sendAttendanceSheetCreationNotification(month, year, result);
    } else {
      console.error(`Failed to auto-create attendance sheet: ${result.message}`);
    }
    
    return result;
  } catch (error) {
    console.error('Error in auto attendance sheet creation:', error);
    return { 
      success: false, 
      message: 'Auto-creation failed: ' + error.message 
    };
  }
}

/**
 * Creates attendance sheet for the next month
 * Useful for running at the end of current month
 */
function createNextMonthAttendanceSheetAuto() {
  try {
    const now = new Date();
    let month = now.getMonth() + 2; // Next month
    let year = now.getFullYear();
    
    if (month > 12) {
      month = 1;
      year++;
    }
    
    const monthName = getMonthName(month);
    console.log(`Attempting to auto-create attendance sheet for next month: ${monthName} ${year}`);
    
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = `Attendance_${monthName}_${year}`;
    const existingSheet = ss.getSheetByName(sheetName);
    
    if (existingSheet) {
      const message = `Attendance sheet for ${monthName} ${year} already exists. Skipping creation.`;
      console.log(message);
      return { success: true, message: message, skipped: true };
    }
    
    const result = createMonthlyAttendanceSheet(monthName, year);
    
    if (result.success) {
      console.log(`Successfully auto-created next month's attendance sheet: ${monthName} ${year}`);
    }
    
    return result;
  } catch (error) {
    console.error('Error in next month auto attendance sheet creation:', error);
    return { 
      success: false, 
      message: 'Next month auto-creation failed: ' + error.message 
    };
  }
}

/**
 * Sends a notification email about attendance sheet creation
 */
function sendAttendanceSheetCreationNotification(month, year, result) {
  try {
    const adminEmail = Session.getActiveUser().getEmail();
    if (!adminEmail) return;
    
    const subject = `Attendance Sheet Created: ${month} ${year}`;
    const body = `
      Attendance sheet for ${month} ${year} has been automatically created.
      
      Details:
      - Month: ${month} ${year}
      - Total Days: ${result.totalDays}
      - Sundays: ${result.sundays}
      - Holidays: ${result.holidays}
      - Working Days: ${result.workingDays}
      - Staff Added: ${result.staffAdded}
      - Total Staff: ${result.totalStaff}
      
      Generated on: ${new Date().toLocaleString()}
      
      This is an automated message from the Staff Salary Management System.
    `;
    
    MailApp.sendEmail(adminEmail, subject, body);
    console.log('Notification email sent to:', adminEmail);
  } catch (error) {
    console.error('Error sending notification email:', error);
  }
}

/**
 * Checks and creates missing attendance sheets
 * Can be run as a weekly/monthly maintenance function
 */
function checkAndCreateMissingAttendanceSheets() {
  try {
    const now = new Date();
    const results = [];
    
    // Check current month
    const currentMonth = getMonthName(now.getMonth() + 1);
    const currentYear = now.getFullYear();
    
    let currentMonthResult = checkAndCreateSingleSheet(currentMonth, currentYear);
    results.push(currentMonthResult);
    
    // Check next month (if we're in the last week of current month)
    const dayOfMonth = now.getDate();
    const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
    
    if (dayOfMonth > daysInMonth - 7) { // Last week of month
      let nextMonth = now.getMonth() + 2;
      let nextYear = now.getFullYear();
      
      if (nextMonth > 12) {
        nextMonth = 1;
        nextYear++;
      }
      
      const nextMonthName = getMonthName(nextMonth);
      let nextMonthResult = checkAndCreateSingleSheet(nextMonthName, nextYear);
      results.push(nextMonthResult);
    }
    
    // Check previous month (if missing)
    let prevMonth = now.getMonth();
    let prevYear = now.getFullYear();
    
    if (prevMonth === 0) {
      prevMonth = 12;
      prevYear--;
    }
    
    const prevMonthName = getMonthName(prevMonth);
    let prevMonthResult = checkAndCreateSingleSheet(prevMonthName, prevYear);
    if (prevMonthResult.created) {
      results.push(prevMonthResult);
    }
    
    const created = results.filter(r => r.created).length;
    const skipped = results.filter(r => !r.created).length;
    
    return {
      success: true,
      message: `Checked ${results.length} months. Created: ${created}, Skipped: ${skipped}`,
      details: results
    };
  } catch (error) {
    console.error('Error checking missing sheets:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

/**
 * Helper function to check and create a single month's sheet
 */
function checkAndCreateSingleSheet(month, year) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = `Attendance_${month}_${year}`;
    const existingSheet = ss.getSheetByName(sheetName);
    
    if (existingSheet) {
      return { month, year, created: false, message: 'Already exists' };
    }
    
    const result = createMonthlyAttendanceSheet(month, year);
    
    return {
      month,
      year,
      created: result.success,
      message: result.success ? 'Created' : 'Failed',
      details: result
    };
  } catch (error) {
    return { month, year, created: false, message: 'Error: ' + error.message };
  }
}

/**
 * Creates attendance sheets for the entire year
 * Useful for year-end planning or initialization
 */
function createFullYearAttendanceSheets(year) {
  try {
    const results = [];
    const months = [
      'January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'
    ];
    
    for (const month of months) {
      const result = createMonthlyAttendanceSheet(month, year);
      results.push({
        month: month,
        year: year,
        success: result.success,
        message: result.message
      });
      
      // Add small delay to avoid rate limiting
      Utilities.sleep(1000);
    }
    
    const successCount = results.filter(r => r.success).length;
    
    return {
      success: true,
      message: `Created ${successCount} out of 12 attendance sheets for ${year}`,
      details: results
    };
  } catch (error) {
    console.error('Error creating full year sheets:', error);
    return { success: false, message: 'Error: ' + error.message };
  }
}

// ========== DAILY ATTENDANCE DASHBOARD FUNCTIONS ==========

function getDailyAttendanceDashboard(dateString) {
  try {
    Logger.log('getDailyAttendanceDashboard called with dateString: ' + dateString);
    
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    // Parse the date string (YYYY-MM-DD format)
    let targetDate;
    if (dateString && typeof dateString === 'string') {
      const dateParts = dateString.split('-');
      if (dateParts.length === 3) {
        // Create date in local timezone
        targetDate = new Date(
          parseInt(dateParts[0]), 
          parseInt(dateParts[1]) - 1, 
          parseInt(dateParts[2])
        );
      } else {
        targetDate = new Date();
      }
    } else {
      targetDate = new Date();
    }
    
    // Format date for display
    const dateStr = Utilities.formatDate(targetDate, Session.getScriptTimeZone(), 'yyyy-MM-dd');
    const dayOfWeek = targetDate.getDay();
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const dayName = dayNames[dayOfWeek];
    
    Logger.log('Processing date: ' + dateStr + ', Day: ' + dayName);
    
    // Get all staff
    const staffList = getAllStaff();
    
    // Sort staff by Staff ID numerically (T001, T002, etc.)
    staffList.sort((a, b) => {
      const idA = a.staffId || '';
      const idB = b.staffId || '';
      
      // Extract numeric part for proper numerical sorting
      const numA = parseInt(idA.replace(/\D/g, '')) || 0;
      const numB = parseInt(idB.replace(/\D/g, '')) || 0;
      
      if (numA !== numB) {
        return numA - numB;
      }
      
      // If numbers are equal, sort alphabetically
      return idA.localeCompare(idB);
    });
    
    Logger.log('Total staff found: ' + staffList.length);
    
    // Get QR tracking data for the date
    const qrTrackingSheet = ss.getSheetByName(SHEET_NAMES.QR_TRACKING);
    const qrTrackingData = [];
    
    if (qrTrackingSheet && qrTrackingSheet.getLastRow() > 1) {
      const qrData = qrTrackingSheet.getDataRange().getValues();
      for (let i = 1; i < qrData.length; i++) {
        const row = qrData[i];
        let rowDate = '';
        
        if (row[0] instanceof Date) {
          rowDate = Utilities.formatDate(row[0], Session.getScriptTimeZone(), 'yyyy-MM-dd');
        } else if (typeof row[0] === 'string') {
          rowDate = row[0];
        } else {
          rowDate = String(row[0] || '');
        }
        
        if (rowDate === dateStr && row[1]) {
          // Get login and logout times - ensure they are just time strings
          let loginTime = '';
          let logoutTime = '';
          
          // Handle login time (column 4 - index 4)
          if (row[4]) {
            if (row[4] instanceof Date) {
              // If it's a Date object, format just the time
              loginTime = Utilities.formatDate(row[4], Session.getScriptTimeZone(), 'HH:mm:ss');
            } else if (typeof row[4] === 'string') {
              // If it's a string, check if it contains a date
              if (row[4].includes(' ')) {
                loginTime = row[4].split(' ')[1];
              } else {
                loginTime = row[4];
              }
            } else {
              loginTime = String(row[4] || '');
            }
          }
          
          // Handle logout time (column 5 - index 5)
          if (row[5]) {
            if (row[5] instanceof Date) {
              // If it's a Date object, format just the time
              logoutTime = Utilities.formatDate(row[5], Session.getScriptTimeZone(), 'HH:mm:ss');
            } else if (typeof row[5] === 'string') {
              // If it's a string, check if it contains a date
              if (row[5].includes(' ')) {
                logoutTime = row[5].split(' ')[1];
              } else {
                logoutTime = row[5];
              }
            } else {
              logoutTime = String(row[5] || '');
            }
          }
          
          // Handle total minutes (column 6 - index 6)
          let totalMinutes = 0;
          if (row[6]) {
            if (typeof row[6] === 'number') {
              totalMinutes = row[6];
            } else if (typeof row[6] === 'string') {
              totalMinutes = parseInt(row[6]) || 0;
            }
          }
          
          qrTrackingData.push({
            staffId: row[1],
            loginTime: loginTime,
            logoutTime: logoutTime,
            totalMinutes: totalMinutes,
            status: row[7] || '',
            attendanceCode: row[8] || '',
            remarks: row[9] || ''
          });
        }
      }
    }
    
    Logger.log('QR tracking records found: ' + qrTrackingData.length);
    
    // Get leaves data for the date
    const leavesSheet = ss.getSheetByName(SHEET_NAMES.LEAVES);
    const approvedLeaves = [];
    
    if (leavesSheet && leavesSheet.getLastRow() > 1) {
      const leavesData = leavesSheet.getRange(2, 1, leavesSheet.getLastRow() - 1, 14).getValues();
      for (let i = 0; i < leavesData.length; i++) {
        const row = leavesData[i];
        if (row[10] === 'Approved') { // Status
          const leaveStart = new Date(row[5]);
          const leaveEnd = new Date(row[6]);
          
          // Compare dates properly
          const checkDate = new Date(targetDate);
          checkDate.setHours(0, 0, 0, 0);
          
          const startDate = new Date(leaveStart);
          startDate.setHours(0, 0, 0, 0);
          
          const endDate = new Date(leaveEnd);
          endDate.setHours(0, 0, 0, 0);
          
          if (checkDate >= startDate && checkDate <= endDate) {
            approvedLeaves.push({
              staffId: row[1],
              leaveType: row[4],
              numberOfDays: row[7]
            });
          }
        }
      }
    }
    
    Logger.log('Approved leaves found: ' + approvedLeaves.length);
    
    // Get holidays for the date
    const holidayInfo = getHolidayForDate(targetDate);
    const isSunday = dayOfWeek === 0;
    const isHoliday = !!holidayInfo;
    
    // Build dashboard data
    const dashboard = [];
    
    for (const staff of staffList) {
      const attendance = qrTrackingData.find(q => q.staffId === staff.staffId);
      const leave = approvedLeaves.find(l => l.staffId === staff.staffId);
      
      let status = '';
      let attendanceCode = '';
      let loginTime = '';
      let logoutTime = '';
      let totalHours = '';
      let remarks = '';
      
      if (isSunday) {
        status = 'Holiday (Sunday)';
        attendanceCode = ATTENDANCE_CODES.HOLIDAY;
        remarks = 'Sunday - No Work';
      } else if (isHoliday) {
        status = `Holiday (${holidayInfo.holidayName})`;
        attendanceCode = ATTENDANCE_CODES.HOLIDAY;
        remarks = holidayInfo.reason || 'Public Holiday';
      } else if (leave) {
        status = `On Leave (${leave.leaveType})`;
        attendanceCode = leave.leaveType && leave.leaveType.toLowerCase().includes('half') 
          ? ATTENDANCE_CODES.HALF_DAY 
          : ATTENDANCE_CODES.FULL_DAY_LEAVE;
        remarks = `Approved ${leave.leaveType}`;
      } else if (attendance) {
        loginTime = attendance.loginTime || '';
        logoutTime = attendance.logoutTime || '';
        
        if (attendance.totalMinutes) {
          const hours = Math.floor(attendance.totalMinutes / 60);
          const minutes = attendance.totalMinutes % 60;
          totalHours = `${hours}h ${minutes}m`;
        }
        
        status = attendance.status || 'Present';
        attendanceCode = attendance.attendanceCode || ATTENDANCE_CODES.PRESENT;
        remarks = attendance.remarks || '';
      } else {
        status = 'Absent';
        attendanceCode = ATTENDANCE_CODES.ABSENT;
        remarks = 'No attendance recorded';
      }
      
      dashboard.push({
        staffId: staff.staffId,
        name: staff.name,
        department: staff.department || 'N/A',
        designation: staff.designation || 'N/A',
        staffType: staff.staffType || 'N/A',
        photoUrl: staff.photoUrl || '',
        status: status,
        attendanceCode: attendanceCode,
        loginTime: loginTime,
        logoutTime: logoutTime,
        totalHours: totalHours,
        remarks: remarks,
        isSunday: isSunday,
        isHoliday: isHoliday,
        holidayName: isHoliday ? holidayInfo?.holidayName : '',
        leaveType: leave?.leaveType || ''
      });
    }
    
    // Staff is already sorted by ID from above
    
    // Calculate summary statistics
    const summary = {
      present: dashboard.filter(d => d.attendanceCode === ATTENDANCE_CODES.PRESENT).length,
      late: dashboard.filter(d => d.attendanceCode === ATTENDANCE_CODES.LATE).length,
      absent: dashboard.filter(d => d.attendanceCode === ATTENDANCE_CODES.ABSENT).length,
      halfDay: dashboard.filter(d => d.attendanceCode === ATTENDANCE_CODES.HALF_DAY).length,
      fullDayLeave: dashboard.filter(d => d.attendanceCode === ATTENDANCE_CODES.FULL_DAY_LEAVE).length,
      holiday: dashboard.filter(d => d.attendanceCode === ATTENDANCE_CODES.HOLIDAY).length
    };
    
    Logger.log('Dashboard built successfully. Summary:', summary);
    
    return {
      success: true,
      date: dateStr,
      dayOfWeek: dayOfWeek,
      dayName: dayName,
      isSunday: isSunday,
      isHoliday: isHoliday,
      holidayName: isHoliday ? holidayInfo?.holidayName : '',
      staff: dashboard,
      summary: summary
    };
    
  } catch (error) {
    Logger.log('Error in getDailyAttendanceDashboard: ' + error.toString());
    Logger.log('Stack: ' + error.stack);
    
    return { 
      success: false, 
      message: 'Error loading attendance data: ' + error.toString()
    };
  }
}

function getTodayAttendanceDashboard() {
  const today = new Date();
  return getDailyAttendanceDashboard(today);
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Salary Management System</title>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- QR Code Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Add after other libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* CSS remains exactly the same as in your original code */
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --info: #4895ef;
            --warning: #f72585;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --gray-light: #adb5bd;
            --white: #ffffff;
            --sidebar-width: 220px;
            --header-height: 60px;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.5;
            font-size: 14px;
        }

        /* Login Page Styles */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 15px;
        }

        .login-card {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 400px;
            padding: 30px;
            text-align: center;
        }

        .login-logo {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            border-radius: 50%;
            background: var(--white);
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-logo img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .login-title {
            color: var(--dark);
            margin-bottom: 8px;
            font-size: 20px;
            font-weight: 700;
        }

        .login-subtitle {
            color: var(--gray);
            margin-bottom: 25px;
            font-size: 14px;
        }

        .login-form {
            text-align: left;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--dark);
            font-size: 13px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: var(--transition);
            background-color: var(--white);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.15);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--white);
            width: 100%;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: var(--gray-light);
            color: var(--white);
        }

        .btn-secondary:hover {
            background-color: var(--gray);
        }

        .btn-success {
            background-color: var(--success);
            color: var(--white);
        }

        .btn-warning {
            background-color: var(--warning);
            color: var(--white);
        }

        .btn-danger {
            background-color: var(--danger);
            color: var(--white);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .login-error {
            background: rgba(230, 57, 70, 0.1);
            color: var(--danger);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
            border-left: 3px solid var(--danger);
            font-size: 13px;
        }

        .default-login-info {
            margin-top: 15px;
            padding: 10px;
            background: rgba(76, 201, 240, 0.1);
            border-radius: 6px;
            font-size: 13px;
            color: var(--info);
            border-left: 3px solid var(--info);
        }

        /* Main Application Layout */
        #mainApp, #staffApp {
            display: none;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--white);
            box-shadow: var(--box-shadow);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: var(--transition);
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-logo {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--white);
            padding: 4px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
        }

        .sidebar-logo img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark);
        }

        .sidebar-nav {
            padding: 15px 0;
        }

        .nav-item {
            margin-bottom: 2px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            color: var(--gray);
            text-decoration: none;
            transition: var(--transition);
            font-weight: 500;
            font-size: 13px;
        }

        .nav-link:hover, .nav-link.active {
            background-color: rgba(67, 97, 238, 0.08);
            color: var(--primary);
            border-right: 2px solid var(--primary);
        }

        .nav-link i {
            margin-right: 10px;
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 15px;
            transition: var(--transition);
        }

        .header {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 12px 18px;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .page-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-details {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }

        .user-role {
            font-size: 12px;
            color: var(--gray);
        }

        .btn-logout {
            background: rgba(230, 57, 70, 0.1);
            color: var(--danger);
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 12px;
        }

        .btn-logout:hover {
            background: var(--danger);
            color: var(--white);
        }

        /* Content Cards */
        .content-card {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 18px;
            margin-bottom: 18px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title i {
            color: var(--primary);
        }

        /* Dashboard Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--white);
        }

        .stat-icon.blue {
            background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
        }

        .stat-icon.green {
            background: linear-gradient(135deg, #4cc9f0 0%, #4895ef 100%);
        }

        .stat-icon.purple {
            background: linear-gradient(135deg, var(--secondary) 0%, #b5179e 100%);
        }

        .stat-icon.orange {
            background: linear-gradient(135deg, #f72585 0%, #e63946 100%);
        }

        .stat-info {
            flex: 1;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 3px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--gray);
        }

        /* Form Styles */
        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
            min-width: 180px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 18px;
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            font-size: 13px;
            border: 1px solid #e2e8f0;
        }

        .data-table th {
            background-color: #4361ee;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #3a56d4;
        }

        .data-table td {
            padding: 10px;
            border: 1px solid #e2e8f0;
        }

        .data-table tr:hover {
            background-color: #f8fafc;
        }

        .data-table tfoot tr {
            background-color: #f8f9fa;
            font-weight: 700;
        }

        /* Currency alignment */
        .currency {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        /* Report specific styles */
        .a4-report-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #4361ee;
        }

        .school-logo-report {
            width: 60px;
            height: 60px;
            margin: 0 auto 10px;
            border-radius: 50%;
            background: var(--white);
            padding: 4px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .school-logo-report img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .school-name-report {
            font-size: 24px;
            font-weight: 700;
            color: #2c5aa0;
            margin: 10px 0 5px;
        }

        .report-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .report-period {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .summary-grid-a4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-card-a4 {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border-left: 4px solid #4361ee;
        }

        .summary-value-a4 {
            font-size: 20px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .summary-label-a4 {
            font-size: 13px;
            color: #666;
        }

        /* Photo Upload Styles */
        .photo-upload {
            border: 2px dashed #cbd5e0;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            background-color: #f7fafc;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 12px;
        }

        .photo-upload:hover {
            border-color: var(--primary);
            background-color: #edf2f7;
        }

        .photo-upload.dragover {
            border-color: var(--primary);
            background-color: #e6fffa;
        }

        .photo-preview {
            max-width: 120px;
            max-height: 120px;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
            margin: 8px auto;
            display: none;
        }

        .photo-placeholder {
            font-size: 36px;
            color: #a0aec0;
            margin-bottom: 8px;
        }

        /* Message Styles */
        .message {
            padding: 10px 12px;
            margin: 12px 0;
            border-radius: 6px;
            font-weight: 500;
            font-size: 13px;
        }

        .message.success {
            background-color: rgba(76, 201, 240, 0.1);
            color: var(--info);
            border-left: 3px solid var(--info);
        }

        .message.error {
            background-color: rgba(230, 57, 70, 0.1);
            color: var(--danger);
            border-left: 3px solid var(--danger);
        }

        .message.warning {
            background-color: rgba(247, 37, 133, 0.1);
            color: var(--warning);
            border-left: 3px solid var(--warning);
        }

        .message.info {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            border-left: 3px solid var(--primary);
        }

        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(76, 201, 240, 0.1);
            color: var(--info);
        }

        .badge-danger {
            background: rgba(230, 57, 70, 0.1);
            color: var(--danger);
        }

        .badge-warning {
            background: rgba(247, 37, 133, 0.1);
            color: var(--warning);
        }

        .badge-info {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            color: var(--gray);
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(67, 97, 238, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 36px;
            margin-bottom: 12px;
            color: #cbd5e0;
        }

        .empty-state h3 {
            font-size: 16px;
            margin-bottom: 6px;
            color: var(--dark);
        }

        .empty-state p {
            font-size: 13px;
            max-width: 400px;
            margin: 0 auto;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 18px;
            overflow-x: auto;
        }

        .tab-button {
            padding: 10px 18px;
            background: none;
            border: none;
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            font-size: 13px;
        }

        .tab-button:hover {
            color: var(--primary);
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Compact table styles */
        .compact-table {
            font-size: 12px;
        }
        
        .compact-table th, .compact-table td {
            padding: 8px 10px;
        }
        
        /* Compact form styles */
        .compact-form .form-group {
            margin-bottom: 12px;
        }
        
        .compact-form .form-control {
            padding: 8px 10px;
            font-size: 13px;
        }
        
        /* Compact card styles */
        .compact-card {
            padding: 15px;
        }
        
        .compact-card .card-header {
            margin-bottom: 12px;
            padding-bottom: 10px;
        }
        
        /* Small photo preview */
        .staff-photo-small {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }

        .staff-photo {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            object-fit: cover;
            border: 1px solid #e2e8f0;
        }

        /* Action buttons in tables */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            padding: 4px 8px;
            font-size: 11px;
        }

        /* Role-based access */
        .role-principal { display: none; }
        .role-admin { display: none; }
        
        .principal .role-principal,
        .admin .role-admin {
            display: block;
        }

        /* Input group for tables */
        .table-input {
            width: 80px;
            padding: 4px 6px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
        }

        .table-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }

        /* Status indicators */
        .status-submitted {
            color: var(--info);
            font-weight: 600;
        }

        .status-pending {
            color: var(--warning);
            font-weight: 600;
        }

        .attendance-present {
            color: #28a745;
            font-weight: 600;
        }

        .attendance-absent {
            color: #dc3545;
            font-weight: 600;
        }

        .attendance-late {
            color: #ffc107;
            font-weight: 600;
        }

        .attendance-halfday {
            color: #17a2b8;
            font-weight: 600;
        }

        .attendance-fullday {
            color: #6f42c1;
            font-weight: 600;
        }

        /* Summary cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px;
            text-align: center;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 13px;
            color: var(--gray);
        }

        .summary-card.success {
            border-left: 4px solid var(--info);
        }

        .summary-card.warning {
            border-left: 4px solid var(--warning);
        }

        .summary-card.danger {
            border-left: 4px solid var(--danger);
        }

        /* Attendance actions */
        .attendance-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .attendance-date {
            font-weight: 600;
            margin-bottom: 10px;
        }

        /* Sidebar Toggler */
        .sidebar-toggler {
            display: none;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--dark);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }
        
        .sidebar-toggler:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        /* Overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        /* Payment Slip Styles */
        .payment-slip-container {
            font-family: 'Inter', sans-serif;
            background: white;
        }

        .landscape-a5-page {
            width: 210mm;
            height: 148mm;
            background: white;
            position: relative;
            margin: 0 auto;
            display: flex;
            overflow: hidden;
        }

        .receipt-column {
            width: 50%;
            height: 100%;
            padding: 3mm;
            position: relative;
            border-right: 1px dashed #bdc3c7;
        }

        .office-column {
            background: linear-gradient(to right, #f8fbff, white);
        }

        .staff-column {
            background: linear-gradient(to right, #fff8f8, white);
        }

        .receipt-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 2mm;
            padding-bottom: 1mm;
            border-bottom: 1px solid #bdc3c7;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .school-logo-receipt {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: white;
            padding: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .school-name {
            font-size: 8pt;
            font-weight: 700;
            color: #2c5aa0;
        }

        .receipt-title {
            font-size: 9pt;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 1mm;
            text-align: center;
        }

        .receipt-number {
            font-size: 7pt;
            font-weight: 600;
            color: #2c3e50;
            background: #f8f9fa;
            padding: 0.5mm 2mm;
            border-radius: 2mm;
            display: inline-block;
            margin-bottom: 1mm;
        }

        .copy-label {
            position: absolute;
            top: 2mm;
            right: 3mm;
            font-size: 6pt;
            font-weight: 700;
            padding: 0.5mm 2mm;
            border-radius: 1mm;
        }

        .office-copy {
            background-color: #3498db;
            color: white;
        }

        .staff-copy {
            background-color: #e74c3c;
            color: white;
        }

        .content-wrapper {
            display: flex;
            gap: 2mm;
            flex: 1;
            margin-bottom: 1mm;
        }

        .left-section {
            flex: 1;
        }

        .right-section {
            flex: 1;
        }

        .staff-section {
            margin-bottom: 1mm;
        }

        .staff-photo-receipt {
            width: 18mm;
            height: 18mm;
            border-radius: 1mm;
            object-fit: cover;
            border: 1px solid #bdc3c7;
            margin-bottom: 0.5mm;
        }

        .staff-name {
            font-size: 8pt;
            font-weight: 700;
            margin-bottom: 0.3mm;
        }

        .staff-id {
            font-size: 6pt;
            color: #666;
            margin-bottom: 0.3mm;
        }

        .staff-designation {
            font-size: 6pt;
            font-weight: 600;
            background: #f8f9fa;
            padding: 0.2mm 0.8mm;
            border-radius: 1mm;
            display: inline-block;
        }

        .details-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5mm;
            margin-bottom: 1mm;
        }

        .detail-group {
            margin-bottom: 0.5mm;
        }

        .detail-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 0.2mm;
            font-size: 5pt;
        }

        .detail-value {
            font-size: 6pt;
            padding: 0.2mm 0;
            border-bottom: 1px dashed #bdc3c7;
        }

        .compact-financial-section {
            margin: 1mm 0;
            background: #f8f9fa;
            border-radius: 1mm;
            padding: 0.8mm;
            border: 1px solid #e2e8f0;
        }

        .financial-row {
            display: flex;
            gap: 1mm;
            width: 100%;
        }

        .financial-column {
            flex: 1;
            min-width: 0;
        }

        .financial-column.earnings-column {
            border-right: 1px dashed #bdc3c7;
            padding-right: 1mm;
        }

        .financial-column.deductions-column {
            padding-left: 1mm;
        }

        .financial-title {
            font-size: 6pt;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5mm;
            text-align: center;
            background: #e9ecef;
            padding: 0.3mm;
            border-radius: 0.5mm;
        }

        .financial-items {
            display: flex;
            flex-direction: column;
            gap: 0.3mm;
        }

        .financial-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.2mm 0;
            font-size: 5pt;
            border-bottom: 0.5px dashed #e2e8f0;
        }

        .financial-item.main-item {
            font-weight: 600;
            color: #2c3e50;
        }

        .financial-item.total-item {
            font-weight: 700;
            background: #e8f5e8;
            padding: 0.3mm;
            border-radius: 0.3mm;
            margin-top: 0.2mm;
            border-bottom: none;
        }

        .salary-section {
            margin-bottom: 6px;
        }

        .salary-title {
            font-size: 9px;
            font-weight: 700;
            margin-bottom: 4px;
            padding-bottom: 3px;
            border-bottom: 1px solid #bdc3c7;
        }

        .salary-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 3px;
        }

        .salary-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            font-size: 8px;
        }

        .salary-item.total {
            font-weight: 700;
            font-size: 9px;
            border-top: 1px solid #bdc3c7;
            padding-top: 3px;
            margin-top: 3px;
        }

        .salary-highlight {
            background: #e8f5e8;
            border-radius: 4px;
            padding: 6px;
            margin-bottom: 6px;
            border-left: 3px solid var(--success);
        }

        .net-salary-amount {
            font-size: 12px;
            font-weight: 800;
            color: var(--success);
            margin-bottom: 2px;
        }

        .combined-attendance-section {
            margin: 1mm 0;
            padding: 0.8mm;
            background: #f0f8ff;
            border-radius: 1mm;
            border-left: 2px solid #3498db;
        }

        .status-section {
            margin-top: auto;
            padding-top: 0.5mm;
            border-top: 1px solid #bdc3c7;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5mm;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3mm;
            padding: 0.3mm 1.5mm;
            border-radius: 1mm;
            font-weight: 700;
            font-size: 6pt;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .signature-section {
            text-align: center;
            font-size: 5pt;
        }

        .signature-line {
            width: 25mm;
            border-top: 1px solid #bdc3c7;
            margin: 0.5mm auto 0.2mm;
        }

        .footer-note {
            margin-top: 0.5mm;
            font-size: 4pt;
            color: #666;
            text-align: center;
            line-height: 1.1;
        }

        /* QR Scanner Styles */
        .scanner-container {
            max-width: 600px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: slideIn 0.5s ease;
            margin: 20px auto;
        }

        .scanner-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .scanner-header h2 {
            font-size: 24px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .scanner-header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .scanner-preview {
            padding: 20px;
        }

        #qr-reader {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 2px solid #f0f0f0;
            min-height: 300px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #qr-reader video {
            width: 100%;
            border-radius: 12px;
        }

        #qr-reader__scan_region {
            background: #f8f9fa;
            min-height: 300px;
        }

        #qr-reader__dashboard {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        .scanner-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }

        .action-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #f7fafc;
            padding: 10px;
            border-radius: 12px;
        }

        .action-tab {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            color: #718096;
            border: 1px solid #e2e8f0;
        }

        .action-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .action-tab i {
            margin-right: 8px;
        }

        .last-result {
            margin-top: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 12px;
            border-left: 4px solid #48bb78;
            animation: fadeIn 0.5s ease;
        }

        .last-result.error {
            border-left-color: #f56565;
            background: #fff5f5;
        }

        .result-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-title i {
            color: #48bb78;
        }

        .error .result-title i {
            color: #f56565;
        }

        .result-details {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .result-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .result-label {
            width: 120px;
            color: #718096;
            font-weight: 500;
        }

        .result-value {
            flex: 1;
            color: #2d3748;
            font-weight: 600;
        }

        .stats-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
            margin-top: 10px;
        }

        /* QR Generator Styles */
        .qr-generator-container {
            max-width: 1200px;
            margin: 20px auto;
        }

        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .staff-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease;
        }

        .staff-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .staff-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .staff-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }

        .staff-info {
            flex: 1;
        }

        .staff-name {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .staff-id {
            font-size: 14px;
            color: #718096;
            font-family: monospace;
        }

        .staff-details {
            margin-bottom: 15px;
            font-size: 14px;
        }

        .staff-detail {
            display: flex;
            margin-bottom: 8px;
        }

        .detail-label {
            width: 100px;
            color: #718096;
            font-weight: 500;
        }

        .detail-value {
            flex: 1;
            color: #2d3748;
            font-weight: 500;
        }

        .qr-code-container {
            text-align: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            margin-top: 15px;
        }

        #qrcode {
            display: inline-block;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .qr-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .qr-actions button {
            flex: 1;
            padding: 8px;
            font-size: 13px;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .stats {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 20px;
            color: white;
        }

        .note {
            margin-top: 20px;
            padding: 12px;
            background: #ebf8ff;
            border-radius: 8px;
            border-left: 4px solid #4299e1;
            font-size: 13px;
            color: #2c5282;
        }

        .note i {
            margin-right: 8px;
        }

        /* ID Card Generator Styles */
        .id-generator-container {
            max-width: 1400px;
            margin: 20px auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .id-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            padding: 20px;
        }

        .id-card-wrapper {
            perspective: 1000px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .id-card-wrapper:hover {
            transform: scale(1.02);
        }

        .id-card-container {
            position: relative;
            width: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .id-card-wrapper.flipped .id-card-container {
            transform: rotateY(180deg);
        }

        .id-card {
            width: 100%;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backface-visibility: hidden;
            transition: all 0.3s;
            border: 1px solid #e0e0e0;
            overflow: hidden;
        }

        .id-card-front {
            transform: rotateY(0deg);
        }

        .id-card-back {
            transform: rotateY(180deg);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .id-photo-placeholder {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: bold;
            margin: 0 auto;
        }

        .id-photo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .id-card-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 12px;
        }

        .id-card-actions button {
            padding: 6px 12px;
            font-size: 11px;
            border-radius: 20px;
            background: white;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
        }

        .id-card-actions button:hover {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* Professional ID card variations by staff type */
        .id-card.teaching {
            border-top: 4px solid #3498db;
        }

        .id-card.non-teaching {
            border-top: 4px solid #e74c3c;
        }

        .id-card.admin {
            border-top: 4px solid #2ecc71;
        }

        /* Print styles for ID cards */
        @media print {
            .id-card-wrapper {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            
            .id-card {
                box-shadow: none;
                border: 2px solid #000;
            }
            
            .no-print {
                display: none !important;
            }
            
            @page {
                size: auto;
                margin: 0.5cm;
            }
        
            .id-photo-container {
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            .id-photo-img {
                display: block !important;
                width: 100% !important;
                height: 100% !important;
                object-fit: cover !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .id-photo-placeholder {
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }
            
            img {
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .sidebar-toggler {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-group {
                min-width: 100%;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .user-info {
                width: 100%;
                justify-content: space-between;
            }
            
            .action-tabs {
                flex-direction: column;
            }
            
            .staff-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .content-card {
                padding: 16px;
            }
            
            .result-row {
                flex-direction: column;
            }
            
            .result-label {
                width: 100%;
                margin-bottom: 4px;
            }
        }

        /* Daily Attendance Dashboard Styles */
.attendance-dashboard-header {
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white;
    padding: 20px;
    border-radius: var(--border-radius);
    margin-bottom: 20px;
}

.attendance-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.attendance-summary-card {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 15px;
    text-align: center;
    box-shadow: var(--box-shadow);
}

.attendance-summary-card.present {
    border-left: 4px solid #28a745;
}

.attendance-summary-card.absent {
    border-left: 4px solid #dc3545;
}

.attendance-summary-card.late {
    border-left: 4px solid #ffc107;
}

.attendance-summary-card.leave {
    border-left: 4px solid #17a2b8;
}

.attendance-summary-card.holiday {
    border-left: 4px solid #6c757d;
}

.attendance-summary-value {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 5px;
}

.attendance-summary-label {
    font-size: 13px;
    color: var(--gray);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.staff-attendance-row {
    transition: all 0.3s ease;
    cursor: pointer;
}

.staff-attendance-row:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
}

.staff-attendance-row.absent {
    background-color: #fff5f5;
}

.staff-attendance-row.late {
    background-color: #fff9e6;
}

.staff-attendance-row.leave {
    background-color: #e6f3ff;
}

.staff-attendance-row.holiday {
    background-color: #f0f0f0;
}

.staff-photo-thumb {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--primary);
}

.status-badge-daily {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.status-badge-daily.present {
    background-color: #d4edda;
    color: #155724;
}

.status-badge-daily.absent {
    background-color: #f8d7da;
    color: #721c24;
}

.status-badge-daily.late {
    background-color: #fff3cd;
    color: #856404;
}

.status-badge-daily.halfday {
    background-color: #d1ecf1;
    color: #0c5460;
}

.status-badge-daily.leave {
    background-color: #cce5ff;
    color: #004085;
}

.status-badge-daily.holiday {
    background-color: #e2e3e5;
    color: #383d41;
}

.time-display {
    font-family: 'Courier New', monospace;
    font-weight: 600;
}

.attendance-filter-section {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    align-items: center;
}

.attendance-search {
    flex: 1;
    min-width: 250px;
}

.attendance-date-picker {
    width: 200px;
}

.filter-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 8px 15px;
    border-radius: 20px;
    border: 1px solid #e2e8f0;
    background: white;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.3s ease;
}

.filter-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.filter-btn.present.active {
    background: #28a745;
}

.filter-btn.absent.active {
    background: #dc3545;
}

.filter-btn.late.active {
    background: #ffc107;
}

.filter-btn.leave.active {
    background: #17a2b8;
}

.filter-btn.holiday.active {
    background: #6c757d;
}

.export-buttons {
    display: flex;
    gap: 10px;
    margin-left: auto;
}

.attendance-legend {
    display: flex;
    gap: 20px;
    margin: 15px 0;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
}

.legend-color.present { background-color: #d4edda; }
.legend-color.absent { background-color: #f8d7da; }
.legend-color.late { background-color: #fff3cd; }
.legend-color.halfday { background-color: #d1ecf1; }
.legend-color.leave { background-color: #cce5ff; }
.legend-color.holiday { background-color: #e2e3e5; }

.attendance-notes {
    margin-top: 20px;
    padding: 15px;
    background: #fff3cd;
    border-radius: var(--border-radius);
    border-left: 4px solid #856404;
}

.attendance-note-item {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    font-size: 13px;
}

.attendance-note-item i {
    width: 20px;
    color: #856404;
}
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <img src="https://lh3.googleusercontent.com/d/1zxgYSP4m3solH4FLbURzIjXmB_OymF3Z" alt="Success School Logo">
            </div>
            <h1 class="login-title">SUCCESS SCHOOL, INDI</h1>
            <p class="login-subtitle">Staff Salary Management System</p>
            
            <div id="loginError" class="login-error"></div>
            
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" id="username" name="username" class="form-control" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" id="password" name="password" class="form-control" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
            
            <div class="default-login-info">
                <p><strong>Login Options:</strong></p>
                <p> Admin/Principal: Use your admin credentials</p>
                <p> Staff: Use your Staff ID as username and password</p>
            </div>
            
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                <button type="button" class="btn btn-secondary" onclick="showStaffLogin()">
                    <i class="fas fa-user"></i> Staff Login
                </button>
            </div>
        </div>
    </div>

    <!-- Staff Login Page -->
    <div id="staffLoginPage" class="login-container" style="display: none;">
        <div class="login-card">
            <div class="login-logo">
                <img src="https://lh3.googleusercontent.com/d/1zxgYSP4m3solH4FLbURzIjXmB_OymF3Z" alt="Success School Logo">
            </div>
            <h1 class="login-title">SUCCESS SCHOOL, INDI</h1>
            <p class="login-subtitle">Staff Portal - Salary Management System</p>
            
            <div id="staffLoginError" class="login-error"></div>
            
            <form id="staffLoginForm" class="login-form">
                <div class="form-group">
                    <label for="staffId" class="form-label">Staff ID *</label>
                    <input type="text" id="staffId" name="staffId" class="form-control" placeholder="Enter your Staff ID (e.g., T001, NT001)" required>
                </div>
                <div class="form-group">
                    <label for="staffPassword" class="form-label">Password *</label>
                    <input type="password" id="staffPassword" name="staffPassword" class="form-control" placeholder="Enter password" required>
                    <small style="color: #666; font-size: 12px;">Default password: Your Staff ID</small>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Staff Login
                </button>
            </form>
            
            <div class="default-login-info">
                <p><strong>Login Instructions:</strong></p>
                <p> Use your Staff ID as username (e.g., T001, NT001)</p>
                <p> Use your Staff ID as password (first time)</p>
                <p> Contact admin if you forgot your password</p>
            </div>
            
            <div style="margin-top: 15px; text-align: center;">
                <button type="button" class="btn btn-secondary" onclick="showAdminLogin()">
                    <i class="fas fa-user-shield"></i> Admin/Principal Login
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Main Application -->
    <div id="mainApp">
        <div class="app-container">
            <!-- Admin Sidebar -->
            <div class="sidebar" id="adminSidebar">
                <div class="sidebar-header">
                    <div class="sidebar-logo">
                        <img src="https://lh3.googleusercontent.com/d/1zxgYSP4m3solH4FLbURzIjXmB_OymF3Z" alt="Success School Logo">
                    </div>
                    <div class="sidebar-title">Admin Portal</div>
                </div>
                <nav class="sidebar-nav">
                    <div class="nav-item">
                        <a href="#" class="nav-link active" data-tab="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </div>
                    <div class="nav-item role-admin">
                        <a href="#" class="nav-link" data-tab="staff">
                            <i class="fas fa-users"></i>
                            <span>Staff Management</span>
                        </a>
                    </div>
                    <div class="nav-item role-admin">
                        <a href="#" class="nav-link" data-tab="user-management">
                            <i class="fas fa-user-cog"></i>
                            <span>User Management</span>
                        </a>
                    </div>
                    <div class="nav-item role-admin">
                        <a href="#" class="nav-link" data-tab="salary-sheet">
                            <i class="fas fa-file-alt"></i>
                            <span>Salary Sheet</span>
                        </a>
                    </div>
                    <div class="nav-item role-principal">
                        <a href="#" class="nav-link" data-tab="attendance">
                            <i class="fas fa-calendar-check"></i>
                            <span>Daily Attendance</span>
                        </a>
                    </div>
                    <div class="nav-item role-principal">
                        <a href="#" class="nav-link" data-tab="holiday-management">
                            <i class="fas fa-calendar-times"></i>
                            <span>Holiday Management</span>
                        </a>
                    </div>
                    <div class="nav-item role-principal">
                        <a href="#" class="nav-link" data-tab="monthly-attendance">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Monthly Attendance</span>
                        </a>
                    </div>
                    <div class="nav-item role-admin">
                        <a href="#" class="nav-link" data-tab="earnings-management">
                            <i class="fas fa-plus-circle"></i>
                            <span>Earnings</span>
                        </a>
                    </div>
                    <div class="nav-item role-admin">
                        <a href="#" class="nav-link" data-tab="deductions-management">
                            <i class="fas fa-minus-circle"></i>
                            <span>Deductions</span>
                        </a>
                    </div>
                    <div class="nav-item role-admin">
                        <a href="#" class="nav-link" data-tab="payment-slips">
                            <i class="fas fa-receipt"></i>
                            <span>Payment Slips</span>
                        </a>
                    </div>
                    <div class="nav-item role-admin role-principal">
                        <a href="#" class="nav-link" data-tab="leave-management">
                            <i class="fas fa-tasks"></i>
                            <span>Leave Management</span>
                        </a>
                    </div>
                    <div class="nav-item role-admin role-principal">
                        <a href="#" class="nav-link" data-tab="notice-management">
                            <i class="fas fa-bullhorn"></i>
                            <span>Notice Management</span>
                        </a>
                    </div>
                    <div class="nav-item role-admin role-principal">
                        <a href="#" class="nav-link" data-tab="task-management">
                            <i class="fas fa-tasks"></i>
                            <span>Task Management</span>
                        </a>
                    </div>
                    <div class="nav-item role-admin">
                        <a href="#" class="nav-link" data-tab="attendance-timing-config">
                            <i class="fas fa-clock"></i>
                            <span>Attendance Timings</span>
                        </a>
                    </div>
                    <div class="nav-item role-admin role-principal">
                        <a href="#" class="nav-link" data-tab="reports">
                            <i class="fas fa-chart-bar"></i>
                            <span>Reports</span>
                        </a>
                    </div>
                    <!-- Integrated QR Scanner Tab -->
                    <div class="nav-item role-admin role-principal">
                        <a href="#" class="nav-link" data-tab="qr-scanner">
                            <i class="fas fa-qrcode"></i>
                            <span>QR Scanner</span>
                        </a>
                    </div>
                    <!-- Integrated QR Generator Tab -->
                    <div class="nav-item role-admin">
                        <a href="#" class="nav-link" data-tab="qr-generator">
                            <i class="fas fa-qrcode"></i>
                            <span>QR Generator</span>
                        </a>
                    </div>
                    <!-- Integrated ID Card Generator Tab -->
                    <div class="nav-item role-admin role-principal">
                        <a href="#" class="nav-link" data-tab="id-card-generator">
                            <i class="fas fa-id-card"></i>
                            <span>ID Card Generator</span>
                        </a>
                    </div>
                </nav>
            </div>

            <!-- Admin Main Content -->
            <div class="main-content">
                <div class="header">
                    <div class="header-left">
                        <button class="sidebar-toggler" onclick="toggleSidebar()">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h1 class="page-title" id="pageTitle">Dashboard</h1>
                    </div>
                    <div class="user-info">
                        <div class="user-details">
                            <div class="user-name" id="userDisplayName">Admin User</div>
                            <div class="user-role" id="userRole">Admin</div>
                        </div>
                        <button class="btn btn-logout" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
                
                <!-- All Tab Contents -->
                <!-- Admin Dashboard with Daily Attendance View -->
<div id="dashboard" class="tab-content active">
    <!-- System Overview Stats -->
    <div class="content-card compact-card">
        <div class="card-header">
            <h2 class="card-title"><i class="fas fa-tachometer-alt"></i> System Overview</h2>
            <button class="btn btn-primary btn-sm" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="totalStaff">0</div>
                    <div class="stat-label">Total Staff</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="teachingStaff">0</div>
                    <div class="stat-label">Teaching Staff</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon purple">
                    <i class="fas fa-user-tie"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="nonTeachingStaff">0</div>
                    <div class="stat-label">Non-Teaching Staff</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orange">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="pendingSalarySheets">0</div>
                    <div class="stat-label">Salary Sheets</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Attendance Dashboard -->
    <div class="content-card compact-card">
        <div class="card-header">
            <h2 class="card-title"><i class="fas fa-calendar-check"></i> Daily Attendance Dashboard</h2>
            <div class="export-buttons">
                <button class="btn btn-success btn-sm" onclick="exportAttendanceToExcel()">
                    <i class="fas fa-file-excel"></i> Export
                </button>
                <button class="btn btn-warning btn-sm" onclick="printAttendanceReport()">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
        
        <!-- Date Selection and Filters -->
        <div class="attendance-filter-section">
            <div class="attendance-date-picker">
                <label for="dashboardAttendanceDate" class="form-label">Select Date</label>
                <input type="date" id="dashboardAttendanceDate" class="form-control" 
                       value="" onchange="loadDailyAttendanceDashboard()">
            </div>
            
            <div class="attendance-search">
                <label for="attendanceSearch" class="form-label">Search Staff</label>
                <input type="text" id="attendanceSearch" class="form-control" 
                       placeholder="Search by name, ID, department..." onkeyup="filterAttendanceTable()">
            </div>
            
            <div class="filter-buttons">
                <label class="form-label" style="display: block;">Quick Filters</label>
                <div>
                    <button class="filter-btn active" onclick="filterAttendance('all', this)">All</button>
                    <button class="filter-btn present" onclick="filterAttendance('present', this)">Present</button>
                    <button class="filter-btn late" onclick="filterAttendance('late', this)">Late</button>
                    <button class="filter-btn absent" onclick="filterAttendance('absent', this)">Absent</button>
                    <button class="filter-btn leave" onclick="filterAttendance('leave', this)">On Leave</button>
                    <button class="filter-btn holiday" onclick="filterAttendance('holiday', this)">Holiday</button>
                </div>
            </div>
        </div>
        
        <!-- Attendance Summary Cards -->
        <div id="attendanceSummary" class="attendance-summary-grid">
            <div class="attendance-summary-card present">
                <div class="attendance-summary-value" id="summaryPresent">0</div>
                <div class="attendance-summary-label">Present</div>
            </div>
            <div class="attendance-summary-card late">
                <div class="attendance-summary-value" id="summaryLate">0</div>
                <div class="attendance-summary-label">Late</div>
            </div>
            <div class="attendance-summary-card absent">
                <div class="attendance-summary-value" id="summaryAbsent">0</div>
                <div class="attendance-summary-label">Absent</div>
            </div>
            <div class="attendance-summary-card leave">
                <div class="attendance-summary-value" id="summaryLeave">0</div>
                <div class="attendance-summary-label">On Leave</div>
            </div>
            <div class="attendance-summary-card holiday">
                <div class="attendance-summary-value" id="summaryHoliday">0</div>
                <div class="attendance-summary-label">Holiday</div>
            </div>
        </div>
        
        <!-- Date Info Banner -->
        <div id="attendanceDateInfo" class="attendance-dashboard-header" style="padding: 15px; margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="margin: 0; color: white; font-size: 18px;">
                        <i class="fas fa-calendar-alt"></i> <span id="currentDateDisplay"></span>
                    </h3>
                    <p style="margin: 5px 0 0 0; opacity: 0.9;" id="dateSpecialInfo"></p>
                </div>
                <div>
                    <span id="timingInfo" class="badge" style="background: rgba(255,255,255,0.2); color: white; padding: 5px 10px;"></span>
                </div>
            </div>
        </div>
        
        <!-- Legend -->
        <div class="attendance-legend">
            <div class="legend-item"><span class="legend-color present"></span> Present</div>
            <div class="legend-item"><span class="legend-color late"></span> Late</div>
            <div class="legend-item"><span class="legend-color absent"></span> Absent</div>
            <div class="legend-item"><span class="legend-color halfday"></span> Half Day</div>
            <div class="legend-item"><span class="legend-color leave"></span> On Leave</div>
            <div class="legend-item"><span class="legend-color holiday"></span> Holiday/Sunday</div>
        </div>
        
        <!-- Attendance Table -->
        <div class="table-container" style="margin-top: 20px; overflow-x: auto;">
            <table class="data-table compact-table" id="attendanceDashboardTable">
                <thead>
                    <tr>
                        <th>Photo</th>
                        <th>Staff ID</th>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Designation</th>
                        <th>Staff Type</th>
                        <th>Status</th>
                        <th>Login Time</th>
                        <th>Logout Time</th>
                        <th>Total Hours</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody id="attendanceDashboardBody">
                    <tr>
                        <td colspan="11" class="text-center">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                <p>Loading attendance data...</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Notes Section -->
        <div id="attendanceNotes" class="attendance-notes" style="display: none;">
            <h4 style="margin-top: 0; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Important Notes</h4>
            <div id="notesContent"></div>
        </div>
        
        <!-- Bulk Actions -->
        <div class="form-actions" style="margin-top: 20px;">
            <button class="btn btn-success" onclick="markAllPresentDaily()">
                <i class="fas fa-check-circle"></i> Mark All Present
            </button>
            <button class="btn btn-danger" onclick="markAllAbsentDaily()">
                <i class="fas fa-times-circle"></i> Mark All Absent
            </button>
            <button class="btn btn-primary" onclick="syncWithQRData()">
                <i class="fas fa-sync-alt"></i> Sync with QR Data
            </button>
            <button class="btn btn-warning" onclick="processEndOfDay()">
                <i class="fas fa-clock"></i> Process End of Day
            </button>
        </div>
    </div>

    <!-- Monthly Attendance View (existing) -->
    <div class="content-card compact-card role-admin">
        <div class="card-header">
            <h2 class="card-title"><i class="fas fa-calendar-alt"></i> Monthly Attendance Overview</h2>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="viewAttendanceMonth" class="form-label">Month</label>
                <select id="viewAttendanceMonth" class="form-control" onchange="loadMonthlyAttendanceView()">
                    <option value="">Select Month</option>
                </select>
            </div>
            <div class="form-group">
                <label for="viewAttendanceYear" class="form-label">Year</label>
                <select id="viewAttendanceYear" class="form-control" onchange="loadMonthlyAttendanceView()">
                    <option value="">Select Year</option>
                </select>
            </div>
        </div>
        
        <div id="monthlyAttendanceView"></div>
    </div>
</div>

                <!-- Staff Management Tab -->
                <div id="staff" class="tab-content">
                    <!-- Staff management content remains same -->
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-user-plus"></i> Add New Staff</h2>
                        </div>
                        
                        <form id="staffForm" class="compact-form" onsubmit="return false;">
                            <div class="form-group">
                                <label class="form-label">Staff Photo (Optional)</label>
                                <div class="photo-upload" id="photoUploadArea" onclick="document.getElementById('photoInput').click()">
                                    <div class="photo-placeholder">
                                        <i class="fas fa-camera"></i>
                                    </div>
                                    <div>Click to upload photo or drag & drop</div>
                                    <small style="color: #666;">Recommended: Square image, max 2MB</small>
                                    <img id="photoPreview" class="photo-preview" alt="Photo preview">
                                </div>
                                <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoSelect(event)">
                                <div id="photoActions" style="display: none; text-align: center;">
                                    <button type="button" class="btn btn-danger btn-sm" onclick="removePhoto()">
                                        <i class="fas fa-trash"></i> Remove Photo
                                    </button>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="name" class="form-label">Full Name *</label>
                                    <input type="text" id="name" name="name" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="department" class="form-label">Department *</label>
                                    <select id="department" name="department" class="form-control" required>
                                        <option value="">Select Department</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="designation" class="form-label">Designation *</label>
                                    <select id="designation" name="designation" class="form-control" required>
                                        <option value="">Select Designation</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="staffType" class="form-label">Staff Type *</label>
                                    <select id="staffType" name="staffType" class="form-control" required>
                                        <option value="Teaching">Teaching</option>
                                        <option value="Non-Teaching">Non-Teaching</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="basicSalary" class="form-label">Basic Salary () *</label>
                                    <input type="number" id="basicSalary" name="basicSalary" class="form-control" step="1" min="0" required>
                                </div>
                                <div class="form-group">
                                    <label for="joinDate" class="form-label">Join Date *</label>
                                    <input type="date" id="joinDate" name="joinDate" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" id="email" name="email" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="phone" class="form-label">Phone</label>
                                    <input type="tel" id="phone" name="phone" class="form-control">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="bankAccount" class="form-label">Bank Account Number</label>
                                <input type="text" id="bankAccount" name="bankAccount" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="ifscCode" class="form-label">IFSC Code</label>
                                <input type="text" id="ifscCode" name="ifscCode" class="form-control" placeholder="Enter IFSC code">
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="addStaff()">
                                    <i class="fas fa-plus"></i> Add Staff
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetStaffForm()" id="cancelBtn" style="display: none;">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </form>
                        <div id="staffMessage"></div>
                    </div>

                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-list"></i> Staff List</h2>
                            <button class="btn btn-primary btn-sm" onclick="loadStaff()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div id="staffList"></div>
                    </div>
                </div>

                <!-- User Management Tab -->
                <div id="user-management" class="tab-content">
                    <!-- User management content remains same -->
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-user-plus"></i> Add New User</h2>
                        </div>
                        
                        <form id="userForm" class="compact-form" onsubmit="return false;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="username" class="form-label">Username *</label>
                                    <input type="text" id="username" name="username" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="password" class="form-label">Password *</label>
                                    <input type="password" id="password" name="password" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="role" class="form-label">Role *</label>
                                    <select id="role" name="role" class="form-control" required>
                                        <option value="">Select Role</option>
                                        <option value="Admin">Admin</option>
                                        <option value="Principal">Principal</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="userStatus" class="form-label">Status *</label>
                                    <select id="userStatus" name="status" class="form-control" required>
                                        <option value="Active">Active</option>
                                        <option value="Inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="addUser()">
                                    <i class="fas fa-plus"></i> Add User
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetUserForm()" id="cancelUserBtn" style="display: none;">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </form>
                        <div id="userMessage"></div>
                    </div>

                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-list"></i> User List</h2>
                            <button class="btn btn-primary btn-sm" onclick="loadUsers()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div id="userList"></div>
                    </div>
                </div>

                <!-- Salary Sheet Generation Tab -->
                <div id="salary-sheet" class="tab-content">
                    <!-- Salary sheet content remains same -->
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-file-alt"></i> Generate Monthly Salary Sheet</h2>
                        </div>
                        
                        <form id="salarySheetForm" class="compact-form" onsubmit="return false;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="month" class="form-label">Month *</label>
                                    <select id="month" name="month" class="form-control" required>
                                        <option value="">Select Month</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="year" class="form-label">Year *</label>
                                    <select id="year" name="year" class="form-control" required>
                                        <option value="">Select Year</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="generateSalarySheet()">
                                    <i class="fas fa-file-export"></i> Generate Salary Sheet
                                </button>
                            </div>
                        </form>
                        <div id="salarySheetMessage"></div>
                    </div>

                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-list"></i> Existing Salary Sheets</h2>
                            <button class="btn btn-primary btn-sm" onclick="loadSalarySheets()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div id="salarySheetsList"></div>
                    </div>
                </div>

                <!-- Attendance Timing Configuration Tab -->
                <div id="attendance-timing-config" class="tab-content">
                    <!-- Attendance timing config content remains same -->
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-cog"></i> Attendance Timing Configuration</h2>
                        </div>
                        
                        <div class="message info">
                            <i class="fas fa-info-circle"></i>
                            Configure the time window during which admin users can submit daily attendance.
                        </div>
                        
                        <form id="timingConfigForm" class="compact-form" onsubmit="return false;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="startHour" class="form-label">Start Hour (24-hour) *</label>
                                    <input type="number" id="startHour" name="startHour" class="form-control" min="0" max="23" required>
                                </div>
                                <div class="form-group">
                                    <label for="startMinute" class="form-label">Start Minute *</label>
                                    <input type="number" id="startMinute" name="startMinute" class="form-control" min="0" max="59" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="endHour" class="form-label">End Hour (24-hour) *</label>
                                    <input type="number" id="endHour" name="endHour" class="form-control" min="0" max="23" required>
                                </div>
                                <div class="form-group">
                                    <label for="endMinute" class="form-label">End Minute *</label>
                                    <input type="number" id="endMinute" name="endMinute" class="form-control" min="0" max="59" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Timing Restriction</label>
                                <div style="display: flex; gap: 15px; align-items: center;">
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="radio" id="timingEnabled" name="isEnabled" value="true" checked>
                                        <span>Enabled</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px;">
                                        <input type="radio" id="timingDisabled" name="isEnabled" value="false">
                                        <span>Disabled</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="saveTimingConfig()">
                                    <i class="fas fa-save"></i> Save Configuration
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="loadTimingConfig()">
                                    <i class="fas fa-sync"></i> Reload
                                </button>
                            </div>
                        </form>
                        
                        <div id="timingConfigMessage"></div>
                        
                        <div class="content-card compact-card" id="currentConfigDisplay" style="display: none;">
                            <h3 class="card-title"><i class="fas fa-info-circle"></i> Current Configuration</h3>
                            <div id="currentConfigDetails"></div>
                        </div>
                    </div>

                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-history"></i> Configuration History</h2>
                            <button class="btn btn-primary btn-sm" onclick="loadTimingConfigLogs()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div id="timingConfigLogs"></div>
                    </div>

                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-eye"></i> Real-time Status</h2>
                        </div>
                        <div id="realTimeStatus">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                Loading current status...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Daily Attendance Tab -->
                <div id="attendance" class="tab-content">
                    <!-- Daily attendance content remains same -->
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-calendar-check"></i> Daily Attendance Management</h2>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="attendanceDate" class="form-label">Date *</label>
                                <input type="date" id="attendanceDate" name="attendanceDate" class="form-control" required onchange="loadAttendanceData()">
                            </div>
                        </div>

                        <div id="attendanceDataContainer" style="display: none;">
                            <div class="content-card compact-card">
                                <h3 class="card-title">Attendance for <span id="attendanceDateDisplay"></span></h3>
                                <p>Mark attendance for all staff members.</p>
                                
                                <div class="attendance-actions">
                                    <button type="button" class="btn btn-success btn-sm" onclick="markAllPresent()">
                                        <i class="fas fa-check-circle"></i> All Present
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="markAllAbsent()">
                                        <i class="fas fa-times-circle"></i> All Absent
                                    </button>
                                    <button type="button" class="btn btn-warning btn-sm" onclick="markAllLate()">
                                        <i class="fas fa-clock"></i> All Late
                                    </button>
                                    <button type="button" class="btn btn-info btn-sm" onclick="markAllHalfDay()">
                                        <i class="fas fa-user-clock"></i> All Half Day
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="markAllFullDay()">
                                        <i class="fas fa-calendar-minus"></i> All Full Day
                                    </button>
                                </div>
                                
                                <div class="table-container">
                                    <table class="data-table compact-table" id="attendanceTable">
                                        <thead>
                                            <tr>
                                                <th>Staff ID</th>
                                                <th>Name</th>
                                                <th>Department</th>
                                                <th>Designation</th>
                                                <th>Staff Type</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="attendanceTableBody"></tbody>
                                    </table>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="button" class="btn btn-primary" onclick="submitAttendance()">
                                        <i class="fas fa-paper-plane"></i> Submit Attendance
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="attendanceMessage"></div>
                    </div>
                </div>

                <!-- Holiday Management Tab -->
                <div id="holiday-management" class="tab-content">
                    <!-- Holiday management content remains same -->
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-calendar-times"></i> Add New Holiday</h2>
                        </div>
                        
                        <form id="holidayForm" class="compact-form" onsubmit="return false;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="holidayName" class="form-label">Holiday Name *</label>
                                    <input type="text" id="holidayName" name="holidayName" class="form-control" placeholder="e.g., Diwali Holiday" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="startDate" class="form-label">Start Date *</label>
                                    <input type="date" id="startDate" name="startDate" class="form-control" required onchange="updateEndDateMin()">
                                </div>
                                <div class="form-group">
                                    <label for="endDate" class="form-label">End Date *</label>
                                    <input type="date" id="endDate" name="endDate" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="reason" class="form-label">Reason *</label>
                                <textarea id="reason" name="reason" class="form-control" rows="3" placeholder="Enter reason for holiday..." required></textarea>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="addHoliday()">
                                    <i class="fas fa-plus"></i> Add Holiday
                                </button>
                            </div>
                        </form>
                        <div id="holidayMessage"></div>
                    </div>

                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-list"></i> Holiday List</h2>
                            <button class="btn btn-primary btn-sm" onclick="loadHolidays()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div id="holidaysList"></div>
                    </div>
                </div>

                <!-- Monthly Attendance Tab -->
                <div id="monthly-attendance" class="tab-content">
                    <!-- Monthly attendance content remains same -->
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-calendar-alt"></i> Create Monthly Attendance Sheet</h2>
                        </div>
                        
                        <form id="monthlyAttendanceForm" class="compact-form" onsubmit="return false;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="attendanceMonth" class="form-label">Month *</label>
                                    <select id="attendanceMonth" name="attendanceMonth" class="form-control" required>
                                        <option value="">Select Month</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="attendanceYear" class="form-label">Year *</label>
                                    <select id="attendanceYear" name="attendanceYear" class="form-control" required>
                                        <option value="">Select Year</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="createMonthlyAttendance()">
                                    <i class="fas fa-file-export"></i> Create Monthly Attendance Sheet
                                </button>
                            </div>
                        </form>
                        <div id="monthlyAttendanceMessage"></div>
                    </div>

                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-calendar-check"></i> Daily Attendance Entry</h2>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dailyAttendanceDate" class="form-label">Date *</label>
                                <input type="date" id="dailyAttendanceDate" name="dailyAttendanceDate" class="form-control" required onchange="loadDailyAttendanceData()">
                            </div>
                        </div>

                        <div id="dailyAttendanceDataContainer" style="display: none;">
                            <div class="content-card compact-card">
                                <h3 class="card-title">Daily Attendance for <span id="dailyAttendanceDateDisplay"></span></h3>
                                <p id="dailyAttendanceInfo"></p>
                                
                                <div class="attendance-actions">
                                    <button type="button" class="btn btn-success btn-sm" onclick="markAllPresentDaily()">All Present</button>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="markAllAbsentDaily()">All Absent</button>
                                    <button type="button" class="btn btn-warning btn-sm" onclick="markAllLateDaily()">All Late</button>
                                    <button type="button" class="btn btn-info btn-sm" onclick="markAllHalfDayDaily()">All Half Day</button>
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="markAllFullDayDaily()">All Full Day</button>
                                </div>
                                
                                <div class="table-container">
                                    <table class="data-table compact-table" id="dailyAttendanceTable">
                                        <thead>
                                            <tr>
                                                <th>Staff ID</th>
                                                <th>Name</th>
                                                <th>Department</th>
                                                <th>Designation</th>
                                                <th>Staff Type</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dailyAttendanceTableBody"></tbody>
                                    </table>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="button" class="btn btn-primary" onclick="submitDailyAttendance()">
                                        <i class="fas fa-paper-plane"></i> Submit Daily Attendance
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="dailyAttendanceMessage"></div>
                    </div>
                </div>

                <!-- Earnings Management Tab -->
                <div id="earnings-management" class="tab-content">
                    <!-- Earnings management content remains same -->
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-plus-circle"></i> Submit Additional Earnings</h2>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="earningsMonth" class="form-label">Month *</label>
                                <select id="earningsMonth" name="earningsMonth" class="form-control" required onchange="loadEarningsData()">
                                    <option value="">Select Month</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="earningsYear" class="form-label">Year *</label>
                                <select id="earningsYear" name="earningsYear" class="form-control" required onchange="loadEarningsData()">
                                    <option value="">Select Year</option>
                                </select>
                            </div>
                        </div>

                        <div id="earningsDataContainer" style="display: none;">
                            <div class="content-card compact-card">
                                <h3 class="card-title">Additional Earnings Submission</h3>
                                <p>Enter additional earnings for each staff member. All amounts should be in .</p>
                                
                                <div class="table-container">
                                    <table class="data-table compact-table" id="earningsTable">
                                        <thead>
                                            <tr>
                                                <th>Staff ID</th>
                                                <th>Name</th>
                                                <th>Department</th>
                                                <th>Arrears</th>
                                                <th>Loan</th>
                                                <th>TD</th>
                                                <th>DA</th>
                                                <th>Earning Leave</th>
                                                <th>Other Allowance</th>
                                                <th>Leave Bonus</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="earningsTableBody"></tbody>
                                    </table>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="button" class="btn btn-primary" onclick="submitEarnings()">
                                        <i class="fas fa-paper-plane"></i> Submit Earnings
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="earningsMessage"></div>
                    </div>
                </div>

                <!-- Deductions Management Tab -->
                <div id="deductions-management" class="tab-content">
                    <!-- Deductions management content remains same -->
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-minus-circle"></i> Submit Deductions</h2>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="deductionsMonth" class="form-label">Month *</label>
                                <select id="deductionsMonth" name="deductionsMonth" class="form-control" required onchange="loadDeductionsData()">
                                    <option value="">Select Month</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="deductionsYear" class="form-label">Year *</label>
                                <select id="deductionsYear" name="deductionsYear" class="form-control" required onchange="loadDeductionsData()">
                                    <option value="">Select Year</option>
                                </select>
                            </div>
                        </div>

                        <div id="deductionsDataContainer" style="display: none;">
                            <div class="content-card compact-card">
                                <h3 class="card-title">Deductions Submission</h3>
                                <p>Enter deductions for each staff member. All amounts should be in .</p>
                                
                                <div class="table-container">
                                    <table class="data-table compact-table" id="deductionsTable">
                                        <thead>
                                            <tr>
                                                <th>Staff ID</th>
                                                <th>Name</th>
                                                <th>Department</th>
                                                <th>Loan Recovery</th>
                                                <th>Student Fees</th>
                                                <th>Penalty</th>
                                                <th>Other Deduction</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="deductionsTableBody"></tbody>
                                    </table>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="button" class="btn btn-primary" onclick="submitDeductions()">
                                        <i class="fas fa-paper-plane"></i> Submit Deductions
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="deductionsMessage"></div>
                    </div>
                </div>

                <!-- Payment Slips Tab -->
                <div id="payment-slips" class="tab-content">
                    <!-- Payment slips content remains same -->
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-receipt"></i> Generate Payment Slips</h2>
                        </div>
                        
                        <div class="content-card compact-card">
                            <h3 class="card-title"><i class="fas fa-print"></i> Bulk Payment Slips</h3>
                            <p>Generate payment slips for all teaching staff in one go.</p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="bulkMonth" class="form-label">Month *</label>
                                    <select id="bulkMonth" name="bulkMonth" class="form-control" required>
                                        <option value="">Select Month</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="bulkYear" class="form-label">Year *</label>
                                    <select id="bulkYear" name="bulkYear" class="form-control" required>
                                        <option value="">Select Year</option>
                                    </select>
                                </div>
                                <div class="form-group" style="align-self: flex-end;">
                                    <button type="button" class="btn btn-warning" onclick="generateAllTeachingSlips()">
                                        <i class="fas fa-print"></i> Generate All Teaching Staff Slips
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="content-card compact-card">
                            <h3 class="card-title"><i class="fas fa-user"></i> Individual Payment Slip</h3>
                            <form id="paymentSlipForm" class="compact-form" onsubmit="return false;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="slipStaffId" class="form-label">Staff ID *</label>
                                        <select id="slipStaffId" name="slipStaffId" class="form-control" required onchange="loadSlipStaffDetails(this.value)">
                                            <option value="">Select Staff ID</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="slipMonth" class="form-label">Month *</label>
                                        <select id="slipMonth" name="slipMonth" class="form-control" required>
                                            <option value="">Select Month</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="slipYear" class="form-label">Year *</label>
                                        <select id="slipYear" name="slipYear" class="form-control" required>
                                            <option value="">Select Year</option>
                                        </select>
                                    </div>
                                </div>

                                <div id="slipStaffDetailsContainer" style="display: none;">
                                    <div class="content-card compact-card">
                                        <h3 class="card-title">Staff Details</h3>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <div class="photo-container" style="display: flex; align-items: center; gap: 12px;">
                                                    <img id="slipDetailPhoto" class="staff-photo" src="" alt="Staff Photo" style="width: 60px; height: 60px; border-radius: 6px; object-fit: cover; display: none;">
                                                    <div class="photo-info" style="flex: 1;">
                                                        <div class="form-row">
                                                            <div class="form-group">
                                                                <label class="form-label">Name</label>
                                                                <div class="form-control" id="slipDetailName">-</div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label class="form-label">Department</label>
                                                                <div class="form-control" id="slipDetailDepartment">-</div>
                                                            </div>
                                                        </div>
                                                        <div class="form-row">
                                                            <div class="form-group">
                                                                <label class="form-label">Designation</label>
                                                                <div class="form-control" id="slipDetailDesignation">-</div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label class="form-label">Staff Type</label>
                                                                <div class="form-control" id="slipDetailStaffType">-</div>
                                                            </div>
                                                        </div>
                                                        <div class="form-row">
                                                            <div class="form-group">
                                                                <label class="form-label">Basic Salary</label>
                                                                <div class="form-control" id="slipDetailBasicSalary">-</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="button" class="btn btn-primary" onclick="generatePaymentSlip()">
                                        <i class="fas fa-receipt"></i> Generate Payment Slip
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div id="paymentSlipMessage"></div>
                        <div id="paymentSlipResult"></div>
                    </div>
                </div>

                <!-- Leave Management Tab -->
                <div id="leave-management" class="tab-content">
                    <!-- Leave management content remains same -->
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-tasks"></i> Leave Applications Management</h2>
                            <button class="btn btn-primary btn-sm" onclick="loadAllLeaves()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        
                        <div class="message info">
                            <i class="fas fa-info-circle"></i>
                            You can approve or reject leave applications.
                        </div>
                        
                        <div id="allLeavesList"></div>
                    </div>
                </div>

                <!-- Notice Management Tab -->
                <div id="notice-management" class="tab-content">
                    <!-- Notice management content remains same -->
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-bullhorn"></i> Send Notice</h2>
                        </div>
                        
                        <form id="noticeForm" class="compact-form" onsubmit="return false;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="noticeTitle" class="form-label">Title *</label>
                                    <input type="text" id="noticeTitle" name="title" class="form-control" placeholder="Enter notice title" required>
                                </div>
                                <div class="form-group">
                                    <label for="noticePriority" class="form-label">Priority *</label>
                                    <select id="noticePriority" name="priority" class="form-control" required>
                                        <option value="">Select Priority</option>
                                        <option value="Low">Low</option>
                                        <option value="Medium">Medium</option>
                                        <option value="High">High</option>
                                        <option value="Urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="targetAudience" class="form-label">Target Audience *</label>
                                    <select id="targetAudience" name="targetAudience" class="form-control" required>
                                        <option value="">Select Audience</option>
                                        <option value="All Staff">All Staff</option>
                                        <option value="Teaching Staff">Teaching Staff Only</option>
                                        <option value="Non-Teaching Staff">Non-Teaching Staff Only</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="noticeExpiry" class="form-label">Expiry Date *</label>
                                    <input type="date" id="noticeExpiry" name="expiryDate" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="noticeMessage" class="form-label">Message *</label>
                                <textarea id="noticeMessage" name="message" class="form-control" rows="5" placeholder="Enter notice message..." required></textarea>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="addNotice()">
                                    <i class="fas fa-paper-plane"></i> Send Notice
                                </button>
                            </div>
                        </form>
                        <div id="noticeFormMessage"></div>
                    </div>

                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-list"></i> Sent Notices</h2>
                            <button class="btn btn-primary btn-sm" onclick="loadAllNotices()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div id="allNoticesList"></div>
                    </div>
                </div>

                <!-- Task Management Tab -->
                <div id="task-management" class="tab-content">
                    <!-- Task management content remains same -->
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-tasks"></i> Assign Task</h2>
                        </div>
                        
                        <form id="taskForm" class="compact-form" onsubmit="return false;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="taskTitle" class="form-label">Title *</label>
                                    <input type="text" id="taskTitle" name="title" class="form-control" placeholder="Enter task title" required>
                                </div>
                                <div class="form-group">
                                    <label for="taskPriority" class="form-label">Priority *</label>
                                    <select id="taskPriority" name="priority" class="form-control" required>
                                        <option value="">Select Priority</option>
                                        <option value="Low">Low</option>
                                        <option value="Medium">Medium</option>
                                        <option value="High">High</option>
                                        <option value="Urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="assignedTo" class="form-label">Assign To *</label>
                                    <select id="assignedTo" name="assignedTo" class="form-control" required>
                                        <option value="">Select Staff Member</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="taskDueDate" class="form-label">Due Date *</label>
                                    <input type="date" id="taskDueDate" name="dueDate" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="taskDescription" class="form-label">Description *</label>
                                <textarea id="taskDescription" name="description" class="form-control" rows="4" placeholder="Enter task description..." required></textarea>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="addTask()">
                                    <i class="fas fa-paper-plane"></i> Assign Task
                                </button>
                            </div>
                        </form>
                        <div id="taskFormMessage"></div>
                    </div>

                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-list"></i> Assigned Tasks</h2>
                            <button class="btn btn-primary btn-sm" onclick="loadAllTasks()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div id="allTasksList"></div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reports" class="tab-content">
                    <!-- Reports content remains same -->
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-chart-bar"></i> Salary Reports</h2>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="reportMonth" class="form-label">Month *</label>
                                <select id="reportMonth" name="reportMonth" class="form-control" required>
                                    <option value="">Select Month</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="reportYear" class="form-label">Year *</label>
                                <select id="reportYear" name="reportYear" class="form-control" required>
                                    <option value="">Select Year</option>
                                </select>
                            </div>
                            <div class="form-group" style="align-self: flex-end;">
                                <button type="button" class="btn btn-primary" onclick="generateReport()">
                                    <i class="fas fa-chart-line"></i> Generate Report
                                </button>
                            </div>
                        </div>

                        <div id="reportResult"></div>
                    </div>
                </div>

                <!-- Integrated QR Scanner Tab -->
                <!-- QR Scanner Tab Content -->
<div id="qr-scanner" class="tab-content">
    <div class="scanner-container" style="margin: 0 auto;">
        <div class="scanner-header">
            <h2><i class="fas fa-qrcode"></i> QR Attendance Scanner</h2>
            <p>Scan staff QR codes to mark attendance</p>
            <div class="stats-badge" id="timeDisplay"></div>
        </div>
        
        <div class="scanner-preview">
            <div class="action-tabs">
                <button class="action-tab active" onclick="setQRAction('login', this)">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <button class="action-tab" onclick="setQRAction('logout', this)">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
            
            <div id="qr-reader" style="min-height: 300px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border: 2px dashed #ccc;">
                <div style="text-align: center; color: #666;">
                    <i class="fas fa-camera" style="font-size: 48px; margin-bottom: 10px; color: #999;"></i>
                    <p>Camera preview will appear here</p>
                    <p style="font-size: 12px;">Click "Start Scanner" to begin</p>
                </div>
            </div>
            
            <div class="scanner-controls">
                <button id="startBtn" class="btn btn-primary" onclick="startScannerWithFallback()">
                    <i class="fas fa-camera"></i> Start Scanner
                </button>
                <button id="stopBtn" class="btn btn-danger" onclick="stopScanner()" style="display: none;">
                    <i class="fas fa-stop"></i> Stop Scanner
                </button>
                <button id="manualEntryBtn" class="btn btn-info" onclick="showManualEntryModal()">
                    <i class="fas fa-keyboard"></i> Manual Entry
                </button>
            </div>
            
            <div id="lastResult" class="last-result" style="display: none;"></div>
            
            <div class="note">
                <i class="fas fa-info-circle"></i>
                <strong>Instructions:</strong>
                <ul style="margin-top: 8px; margin-left: 20px;">
                    <li>Select Login or Logout action</li>
                    <li>Click Start Scanner to activate camera</li>
                    <li>Hold QR code steady in front of camera</li>
                    <li>If camera doesn't work, use Manual Entry button</li>
                    <li>Grace period: 15 minutes after 9:00 AM</li>
                    <li>Half day after 30 minutes grace period</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Then add all the JavaScript functions in your script section -->

                <!-- Integrated QR Generator Tab -->
                <div id="qr-generator" class="tab-content">
                    <div class="qr-generator-container">
                        <div class="scanner-header" style="border-radius: 20px 20px 0 0;">
                            <h2><i class="fas fa-qrcode"></i> Staff QR Code Generator</h2>
                            <p>Generate QR codes for staff attendance tracking</p>
                            <div class="stats">
                                <div class="stat-item" id="qrTotalStaff">Loading...</div>
                                <div class="stat-item" id="qrGeneratedCount">Generated: 0</div>
                            </div>
                        </div>
                        
                        <div class="scanner-preview" style="background: white;">
                            <div class="controls no-print" style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px;">
                                <button class="btn btn-primary" onclick="loadAllStaffForQR()">
                                    <i class="fas fa-sync-alt"></i> Refresh Staff List
                                </button>
                                <button class="btn btn-success" onclick="generateAllQRCodes()">
                                    <i class="fas fa-qrcode"></i> Generate All QR Codes
                                </button>
                                <button class="btn btn-warning" onclick="printAllQRCodes()">
                                    <i class="fas fa-print"></i> Print All QR Codes
                                </button>
                            </div>
                            
                            <div class="progress-bar" id="qrProgressBar">
                                <div class="progress-fill" id="qrProgressFill"></div>
                            </div>
                            
                            <div id="qrStaffList" class="staff-grid">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <p>Loading staff data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Integrated ID Card Generator Tab -->
                <div id="id-card-generator" class="tab-content">
                    <div class="id-generator-container">
                        <div class="scanner-header" style="border-radius: 20px 20px 0 0; background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);">
                            <h2><i class="fas fa-id-card"></i> Staff ID Card Generator</h2>
                            <p>Generate professional ID cards with QR codes for staff attendance</p>
                            <div class="stats">
                                <div class="stat-item" id="idTotalStaff">Loading...</div>
                                <div class="stat-item" id="idGeneratedCount">Generated: 0</div>
                            </div>
                        </div>
                        
                        <div class="id-preview-panel" style="background: white; padding: 30px;">
                            <div class="controls no-print" style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-bottom: 30px;">
                                <button class="btn btn-primary" onclick="loadAllStaffForIDCards()">
                                    <i class="fas fa-sync-alt"></i> Refresh Staff List
                                </button>
                                <button class="btn btn-success" onclick="generateAllIDCards()">
                                    <i class="fas fa-id-card"></i> Generate All ID Cards
                                </button>
                                <button class="btn btn-warning" onclick="printAllIDCards()">
                                    <i class="fas fa-print"></i> Print All ID Cards
                                </button>
                                <button class="btn btn-info" onclick="downloadAllIDCards()">
                                    <i class="fas fa-download"></i> Download All (ZIP)
                                </button>
                            </div>
                            
                            <div class="progress-bar" id="idProgressBar" style="display: none;">
                                <div class="progress-fill" id="idProgressFill"></div>
                            </div>
                            
                            <div id="idCardGrid" class="id-card-grid">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <p>Loading staff data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Main Application -->
    <div id="staffApp">
        <div class="app-container">
            <!-- Staff Sidebar -->
            <div class="sidebar" id="staffSidebar">
                <div class="sidebar-header">
                    <div class="sidebar-logo">
                        <img src="https://lh3.googleusercontent.com/d/1zxgYSP4m3solH4FLbURzIjXmB_OymF3Z" alt="Success School Logo">
                    </div>
                    <div class="sidebar-title">Staff Portal</div>
                </div>
                <nav class="sidebar-nav">
                    <div class="nav-item">
                        <a href="#" class="nav-link active" data-tab="staff-dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-tab="staff-profile">
                            <i class="fas fa-user-edit"></i>
                            <span>My Profile</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-tab="staff-idcard">
                            <i class="fas fa-id-card"></i>
                            <span>My ID Card</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-tab="staff-leaves">
                            <i class="fas fa-calendar-minus"></i>
                            <span>Leave Application</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-tab="staff-salary">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>Salary & Payments</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-tab="staff-notices">
                            <i class="fas fa-bullhorn"></i>
                            <span>Notices & Tasks</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-tab="staff-password">
                            <i class="fas fa-lock"></i>
                            <span>Change Password</span>
                        </a>
                    </div>
                </nav>
            </div>

            <!-- Staff Main Content -->
            <div class="main-content">
                <div class="header">
                    <div class="header-left">
                        <button class="sidebar-toggler" onclick="toggleSidebar()">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h1 class="page-title" id="staffPageTitle">Staff Dashboard</h1>
                    </div>
                    <div class="user-info">
                        <div class="user-details">
                            <div class="user-name" id="staffDisplayName">Staff Member</div>
                            <div class="user-role" id="staffDesignation">Staff</div>
                        </div>
                        <button class="btn btn-logout" onclick="staffLogout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
                
                <!-- Staff Notices & Tasks Tab -->
                <div id="staff-notices" class="tab-content">
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-bullhorn"></i> Notices</h2>
                            <button class="btn btn-primary btn-sm" onclick="loadStaffNotices()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div id="staffNoticesList"></div>
                    </div>

                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-tasks"></i> My Tasks</h2>
                            <button class="btn btn-primary btn-sm" onclick="loadStaffTasks()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div id="staffTasksList"></div>
                    </div>
                </div>
                
                <!-- Staff Dashboard Tab -->
                <div id="staff-dashboard" class="tab-content active">
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-tachometer-alt"></i> My Dashboard</h2>
                            <button class="btn btn-primary btn-sm" onclick="loadStaffDashboard()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon blue">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value" id="staffNetSalary">0</div>
                                    <div class="stat-label">Current Month Salary</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon green">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value" id="staffPresentDays">0</div>
                                    <div class="stat-label">Present Days</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon purple">
                                    <i class="fas fa-calendar-minus"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value" id="staffLeaves">0</div>
                                    <div class="stat-label">Approved Leaves</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon orange">
                                    <i class="fas fa-receipt"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value" id="staffPaymentStatus">Pending</div>
                                    <div class="stat-label">Payment Status</div>
                                </div>
                            </div>
                        </div>

                        <div class="content-card compact-card">
                            <h3 class="card-title"><i class="fas fa-bolt"></i> Quick Actions</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <button class="btn btn-primary" onclick="showStaffTab('staff-leaves')">
                                        <i class="fas fa-calendar-plus"></i> Apply for Leave
                                    </button>
                                </div>
                                <div class="form-group">
                                    <button class="btn btn-success" onclick="showStaffTab('staff-salary')">
                                        <i class="fas fa-receipt"></i> Confirm Payment
                                    </button>
                                </div>
                                <div class="form-group">
                                    <button class="btn btn-info" onclick="showStaffTab('staff-profile')">
                                        <i class="fas fa-user-edit"></i> Update Profile
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="content-card compact-card">
                            <h3 class="card-title"><i class="fas fa-history"></i> Recent Activities</h3>
                            <div id="staffRecentActivities">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    Loading activities...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Staff Profile Tab -->
                <div id="staff-profile" class="tab-content">
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-user-edit"></i> My Profile</h2>
                        </div>
                        
                        <form id="staffProfileForm" class="compact-form" onsubmit="return false;">
                            <div class="form-group">
                                <label class="form-label">Profile Photo</label>
                                <div class="photo-upload" id="staffPhotoUploadArea" onclick="document.getElementById('staffPhotoInput').click()">
                                    <div class="photo-placeholder">
                                        <i class="fas fa-camera"></i>
                                    </div>
                                    <div>Click to upload photo</div>
                                    <small style="color: #666;">Recommended: Square image, max 2MB</small>
                                    <img id="staffPhotoPreview" class="photo-preview" alt="Photo preview">
                                </div>
                                <input type="file" id="staffPhotoInput" accept="image/*" style="display: none;" onchange="handleStaffPhotoSelect(event)">
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Staff ID</label>
                                    <input type="text" class="form-control" id="staffProfileId" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="staffProfileName" readonly>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Department</label>
                                    <input type="text" class="form-control" id="staffProfileDepartment" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Designation</label>
                                    <input type="text" class="form-control" id="staffProfileDesignation" readonly>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="staffProfileEmail" class="form-label">Email *</label>
                                    <input type="email" id="staffProfileEmail" name="email" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="staffProfilePhone" class="form-label">Phone *</label>
                                    <input type="tel" id="staffProfilePhone" name="phone" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="staffProfileBankAccount" class="form-label">Bank Account Number</label>
                                <input type="text" id="staffProfileBankAccount" name="bankAccount" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="staffProfileIfscCode" class="form-label">IFSC Code</label>
                                <input type="text" id="staffProfileIfscCode" name="ifscCode" class="form-control" placeholder="Enter IFSC code">
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="updateStaffProfile()">
                                    <i class="fas fa-save"></i> Update Profile
                                </button>
                            </div>
                        </form>
                        <div id="staffProfileMessage"></div>
                    </div>
                </div>

                <!-- Staff Leaves Tab -->
                <div id="staff-leaves" class="tab-content">
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-calendar-plus"></i> Apply for Leave</h2>
                        </div>
                        
                        <form id="leaveApplicationForm" class="compact-form" onsubmit="return false;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="leaveType" class="form-label">Leave Type *</label>
                                    <select id="leaveType" name="leaveType" class="form-control" required>
                                        <option value="">Select Leave Type</option>
                                        <option value="Sick Leave">Sick Leave</option>
                                        <option value="Casual Leave">Casual Leave</option>
                                        <option value="Earned Leave">Earned Leave</option>
                                        <option value="Maternity Leave">Maternity Leave</option>
                                        <option value="Paternity Leave">Paternity Leave</option>
                                        <option value="Emergency Leave">Emergency Leave</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="leaveStartDate" class="form-label">Start Date *</label>
                                    <input type="date" id="leaveStartDate" name="startDate" class="form-control" required onchange="updateLeaveEndDateMin()">
                                </div>
                                <div class="form-group">
                                    <label for="leaveEndDate" class="form-label">End Date *</label>
                                    <input type="date" id="leaveEndDate" name="endDate" class="form-control" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="leaveReason" class="form-label">Reason *</label>
                                <textarea id="leaveReason" name="reason" class="form-control" rows="3" placeholder="Please provide reason for leave..." required></textarea>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="applyForLeave()">
                                    <i class="fas fa-paper-plane"></i> Submit Leave Application
                                </button>
                            </div>
                        </form>
                        <div id="leaveApplicationMessage"></div>
                    </div>

                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-history"></i> My Leave History</h2>
                            <button class="btn btn-primary btn-sm" onclick="loadStaffLeaves()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div id="staffLeavesList"></div>
                    </div>
                </div>

                <!-- Staff Salary & Payments Tab -->
                <div id="staff-salary" class="tab-content">
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-receipt"></i> Confirm Payment Receipt</h2>
                        </div>
                        
                        <form id="paymentConfirmationForm" class="compact-form" onsubmit="return false;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="paymentMonth" class="form-label">Month *</label>
                                    <select id="paymentMonth" name="month" class="form-control" required>
                                        <option value="">Select Month</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="paymentYear" class="form-label">Year *</label>
                                    <select id="paymentYear" name="year" class="form-control" required>
                                        <option value="">Select Year</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="paymentMethod" class="form-label">Payment Method *</label>
                                    <select id="paymentMethod" name="paymentMethod" class="form-control" required>
                                        <option value="">Select Method</option>
                                        <option value="Bank Transfer">Bank Transfer</option>
                                        <option value="Cash">Cash</option>
                                        <option value="Cheque">Cheque</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="paymentSignature" class="form-label">Digital Signature *</label>
                                <input type="text" id="paymentSignature" name="signature" class="form-control" 
                                       placeholder="Type your full name as signature" required>
                                <small style="color: #666;">Type your full name exactly as registered: 
                                    <span id="staffNameHint" style="font-weight:600; color: #007bff;"></span>
                                </small>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-success" onclick="confirmPaymentReceipt()">
                                    <i class="fas fa-check-circle"></i> Confirm Payment Receipt
                                </button>
                            </div>
                        </form>
                        <div id="paymentConfirmationMessage"></div>
                    </div>

                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-history"></i> Payment History</h2>
                            <button class="btn btn-primary btn-sm" onclick="loadStaffPayments()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div id="staffPaymentsList"></div>
                    </div>
                </div>

                <!-- Staff Attendance Tab -->
                <div id="staff-attendance" class="tab-content">
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-calendar-check"></i> My Attendance</h2>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="staffAttendanceMonth" class="form-label">Month</label>
                                <select id="staffAttendanceMonth" name="staffAttendanceMonth" class="form-control" onchange="loadStaffAttendance()">
                                    <option value="">Select Month</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="staffAttendanceYear" class="form-label">Year</label>
                                <select id="staffAttendanceYear" name="staffAttendanceYear" class="form-control" onchange="loadStaffAttendance()">
                                    <option value="">Select Year</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="staffAttendanceData"></div>
                    </div>
                </div>

                <!-- Staff ID Card Tab - FIXED AND PROPERLY PLACED -->
                <div id="staff-idcard" class="tab-content">
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-id-card"></i> My Staff ID Card</h2>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="refreshMyIDCard()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                                <button class="btn btn-success btn-sm" onclick="downloadMyIDCard()">
                                    <i class="fas fa-download"></i> Download
                                </button>
                                <button class="btn btn-info btn-sm" onclick="printMyIDCard()">
                                    <i class="fas fa-print"></i> Print
                                </button>
                            </div>
                        </div>
                        
                        <div class="staff-id-card-container" style="display: flex; justify-content: center; padding: 20px;">
                            <div id="staffPersonalIDCard" class="id-card-wrapper-single" style="width: 350px;">
                                <!-- ID Card will be generated here -->
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <p>Loading your ID card...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="message info" style="margin-top: 20px;">
                            <i class="fas fa-info-circle"></i>
                            <strong>Instructions:</strong>
                            <ul style="margin-top: 8px; margin-left: 20px;">
                                <li>Your ID card contains your photo, staff details, and QR code for attendance</li>
                                <li>Use the QR code to mark your attendance by scanning at the school's QR scanner</li>
                                <li>Download or print your ID card for physical use</li>
                                <li>The back side contains important attendance rules and cautions</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Staff Password Change Tab -->
                <div id="staff-password" class="tab-content">
                    <div class="content-card compact-card">
                        <div class="card-header">
                            <h2 class="card-title"><i class="fas fa-lock"></i> Change Password</h2>
                        </div>
                        
                        <form id="staffPasswordForm" class="compact-form" onsubmit="return false;">
                            <div class="form-group">
                                <label for="currentPassword" class="form-label">Current Password *</label>
                                <input type="password" id="currentPassword" name="currentPassword" class="form-control" required>
                                <small style="color: #666;">Default password is your Staff ID</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="newPassword" class="form-label">New Password *</label>
                                <input type="password" id="newPassword" name="newPassword" class="form-control" required minlength="6">
                                <small style="color: #666;">Minimum 6 characters</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="confirmPassword" class="form-label">Confirm New Password *</label>
                                <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" required>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="changeStaffPassword()">
                                    <i class="fas fa-key"></i> Change Password
                                </button>
                            </div>
                        </form>
                        <div id="staffPasswordMessage"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Payment Slip Template -->
    <div id="paymentSlipTemplate" style="display: none;">
        <!-- Payment slip template HTML remains the same -->
        <div class="payment-slip-container">
            <div class="landscape-a5-page">
                <!-- OFFICE COPY -->
                <div class="receipt-column office-column">
                    <div class="receipt-container">
                        <div class="copy-label office-copy">OFFICE COPY</div>
                        
                        <div class="receipt-header">
                            <div class="school-logo-receipt">
                                <img src="https://lh3.googleusercontent.com/d/1zxgYSP4m3solH4FLbURzIjXmB_OymF3Z" alt="Success School Logo" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">
                            </div>
                            <div class="school-name">SUCCESS SCHOOL, INDI</div>
                        </div>
                        <div class="receipt-title">SALARY PAYMENT SLIP</div>
                        <div class="receipt-number">{receiptNumber}</div>
                        
                        <div class="content-wrapper">
                            <div class="left-section">
                                <div class="staff-section">
                                    {staffPhoto}
                                    <div class="staff-name">{staffName}</div>
                                    <div class="staff-id">ID: {staffId}</div>
                                    <div class="staff-designation">{designation} - {department}</div>
                                </div>
                                
                                <div class="details-grid">
                                    <div class="detail-group">
                                        <div class="detail-label">STAFF TYPE</div>
                                        <div class="detail-value">{staffType}</div>
                                    </div>
                                    <div class="detail-group">
                                        <div class="detail-label">BANK ACCOUNT</div>
                                        <div class="detail-value">{bankAccount}</div>
                                    </div>
                                    <div class="detail-group">
                                        <div class="detail-label">CONTACT</div>
                                        <div class="detail-value">{phone}</div>
                                    </div>
                                    <div class="detail-group">
                                        <div class="detail-label">JOIN DATE</div>
                                        <div class="detail-value">{joinDate}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="right-section">
                                <div class="details-grid">
                                    <div class="detail-group">
                                        <div class="detail-label">PAYMENT PERIOD</div>
                                        <div class="detail-value">{paymentPeriod}</div>
                                    </div>
                                    <div class="detail-group">
                                        <div class="detail-label">PAYMENT DATE</div>
                                        <div class="detail-value">{paymentDate}</div>
                                    </div>
                                    
                                    <div class="combined-attendance-section">
                                        <div class="salary-title">ATTENDANCE SUMMARY</div>
                                        <div class="salary-details">
                                            <div class="salary-item">
                                                <span>Working Days / Present:</span>
                                                <span>{totalDays} / {presentDays}</span>
                                            </div>
                                            <div class="salary-item">
                                                <span>Absent Days:</span>
                                                <span>{absentDays}</span>
                                            </div>
                                            <div class="salary-item">
                                                <span>Late Coming Days:</span>
                                                <span>{lateDays}</span>
                                            </div>
                                            <div class="salary-item">
                                                <span>Half Day Leaves:</span>
                                                <span>{halfDayLeave}</span>
                                            </div>
                                            <div class="salary-item">
                                                <span>Full Day Leaves:</span>
                                                <span>{fullDayLeave}</span>
                                            </div>
                                            <div class="salary-item total">
                                                <span>Attendance %:</span>
                                                <span>{attendancePercentage}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="salary-highlight">
                                    <div class="net-salary-amount">{netSalary}</div>
                                    <div>Net Salary Payable</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="payment-method-section">
                            <div class="salary-title">PAYMENT METHOD</div>
                            <div class="payment-options">
                                <div class="payment-option">
                                    <div class="check-box {onlineChecked}"></div>
                                    <span>Online Transfer</span>
                                </div>
                                <div class="payment-option">
                                    <div class="check-box {cashChecked}"></div>
                                    <span>Cash Payment</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="compact-financial-section">
                            <div class="financial-row">
                                <div class="financial-column earnings-column">
                                    <div class="financial-title">EARNINGS</div>
                                    <div class="financial-items">
                                        <div class="financial-item main-item">
                                            <span>Basic Salary:</span>
                                            <span>{basicSalary}</span>
                                        </div>
                                        {compactEarningsDetails}
                                        <div class="financial-item total-item">
                                            <span>Total Earnings:</span>
                                            <span>{totalEarnings}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="financial-column deductions-column">
                                    <div class="financial-title">DEDUCTIONS</div>
                                    <div class="financial-items">
                                        {compactDeductionsDetails}
                                        <div class="financial-item total-item">
                                            <span>Total Deductions:</span>
                                            <span>{totalDeductions}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="status-section">
                            <div class="status-row">
                                <div>
                                    <div class="detail-label">PAYMENT STATUS</div>
                                    <div class="status-badge status-paid">
                                        <i class="fas fa-check-circle"></i>
                                        PAYMENT PROCESSED
                                    </div>
                                </div>
                                
                                <div class="signature-section">
                                    <div class="signature-line"></div>
                                    <div>Authorized Signature</div>
                                </div>
                            </div>
                            
                            <div class="footer-note">
                                <p>This is an official salary slip. Please keep it for your records.</p>
                                <p>For any queries, contact the school administration.</p>
                                <p>Phone: +91-80-12345678 | Email: accounts@successschool.edu</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- STAFF COPY -->
                <div class="receipt-column staff-column">
                    <div class="receipt-container">
                        <div class="copy-label staff-copy">STAFF COPY</div>
                        
                        <div class="receipt-header">
                            <div class="school-logo-receipt">
                                <img src="https://lh3.googleusercontent.com/d/1zxgYSP4m3solH4FLbURzIjXmB_OymF3Z" alt="Success School Logo" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">
                            </div>
                            <div class="school-name">SUCCESS SCHOOL, INDI</div>
                        </div>
                        <div class="receipt-title">SALARY PAYMENT SLIP</div>
                        <div class="receipt-number">{receiptNumber}</div>
                        
                        <div class="content-wrapper">
                            <div class="left-section">
                                <div class="staff-section">
                                    {staffPhoto}
                                    <div class="staff-name">{staffName}</div>
                                    <div class="staff-id">ID: {staffId}</div>
                                    <div class="staff-designation">{designation} - {department}</div>
                                </div>
                                
                                <div class="details-grid">
                                    <div class="detail-group">
                                        <div class="detail-label">STAFF TYPE</div>
                                        <div class="detail-value">{staffType}</div>
                                    </div>
                                    <div class="detail-group">
                                        <div class="detail-label">BANK ACCOUNT</div>
                                        <div class="detail-value">{bankAccount}</div>
                                    </div>
                                    <div class="detail-group">
                                        <div class="detail-label">CONTACT</div>
                                        <div class="detail-value">{phone}</div>
                                    </div>
                                    <div class="detail-group">
                                        <div class="detail-label">JOIN DATE</div>
                                        <div class="detail-value">{joinDate}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="right-section">
                                <div class="details-grid">
                                    <div class="detail-group">
                                        <div class="detail-label">PAYMENT PERIOD</div>
                                        <div class="detail-value">{paymentPeriod}</div>
                                    </div>
                                    <div class="detail-group">
                                        <div class="detail-label">PAYMENT DATE</div>
                                        <div class="detail-value">{paymentDate}</div>
                                    </div>
                                    
                                    <div class="combined-attendance-section">
                                        <div class="salary-title">ATTENDANCE SUMMARY</div>
                                        <div class="salary-details">
                                            <div class="salary-item">
                                                <span>Working Days / Present:</span>
                                                <span>{totalDays} / {presentDays}</span>
                                            </div>
                                            <div class="salary-item">
                                                <span>Absent Days:</span>
                                                <span>{absentDays}</span>
                                            </div>
                                            <div class="salary-item">
                                                <span>Late Coming Days:</span>
                                                <span>{lateDays}</span>
                                            </div>
                                            <div class="salary-item">
                                                <span>Half Day Leaves:</span>
                                                <span>{halfDayLeave}</span>
                                            </div>
                                            <div class="salary-item">
                                                <span>Full Day Leaves:</span>
                                                <span>{fullDayLeave}</span>
                                            </div>
                                            <div class="salary-item total">
                                                <span>Attendance %:</span>
                                                <span>{attendancePercentage}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="salary-highlight">
                                    <div class="net-salary-amount">{netSalary}</div>
                                    <div>Net Salary Received</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="payment-method-section">
                            <div class="salary-title">PAYMENT METHOD</div>
                            <div class="payment-options">
                                <div class="payment-option">
                                    <div class="check-box {onlineChecked}"></div>
                                    <span>Online Transfer</span>
                                </div>
                                <div class="payment-option">
                                    <div class="check-box {cashChecked}"></div>
                                    <span>Cash Payment</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="compact-financial-section">
                            <div class="financial-row">
                                <div class="financial-column earnings-column">
                                    <div class="financial-title">EARNINGS</div>
                                    <div class="financial-items">
                                        <div class="financial-item main-item">
                                            <span>Basic Salary:</span>
                                            <span>{basicSalary}</span>
                                        </div>
                                        {compactEarningsDetails}
                                        <div class="financial-item total-item">
                                            <span>Total Earnings:</span>
                                            <span>{totalEarnings}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="financial-column deductions-column">
                                    <div class="financial-title">DEDUCTIONS</div>
                                    <div class="financial-items">
                                        {compactDeductionsDetails}
                                        <div class="financial-item total-item">
                                            <span>Total Deductions:</span>
                                            <span>{totalDeductions}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="status-section">
                            <div class="status-row">
                                <div>
                                    <div class="detail-label">PAYMENT STATUS</div>
                                    <div class="status-badge status-paid">
                                        <i class="fas fa-check-circle"></i>
                                        PAYMENT RECEIVED
                                    </div>
                                </div>
                                
                                <div class="signature-section">
                                    <div class="signature-line"></div>
                                    <div>Staff Signature</div>
                                </div>
                            </div>
                            
                            <div class="footer-note">
                                <p>This is an official salary slip. Please keep it for your records.</p>
                                <p>For any queries, contact the school administration.</p>
                                <p>Phone: +91-80-12345678 | Email: accounts@successschool.edu</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentStaff = null;
        let selectedPhoto = null;
        let selectedStaffPhoto = null;
        let isEditingStaff = false;
        let currentEditingStaffId = null;
        let currentEarningsData = {};
        let currentDeductionsData = {};
        let currentAttendanceData = {}; // For daily attendance
        let currentMonthlyAttendanceData = {}; // For monthly attendance
        let currentFilter = 'all';

        // QR Scanner variables
        let html5QrCode = null;
        let currentQRAction = 'login';
        let isScannerInitialized = false;

        // QR Generator variables
        let staffData = [];
        let qrCodesGenerated = 0;

        // ID Card Generator variables
        let idCardStaffData = [];
        let idCardsGenerated = 0;

        // Initialize on page load
        window.onload = function() {
            showAdminLogin();
            initializeApp();
            initializeTimeDisplay();
            
            // Pre-initialize scanner but don't start it
            setTimeout(function() {
                if (typeof Html5Qrcode !== 'undefined') {
                    console.log('QR Scanner library loaded successfully');
                    isScannerInitialized = true;
                } else {
                    console.error('QR Scanner library not loaded');
                }
            }, 1000);
        };

        function initializeApp() {
    loadMonthsYears();
    loadStaff();
    loadStaffIds();
    loadDepartmentsAndDesignations();
    loadDashboard();
    loadSalarySheets();
    loadHolidays();
    loadUsers();
    setupDragAndDrop();
    setupSidebarCloseOnClick();
    
    // Set default date for dashboard to February 20, 2026
    const dashboardDate = document.getElementById('dashboardAttendanceDate');
    if (dashboardDate) {
        dashboardDate.value = '2026-02-20';
    }
    
    // Load initial attendance data for February 20, 2026
    setTimeout(loadDailyAttendanceDashboard, 500);
    
    // IMPORTANT: DO NOT initialize scanner here
    // Scanner will only initialize when user clicks "Start Scanner"
}

        // ========== GOOGLE APPS SCRIPT INTEGRATION ==========
        
        // This function handles all Google Apps Script calls
        function callGoogleScript(functionName, params, successCallback, errorCallback) {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (successCallback) successCallback(result);
                })
                .withFailureHandler(function(error) {
                    console.error('Google Script Error:', error);
                    if (errorCallback) {
                        errorCallback(error);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: error.message || 'An error occurred while communicating with the server'
                        });
                    }
                })
                [functionName](params);
        }

        // ========== NAVIGATION FUNCTIONS ==========

        function showAdminLogin() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('staffLoginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('staffApp').style.display = 'none';
            
            // Stop scanner if running
            stopScanner();
        }

        function showStaffLogin() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('staffLoginPage').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('staffApp').style.display = 'none';
            
            // Stop scanner if running
            stopScanner();
        }

        function showMainApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('staffLoginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('staffApp').style.display = 'none';
            
            document.getElementById('userDisplayName').textContent = currentUser.username;
            document.getElementById('userRole').textContent = currentUser.role;
            
            document.body.className = currentUser.role.toLowerCase();
            
            // Initialize app with fresh data
            setTimeout(function() {
                loadStaff();
                loadStaffIds();
                loadDepartmentsAndDesignations();
                loadDashboard();
            }, 500);
            
            // Stop scanner if running
            stopScanner();
        }

        function showStaffApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('staffLoginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('staffApp').style.display = 'block';
            
            document.getElementById('staffDisplayName').textContent = currentStaff.name;
            document.getElementById('staffDesignation').textContent = currentStaff.designation;
            
            initializeStaffApp();
            
            // Stop scanner if running
            stopScanner();
        }

        function toggleSidebar() {
            const adminSidebar = document.getElementById('adminSidebar');
            const staffSidebar = document.getElementById('staffSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (document.getElementById('mainApp').style.display !== 'none') {
                if (adminSidebar) {
                    adminSidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                }
            } else if (document.getElementById('staffApp').style.display !== 'none') {
                if (staffSidebar) {
                    staffSidebar.classList.toggle('active');
                    overlay.classList.toggle('active');
                }
            }
        }

        function setupSidebarCloseOnClick() {
            const navLinks = document.querySelectorAll('.sidebar-nav .nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 992) {
                        toggleSidebar();
                    }
                });
            });
        }

        window.addEventListener('resize', function() {
            const adminSidebar = document.getElementById('adminSidebar');
            const staffSidebar = document.getElementById('staffSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth > 992) {
                if (adminSidebar) adminSidebar.classList.remove('active');
                if (staffSidebar) staffSidebar.classList.remove('active');
                overlay.classList.remove('active');
            }
        });

        // ========== AUTHENTICATION FUNCTIONS ==========

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response && response.success) {
                        currentUser = response.user;
                        showMainApp();
                    } else {
                        showLoginError(response ? response.message : 'Login failed');
                    }
                })
                .withFailureHandler(function(error) {
                    showLoginError('Login failed: ' + error.message);
                })
                .authenticateUser(username, password);
        });

        document.getElementById('staffLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const staffId = document.getElementById('staffId').value.trim();
            const password = document.getElementById('staffPassword').value;
            
            if (!staffId) {
                showStaffLoginError('Please enter your Staff ID');
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response && response.success) {
                        currentStaff = response.staff;
                        showStaffApp();
                    } else {
                        showStaffLoginError(response ? response.message : 'Login failed');
                    }
                })
                .withFailureHandler(function(error) {
                    showStaffLoginError('Login failed: ' + error.message);
                })
                .authenticateStaff(staffId, password);
        });

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function showStaffLoginError(message) {
            const errorDiv = document.getElementById('staffLoginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function logout() {
            currentUser = null;
            document.getElementById('mainApp').style.display = 'none';
            showAdminLogin();
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').style.display = 'none';
            document.body.className = '';
            
            // Stop scanner if running
            stopScanner();
        }

        function staffLogout() {
            currentStaff = null;
            document.getElementById('staffApp').style.display = 'none';
            showStaffLogin();
            document.getElementById('staffLoginForm').reset();
            document.getElementById('staffLoginError').style.display = 'none';
            
            // Stop scanner if running
            stopScanner();
        }

        // ========== ADMIN NAVIGATION ==========

        document.querySelectorAll('#mainApp .sidebar-nav .nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const tabId = this.getAttribute('data-tab');
                
                if (tabId) {
                    document.querySelectorAll('#mainApp .nav-link').forEach(nav => {
                        nav.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    document.querySelectorAll('#mainApp .tab-content').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');
                    
                    document.getElementById('pageTitle').textContent = this.querySelector('span').textContent;
                    
                    // Special handling for certain tabs
                    if (tabId === 'task-management') {
                        loadAllTasks();
                        loadStaffForTasks();
                    }
                    if (tabId === 'notice-management') {
                        loadAllNotices();
                    }
                    if (tabId === 'attendance-timing-config') {
                        setTimeout(function() {
                            loadTimingConfig();
                            loadTimingConfigLogs();
                            updateRealTimeStatus();
                        }, 100);
                    }
                    if (tabId === 'staff') {
                        setTimeout(function() {
                            loadStaff();
                            loadStaffIds();
                            loadDepartmentsAndDesignations();
                        }, 100);
                    }
                    if (tabId === 'dashboard') {
                        setTimeout(function() {
                            loadDashboard();
                            loadDailyAttendanceDashboard();
                        }, 100);
                    }
                    if (tabId === 'qr-scanner') {
                        setTimeout(function() {
                            // Initialize scanner tab
                            updateTimeDisplay();
                        }, 100);
                    }
                    if (tabId === 'qr-generator') {
                        setTimeout(function() {
                            loadAllStaffForQR();
                        }, 100);
                    }
                    if (tabId === 'id-card-generator') {
                        setTimeout(function() {
                            loadAllStaffForIDCards();
                        }, 100);
                    }
                    
                    // Stop scanner when leaving QR scanner tab
                    if (tabId !== 'qr-scanner') {
                        stopScanner();
                    }
                }
            });
        });

        // ========== STAFF NAVIGATION ==========

        function showStaffTab(tabId) {
            document.querySelectorAll('#staffApp .sidebar-nav .nav-link').forEach(nav => {
                nav.classList.remove('active');
            });
            
            document.querySelectorAll('#staffApp .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelector(`#staffApp [data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            const tabName = document.querySelector(`#staffApp [data-tab="${tabId}"] span`).textContent;
            document.getElementById('staffPageTitle').textContent = tabName;
            
            // Load specific content when tabs are clicked
            if (tabId === 'staff-notices') {
                setTimeout(loadStaffNotices, 100);
                setTimeout(loadStaffTasks, 100);
            } else if (tabId === 'staff-idcard') {
                setTimeout(loadStaffIDCard, 100);
            }
        }

        // ========== STAFF APP INITIALIZATION ==========

        function initializeStaffApp() {
            loadStaffMonthsYears();
            loadStaffDashboard();
            loadStaffProfile();
            loadStaffLeaves();
            loadStaffPayments();
            initializeStaffNameHint();
            loadStaffIDCard();
            setupSidebarCloseOnClick();
            
            document.querySelectorAll('#staffApp .sidebar-nav .nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabId = this.getAttribute('data-tab');
                    showStaffTab(tabId);
                });
            });
            
            const activeTab = document.querySelector('#staffApp .sidebar-nav .nav-link.active');
            if (activeTab) {
                const activeTabId = activeTab.getAttribute('data-tab');
                if (activeTabId === 'staff-notices') {
                    setTimeout(loadStaffNotices, 100);
                    setTimeout(loadStaffTasks, 100);
                } else if (activeTabId === 'staff-idcard') {
                    setTimeout(loadStaffIDCard, 100);
                }
            }
        }

        // ========== MONTH/YEAR LOADING ==========

        function loadMonthsYears() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            
            const currentYear = new Date().getFullYear();
            const years = [currentYear - 1, currentYear, currentYear + 1];
            
            const monthSelects = ['month', 'earningsMonth', 'deductionsMonth', 'reportMonth', 'bulkMonth', 'slipMonth', 'attendanceMonth', 'viewAttendanceMonth'];
            const yearSelects = ['year', 'earningsYear', 'deductionsYear', 'reportYear', 'bulkYear', 'slipYear', 'attendanceYear', 'viewAttendanceYear'];
            
            monthSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select Month</option>';
                    months.forEach(month => {
                        select.add(new Option(month, month));
                    });
                }
            });
            
            yearSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select Year</option>';
                    years.forEach(year => {
                        select.add(new Option(year, year));
                    });
                }
            });
            
            const currentMonth = months[new Date().getMonth()];
            monthSelects.forEach(selectId => {
                const element = document.getElementById(selectId);
                if (element) element.value = currentMonth;
            });
            yearSelects.forEach(selectId => {
                const element = document.getElementById(selectId);
                if (element) element.value = currentYear;
            });
            
            const today = new Date().toISOString().split('T')[0];
            const attendanceDate = document.getElementById('attendanceDate');
            const dailyAttendanceDate = document.getElementById('dailyAttendanceDate');
            if (attendanceDate) attendanceDate.value = today;
            if (dailyAttendanceDate) dailyAttendanceDate.value = today;
        }

        function loadStaffMonthsYears() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            
            const currentYear = new Date().getFullYear();
            const years = [currentYear - 1, currentYear, currentYear + 1];
            
            const monthSelects = ['paymentMonth', 'staffAttendanceMonth'];
            const yearSelects = ['paymentYear', 'staffAttendanceYear'];
            
            monthSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select Month</option>';
                    months.forEach(month => {
                        select.add(new Option(month, month));
                    });
                }
            });
            
            yearSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select Year</option>';
                    years.forEach(year => {
                        select.add(new Option(year, year));
                    });
                }
            });
            
            const currentMonth = months[new Date().getMonth()];
            monthSelects.forEach(selectId => {
                const element = document.getElementById(selectId);
                if (element) element.value = currentMonth;
            });
            yearSelects.forEach(selectId => {
                const element = document.getElementById(selectId);
                if (element) element.value = currentYear;
            });
        }

        // ========== MESSAGE FUNCTIONS ==========

        function showMessage(elementId, message, isSuccess) {
            const messageDiv = document.getElementById(elementId);
            if (messageDiv) {
                messageDiv.innerHTML = `<div class="message ${isSuccess ? 'success' : 'error'}">${message}</div>`;
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 5000);
            }
        }

        function showStaffMessage(elementId, message, isSuccess) {
            showMessage(elementId, message, isSuccess);
        }

        // ========== STAFF DASHBOARD FUNCTIONS ==========

        function loadStaffDashboard() {
            if (!currentStaff || !currentStaff.staffId) {
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response && response.success) {
                        const data = response.data;
                        
                        document.getElementById('staffNetSalary').textContent = '' + (data.salary.netSalary || 0).toLocaleString('en-IN');
                        document.getElementById('staffPresentDays').textContent = data.attendance.presentDays || 0;
                        document.getElementById('staffLeaves').textContent = data.leaves.approved || 0;
                        
                        const paymentStatus = data.salary.paymentConfirmed ? 'Confirmed' : 'Pending';
                        document.getElementById('staffPaymentStatus').textContent = paymentStatus;
                        
                        loadStaffRecentActivities();
                        updateAvailablePaymentMonths();
                    } else {
                        showStaffMessage('staffDashboardMessage', response?.message || 'Error loading dashboard data', false);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading staff dashboard:', error);
                })
                .getStaffDashboardData(currentStaff.staffId);
        }

        function loadStaffRecentActivities() {
            const activitiesDiv = document.getElementById('staffRecentActivities');
            activitiesDiv.innerHTML = '<div class="activity-list">No recent activities</div>';
        }

        function updateAvailablePaymentMonths() {
            if (!currentStaff || !currentStaff.staffId) return;
            
            google.script.run
                .withSuccessHandler(function(availableMonths) {
                    const paymentMonthSelect = document.getElementById('paymentMonth');
                    if (!paymentMonthSelect) return;
                    
                    paymentMonthSelect.innerHTML = '<option value="">Select Month</option>';
                    
                    if (availableMonths && availableMonths.length > 0) {
                        availableMonths.forEach(monthData => {
                            const option = document.createElement('option');
                            option.value = monthData.month;
                            option.textContent = monthData.display + ' (' + monthData.netSalary.toLocaleString('en-IN') + ')';
                            option.setAttribute('data-year', monthData.year);
                            paymentMonthSelect.appendChild(option);
                        });
                    } else {
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No available months for confirmation';
                        paymentMonthSelect.appendChild(option);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading available months:', error);
                })
                .getAvailableSalaryMonthsForStaff(currentStaff.staffId);
        }

        document.getElementById('paymentMonth')?.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const year = selectedOption.getAttribute('data-year');
            if (year) {
                document.getElementById('paymentYear').value = year;
            }
        });

        // ========== STAFF PROFILE FUNCTIONS ==========

        function loadStaffProfile() {
            if (!currentStaff) return;
            
            document.getElementById('staffProfileId').value = currentStaff.staffId || '';
            document.getElementById('staffProfileName').value = currentStaff.name || '';
            document.getElementById('staffProfileDepartment').value = currentStaff.department || '';
            document.getElementById('staffProfileDesignation').value = currentStaff.designation || '';
            document.getElementById('staffProfileEmail').value = currentStaff.email || '';
            document.getElementById('staffProfilePhone').value = currentStaff.phone || '';
            document.getElementById('staffProfileBankAccount').value = currentStaff.bankAccount || '';
            document.getElementById('staffProfileIfscCode').value = currentStaff.ifscCode || '';
            
            if (currentStaff.photoUrl) {
                const preview = document.getElementById('staffPhotoPreview');
                preview.src = currentStaff.photoUrl;
                preview.style.display = 'block';
            }
        }

        function updateStaffProfile() {
            if (!currentStaff || !currentStaff.staffId) {
                showStaffMessage('staffProfileMessage', 'Staff information not available', false);
                return;
            }
            
            const profileData = {
                email: document.getElementById('staffProfileEmail').value,
                phone: document.getElementById('staffProfilePhone').value,
                bankAccount: document.getElementById('staffProfileBankAccount').value,
                ifscCode: document.getElementById('staffProfileIfscCode').value
            };
            
            if (selectedStaffPhoto) {
                profileData.photoData = selectedStaffPhoto.data;
                profileData.photoName = selectedStaffPhoto.name;
            }
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showStaffMessage('staffProfileMessage', response.message, response.success);
                    if (response.success) {
                        if (response.photoUrl) {
                            currentStaff.photoUrl = response.photoUrl;
                        }
                        currentStaff.email = profileData.email;
                        currentStaff.phone = profileData.phone;
                        currentStaff.bankAccount = profileData.bankAccount;
                        currentStaff.ifscCode = profileData.ifscCode;
                        
                        selectedStaffPhoto = null;
                    }
                })
                .withFailureHandler(function(error) {
                    showStaffMessage('staffProfileMessage', 'Error updating profile: ' + error.message, false);
                })
                .updateStaffProfile(currentStaff.staffId, profileData);
        }

        function handleStaffPhotoSelect(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) {
                    showStaffMessage('staffProfileMessage', 'Photo size must be less than 2MB', false);
                    return;
                }
                
                if (!file.type.startsWith('image/')) {
                    showStaffMessage('staffProfileMessage', 'Please select an image file', false);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedStaffPhoto = {
                        data: e.target.result,
                        name: file.name
                    };
                    
                    const preview = document.getElementById('staffPhotoPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    
                    document.querySelector('#staffPhotoUploadArea div:nth-child(2)').textContent = 'Photo selected: ' + file.name;
                };
                reader.readAsDataURL(file);
            }
        }

        // ========== LEAVE APPLICATION FUNCTIONS ==========

        function updateLeaveEndDateMin() {
            const startDate = document.getElementById('leaveStartDate').value;
            if (startDate) {
                document.getElementById('leaveEndDate').min = startDate;
                if (!document.getElementById('leaveEndDate').value) {
                    document.getElementById('leaveEndDate').value = startDate;
                }
            }
        }

        function applyForLeave() {
            if (!currentStaff || !currentStaff.staffId) {
                showStaffMessage('leaveApplicationMessage', 'Staff information not available', false);
                return;
            }
            
            const leaveData = {
                staffId: currentStaff.staffId,
                leaveType: document.getElementById('leaveType').value,
                startDate: document.getElementById('leaveStartDate').value,
                endDate: document.getElementById('leaveEndDate').value,
                reason: document.getElementById('leaveReason').value
            };
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showStaffMessage('leaveApplicationMessage', response.message, response.success);
                    if (response.success) {
                        document.getElementById('leaveApplicationForm').reset();
                        loadStaffLeaves();
                        loadStaffDashboard();
                    }
                })
                .withFailureHandler(function(error) {
                    showStaffMessage('leaveApplicationMessage', 'Error applying for leave: ' + error.message, false);
                })
                .applyForLeave(leaveData);
        }

        function loadStaffLeaves() {
            if (!currentStaff || !currentStaff.staffId) return;
            
            google.script.run
                .withSuccessHandler(function(leaves) {
                    const leavesListDiv = document.getElementById('staffLeavesList');
                    if (!leaves || leaves.length === 0) {
                        leavesListDiv.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><h3>No Leave Applications</h3><p>You haven\'t applied for any leaves yet.</p></div>';
                        return;
                    }
                    
                    let html = '<div class="table-container"><table class="data-table compact-table"><thead><tr><th>Leave ID</th><th>Type</th><th>Start Date</th><th>End Date</th><th>Days</th><th>Reason</th><th>Status</th><th>Applied Date</th></tr></thead><tbody>';
                    leaves.forEach(leave => {
                        const statusColor = leave.status === 'Approved' ? 'badge-success' : 
                                          leave.status === 'Rejected' ? 'badge-danger' : 'badge-warning';
                        html += `<tr>
                            <td><code>${leave.leaveId || 'N/A'}</code></td>
                            <td>${leave.leaveType || 'N/A'}</td>
                            <td>${leave.startDate || 'N/A'}</td>
                            <td>${leave.endDate || 'N/A'}</td>
                            <td>${leave.numberOfDays || 0}</td>
                            <td>${leave.reason || 'N/A'}</td>
                            <td><span class="badge ${statusColor}">${leave.status || 'Pending'}</span></td>
                            <td>${leave.appliedDate || 'N/A'}</td>
                        </tr>`;
                    });
                    html += '</tbody></table></div>';
                    leavesListDiv.innerHTML = html;
                })
                .withFailureHandler(function(error) {
                    const leavesListDiv = document.getElementById('staffLeavesList');
                    leavesListDiv.innerHTML = '<div class="message error">Error loading leaves: ' + error.message + '</div>';
                })
                .getStaffLeaves(currentStaff.staffId);
        }

        // ========== PAYMENT CONFIRMATION FUNCTIONS ==========

        function initializeStaffNameHint() {
            if (currentStaff && currentStaff.name) {
                const staffNameHint = document.getElementById('staffNameHint');
                const paymentSignature = document.getElementById('paymentSignature');
                
                if (staffNameHint) {
                    staffNameHint.textContent = currentStaff.name;
                }
                if (paymentSignature) {
                    paymentSignature.value = currentStaff.name;
                    paymentSignature.placeholder = "Type: " + currentStaff.name;
                }
            }
        }

        function confirmPaymentReceipt() {
            if (!currentStaff || !currentStaff.staffId) {
                showStaffMessage('paymentConfirmationMessage', 'Staff information not available', false);
                return;
            }
            
            const month = document.getElementById('paymentMonth').value;
            const yearSelect = document.querySelector('#paymentMonth option:checked');
            const year = yearSelect ? yearSelect.getAttribute('data-year') : '';
            const paymentMethod = document.getElementById('paymentMethod').value;
            const signature = document.getElementById('paymentSignature').value;
            
            if (!month || !year) {
                showStaffMessage('paymentConfirmationMessage', 'Please select a valid month and year', false);
                return;
            }
            
            if (!paymentMethod) {
                showStaffMessage('paymentConfirmationMessage', 'Please select payment method', false);
                return;
            }
            
            if (!signature) {
                showStaffMessage('paymentConfirmationMessage', 'Please provide your digital signature', false);
                return;
            }
            
            if (signature.toLowerCase() !== currentStaff.name.toLowerCase()) {
                showStaffMessage('paymentConfirmationMessage', 'Digital signature must match your registered name: ' + currentStaff.name, false);
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showStaffMessage('paymentConfirmationMessage', response.message, response.success);
                    if (response.success) {
                        document.getElementById('paymentConfirmationForm').reset();
                        loadStaffPayments();
                        loadStaffDashboard();
                    }
                })
                .withFailureHandler(function(error) {
                    showStaffMessage('paymentConfirmationMessage', 'Error confirming payment: ' + error.message, false);
                })
                .confirmSalaryReceipt(currentStaff.staffId, month, year, paymentMethod, signature);
        }

        function loadStaffPayments() {
            if (!currentStaff || !currentStaff.staffId) return;
            
            google.script.run
                .withSuccessHandler(function(payments) {
                    const paymentsListDiv = document.getElementById('staffPaymentsList');
                    if (!payments || payments.length === 0) {
                        paymentsListDiv.innerHTML = '<div class="empty-state"><i class="fas fa-receipt"></i><h3>No Payment Confirmations</h3><p>You haven\'t confirmed any payments yet.</p></div>';
                        return;
                    }
                    
                    let html = '<div class="table-container"><table class="data-table compact-table"><thead><tr><th>Confirmation ID</th><th>Month</th><th>Year</th><th>Net Salary</th><th>Payment Method</th><th>Confirmed Date</th><th>Signature</th></tr></thead><tbody>';
                    payments.forEach(payment => {
                        html += `<tr>
                            <td><code>${payment.confirmationId || 'N/A'}</code></td>
                            <td>${payment.month || 'N/A'}</td>
                            <td>${payment.year || 'N/A'}</td>
                            <td class="currency">${(payment.netSalary || 0).toLocaleString('en-IN')}</td>
                            <td>${payment.paymentMethod || 'N/A'}</td>
                            <td>${payment.confirmedDate || 'N/A'}</td>
                            <td><small>${payment.signature || 'N/A'}</small></td>
                        </tr>`;
                    });
                    html += '</tbody></table></div>';
                    paymentsListDiv.innerHTML = html;
                })
                .withFailureHandler(function(error) {
                    const paymentsListDiv = document.getElementById('staffPaymentsList');
                    paymentsListDiv.innerHTML = '<div class="message error">Error loading payments: ' + error.message + '</div>';
                })
                .getStaffPaymentConfirmations(currentStaff.staffId);
        }

        // ========== STAFF ATTENDANCE FUNCTIONS ==========

        function loadStaffAttendance() {
            const month = document.getElementById('staffAttendanceMonth').value;
            const year = document.getElementById('staffAttendanceYear').value;
            
            if (!month || !year) return;
            
            if (!currentStaff || !currentStaff.staffId) {
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(response) {
                    const container = document.getElementById('staffAttendanceData');
                    
                    if (response.success) {
                        const attendance = response.data[currentStaff.staffId];
                        if (attendance) {
                            let html = `<h3>Attendance Summary for ${month} ${year}</h3>`;
                            html += '<div class="summary-grid">';
                            html += `<div class="summary-card success"><div class="summary-value">${attendance.presentDays || 0}</div><div class="summary-label">Present Days</div></div>`;
                            html += `<div class="summary-card warning"><div class="summary-value">${attendance.absentDays || 0}</div><div class="summary-label">Absent Days</div></div>`;
                            html += `<div class="summary-card info"><div class="summary-value">${attendance.lateDays || 0}</div><div class="summary-label">Late Coming</div></div>`;
                            html += `<div class="summary-card"><div class="summary-value">${attendance.attendancePercentage || '0%'}</div><div class="summary-label">Attendance %</div></div>`;
                            html += '</div>';
                            
                            container.innerHTML = html;
                        } else {
                            container.innerHTML = '<div class="message warning">No attendance data found for this month.</div>';
                        }
                    } else {
                        container.innerHTML = `<div class="message error">${response.message || 'Error loading attendance data'}</div>`;
                    }
                })
                .withFailureHandler(function(error) {
                    const container = document.getElementById('staffAttendanceData');
                    container.innerHTML = `<div class="message error">Error loading attendance: ${error.message}</div>`;
                })
                .getMonthlyAttendanceData(month, year);
        }

        // ========== STAFF PASSWORD CHANGE FUNCTIONS ==========

        function changeStaffPassword() {
            if (!currentStaff || !currentStaff.staffId) {
                showStaffMessage('staffPasswordMessage', 'Staff information not available', false);
                return;
            }
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showStaffMessage('staffPasswordMessage', 'New password and confirm password do not match', false);
                return;
            }
            
            if (newPassword.length < 6) {
                showStaffMessage('staffPasswordMessage', 'New password must be at least 6 characters long', false);
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showStaffMessage('staffPasswordMessage', response.message, response.success);
                    if (response.success) {
                        document.getElementById('staffPasswordForm').reset();
                    }
                })
                .withFailureHandler(function(error) {
                    showStaffMessage('staffPasswordMessage', 'Error changing password: ' + error.message, false);
                })
                .changeStaffPassword(currentStaff.staffId, currentPassword, newPassword);
        }

        // ========== PHOTO HANDLING FUNCTIONS ==========

        function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) {
                    showMessage('staffMessage', 'Photo size must be less than 2MB', false);
                    return;
                }
                
                if (!file.type.startsWith('image/')) {
                    showMessage('staffMessage', 'Please select an image file', false);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedPhoto = {
                        data: e.target.result,
                        name: file.name
                    };
                    
                    const preview = document.getElementById('photoPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    
                    document.getElementById('photoActions').style.display = 'block';
                    
                    document.querySelector('#photoUploadArea div:nth-child(2)').textContent = 'Photo selected: ' + file.name;
                };
                reader.readAsDataURL(file);
            }
        }

        function removePhoto() {
            selectedPhoto = null;
            document.getElementById('photoInput').value = '';
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('photoActions').style.display = 'none';
            document.querySelector('#photoUploadArea div:nth-child(2)').textContent = 'Click to upload photo or drag & drop';
        }

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('photoUploadArea');
            if (!uploadArea) return;
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const fileInput = document.getElementById('photoInput');
                    fileInput.files = files;
                    handlePhotoSelect({ target: fileInput });
                }
            });
        }

        // ========== DASHBOARD FUNCTIONS ==========

        function loadDashboard() {
            google.script.run
                .withSuccessHandler(function(staffList) {
                    const totalStaff = staffList.length;
                    const teachingStaff = staffList.filter(staff => staff.staffType === 'Teaching').length;
                    const nonTeachingStaff = staffList.filter(staff => staff.staffType === 'Non-Teaching').length;
                    
                    document.getElementById('totalStaff').textContent = totalStaff;
                    document.getElementById('teachingStaff').textContent = teachingStaff;
                    document.getElementById('nonTeachingStaff').textContent = nonTeachingStaff;
                    
                    google.script.run
                        .withSuccessHandler(function(sheets) {
                            document.getElementById('pendingSalarySheets').textContent = sheets.length;
                        })
                        .getAllSalarySheets();
                })
                .getAllStaff();
        }

        function refreshDashboard() {
            loadDashboard();
            loadDailyAttendanceDashboard();
        }

        // ========== STAFF MANAGEMENT FUNCTIONS ==========

        function addStaff() {
            const form = document.getElementById('staffForm');
            const staffData = {
                name: document.getElementById('name').value,
                department: document.getElementById('department').value,
                designation: document.getElementById('designation').value,
                staffType: document.getElementById('staffType').value,
                basicSalary: parseFloat(document.getElementById('basicSalary').value),
                joinDate: document.getElementById('joinDate').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                bankAccount: document.getElementById('bankAccount').value,
                ifscCode: document.getElementById('ifscCode').value
            };
            
            if (!staffData.name || !staffData.department || !staffData.designation) {
                showMessage('staffMessage', 'Please fill all required fields', false);
                return;
            }
            
            if (staffData.basicSalary <= 0) {
                showMessage('staffMessage', 'Basic salary must be greater than 0', false);
                return;
            }
            
            if (selectedPhoto) {
                staffData.photoData = selectedPhoto.data;
                staffData.photoName = selectedPhoto.name;
            }
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showMessage('staffMessage', response.message, response.success);
                    if (response.success) {
                        resetStaffForm();
                        loadStaff();
                        loadStaffIds();
                        loadDashboard();
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('staffMessage', 'Error adding staff: ' + error.message, false);
                })
                .addStaff(staffData);
        }

        function updateStaff() {
            if (!currentEditingStaffId) {
                showMessage('staffMessage', 'No staff selected for editing', false);
                return;
            }
            
            const staffData = {
                name: document.getElementById('name').value,
                department: document.getElementById('department').value,
                designation: document.getElementById('designation').value,
                staffType: document.getElementById('staffType').value,
                basicSalary: parseFloat(document.getElementById('basicSalary').value),
                joinDate: document.getElementById('joinDate').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                bankAccount: document.getElementById('bankAccount').value,
                ifscCode: document.getElementById('ifscCode').value,
                status: 'Active'
            };
            
            if (staffData.basicSalary <= 0) {
                showMessage('staffMessage', 'Basic salary must be greater than 0', false);
                return;
            }
            
            if (selectedPhoto) {
                staffData.photoData = selectedPhoto.data;
                staffData.photoName = selectedPhoto.name;
            }
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showMessage('staffMessage', response.message, response.success);
                    if (response.success) {
                        resetStaffForm();
                        loadStaff();
                        loadStaffIds();
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('staffMessage', 'Error updating staff: ' + error.message, false);
                })
                .updateStaff(currentEditingStaffId, staffData);
        }

        function loadStaff() {
            const staffListDiv = document.getElementById('staffList');
            
            if (!staffListDiv) {
                console.error('staffList element not found in DOM');
                return;
            }
            
            // Show loading state
            staffListDiv.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Loading staff data...</p></div>';
            
            google.script.run
                .withSuccessHandler(function(staffList) {
                    if (!staffList || staffList.length === 0) {
                        staffListDiv.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><h3>No Staff Members</h3><p>No staff members found. Please add staff members first.</p></div>';
                        return;
                    }
                    
                    let html = '<div class="table-container"><table class="data-table compact-table"><thead><tr><th>Photo</th><th>Staff ID</th><th>Name</th><th>Department</th><th>Designation</th><th>Type</th><th>Basic Salary</th><th>Join Date</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                    
                    staffList.forEach(staff => {
                        const photoHtml = staff.photoUrl 
                            ? `<img src="${staff.photoUrl}" alt="${staff.name}" class="staff-photo-small" onerror="this.style.display=\'none\'">`
                            : '<div style="width:35px;height:35px;background:#f0f0f0;border-radius:50%;display:flex;align-items:center;justify-content:center;"><i class="fas fa-user" style="color:#999;"></i></div>';
                        
                        html += `<tr>
                            <td>${photoHtml}</td>
                            <td><strong>${staff.staffId || 'N/A'}</strong></td>
                            <td>${staff.name || 'N/A'}</td>
                            <td>${staff.department || 'N/A'}</td>
                            <td>${staff.designation || 'N/A'}</td>
                            <td><span class="badge ${staff.staffType === 'Teaching' ? 'badge-success' : 'badge-warning'}">${staff.staffType || 'N/A'}</span></td>
                            <td class="currency">${(staff.basicSalary || 0).toLocaleString('en-IN')}</td>
                            <td>${staff.joinDate || 'N/A'}</td>
                            <td><span class="badge badge-success">${staff.status || 'Active'}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-secondary btn-sm" onclick="editStaff('${staff.staffId}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteStaff('${staff.staffId}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    staffListDiv.innerHTML = html;
                    
                    // Update dashboard counts
                    const totalStaff = staffList.length;
                    const teachingStaff = staffList.filter(staff => staff.staffType === 'Teaching').length;
                    const nonTeachingStaff = staffList.filter(staff => staff.staffType === 'Non-Teaching').length;
                    
                    const totalStaffEl = document.getElementById('totalStaff');
                    const teachingStaffEl = document.getElementById('teachingStaff');
                    const nonTeachingStaffEl = document.getElementById('nonTeachingStaff');
                    
                    if (totalStaffEl) totalStaffEl.textContent = totalStaff;
                    if (teachingStaffEl) teachingStaffEl.textContent = teachingStaff;
                    if (nonTeachingStaffEl) nonTeachingStaffEl.textContent = nonTeachingStaff;
                    
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading staff:', error);
                    staffListDiv.innerHTML = '<div class="message error">Error loading staff: ' + error.message + '</div>';
                })
                .getAllStaff();
        }

        function editStaff(staffId) {
            if (!staffId) {
                showMessage('staffMessage', 'Invalid staff ID', false);
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        const staff = response.staff;
                        
                        document.getElementById('name').value = staff.name || '';
                        document.getElementById('department').value = staff.department || '';
                        document.getElementById('designation').value = staff.designation || '';
                        document.getElementById('staffType').value = staff.staffType || '';
                        document.getElementById('basicSalary').value = staff.basicSalary || '';
                        document.getElementById('joinDate').value = staff.joinDate || '';
                        document.getElementById('email').value = staff.email || '';
                        document.getElementById('phone').value = staff.phone || '';
                        document.getElementById('bankAccount').value = staff.bankAccount || '';
                        document.getElementById('ifscCode').value = staff.ifscCode || '';
                        
                        if (staff.photoUrl) {
                            const preview = document.getElementById('photoPreview');
                            preview.src = staff.photoUrl;
                            preview.style.display = 'block';
                            document.getElementById('photoActions').style.display = 'block';
                            document.querySelector('#photoUploadArea div:nth-child(2)').textContent = 'Current photo loaded';
                            
                            selectedPhoto = null;
                        }
                        
                        isEditingStaff = true;
                        currentEditingStaffId = staffId;
                        
                        const submitBtn = document.querySelector('#staffForm button[type="button"]');
                        submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Staff';
                        submitBtn.setAttribute('onclick', 'updateStaff()');
                        
                        document.getElementById('cancelBtn').style.display = 'block';
                        
                        showMessage('staffMessage', 'Staff data loaded for editing. Make changes and click Update Staff.', true);
                        
                        document.getElementById('staffForm').scrollIntoView({ behavior: 'smooth' });
                    } else {
                        showMessage('staffMessage', response.message || 'Error loading staff data', false);
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('staffMessage', 'Error loading staff: ' + error.message, false);
                })
                .getStaffById(staffId);
        }

        function deleteStaff(staffId) {
            if (!staffId) {
                showMessage('staffMessage', 'Invalid staff ID', false);
                return;
            }
            
            if (confirm('Are you sure you want to delete this staff member? This action cannot be undone.')) {
                google.script.run
                    .withSuccessHandler(function(response) {
                        showMessage('staffMessage', response.message, response.success);
                        if (response.success) {
                            loadStaff();
                            loadStaffIds();
                            loadDashboard();
                        }
                    })
                    .withFailureHandler(function(error) {
                        showMessage('staffMessage', 'Error deleting staff: ' + error.message, false);
                    })
                    .deleteStaff(staffId);
            }
        }

        function resetStaffForm() {
            document.getElementById('staffForm').reset();
            removePhoto();
            
            isEditingStaff = false;
            currentEditingStaffId = null;
            
            const submitBtn = document.querySelector('#staffForm button[type="button"]');
            submitBtn.innerHTML = '<i class="fas fa-plus"></i> Add Staff';
            submitBtn.setAttribute('onclick', 'addStaff()');
            
            document.getElementById('cancelBtn').style.display = 'none';
            
            showMessage('staffMessage', 'Form reset. Ready to add new staff.', true);
        }

        function loadStaffIds() {
            google.script.run
                .withSuccessHandler(function(staffIds) {
                    const slipStaffSelect = document.getElementById('slipStaffId');
                    
                    if (!slipStaffSelect) return;
                    
                    if (!staffIds || staffIds.length === 0) {
                        slipStaffSelect.innerHTML = '<option value="">No staff members found</option>';
                        return;
                    }
                    
                    slipStaffSelect.innerHTML = '<option value="">Select Staff ID</option>';
                    
                    staffIds.forEach(staffId => {
                        if (staffId) {
                            const option = new Option(staffId, staffId);
                            slipStaffSelect.add(option);
                        }
                    });
                })
                .withFailureHandler(function(error) {
                    const slipStaffSelect = document.getElementById('slipStaffId');
                    if (slipStaffSelect) {
                        slipStaffSelect.innerHTML = '<option value="">Error loading staff IDs</option>';
                    }
                })
                .getAllStaffIds();
        }

        function loadDepartmentsAndDesignations() {
            google.script.run
                .withSuccessHandler(function(departments) {
                    const deptSelect = document.getElementById('department');
                    if (deptSelect) {
                        deptSelect.innerHTML = '<option value="">Select Department</option>';
                        if (departments && departments.length > 0) {
                            departments.forEach(dept => {
                                if (dept) deptSelect.add(new Option(dept, dept));
                            });
                        }
                    }
                })
                .getDepartments();
            
            google.script.run
                .withSuccessHandler(function(designations) {
                    const desigSelect = document.getElementById('designation');
                    if (desigSelect) {
                        desigSelect.innerHTML = '<option value="">Select Designation</option>';
                        if (designations && designations.length > 0) {
                            designations.forEach(desig => {
                                if (desig) desigSelect.add(new Option(desig, desig));
                            });
                        }
                    }
                })
                .getDesignations();
        }

        // ========== USER MANAGEMENT FUNCTIONS ==========

        function loadUsers() {
            google.script.run
                .withSuccessHandler(function(usersList) {
                    const userListDiv = document.getElementById('userList');
                    if (usersList.length === 0) {
                        userListDiv.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><h3>No Users</h3><p>No users found.</p></div>';
                        return;
                    }
                    
                    let html = '<div class="table-container"><table class="data-table compact-table"><thead><tr><th>User ID</th><th>Username</th><th>Role</th><th>Status</th><th>Created Date</th><th>Actions</th></tr></thead><tbody>';
                    usersList.forEach(user => {
                        html += `<tr>
                            <td><strong>${user.userId}</strong></td>
                            <td>${user.username}</td>
                            <td><span class="badge ${user.role === 'Admin' ? 'badge-success' : 'badge-info'}">${user.role}</span></td>
                            <td><span class="badge ${user.status === 'Active' ? 'badge-success' : 'badge-danger'}">${user.status}</span></td>
                            <td>${user.createdDate}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-secondary btn-sm" onclick="editUser('${user.userId}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.userId}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                    });
                    html += '</tbody></table></div>';
                    userListDiv.innerHTML = html;
                })
                .getAllUsers();
        }

        function addUser() {
            const userData = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value,
                status: document.getElementById('userStatus').value
            };
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showMessage('userMessage', response.message, response.success);
                    if (response.success) {
                        document.getElementById('userForm').reset();
                        loadUsers();
                    }
                })
                .addUser(userData);
        }

        function editUser(userId) {
            showMessage('userMessage', 'User editing functionality to be implemented', false);
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                google.script.run
                    .withSuccessHandler(function(response) {
                        showMessage('userMessage', response.message, response.success);
                        if (response.success) {
                            loadUsers();
                        }
                    })
                    .deleteUser(userId);
            }
        }

        function resetUserForm() {
            document.getElementById('userForm').reset();
            document.getElementById('cancelUserBtn').style.display = 'none';
        }

        // ========== MONTHLY ATTENDANCE VIEW ==========

        function loadMonthlyAttendanceView() {
            const month = document.getElementById('viewAttendanceMonth').value;
            const year = document.getElementById('viewAttendanceYear').value;
            
            if (!month || !year) return;
            
            google.script.run
                .withSuccessHandler(function(response) {
                    const container = document.getElementById('monthlyAttendanceView');
                    
                    if (response.success) {
                        let html = `<h3>Attendance Summary for ${month} ${year}</h3>`;
                        html += '<div class="table-container"><table class="data-table compact-table"><thead><tr><th>Staff ID</th><th>Name</th><th>Department</th><th>Present</th><th>Absent</th><th>Late</th><th>Half Day</th><th>Full Day</th><th>Holiday</th><th>%</th></tr></thead><tbody>';
                        
                        Object.keys(response.data).forEach(staffId => {
                            const staff = response.data[staffId];
                            html += `<tr>
                                <td><strong>${staffId}</strong></td>
                                <td>${staff.name}</td>
                                <td>${staff.department}</td>
                                <td class="attendance-present">${staff.presentDays}</td>
                                <td class="attendance-absent">${staff.absentDays}</td>
                                <td class="attendance-late">${staff.lateDays}</td>
                                <td class="attendance-halfday">${staff.halfDayLeave}</td>
                                <td class="attendance-fullday">${staff.fullDayLeave}</td>
                                <td>${staff.holidayDays}</td>
                                <td>${staff.attendancePercentage}</td>
                            </tr>`;
                        });
                        
                        html += '</tbody></table></div>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = `<div class="message error">${response.message}</div>`;
                    }
                })
                .withFailureHandler(function(error) {
                    const container = document.getElementById('monthlyAttendanceView');
                    container.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
                })
                .getMonthlyAttendanceData(month, year);
        }

        // ========== SALARY SHEET FUNCTIONS ==========

        function generateSalarySheet() {
            const month = document.getElementById('month').value;
            const year = document.getElementById('year').value;
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showMessage('salarySheetMessage', response.message, response.success);
                    if (response.success) {
                        loadSalarySheets();
                        loadDashboard();
                    }
                })
                .generateSalarySheet(month, year);
        }

        function loadSalarySheets() {
            google.script.run
                .withSuccessHandler(function(sheets) {
                    const sheetsListDiv = document.getElementById('salarySheetsList');
                    if (sheets.length === 0) {
                        sheetsListDiv.innerHTML = '<div class="empty-state"><i class="fas fa-file-alt"></i><h3>No Salary Sheets</h3><p>No salary sheets generated yet. Generate one using the form above.</p></div>';
                        return;
                    }
                    
                    let html = '<div class="table-container"><table class="data-table compact-table"><thead><tr><th>Sheet Name</th><th>Month</th><th>Year</th><th>Actions</th></tr></thead><tbody>';
                    sheets.sort().reverse().forEach(sheet => {
                        const [month, year] = sheet.split('_');
                        html += `<tr>
                            <td><strong>${sheet}</strong></td>
                            <td>${month}</td>
                            <td>${year}</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="viewSalarySheet('${month}', '${year}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>`;
                    });
                    html += '</tbody></table></div>';
                    sheetsListDiv.innerHTML = html;
                })
                .getAllSalarySheets();
        }

        function viewSalarySheet(month, year) {
            alert(`Viewing salary sheet for ${month} ${year}. This would open the actual Google Sheet.`);
        }

        // ========== ATTENDANCE MANAGEMENT FUNCTIONS ==========

        function loadAttendanceData() {
            const date = document.getElementById('attendanceDate').value;
            
            if (!date) {
                document.getElementById('attendanceDataContainer').style.display = 'none';
                return;
            }
            
            document.getElementById('attendanceDateDisplay').textContent = new Date(date).toLocaleDateString('en-IN');
            
            document.getElementById('attendanceMessage').innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading attendance data...</div>';
            
            google.script.run
                .withSuccessHandler(function(staffList) {
                    document.getElementById('attendanceMessage').innerHTML = '';
                    
                    if (staffList.length > 0) {
                        currentAttendanceData = {};
                        staffList.forEach(staff => {
                            currentAttendanceData[staff.staffId] = {
                                name: staff.name,
                                department: staff.department,
                                designation: staff.designation,
                                staffType: staff.staffType,
                                status: 'present'
                            };
                        });
                        displayAttendanceTable();
                        document.getElementById('attendanceDataContainer').style.display = 'block';
                    } else {
                        showMessage('attendanceMessage', 'No staff members found!', false);
                        document.getElementById('attendanceDataContainer').style.display = 'none';
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('attendanceMessage', 'Error loading attendance data: ' + error.message, false);
                    document.getElementById('attendanceDataContainer').style.display = 'none';
                })
                .getAllStaff();
        }

        function displayAttendanceTable() {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            
            Object.keys(currentAttendanceData).forEach(staffId => {
                const staff = currentAttendanceData[staffId];
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${staffId}</strong></td>
                    <td>${staff.name}</td>
                    <td>${staff.department}</td>
                    <td>${staff.designation}</td>
                    <td><span class="badge ${staff.staffType === 'Teaching' ? 'badge-success' : 'badge-warning'}">${staff.staffType}</span></td>
                    <td><span class="${staff.status === 'present' ? 'attendance-present' : staff.status === 'absent' ? 'attendance-absent' : 'attendance-late'}">${staff.status.charAt(0).toUpperCase() + staff.status.slice(1)}</span></td>
                    <td>
                        <select class="table-input" onchange="updateAttendanceData('${staffId}', this.value)">
                            <option value="present" ${staff.status === 'present' ? 'selected' : ''}>Present</option>
                            <option value="absent" ${staff.status === 'absent' ? 'selected' : ''}>Absent</option>
                            <option value="late" ${staff.status === 'late' ? 'selected' : ''}>Late Coming</option>
                            <option value="halfday" ${staff.status === 'halfday' ? 'selected' : ''}>Half Day</option>
                            <option value="fullday" ${staff.status === 'fullday' ? 'selected' : ''}>Full Day Leave</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateAttendanceData(staffId, status) {
            if (currentAttendanceData[staffId]) {
                currentAttendanceData[staffId].status = status;
            }
        }

        function markAllPresent() {
            Object.keys(currentAttendanceData).forEach(staffId => {
                currentAttendanceData[staffId].status = 'present';
            });
            displayAttendanceTable();
        }

        function markAllAbsent() {
            Object.keys(currentAttendanceData).forEach(staffId => {
                currentAttendanceData[staffId].status = 'absent';
            });
            displayAttendanceTable();
        }

        function markAllLate() {
            Object.keys(currentAttendanceData).forEach(staffId => {
                currentAttendanceData[staffId].status = 'late';
            });
            displayAttendanceTable();
        }

        function markAllHalfDay() {
            Object.keys(currentAttendanceData).forEach(staffId => {
                currentAttendanceData[staffId].status = 'halfday';
            });
            displayAttendanceTable();
        }

        function markAllFullDay() {
            Object.keys(currentAttendanceData).forEach(staffId => {
                currentAttendanceData[staffId].status = 'fullday';
            });
            displayAttendanceTable();
        }

        function submitAttendance() {
            const date = document.getElementById('attendanceDate').value;
            
            if (!date) {
                showMessage('attendanceMessage', 'Please select a date', false);
                return;
            }
            
            if (!currentUser) {
                showMessage('attendanceMessage', 'User not authenticated', false);
                return;
            }
            
            const attendanceData = {};
            Object.keys(currentAttendanceData).forEach(staffId => {
                attendanceData[staffId] = currentAttendanceData[staffId].status;
            });
            
            if (Object.keys(attendanceData).length === 0) {
                showMessage('attendanceMessage', 'No attendance data to submit', false);
                return;
            }
            
            showMessage('attendanceMessage', '<div class="loading"><div class="loading-spinner"></div>Submitting attendance...</div>', true);
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        let message = response.message;
                        showMessage('attendanceMessage', message, true);
                    } else {
                        showMessage('attendanceMessage', response.message, false);
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('attendanceMessage', 'Error submitting attendance: ' + error.message, false);
                })
                .submitDailyAttendanceWithConfigCheck(date, attendanceData, currentUser.username, currentUser.role);
        }

        // ========== EARNINGS MANAGEMENT FUNCTIONS ==========

        function loadEarningsData() {
            const month = document.getElementById('earningsMonth').value;
            const year = document.getElementById('earningsYear').value;
            
            if (!month || !year) {
                document.getElementById('earningsDataContainer').style.display = 'none';
                return;
            }
            
            document.getElementById('earningsMessage').innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading earnings data...</div>';
            
            google.script.run
                .withSuccessHandler(function(response) {
                    document.getElementById('earningsMessage').innerHTML = '';
                    
                    if (response.success) {
                        currentEarningsData = response.data;
                        displayEarningsTable();
                        document.getElementById('earningsDataContainer').style.display = 'block';
                    } else {
                        showMessage('earningsMessage', response.message, false);
                        document.getElementById('earningsDataContainer').style.display = 'none';
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('earningsMessage', 'Error loading earnings data: ' + error.message, false);
                    document.getElementById('earningsDataContainer').style.display = 'none';
                })
                .getSalaryDataForMonth(month, year);
        }

        function displayEarningsTable() {
            const tbody = document.getElementById('earningsTableBody');
            tbody.innerHTML = '';
            
            Object.keys(currentEarningsData).forEach(staffId => {
                const staff = currentEarningsData[staffId];
                const status = staff.earningsSubmitted ? 
                    `<span class="status-submitted">Submitted</span>` : 
                    `<span class="status-pending">Pending</span>`;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${staffId}</strong></td>
                    <td>${staff.name}</td>
                    <td>${staff.department}</td>
                    <td><input type="number" class="table-input" id="arrears_${staffId}" value="${staff.arrears}" onchange="updateEarningsData('${staffId}', 'arrears', this.value)"></td>
                    <td><input type="number" class="table-input" id="loan_${staffId}" value="${staff.loan}" onchange="updateEarningsData('${staffId}', 'loan', this.value)"></td>
                    <td><input type="number" class="table-input" id="td_${staffId}" value="${staff.td}" onchange="updateEarningsData('${staffId}', 'td', this.value)"></td>
                    <td><input type="number" class="table-input" id="da_${staffId}" value="${staff.da}" onchange="updateEarningsData('${staffId}', 'da', this.value)"></td>
                    <td><input type="number" class="table-input" id="earningLeave_${staffId}" value="${staff.earningLeave}" onchange="updateEarningsData('${staffId}', 'earningLeave', this.value)"></td>
                    <td><input type="number" class="table-input" id="otherAllowance_${staffId}" value="${staff.otherAllowance}" onchange="updateEarningsData('${staffId}', 'otherAllowance', this.value)"></td>
                    <td><input type="number" class="table-input" id="leaveBonus_${staffId}" value="${staff.leaveBonus}" onchange="updateEarningsData('${staffId}', 'leaveBonus', this.value)"></td>
                    <td>${status}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateEarningsData(staffId, field, value) {
            if (currentEarningsData[staffId]) {
                currentEarningsData[staffId][field] = parseFloat(value) || 0;
            }
        }

        function submitEarnings() {
            const month = document.getElementById('earningsMonth').value;
            const year = document.getElementById('earningsYear').value;
            
            const earningsData = {};
            Object.keys(currentEarningsData).forEach(staffId => {
                earningsData[staffId] = {
                    arrears: currentEarningsData[staffId].arrears,
                    loan: currentEarningsData[staffId].loan,
                    td: currentEarningsData[staffId].td,
                    da: currentEarningsData[staffId].da,
                    earningLeave: currentEarningsData[staffId].earningLeave,
                    otherAllowance: currentEarningsData[staffId].otherAllowance,
                    leaveBonus: currentEarningsData[staffId].leaveBonus
                };
            });
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showMessage('earningsMessage', response.message, response.success);
                    if (response.success) {
                        loadEarningsData();
                    }
                })
                .submitEarningsForAllStaff(month, year, earningsData);
        }

        // ========== DEDUCTIONS MANAGEMENT FUNCTIONS ==========

        function loadDeductionsData() {
            const month = document.getElementById('deductionsMonth').value;
            const year = document.getElementById('deductionsYear').value;
            
            if (!month || !year) {
                document.getElementById('deductionsDataContainer').style.display = 'none';
                return;
            }
            
            document.getElementById('deductionsMessage').innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading deductions data...</div>';
            
            google.script.run
                .withSuccessHandler(function(response) {
                    document.getElementById('deductionsMessage').innerHTML = '';
                    
                    if (response.success) {
                        currentDeductionsData = response.data;
                        displayDeductionsTable();
                        document.getElementById('deductionsDataContainer').style.display = 'block';
                    } else {
                        showMessage('deductionsMessage', response.message, false);
                        document.getElementById('deductionsDataContainer').style.display = 'none';
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('deductionsMessage', 'Error loading deductions data: ' + error.message, false);
                    document.getElementById('deductionsDataContainer').style.display = 'none';
                })
                .getSalaryDataForMonth(month, year);
        }

        function displayDeductionsTable() {
            const tbody = document.getElementById('deductionsTableBody');
            tbody.innerHTML = '';
            
            Object.keys(currentDeductionsData).forEach(staffId => {
                const staff = currentDeductionsData[staffId];
                const status = staff.deductionsSubmitted ? 
                    `<span class="status-submitted">Submitted</span>` : 
                    `<span class="status-pending">Pending</span>`;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${staffId}</strong></td>
                    <td>${staff.name}</td>
                    <td>${staff.department}</td>
                    <td><input type="number" class="table-input" id="loanRecovery_${staffId}" value="${staff.loanRecovery || 0}" onchange="updateDeductionsData('${staffId}', 'loanRecovery', this.value)"></td>
                    <td><input type="number" class="table-input" id="studentFees_${staffId}" value="${staff.studentFees || 0}" onchange="updateDeductionsData('${staffId}', 'studentFees', this.value)"></td>
                    <td><input type="number" class="table-input" id="penalty_${staffId}" value="${staff.penalty || 0}" onchange="updateDeductionsData('${staffId}', 'penalty', this.value)"></td>
                    <td><input type="number" class="table-input" id="otherDeduction_${staffId}" value="${staff.otherDeduction || 0}" onchange="updateDeductionsData('${staffId}', 'otherDeduction', this.value)"></td>
                    <td>${status}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateDeductionsData(staffId, field, value) {
            if (currentDeductionsData[staffId]) {
                currentDeductionsData[staffId][field] = parseFloat(value) || 0;
            }
        }

        function submitDeductions() {
            const month = document.getElementById('deductionsMonth').value;
            const year = document.getElementById('deductionsYear').value;
            
            const deductionsData = {};
            Object.keys(currentDeductionsData).forEach(staffId => {
                deductionsData[staffId] = {
                    loanRecovery: parseFloat(currentDeductionsData[staffId].loanRecovery) || 0,
                    studentFees: parseFloat(currentDeductionsData[staffId].studentFees) || 0,
                    penalty: parseFloat(currentDeductionsData[staffId].penalty) || 0,
                    otherDeduction: parseFloat(currentDeductionsData[staffId].otherDeduction) || 0
                };
            });
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showMessage('deductionsMessage', response.message, response.success);
                    if (response.success) {
                        loadDeductionsData();
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('deductionsMessage', 'Error submitting deductions: ' + error.message, false);
                })
                .submitDeductionsForAllStaff(month, year, deductionsData);
        }

        // ========== PAYMENT SLIP FUNCTIONS ==========

        function loadSlipStaffDetails(staffId) {
            if (!staffId) return;
            
            const staffDetailsContainer = document.getElementById('slipStaffDetailsContainer');
            staffDetailsContainer.style.display = 'block';
            
            document.getElementById('slipDetailName').textContent = 'Loading...';
            document.getElementById('slipDetailDepartment').textContent = 'Loading...';
            document.getElementById('slipDetailDesignation').textContent = 'Loading...';
            document.getElementById('slipDetailStaffType').textContent = 'Loading...';
            document.getElementById('slipDetailBasicSalary').textContent = 'Loading...';
            document.getElementById('slipDetailPhoto').style.display = 'none';
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        const staff = response.staff;
                        
                        document.getElementById('slipDetailName').textContent = staff.name;
                        document.getElementById('slipDetailDepartment').textContent = staff.department;
                        document.getElementById('slipDetailDesignation').textContent = staff.designation;
                        document.getElementById('slipDetailStaffType').textContent = staff.staffType;
                        document.getElementById('slipDetailBasicSalary').textContent = '' + staff.basicSalary.toLocaleString('en-IN');
                        
                        const photoElement = document.getElementById('slipDetailPhoto');
                        if (staff.photoUrl) {
                            photoElement.src = staff.photoUrl;
                            photoElement.style.display = 'block';
                        } else {
                            photoElement.style.display = 'none';
                        }
                        
                        document.getElementById('paymentSlipMessage').innerHTML = '';
                    } else {
                        document.getElementById('slipDetailName').textContent = 'Not found';
                        document.getElementById('slipDetailDepartment').textContent = '-';
                        document.getElementById('slipDetailDesignation').textContent = '-';
                        document.getElementById('slipDetailStaffType').textContent = '-';
                        document.getElementById('slipDetailBasicSalary').textContent = '-';
                        document.getElementById('slipDetailPhoto').style.display = 'none';
                        
                        showMessage('paymentSlipMessage', response.message, false);
                    }
                })
                .withFailureHandler(function(error) {
                    document.getElementById('slipDetailName').textContent = 'Error loading';
                    document.getElementById('slipDetailDepartment').textContent = '-';
                    document.getElementById('slipDetailDesignation').textContent = '-';
                    document.getElementById('slipDetailStaffType').textContent = '-';
                    document.getElementById('slipDetailBasicSalary').textContent = '-';
                    document.getElementById('slipDetailPhoto').style.display = 'none';
                    
                    showMessage('paymentSlipMessage', 'Error loading staff details: ' + error.message, false);
                })
                .getStaffById(staffId);
        }

        function generatePaymentSlip() {
            const staffId = document.getElementById('slipStaffId').value;
            const month = document.getElementById('slipMonth').value;
            const year = document.getElementById('slipYear').value;
            
            if (!staffId || !month || !year) {
                showMessage('paymentSlipMessage', 'Please select all fields', false);
                return;
            }
            
            const resultDiv = document.getElementById('paymentSlipResult');
            resultDiv.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Generating payment slip...</div>';
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        showMessage('paymentSlipMessage', 'Payment slip generated successfully!', true);
                        
                        const slipHtml = generatePaymentSlipHtml(response);
                        resultDiv.innerHTML = slipHtml;
                        
                        const slipActions = document.createElement('div');
                        slipActions.className = 'slip-actions no-print';
                        slipActions.innerHTML = `
                            <div style="text-align: center; margin: 20px 0;">
                                <button class="btn btn-primary" onclick="printPaymentSlip()">
                                    <i class="fas fa-print"></i> Print Salary Slip
                                </button>
                            </div>
                        `;
                        resultDiv.insertBefore(slipActions, resultDiv.firstChild);
                        
                        resultDiv.scrollIntoView({ behavior: 'smooth' });
                    } else {
                        showMessage('paymentSlipMessage', response.message, false);
                        resultDiv.innerHTML = '<div class="message error">Failed to generate payment slip: ' + response.message + '</div>';
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('paymentSlipMessage', 'Error generating payment slip: ' + error.message, false);
                    resultDiv.innerHTML = '<div class="message error">Error: ' + error.message + '</div>';
                })
                .getSalarySlipData(staffId, month, year);
        }

        function generateAllTeachingSlips() {
            const month = document.getElementById('bulkMonth').value;
            const year = document.getElementById('bulkYear').value;
            
            if (!month || !year) {
                showMessage('paymentSlipMessage', 'Please select month and year', false);
                return;
            }
            
            const resultDiv = document.getElementById('paymentSlipResult');
            resultDiv.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Generating payment slips for all teaching staff...</div>';
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        showMessage('paymentSlipMessage', response.message, true);
                        
                        let slipsHtml = '<div class="slips-container">';
                        slipsHtml += `<h4>Payment Slips for ${month} ${year} (${response.data.length} teaching staff)</h4>`;
                        
                        response.data.forEach((slipData, index) => {
                            const slipHtml = generatePaymentSlipHtml(slipData);
                            slipsHtml += `<div class="content-card compact-card slip-item" style="margin-bottom: 20px;">`;
                            slipsHtml += `<div class="card-header">`;
                            slipsHtml += `<h5>${slipData.staff.name} (${slipData.staff.staffId}) - ${slipData.staff.designation}</h5>`;
                            slipsHtml += `<button class="btn btn-primary btn-sm no-print" onclick="printSingleSlip(this)">Print</button>`;
                            slipsHtml += `</div>`;
                            slipsHtml += `<div class="slip-content">${slipHtml}</div>`;
                            slipsHtml += `</div>`;
                        });
                        
                        slipsHtml += '</div>';
                        resultDiv.innerHTML = slipsHtml;
                        
                        resultDiv.scrollIntoView({ behavior: 'smooth' });
                    } else {
                        showMessage('paymentSlipMessage', response.message, false);
                        resultDiv.innerHTML = '<div class="message error">Failed to generate payment slips: ' + response.message + '</div>';
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('paymentSlipMessage', 'Error generating payment slips: ' + error.message, false);
                    resultDiv.innerHTML = '<div class="message error">Error: ' + error.message + '</div>';
                })
                .generateAllTeachingStaffSlips(month, year);
        }

        function printSingleSlip(button) {
            const slipContainer = button.closest('.slip-item').querySelector('.payment-slip-container');
            if (slipContainer) {
                const printContent = slipContainer.outerHTML;
                printSlipContent(printContent);
            }
        }

        function printPaymentSlip() {
            const slipContainer = document.querySelector('#paymentSlipResult .payment-slip-container');
            if (slipContainer) {
                const printContent = slipContainer.outerHTML;
                printSlipContent(printContent);
            }
        }

        function printSlipContent(content) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Print Salary Slip - A5 Landscape</title>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        body { margin: 0; padding: 0; font-family: 'Inter', Arial, sans-serif; background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        .payment-slip-container { width: 100%; margin: 0; padding: 0; border: none; box-shadow: none; }
                        .no-print { display: none !important; }
                        @media print {
                            body { margin: 0; padding: 0; width: 100%; height: 100%; }
                            .payment-slip-container { border: none !important; box-shadow: none !important; width: 100%; height: 100%; }
                            .receipt-column { page-break-inside: avoid; break-inside: avoid; }
                            @page { size: A5 landscape; margin: 0.2cm; }
                        }
                        ${document.querySelector('style').innerHTML}
                    </style>
                </head>
                <body>
                    ${content}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function generatePaymentSlipHtml(response) {
            const template = document.getElementById('paymentSlipTemplate').innerHTML;
            let slipHtml = template;
            
            const totalDays = response.calculation.totalDays || 0;
            const presentDays = response.calculation.presentDays || 0;
            const attendancePercentage = totalDays > 0 ? Math.round((presentDays / totalDays) * 100) : 0;
            
            slipHtml = slipHtml.replace(/{receiptNumber}/g, response.receiptNumber || 'N/A');
            slipHtml = slipHtml.replace(/{staffName}/g, response.staff.name);
            slipHtml = slipHtml.replace(/{staffId}/g, response.staff.staffId);
            slipHtml = slipHtml.replace(/{designation}/g, response.staff.designation);
            slipHtml = slipHtml.replace(/{department}/g, response.staff.department);
            slipHtml = slipHtml.replace(/{staffType}/g, response.staff.staffType);
            slipHtml = slipHtml.replace(/{bankAccount}/g, response.staff.bankAccount || 'N/A');
            slipHtml = slipHtml.replace(/{ifscCode}/g, response.staff.ifscCode || 'N/A');
            slipHtml = slipHtml.replace(/{phone}/g, response.staff.phone || 'N/A');
            slipHtml = slipHtml.replace(/{email}/g, response.staff.email || 'N/A');
            slipHtml = slipHtml.replace(/{joinDate}/g, response.staff.joinDate);
            slipHtml = slipHtml.replace(/{paymentPeriod}/g, `${response.month} ${response.year}`);
            slipHtml = slipHtml.replace(/{paymentDate}/g, new Date().toLocaleDateString('en-IN'));
            slipHtml = slipHtml.replace(/{totalDays}/g, totalDays);
            slipHtml = slipHtml.replace(/{presentDays}/g, presentDays);
            slipHtml = slipHtml.replace(/{absentDays}/g, response.calculation.absentDays || 0);
            slipHtml = slipHtml.replace(/{lateDays}/g, response.calculation.lateDays || 0);
            slipHtml = slipHtml.replace(/{halfDayLeave}/g, response.calculation.halfDayLeave || 0);
            slipHtml = slipHtml.replace(/{fullDayLeave}/g, response.calculation.fullDayLeave || 0);
            slipHtml = slipHtml.replace(/{basicSalary}/g, response.calculation.basicSalary.toLocaleString('en-IN'));
            slipHtml = slipHtml.replace(/{netSalary}/g, response.calculation.netSalary.toLocaleString('en-IN'));
            slipHtml = slipHtml.replace(/{totalEarnings}/g, response.calculation.totalEarnings.toLocaleString('en-IN'));
            slipHtml = slipHtml.replace(/{totalDeductions}/g, response.calculation.totalDeductions.toLocaleString('en-IN'));
            slipHtml = slipHtml.replace(/{attendancePercentage}/g, `${attendancePercentage}%`);
            
            const hasBankAccount = response.staff.bankAccount && response.staff.bankAccount !== 'N/A';
            const onlineChecked = hasBankAccount ? 'checked' : '';
            const cashChecked = !hasBankAccount ? 'checked' : '';
            slipHtml = slipHtml.replace(/{onlineChecked}/g, onlineChecked);
            slipHtml = slipHtml.replace(/{cashChecked}/g, cashChecked);
            
            const staffPhotoHtml = response.staff.photoUrl 
                ? `<img src="${response.staff.photoUrl}" alt="${response.staff.name}" class="staff-photo-receipt">`
                : '<div class="staff-photo-receipt" style="background:#f0f0f0;display:flex;align-items:center;justify-content:center;"><i class="fas fa-user" style="color:#999;"></i></div>';
            slipHtml = slipHtml.replace(/{staffPhoto}/g, staffPhotoHtml);
            
            let compactEarningsHtml = '';
            if (response.calculation.arrears > 0) {
                compactEarningsHtml += `<div class="financial-item"><span>Arrears:</span><span>${response.calculation.arrears.toLocaleString('en-IN')}</span></div>`;
            }
            if (response.calculation.loanEarning > 0) {
                compactEarningsHtml += `<div class="financial-item"><span>Loan:</span><span>${response.calculation.loanEarning.toLocaleString('en-IN')}</span></div>`;
            }
            if (response.calculation.td > 0) {
                compactEarningsHtml += `<div class="financial-item"><span>TD:</span><span>${response.calculation.td.toLocaleString('en-IN')}</span></div>`;
            }
            if (response.calculation.da > 0) {
                compactEarningsHtml += `<div class="financial-item"><span>DA:</span><span>${response.calculation.da.toLocaleString('en-IN')}</span></div>`;
            }
            if (response.calculation.earningLeave > 0) {
                compactEarningsHtml += `<div class="financial-item"><span>Earning Leave:</span><span>${response.calculation.earningLeave.toLocaleString('en-IN')}</span></div>`;
            }
            if (response.calculation.otherAllowance > 0) {
                compactEarningsHtml += `<div class="financial-item"><span>Other Allowance:</span><span>${response.calculation.otherAllowance.toLocaleString('en-IN')}</span></div>`;
            }
            if (response.calculation.leaveBonus > 0) {
                compactEarningsHtml += `<div class="financial-item"><span>Leave Bonus:</span><span>${response.calculation.leaveBonus.toLocaleString('en-IN')}</span></div>`;
            }
            
            if (!compactEarningsHtml) {
                compactEarningsHtml = '<div class="financial-item"><span>No additional earnings</span><span>0</span></div>';
            }
            slipHtml = slipHtml.replace(/{compactEarningsDetails}/g, compactEarningsHtml);
            
            let compactDeductionsHtml = '';
            if (response.calculation.lossOfPay > 0) {
                compactDeductionsHtml += `<div class="financial-item"><span>Loss of Pay:</span><span>${response.calculation.lossOfPay.toLocaleString('en-IN')}</span></div>`;
            }
            if (response.calculation.latePenalty > 0) {
                compactDeductionsHtml += `<div class="financial-item"><span>Late Penalty:</span><span>${response.calculation.latePenalty.toLocaleString('en-IN')}</span></div>`;
            }
            if (response.calculation.loanRecovery > 0) {
                compactDeductionsHtml += `<div class="financial-item"><span>Loan Recovery:</span><span>${response.calculation.loanRecovery.toLocaleString('en-IN')}</span></div>`;
            }
            if (response.calculation.studentFees > 0) {
                compactDeductionsHtml += `<div class="financial-item"><span>Student Fees:</span><span>${response.calculation.studentFees.toLocaleString('en-IN')}</span></div>`;
            }
            if (response.calculation.penalty > 0) {
                compactDeductionsHtml += `<div class="financial-item"><span>Penalty:</span><span>${response.calculation.penalty.toLocaleString('en-IN')}</span></div>`;
            }
            if (response.calculation.otherDeduction > 0) {
                compactDeductionsHtml += `<div class="financial-item"><span>Other Deduction:</span><span>${response.calculation.otherDeduction.toLocaleString('en-IN')}</span></div>`;
            }
            
            if (!compactDeductionsHtml) {
                compactDeductionsHtml = '<div class="financial-item"><span>No deductions</span><span>0</span></div>';
            }
            slipHtml = slipHtml.replace(/{compactDeductionsDetails}/g, compactDeductionsHtml);
            
            return slipHtml;
        }

        // ========== REPORT FUNCTIONS ==========

        function generateReport() {
            const month = document.getElementById('reportMonth').value;
            const year = document.getElementById('reportYear').value;
            
            if (!month || !year) {
                showMessage('reportResult', 'Please select both month and year', false);
                return;
            }
            
            const resultDiv = document.getElementById('reportResult');
            resultDiv.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Generating A4 report for ' + month + ' ' + year + '...</div>';
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        displayA4Report(response.data, month, year);
                    } else {
                        resultDiv.innerHTML = `<div class="message error">${response.message}</div>`;
                    }
                })
                .withFailureHandler(function(error) {
                    resultDiv.innerHTML = `<div class="message error">Error generating report: ${error.message}</div>`;
                })
                .getSalaryDataForMonth(month, year);
        }

        function displayA4Report(data, month, year) {
            const container = document.getElementById('reportResult');
            
            let totalEarnings = 0;
            let totalDeductions = 0;
            let totalNetSalary = 0;
            
            const sortedStaffIds = Object.keys(data).sort((a, b) => {
                const getNumber = (id) => {
                    const match = id.match(/(\d+)$/);
                    return match ? parseInt(match[1]) : 0;
                };
                return getNumber(a) - getNumber(b);
            });
            
            const staffCount = sortedStaffIds.length;
            
            sortedStaffIds.forEach(staffId => {
                const staff = data[staffId];
                totalEarnings += staff.totalEarnings;
                totalDeductions += staff.totalDeductions;
                totalNetSalary += staff.netSalary;
            });
            
            let html = `
                <div class="a4-report-container">
                    <div class="report-header">
                        <div class="school-logo-report">
                            <img src="https://lh3.googleusercontent.com/d/1zxgYSP4m3solH4FLbURzIjXmB_OymF3Z" alt="Success School Logo">
                        </div>
                        <div class="school-name-report">SUCCESS SCHOOL, INDI</div>
                        <div class="report-title">SALARY REPORT</div>
                        <div class="report-period">${month} ${year}</div>
                    </div>
                    
                    <div class="report-summary">
                        <div class="summary-grid-a4">
                            <div class="summary-card-a4">
                                <div class="summary-value-a4">${staffCount}</div>
                                <div class="summary-label-a4">Total Staff</div>
                            </div>
                            <div class="summary-card-a4">
                                <div class="summary-value-a4">${totalEarnings.toLocaleString('en-IN')}</div>
                                <div class="summary-label-a4">Total Earnings</div>
                            </div>
                            <div class="summary-card-a4">
                                <div class="summary-value-a4">${totalDeductions.toLocaleString('en-IN')}</div>
                                <div class="summary-label-a4">Total Deductions</div>
                            </div>
                            <div class="summary-card-a4">
                                <div class="summary-value-a4">${totalNetSalary.toLocaleString('en-IN')}</div>
                                <div class="summary-label-a4">Net Salary Paid</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container" style="overflow-x: auto; margin-bottom: 20px;">
                        <table class="data-table compact-table" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background-color: #4361ee; color: white;">
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Staff ID</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Name</th>
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Department</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Basic Salary</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Total Earnings</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Total Deductions</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Net Salary</th>
                                    <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            sortedStaffIds.forEach(staffId => {
                const staff = data[staffId];
                const status = staff.earningsSubmitted && staff.deductionsSubmitted ?
                    '<span style="background-color: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;"> Complete</span>' :
                    '<span style="background-color: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;"> Pending</span>';
                
                html += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">${staffId}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${staff.name}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${staff.department}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${staff.basicSalary.toLocaleString('en-IN')}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${staff.totalEarnings.toLocaleString('en-IN')}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${staff.totalDeductions.toLocaleString('en-IN')}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: 700;">${staff.netSalary.toLocaleString('en-IN')}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${status}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                            <tfoot>
                                <tr style="background-color: #f8f9fa; font-weight: 700;">
                                    <td colspan="4" style="padding: 12px; border: 1px solid #ddd; text-align: right;">Totals:</td>
                                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${totalEarnings.toLocaleString('en-IN')}</td>
                                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${totalDeductions.toLocaleString('en-IN')}</td>
                                    <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${totalNetSalary.toLocaleString('en-IN')}</td>
                                    <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${staffCount} Staff</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="report-footer" style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd; text-align: center; font-size: 12px; color: #666;">
                        <div>Generated on: ${new Date().toLocaleDateString('en-IN')}</div>
                        <div>SUCCESS SCHOOL, INDI - Salary Management System</div>
                    </div>
                </div>
                
                <div class="no-print" style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="printA4Report()" style="margin-right: 10px;">
                        <i class="fas fa-print"></i> Print A4 Report
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function printA4Report() {
            const reportContainer = document.querySelector('.a4-report-container');
            if (reportContainer) {
                const printContent = reportContainer.outerHTML;
                printA4Content(printContent);
            }
        }

        function printA4Content(content) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Salary Report - A4</title>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        body { margin: 0; padding: 0; font-family: 'Inter', Arial, sans-serif; background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        .a4-report-container { width: 210mm; min-height: 297mm; margin: 0 auto; background: white; padding: 10mm; box-shadow: none; border: none; }
                        .no-print { display: none !important; }
                        .report-header { text-align: center; margin-bottom: 6mm; border-bottom: 2px solid #333; padding-bottom: 3mm; }
                        .school-logo-report { width: 60px; height: 60px; margin: 0 auto 1.5mm; border-radius: 50%; background: white; padding: 2px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; overflow: hidden; }
                        .school-logo-report img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; display: block; }
                        .school-name-report { font-size: 14pt; font-weight: 700; color: #2c5aa0; margin-bottom: 1mm; line-height: 1.2; }
                        .report-title { font-size: 12pt; font-weight: 600; color: #2c3e50; margin-bottom: 1mm; }
                        .report-period { font-size: 10pt; color: #666; }
                        .report-summary { margin-bottom: 6mm; padding: 3mm; background: #f8f9fa; border-radius: 2mm; border-left: 4px solid #3498db; }
                        .summary-grid-a4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2mm; margin-bottom: 4mm; }
                        .summary-card-a4 { background: white; border-radius: 1mm; padding: 3mm; text-align: center; border: 1px solid #e2e8f0; }
                        .summary-value-a4 { font-size: 14pt; font-weight: 700; margin-bottom: 1mm; color: #2c3e50; }
                        .summary-label-a4 { font-size: 9pt; color: #666; font-weight: 500; }
                        .compact-table-a4 { width: 100%; border-collapse: collapse; font-size: 8pt; margin-bottom: 4mm; }
                        .compact-table-a4 th { background: #2c5aa0 !important; color: white !important; padding: 1.5mm 2mm; text-align: left; font-weight: 600; border: 1px solid #1e3a8a; }
                        .compact-table-a4 td { padding: 1.5mm 2mm; border: 1px solid #e2e8f0; }
                        .compact-table-a4 tr:nth-child(even) { background: #f8fafc; }
                        .currency { text-align: right; font-family: 'Courier New', monospace; }
                        .report-footer { margin-top: 6mm; padding-top: 3mm; border-top: 1px solid #e2e8f0; text-align: center; font-size: 8pt; color: #666; }
                        @page { size: A4; margin: 10mm; }
                        @media print { body { margin: 0; } .a4-report-container { margin: 0; padding: 10mm; border: none; box-shadow: none; } .compact-table-a4 { font-size: 7pt; } }
                    </style>
                </head>
                <body>
                    ${content}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // ========== HOLIDAY MANAGEMENT FUNCTIONS ==========

        function updateEndDateMin() {
            const startDate = document.getElementById('startDate').value;
            if (startDate) {
                document.getElementById('endDate').min = startDate;
                if (!document.getElementById('endDate').value) {
                    document.getElementById('endDate').value = startDate;
                }
            }
        }

        function addHoliday() {
            const data = {
                holidayName: document.getElementById('holidayName').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                reason: document.getElementById('reason').value,
                addedBy: currentUser ? currentUser.username : 'Admin'
            };
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showMessage('holidayMessage', response.message, response.success);
                    if (response.success) {
                        document.getElementById('holidayForm').reset();
                        loadHolidays();
                    }
                })
                .addHoliday(data);
        }

        function loadHolidays() {
            google.script.run
                .withSuccessHandler(function(holidays) {
                    const holidaysListDiv = document.getElementById('holidaysList');
                    if (holidays.length === 0) {
                        holidaysListDiv.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><h3>No Holidays</h3><p>No holidays added yet. Add holidays using the form above.</p></div>';
                        return;
                    }
                    
                    let html = '<div class="table-container"><table class="data-table compact-table"><thead><tr><th>Holiday ID</th><th>Holiday Name</th><th>Start Date</th><th>End Date</th><th>Days</th><th>Reason</th><th>Added By</th><th>Actions</th></tr></thead><tbody>';
                    holidays.forEach(holiday => {
                        html += `<tr>
                            <td><strong>${holiday.holidayId}</strong></td>
                            <td>${holiday.holidayName}</td>
                            <td>${holiday.startDate}</td>
                            <td>${holiday.endDate}</td>
                            <td>${holiday.numberOfDays}</td>
                            <td>${holiday.reason}</td>
                            <td>${holiday.addedBy}</td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteHoliday('${holiday.holidayId}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>`;
                    });
                    html += '</tbody></table></div>';
                    holidaysListDiv.innerHTML = html;
                })
                .getAllHolidays();
        }

        function deleteHoliday(holidayId) {
            if (confirm('Are you sure you want to delete this holiday? This will update attendance records for the holiday period.')) {
                google.script.run
                    .withSuccessHandler(function(response) {
                        showMessage('holidayMessage', response.message, response.success);
                        if (response.success) {
                            loadHolidays();
                        }
                    })
                    .deleteHoliday(holidayId);
            }
        }

        // ========== MONTHLY ATTENDANCE FUNCTIONS ==========

        function createMonthlyAttendance() {
            const month = document.getElementById('attendanceMonth').value;
            const year = document.getElementById('attendanceYear').value;
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showMessage('monthlyAttendanceMessage', response.message, response.success);
                })
                .createMonthlyAttendanceSheet(month, year);
        }

        // ========== DAILY ATTENDANCE FUNCTIONS ==========

        function loadDailyAttendanceData() {
            const date = document.getElementById('dailyAttendanceDate').value;
            
            if (!date) {
                document.getElementById('dailyAttendanceDataContainer').style.display = 'none';
                return;
            }
            
            document.getElementById('dailyAttendanceDateDisplay').textContent = new Date(date).toLocaleDateString('en-IN');
            
            document.getElementById('dailyAttendanceMessage').innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading staff data...</div>';
            
            google.script.run
                .withSuccessHandler(function(staffList) {
                    document.getElementById('dailyAttendanceMessage').innerHTML = '';
                    
                    if (staffList.length > 0) {
                        currentDailyAttendanceData = {};
                        staffList.forEach(staff => {
                            currentDailyAttendanceData[staff.staffId] = {
                                name: staff.name,
                                department: staff.department,
                                designation: staff.designation,
                                staffType: staff.staffType,
                                status: 'present'
                            };
                        });
                        displayDailyAttendanceTable();
                        document.getElementById('dailyAttendanceDataContainer').style.display = 'block';
                        
                        const attendanceDate = new Date(date);
                        const isSunday = attendanceDate.getDay() === 0;
                        
                        let infoText = 'Mark attendance for all staff members. ';
                        if (isSunday) {
                            infoText += '<strong style="color: var(--warning);">Note: This is Sunday - will be automatically marked as holiday.</strong>';
                        }
                        
                        document.getElementById('dailyAttendanceInfo').innerHTML = infoText;
                        
                    } else {
                        showMessage('dailyAttendanceMessage', 'No staff members found!', false);
                        document.getElementById('dailyAttendanceDataContainer').style.display = 'none';
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('dailyAttendanceMessage', 'Error loading staff data: ' + error.message, false);
                    document.getElementById('dailyAttendanceDataContainer').style.display = 'none';
                })
                .getAllStaff();
        }

        function displayDailyAttendanceTable() {
            const tbody = document.getElementById('dailyAttendanceTableBody');
            tbody.innerHTML = '';
            
            Object.keys(currentDailyAttendanceData).forEach(staffId => {
                const staff = currentDailyAttendanceData[staffId];
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${staffId}</strong></td>
                    <td>${staff.name}</td>
                    <td>${staff.department}</td>
                    <td>${staff.designation}</td>
                    <td><span class="badge ${staff.staffType === 'Teaching' ? 'badge-success' : 'badge-warning'}">${staff.staffType}</span></td>
                    <td><span class="${staff.status === 'present' ? 'attendance-present' : staff.status === 'absent' ? 'attendance-absent' : 'attendance-late'}">${staff.status.charAt(0).toUpperCase() + staff.status.slice(1)}</span></td>
                    <td>
                        <select class="table-input" onchange="updateDailyAttendanceData('${staffId}', this.value)">
                            <option value="present" ${staff.status === 'present' ? 'selected' : ''}>Present</option>
                            <option value="absent" ${staff.status === 'absent' ? 'selected' : ''}>Absent</option>
                            <option value="late" ${staff.status === 'late' ? 'selected' : ''}>Late Coming</option>
                            <option value="halfday" ${staff.status === 'halfday' ? 'selected' : ''}>Half Day</option>
                            <option value="fullday" ${staff.status === 'fullday' ? 'selected' : ''}>Full Day Leave</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateDailyAttendanceData(staffId, status) {
            if (currentDailyAttendanceData[staffId]) {
                currentDailyAttendanceData[staffId].status = status;
            }
        }

        function markAllPresentDaily() {
            Object.keys(currentDailyAttendanceData).forEach(staffId => {
                currentDailyAttendanceData[staffId].status = 'present';
            });
            displayDailyAttendanceTable();
        }

        function markAllAbsentDaily() {
            Object.keys(currentDailyAttendanceData).forEach(staffId => {
                currentDailyAttendanceData[staffId].status = 'absent';
            });
            displayDailyAttendanceTable();
        }

        function markAllLateDaily() {
            Object.keys(currentDailyAttendanceData).forEach(staffId => {
                currentDailyAttendanceData[staffId].status = 'late';
            });
            displayDailyAttendanceTable();
        }

        function markAllHalfDayDaily() {
            Object.keys(currentDailyAttendanceData).forEach(staffId => {
                currentDailyAttendanceData[staffId].status = 'halfday';
            });
            displayDailyAttendanceTable();
        }

        function markAllFullDayDaily() {
            Object.keys(currentDailyAttendanceData).forEach(staffId => {
                currentDailyAttendanceData[staffId].status = 'fullday';
            });
            displayDailyAttendanceTable();
        }

        function submitDailyAttendance() {
            const date = document.getElementById('dailyAttendanceDate').value;
            
            const attendanceData = {};
            Object.keys(currentDailyAttendanceData).forEach(staffId => {
                attendanceData[staffId] = currentDailyAttendanceData[staffId].status;
            });
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showMessage('dailyAttendanceMessage', response.message, response.success);
                    if (response.success) {
                        if (response.isSunday) {
                            showMessage('dailyAttendanceMessage', 'Attendance submitted! ' + response.message + ' (Sunday - automatically marked as holiday)', true);
                        } else if (response.isHoliday) {
                            showMessage('dailyAttendanceMessage', 'Attendance submitted! ' + response.message + ' (' + response.holidayName + ' - automatically marked as holiday)', true);
                        }
                    }
                })
                .submitDailyAttendance(date, attendanceData);
        }

        // ========== LEAVE MANAGEMENT FUNCTIONS ==========

        function loadAllLeaves() {
            google.script.run
                .withSuccessHandler(function(leaves) {
                    const leavesListDiv = document.getElementById('allLeavesList');
                    if (!leaves || leaves.length === 0) {
                        leavesListDiv.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><h3>No Leave Applications</h3><p>No pending leave applications found.</p></div>';
                        return;
                    }
                    
                    let html = '<div class="table-container"><table class="data-table compact-table"><thead><tr><th>Leave ID</th><th>Staff ID</th><th>Staff Name</th><th>Department</th><th>Leave Type</th><th>Start Date</th><th>End Date</th><th>Days</th><th>Reason</th><th>Status</th><th>Applied Date</th><th>Actions</th></tr></thead><tbody>';
                    
                    leaves.forEach(leave => {
                        const statusColor = leave.status === 'Approved' ? 'badge-success' : 
                                          leave.status === 'Rejected' ? 'badge-danger' : 'badge-warning';
                        
                        const actionButtons = leave.status === 'Pending' ? 
                            `<div class="action-buttons">
                                <button class="btn btn-success btn-sm" onclick="approveLeave('${leave.leaveId}')">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="rejectLeave('${leave.leaveId}')">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </div>` : 
                            `<span class="badge ${statusColor}">${leave.status}</span>`;
                        
                        html += `<tr>
                            <td><code>${leave.leaveId || 'N/A'}</code></td>
                            <td><strong>${leave.staffId || 'N/A'}</strong></td>
                            <td>${leave.staffName || 'N/A'}</td>
                            <td>${leave.department || 'N/A'}</td>
                            <td>${leave.leaveType || 'N/A'}</td>
                            <td>${leave.startDate || 'N/A'}</td>
                            <td>${leave.endDate || 'N/A'}</td>
                            <td>${leave.numberOfDays || 0}</td>
                            <td>${leave.reason || 'N/A'}</td>
                            <td><span class="badge ${statusColor}">${leave.status || 'Pending'}</span></td>
                            <td>${leave.appliedDate || 'N/A'}</td>
                            <td>${actionButtons}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    leavesListDiv.innerHTML = html;
                    
                })
                .withFailureHandler(function(error) {
                    const leavesListDiv = document.getElementById('allLeavesList');
                    leavesListDiv.innerHTML = '<div class="message error">Error loading leaves: ' + error.message + '</div>';
                })
                .getAllLeavesForAdmin();
        }

        function approveLeave(leaveId) {
            if (confirm('Are you sure you want to approve this leave application?')) {
                const approvedBy = currentUser ? currentUser.username : 'Principal';
                
                google.script.run
                    .withSuccessHandler(function(response) {
                        if (response.success) {
                            showMessage('allLeavesList', response.message, true);
                            loadAllLeaves();
                        } else {
                            showMessage('allLeavesList', response.message, false);
                        }
                    })
                    .withFailureHandler(function(error) {
                        showMessage('allLeavesList', 'Error approving leave: ' + error.message, false);
                    })
                    .approveLeave(leaveId, approvedBy);
            }
        }

        function rejectLeave(leaveId) {
            if (confirm('Are you sure you want to reject this leave application?')) {
                const approvedBy = currentUser ? currentUser.username : 'Principal';
                
                google.script.run
                    .withSuccessHandler(function(response) {
                        if (response.success) {
                            showMessage('allLeavesList', response.message, true);
                            loadAllLeaves();
                        } else {
                            showMessage('allLeavesList', response.message, false);
                        }
                    })
                    .withFailureHandler(function(error) {
                        showMessage('allLeavesList', 'Error rejecting leave: ' + error.message, false);
                    })
                    .rejectLeave(leaveId, approvedBy);
            }
        }

        // ========== NOTICE AND TASK MANAGEMENT FUNCTIONS ==========

        function addNotice() {
            const noticeData = {
                title: document.getElementById('noticeTitle').value,
                priority: document.getElementById('noticePriority').value,
                targetAudience: document.getElementById('targetAudience').value,
                expiryDate: document.getElementById('noticeExpiry').value,
                message: document.getElementById('noticeMessage').value,
                sender: currentUser ? currentUser.username : 'Admin'
            };
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showMessage('noticeFormMessage', response.message, response.success);
                    if (response.success) {
                        document.getElementById('noticeForm').reset();
                        loadAllNotices();
                    }
                })
                .addNotice(noticeData);
        }

        function addTask() {
            const taskData = {
                title: document.getElementById('taskTitle').value,
                priority: document.getElementById('taskPriority').value,
                assignedTo: document.getElementById('assignedTo').value,
                dueDate: document.getElementById('taskDueDate').value,
                description: document.getElementById('taskDescription').value,
                assignedBy: currentUser ? currentUser.username : 'Admin'
            };
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showMessage('taskFormMessage', response.message, response.success);
                    if (response.success) {
                        document.getElementById('taskForm').reset();
                        loadAllTasks();
                    }
                })
                .addTask(taskData);
        }

        function loadAllNotices() {
            google.script.run
                .withSuccessHandler(function(notices) {
                    const noticesListDiv = document.getElementById('allNoticesList');
                    if (!notices || notices.length === 0) {
                        noticesListDiv.innerHTML = '<div class="empty-state"><i class="fas fa-bullhorn"></i><h3>No Notices</h3><p>No notices have been sent yet.</p></div>';
                        return;
                    }
                    
                    let html = '<div class="table-container"><table class="data-table compact-table"><thead><tr><th>Notice ID</th><th>Title</th><th>Priority</th><th>Audience</th><th>Sender</th><th>Sent Date</th><th>Expiry Date</th><th>Status</th><th>Read By</th><th>Acknowledged By</th></tr></thead><tbody>';
                    
                    notices.forEach(notice => {
                        const priorityColor = notice.priority === 'Urgent' ? 'badge-danger' : 
                                            notice.priority === 'High' ? 'badge-warning' :
                                            notice.priority === 'Medium' ? 'badge-info' : 'badge-success';
                        
                        html += `<tr>
                            <td><code>${notice.noticeId}</code></td>
                            <td><strong>${notice.title}</strong></td>
                            <td><span class="badge ${priorityColor}">${notice.priority}</span></td>
                            <td>${notice.targetAudience}</td>
                            <td>${notice.sender}</td>
                            <td>${notice.sentDate}</td>
                            <td>${notice.expiryDate}</td>
                            <td><span class="badge badge-success">${notice.status}</span></td>
                            <td>${notice.readBy ? notice.readBy.split(',').length : 0} staff</td>
                            <td>${notice.acknowledgedBy ? notice.acknowledgedBy.split(',').length : 0} staff</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    noticesListDiv.innerHTML = html;
                })
                .withFailureHandler(function(error) {
                    const noticesListDiv = document.getElementById('allNoticesList');
                    noticesListDiv.innerHTML = '<div class="message error">Error loading notices: ' + error.message + '</div>';
                })
                .getAllNotices();
        }

        function loadStaffForTasks() {
            google.script.run
                .withSuccessHandler(function(staffOptions) {
                    const assignedToSelect = document.getElementById('assignedTo');
                    
                    if (staffOptions && staffOptions.length > 0) {
                        assignedToSelect.innerHTML = '<option value="">Select Staff Member</option>';
                        
                        staffOptions.forEach(staff => {
                            const option = new Option(staff.displayText, staff.staffId);
                            assignedToSelect.add(option);
                        });
                    } else {
                        assignedToSelect.innerHTML = '<option value="">No staff members found</option>';
                    }
                })
                .withFailureHandler(function(error) {
                    const assignedToSelect = document.getElementById('assignedTo');
                    assignedToSelect.innerHTML = '<option value="">Error loading staff</option>';
                    console.error('Error loading staff for tasks:', error);
                })
                .getAllStaffForTasks();
        }

        function loadAllTasks() {
            google.script.run
                .withSuccessHandler(function(tasks) {
                    const tasksListDiv = document.getElementById('allTasksList');
                    if (!tasks || tasks.length === 0) {
                        tasksListDiv.innerHTML = '<div class="empty-state"><i class="fas fa-tasks"></i><h3>No Tasks</h3><p>No tasks have been assigned yet.</p></div>';
                        return;
                    }
                    
                    let html = '<div class="table-container"><table class="data-table compact-table"><thead><tr><th>Task ID</th><th>Title</th><th>Assigned To</th><th>Assigned By</th><th>Due Date</th><th>Priority</th><th>Status</th><th>Acknowledged</th><th>Actions</th></tr></thead><tbody>';
                    
                    tasks.forEach(task => {
                        const priorityColor = task.priority === 'Urgent' ? 'badge-danger' : 
                                            task.priority === 'High' ? 'badge-warning' :
                                            task.priority === 'Medium' ? 'badge-info' : 'badge-success';
                        
                        const statusColor = task.status === 'Completed' ? 'badge-success' :
                                          task.status === 'In Progress' ? 'badge-info' :
                                          task.status === 'Pending' ? 'badge-warning' : 'badge-secondary';
                        
                        const isOverdue = new Date(task.dueDate) < new Date() && task.status !== 'Completed';
                        
                        html += `<tr ${isOverdue ? 'style="background-color: #fff5f5;"' : ''}>
                            <td><code>${task.taskId}</code></td>
                            <td><strong>${task.title}</strong>${isOverdue ? ' <span class="badge badge-danger">Overdue</span>' : ''}</td>
                            <td>${task.assignedTo}</td>
                            <td>${task.assignedBy}</td>
                            <td>${task.dueDate}</td>
                            <td><span class="badge ${priorityColor}">${task.priority}</span></td>
                            <td><span class="badge ${statusColor}">${task.status}</span></td>
                            <td>${task.acknowledged ? '<span class="badge badge-success">Yes</span>' : '<span class="badge badge-warning">No</span>'}</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="viewTaskDetails('${task.taskId}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    tasksListDiv.innerHTML = html;
                })
                .withFailureHandler(function(error) {
                    const tasksListDiv = document.getElementById('allTasksList');
                    tasksListDiv.innerHTML = '<div class="message error">Error loading tasks: ' + error.message + '</div>';
                })
                .getAllTasks();
        }

        function viewTaskDetails(taskId) {
            alert(`Viewing task details for ${taskId}`);
        }

        function loadStaffNotices() {
            if (!currentStaff || !currentStaff.staffId) return;
            
            google.script.run
                .withSuccessHandler(function(notices) {
                    const noticesListDiv = document.getElementById('staffNoticesList');
                    if (!notices || notices.length === 0) {
                        noticesListDiv.innerHTML = '<div class="empty-state"><i class="fas fa-bullhorn"></i><h3>No Notices</h3><p>No notices available at the moment.</p></div>';
                        return;
                    }
                    
                    let html = '';
                    notices.forEach(notice => {
                        const priorityColor = notice.priority === 'Urgent' ? 'badge-danger' : 
                                            notice.priority === 'High' ? 'badge-warning' :
                                            notice.priority === 'Medium' ? 'badge-info' : 'badge-success';
                        
                        const readStatus = notice.isRead ? 
                            '<span class="badge badge-success"><i class="fas fa-check"></i> Read</span>' : 
                            '<span class="badge badge-warning"><i class="fas fa-envelope"></i> Unread</span>';
                        
                        const ackStatus = notice.isAcknowledged ?
                            '<span class="badge badge-success"><i class="fas fa-check-double"></i> Acknowledged</span>' :
                            '<span class="badge badge-secondary"><i class="fas fa-clock"></i> Pending</span>';
                        
                        html += `
                            <div class="content-card compact-card" style="border-left: 4px solid ${getPriorityColor(notice.priority)}; margin-bottom: 15px;">
                                <div class="card-header">
                                    <h3 class="card-title">${notice.title} <span class="badge ${priorityColor}">${notice.priority}</span></h3>
                                    <div>
                                        ${readStatus}
                                        ${ackStatus}
                                    </div>
                                </div>
                                <div class="notice-content">
                                    <p>${notice.message}</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>
                                            <strong>From:</strong> ${notice.sender} | 
                                            <strong>Sent:</strong> ${notice.sentDate} |
                                            <strong>Expires:</strong> ${notice.expiryDate}
                                        </div>
                                        <div class="action-buttons">
                                            ${!notice.isRead ? `
                                                <button class="btn btn-primary btn-sm" onclick="markNoticeAsRead('${notice.noticeId}')">
                                                    <i class="fas fa-check"></i> Mark as Read
                                                </button>
                                            ` : ''}
                                            ${!notice.isAcknowledged ? `
                                                <button class="btn btn-success btn-sm" onclick="acknowledgeStaffNotice('${notice.noticeId}')">
                                                    <i class="fas fa-check-double"></i> Acknowledge
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    noticesListDiv.innerHTML = html;
                })
                .withFailureHandler(function(error) {
                    const noticesListDiv = document.getElementById('staffNoticesList');
                    noticesListDiv.innerHTML = '<div class="message error">Error loading notices: ' + error.message + '</div>';
                })
                .getNoticesForStaff(currentStaff.staffId);
        }

        function loadStaffTasks() {
            if (!currentStaff || !currentStaff.staffId) return;
            
            google.script.run
                .withSuccessHandler(function(tasks) {
                    const tasksListDiv = document.getElementById('staffTasksList');
                    if (!tasks || tasks.length === 0) {
                        tasksListDiv.innerHTML = '<div class="empty-state"><i class="fas fa-tasks"></i><h3>No Tasks</h3><p>No tasks assigned to you at the moment.</p></div>';
                        return;
                    }
                    
                    let html = '';
                    tasks.forEach(task => {
                        const priorityColor = task.priority === 'Urgent' ? 'badge-danger' : 
                                            task.priority === 'High' ? 'badge-warning' :
                                            task.priority === 'Medium' ? 'badge-info' : 'badge-success';
                        
                        const statusColor = task.status === 'Completed' ? 'badge-success' :
                                          task.status === 'In Progress' ? 'badge-info' :
                                          task.status === 'Pending' ? 'badge-warning' : 'badge-secondary';
                        
                        const isOverdue = new Date(task.dueDate) < new Date() && task.status !== 'Completed';
                        
                        html += `
                            <div class="content-card compact-card" style="border-left: 4px solid ${getPriorityColor(task.priority)}; margin-bottom: 15px;">
                                <div class="card-header">
                                    <h3 class="card-title">${task.title} <span class="badge ${priorityColor}">${task.priority}</span></h3>
                                    <div>
                                        <span class="badge ${statusColor}">${task.status}</span>
                                        ${isOverdue ? '<span class="badge badge-danger">Overdue</span>' : ''}
                                    </div>
                                </div>
                                <div class="task-content">
                                    <p><strong>Description:</strong> ${task.description}</p>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>
                                            <strong>Assigned by:</strong> ${task.assignedBy} | 
                                            <strong>Due Date:</strong> ${task.dueDate}
                                        </div>
                                        <div class="action-buttons">
                                            ${!task.acknowledged ? `
                                                <button class="btn btn-primary btn-sm" onclick="acknowledgeStaffTask('${task.taskId}')">
                                                    <i class="fas fa-check"></i> Acknowledge
                                                </button>
                                            ` : ''}
                                            ${task.status !== 'Completed' ? `
                                                <button class="btn btn-success btn-sm" onclick="updateTaskStatus('${task.taskId}', 'In Progress')">
                                                    <i class="fas fa-play"></i> Start
                                                </button>
                                                <button class="btn btn-info btn-sm" onclick="updateTaskStatus('${task.taskId}', 'Completed')">
                                                    <i class="fas fa-check-circle"></i> Complete
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    tasksListDiv.innerHTML = html;
                })
                .withFailureHandler(function(error) {
                    const tasksListDiv = document.getElementById('staffTasksList');
                    tasksListDiv.innerHTML = '<div class="message error">Error loading tasks: ' + error.message + '</div>';
                })
                .getTasksForStaff(currentStaff.staffId);
        }

        function getPriorityColor(priority) {
            switch(priority) {
                case 'Urgent': return '#dc3545';
                case 'High': return '#fd7e14';
                case 'Medium': return '#007bff';
                case 'Low': return '#28a745';
                default: return '#6c757d';
            }
        }

        function markNoticeAsRead(noticeId) {
            if (!currentStaff || !currentStaff.staffId) return;
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        showStaffMessage('staffNoticesList', response.message, true);
                        loadStaffNotices();
                    } else {
                        showStaffMessage('staffNoticesList', response.message, false);
                    }
                })
                .markNoticeAsRead(noticeId, currentStaff.staffId);
        }

        function acknowledgeStaffNotice(noticeId) {
            if (!currentStaff || !currentStaff.staffId) return;
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        showStaffMessage('staffNoticesList', response.message, true);
                        loadStaffNotices();
                    } else {
                        showStaffMessage('staffNoticesList', response.message, false);
                    }
                })
                .acknowledgeNotice(noticeId, currentStaff.staffId);
        }

        function acknowledgeStaffTask(taskId) {
            if (!currentStaff || !currentStaff.staffId) return;
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        showStaffMessage('staffTasksList', response.message, true);
                        loadStaffTasks();
                    } else {
                        showStaffMessage('staffTasksList', response.message, false);
                    }
                })
                .acknowledgeTask(taskId, currentStaff.staffId);
        }

        function updateTaskStatus(taskId, status) {
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        showStaffMessage('staffTasksList', response.message, true);
                        loadStaffTasks();
                    } else {
                        showStaffMessage('staffTasksList', response.message, false);
                    }
                })
                .updateTaskStatus(taskId, status, '');
        }

        // ========== TIMING CONFIGURATION FUNCTIONS ==========

        function loadTimingConfig() {
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        const config = response.config;
                        
                        document.getElementById('startHour').value = config.startHour;
                        document.getElementById('startMinute').value = config.startMinute;
                        document.getElementById('endHour').value = config.endHour;
                        document.getElementById('endMinute').value = config.endMinute;
                        
                        if (config.isEnabled) {
                            document.getElementById('timingEnabled').checked = true;
                        } else {
                            document.getElementById('timingDisabled').checked = true;
                        }
                        
                        displayCurrentConfig(config);
                        
                        showMessage('timingConfigMessage', 'Current configuration loaded successfully!', true);
                    } else {
                        showMessage('timingConfigMessage', response.message, false);
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('timingConfigMessage', 'Error loading configuration: ' + error.message, false);
                })
                .getAttendanceTimingConfig();
        }

        function displayCurrentConfig(config) {
            const displayDiv = document.getElementById('currentConfigDisplay');
            const detailsDiv = document.getElementById('currentConfigDetails');
            
            const startTime = `${config.startHour.toString().padStart(2, '0')}:${config.startMinute.toString().padStart(2, '0')}`;
            const endTime = `${config.endHour.toString().padStart(2, '0')}:${config.endMinute.toString().padStart(2, '0')}`;
            
            let html = `
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Allowed Time Window</label>
                        <div class="form-control" style="background: #e8f5e8; font-weight: bold;">
                            ${startTime} - ${endTime}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Restriction Status</label>
                        <div class="form-control" style="background: ${config.isEnabled ? '#e8f5e8' : '#fff3cd'}; font-weight: bold;">
                            ${config.isEnabled ? ' Enabled' : ' Disabled'}
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Last Modified</label>
                        <div class="form-control">${new Date(config.lastModified).toLocaleString()}</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Modified By</label>
                        <div class="form-control">${config.modifiedBy}</div>
                    </div>
                </div>
            `;
            
            detailsDiv.innerHTML = html;
            displayDiv.style.display = 'block';
        }

        function saveTimingConfig() {
            if (!currentUser || currentUser.role !== 'Admin') {
                showMessage('timingConfigMessage', 'Only admin users can modify timing configuration', false);
                return;
            }
            
            const configData = {
                startHour: parseInt(document.getElementById('startHour').value),
                startMinute: parseInt(document.getElementById('startMinute').value),
                endHour: parseInt(document.getElementById('endHour').value),
                endMinute: parseInt(document.getElementById('endMinute').value),
                isEnabled: document.querySelector('input[name="isEnabled"]:checked').value === 'true'
            };
            
            const startTotal = configData.startHour * 60 + configData.startMinute;
            const endTotal = configData.endHour * 60 + configData.endMinute;
            
            if (startTotal >= endTotal) {
                showMessage('timingConfigMessage', 'End time must be after start time', false);
                return;
            }
            
            google.script.run
                .withSuccessHandler(function(response) {
                    showMessage('timingConfigMessage', response.message, response.success);
                    if (response.success) {
                        displayCurrentConfig(response.config);
                        updateRealTimeStatus();
                        loadTimingConfigLogs();
                    }
                })
                .withFailureHandler(function(error) {
                    showMessage('timingConfigMessage', 'Error saving configuration: ' + error.message, false);
                })
                .updateAttendanceTimingConfig(configData, currentUser.username);
        }

        function loadTimingConfigLogs() {
            google.script.run
                .withSuccessHandler(function(logs) {
                    const logsDiv = document.getElementById('timingConfigLogs');
                    
                    if (!logs || logs.length === 0) {
                        logsDiv.innerHTML = '<div class="empty-state"><i class="fas fa-history"></i><h3>No Configuration Logs</h3><p>No configuration changes have been made yet.</p></div>';
                        return;
                    }
                    
                    let html = '<div class="table-container"><table class="data-table compact-table"><thead><tr><th>Timestamp</th><th>Modified By</th><th>Start Time</th><th>End Time</th><th>Enabled</th><th>Changes</th></tr></thead><tbody>';
                    
                    logs.forEach(log => {
                        html += `<tr>
                            <td>${log.timestamp}</td>
                            <td>${log.modifiedBy}</td>
                            <td>${log.startTime}</td>
                            <td>${log.endTime}</td>
                            <td><span class="badge ${log.isEnabled === 'Yes' ? 'badge-success' : 'badge-warning'}">${log.isEnabled}</span></td>
                            <td>${log.changes}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    logsDiv.innerHTML = html;
                })
                .withFailureHandler(function(error) {
                    const logsDiv = document.getElementById('timingConfigLogs');
                    logsDiv.innerHTML = '<div class="message error">Error loading logs: ' + error.message + '</div>';
                })
                .getTimingConfigLogs(20);
        }

        function updateRealTimeStatus() {
            if (!currentUser) return;
            
            google.script.run
                .withSuccessHandler(function(timeCheck) {
                    const statusDiv = document.getElementById('realTimeStatus');
                    
                    const currentTime = new Date();
                    const currentTimeStr = currentTime.toLocaleTimeString('en-US', { 
                        hour12: false, 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    let html = `
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Current Time</label>
                                <div class="form-control" style="background: #f8f9fa; font-family: monospace; font-size: 16px; font-weight: bold;">
                                    ${currentTimeStr}
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Submission Status</label>
                                <div class="form-control" style="background: ${timeCheck.allowed ? '#e8f5e8' : '#ffe6e6'}; font-weight: bold;">
                                    ${timeCheck.allowed ? ' Allowed' : ' Not Allowed'}
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Configured Time Window</label>
                                <div class="form-control">${timeCheck.config.startHour.toString().padStart(2, '0')}:${timeCheck.config.startMinute.toString().padStart(2, '0')} - ${timeCheck.config.endHour.toString().padStart(2, '0')}:${timeCheck.config.endMinute.toString().padStart(2, '0')}</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Restriction Mode</label>
                                <div class="form-control">${timeCheck.config.isEnabled ? 'Enabled (Admin can submit within time window)' : 'Disabled (Admin can submit anytime)'}</div>
                            </div>
                        </div>
                    `;
                    
                    if (!timeCheck.allowed && timeCheck.config.isEnabled) {
                        html += `
                            <div class="message warning">
                                <i class="fas fa-clock"></i>
                                ${timeCheck.message}
                            </div>
                        `;
                    } else if (timeCheck.allowed && timeCheck.config.isEnabled) {
                        html += `
                            <div class="message success">
                                <i class="fas fa-check-circle"></i>
                                ${timeCheck.message} (${timeCheck.timeRemaining} remaining)
                            </div>
                        `;
                    } else if (!timeCheck.config.isEnabled) {
                        html += `
                            <div class="message info">
                                <i class="fas fa-info-circle"></i>
                                Timing restrictions are disabled. Admin users can submit attendance at any time.
                            </div>
                        `;
                    }
                    
                    statusDiv.innerHTML = html;
                })
                .withFailureHandler(function(error) {
                    const statusDiv = document.getElementById('realTimeStatus');
                    statusDiv.innerHTML = '<div class="message error">Error loading status: ' + error.message + '</div>';
                })
                .canSubmitAttendanceNow(currentUser.role);
        }

        // ========== QR SCANNER FUNCTIONS ==========

        function initializeTimeDisplay() {
            updateTimeDisplay();
            setInterval(updateTimeDisplay, 1000);
        }

        function updateTimeDisplay() {
            const timeElement = document.getElementById('timeDisplay');
            if (timeElement) {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { 
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                timeElement.textContent = `Current Time: ${timeStr}`;
            }
        }

        function setQRAction(action, button) {
            currentQRAction = action;
            document.querySelectorAll('.action-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (button) {
                button.classList.add('active');
            } else {
                document.querySelectorAll('.action-tab')[0].classList.add('active');
            }
            
            Swal.fire({
                icon: 'info',
                title: `Action Set: ${action === 'login' ? 'Login' : 'Logout'}`,
                text: `Ready to mark staff ${action === 'login' ? 'login' : 'logout'}`,
                timer: 2000,
                showConfirmButton: false,
                toast: true,
                position: 'top-end'
            });
        }

// ADD THESE NEW FUNCTIONS HERE (around line 3800-3900):

function startScannerWithFallback() {
  // First check if we can access camera
  if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
    showManualEntryModal();
    return;
  }
  
  navigator.mediaDevices.enumerateDevices()
    .then(devices => {
      const hasCamera = devices.some(d => d.kind === 'videoinput');
      if (!hasCamera) {
        showManualEntryModal('No camera found on this device');
        return;
      }
      
      // Try to start scanner
      startScanner();
    })
    .catch(err => {
      console.warn('Camera enumeration failed:', err);
      showManualEntryModal('Camera access blocked. Use manual entry.');
    });
}

function showManualEntryModal(message) {
  Swal.fire({
    icon: 'info',
    title: 'Camera Issue',
    text: message || 'Unable to access camera. Please use manual entry.',
    input: 'text',
    inputLabel: 'Enter Staff ID',
    inputPlaceholder: 'e.g., T001',
    showCancelButton: true,
    confirmButtonText: 'Submit',
    cancelButtonText: 'Cancel',
    inputValidator: (value) => {
      if (!value) return 'Please enter Staff ID';
    }
  }).then((result) => {
    if (result.isConfirmed && result.value) {
      processManualAttendance(result.value);
    }
  });
}

function processManualAttendance(staffId) {
  const action = currentQRAction || 'login';
  
  Swal.fire({
    title: `Processing ${action}...`,
    text: `Staff ID: ${staffId}`,
    allowOutsideClick: false,
    didOpen: () => {
      Swal.showLoading();
      
      const funcName = action === 'login' ? 'markLogin' : 'markLogout';
      
      google.script.run
        .withSuccessHandler(handleAttendanceResponse)
        .withFailureHandler(handleAttendanceError)
        [funcName](staffId, currentUser ? currentUser.username : 'Admin');
    }
  });
}

function handleAttendanceResponse(result) {
  Swal.close();
  
  if (result && result.success) {
    Swal.fire({
      icon: 'success',
      title: result.status === 'Late' ? 'Late Arrival!' :
             result.status === 'Half Day' ? 'Half Day Marked!' :
             result.status === 'Early Logout' ? 'Early Logout!' :
             `${currentQRAction === 'login' ? 'Login' : 'Logout'} Successful!`,
      html: `
        <div style="text-align: left;">
          <p><strong>Staff ID:</strong> ${result.staffId}</p>
          <p><strong>Name:</strong> ${result.staffName}</p>
          <p><strong>Department:</strong> ${result.department}</p>
          <p><strong>${currentQRAction === 'login' ? 'Login' : 'Logout'} Time:</strong> ${result.loginTime || result.logoutTime || 'N/A'}</p>
          <p><strong>Status:</strong> ${result.status}</p>
        </div>
      `,
      timer: 5000,
      showConfirmButton: true
    });
    
    displayLastResult(result);
  } else {
    Swal.fire({
      icon: 'error',
      title: 'Failed',
      text: result ? result.message : 'Unknown error occurred',
      footer: 'Please try again or contact admin'
    });
    
    displayLastResult({
      success: false,
      staffId: result?.staffId || 'Unknown',
      message: result ? result.message : 'Unknown error'
    });
  }
}

function handleAttendanceError(error) {
  Swal.close();
  Swal.fire({
    icon: 'error',
    title: 'Error',
    text: error.message || 'Failed to connect to server',
    footer: 'Please check your connection and try again'
  });
  
  displayLastResult({
    success: false,
    staffId: 'Unknown',
    message: 'Server error: ' + (error.message || 'Unknown error')
  });
}

        function startScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                console.log('Scanner already running');
                return;
            }
            
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const qrReader = document.getElementById('qr-reader');
            
            // Clear the container
            qrReader.innerHTML = '';
            
            // Show loading indicator
            qrReader.innerHTML = '<div style="text-align: center; color: #666; padding: 50px;"><div class="loading-spinner" style="margin: 0 auto 10px;"></div><p>Initializing camera...</p></div>';
            
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-flex';
            
            try {
                html5QrCode = new Html5Qrcode("qr-reader");
                
                html5QrCode.start(
                    { facingMode: "environment" },
                    { 
                        fps: 10, 
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0
                    },
                    onScanSuccess,
                    onScanError
                ).then(() => {
                    console.log('QR Scanner started successfully');
                }).catch(err => {
                    console.error('Camera error:', err);
                    
                    // Show error in the QR reader container
                    qrReader.innerHTML = `
                        <div style="text-align: center; color: #e53e3e; padding: 30px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 10px;"></i>
                            <p><strong>Camera Error</strong></p>
                            <p>${err.message || 'Unable to access camera'}</p>
                            <p style="font-size: 12px; margin-top: 10px;">Please ensure camera permissions are granted and no other app is using the camera.</p>
                        </div>
                    `;
                    
                    Swal.fire({
                        icon: 'error',
                        title: 'Camera Error',
                        text: 'Unable to access camera. Please grant camera permissions.',
                        footer: 'Make sure no other application is using the camera'
                    });
                    
                    stopScanner();
                });
            } catch (error) {
                console.error('Scanner initialization error:', error);
                
                qrReader.innerHTML = `
                    <div style="text-align: center; color: #e53e3e; padding: 30px;">
                        <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 10px;"></i>
                        <p><strong>Scanner Error</strong></p>
                        <p>Failed to initialize QR scanner.</p>
                    </div>
                `;
                
                Swal.fire({
                    icon: 'error',
                    title: 'Scanner Error',
                    text: 'Failed to initialize QR scanner. Please refresh the page and try again.'
                });
                
                stopScanner();
            }
        }

        function stopScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    console.log('QR Scanner stopped');
                    html5QrCode = null;
                    
                    // Reset the QR reader container
                    const qrReader = document.getElementById('qr-reader');
                    qrReader.innerHTML = '<div style="text-align: center; color: #666; padding: 50px;"><i class="fas fa-camera" style="font-size: 48px; margin-bottom: 10px; color: #999;"></i><p>Camera preview will appear here</p><p style="font-size: 12px;">Click "Start Scanner" to begin</p></div>';
                    
                    document.getElementById('startBtn').style.display = 'inline-flex';
                    document.getElementById('stopBtn').style.display = 'none';
                }).catch(err => {
                    console.error('Stop error:', err);
                    
                    // Force reset
                    html5QrCode = null;
                    const qrReader = document.getElementById('qr-reader');
                    qrReader.innerHTML = '<div style="text-align: center; color: #666; padding: 50px;"><i class="fas fa-camera" style="font-size: 48px; margin-bottom: 10px; color: #999;"></i><p>Camera preview will appear here</p><p style="font-size: 12px;">Click "Start Scanner" to begin</p></div>';
                    
                    document.getElementById('startBtn').style.display = 'inline-flex';
                    document.getElementById('stopBtn').style.display = 'none';
                });
            } else {
                // Ensure UI is reset even if scanner wasn't running
                document.getElementById('startBtn').style.display = 'inline-flex';
                document.getElementById('stopBtn').style.display = 'none';
                
                const qrReader = document.getElementById('qr-reader');
                if (qrReader && qrReader.innerHTML.indexOf('camera') === -1) {
                    qrReader.innerHTML = '<div style="text-align: center; color: #666; padding: 50px;"><i class="fas fa-camera" style="font-size: 48px; margin-bottom: 10px; color: #999;"></i><p>Camera preview will appear here</p><p style="font-size: 12px;">Click "Start Scanner" to begin</p></div>';
                }
            }
        }

        function onScanSuccess(decodedText) {
            console.log('QR Code scanned:', decodedText);
            
            // Stop scanner immediately to prevent multiple scans
            stopScanner();
            
            Swal.fire({
                title: `Marking ${currentQRAction === 'login' ? 'Login' : 'Logout'}...`,
                html: `
                    <div style="text-align: left;">
                        <p><strong>Scanned ID:</strong> ${decodedText}</p>
                        <p><strong>Action:</strong> ${currentQRAction === 'login' ? 'Login' : 'Logout'}</p>
                    </div>
                `,
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            const funcName = currentQRAction === 'login' ? 'markLogin' : 'markLogout';
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Response:', result);
                    
                    Swal.close();
                    
                    if (result && result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: result.status === 'Late' ? 'Late Arrival!' :
                                   result.status === 'Half Day' ? 'Half Day Marked!' :
                                   result.status === 'Early Logout' ? 'Early Logout!' :
                                   `${currentQRAction === 'login' ? 'Login' : 'Logout'} Successful!`,
                            html: `
                                <div style="text-align: left;">
                                    <p><strong>Staff ID:</strong> ${result.staffId}</p>
                                    <p><strong>Name:</strong> ${result.staffName}</p>
                                    <p><strong>Department:</strong> ${result.department}</p>
                                    <p><strong>${currentQRAction === 'login' ? 'Login' : 'Logout'} Time:</strong> ${result.loginTime || result.logoutTime || 'N/A'}</p>
                                    <p><strong>Status:</strong> ${result.status}</p>
                                </div>
                            `,
                            timer: 5000,
                            showConfirmButton: true
                        });
                        
                        displayLastResult(result);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Failed',
                            text: result ? result.message : 'Unknown error occurred',
                            footer: 'Please try again or contact admin'
                        });
                        
                        displayLastResult({
                            success: false,
                            staffId: decodedText,
                            message: result ? result.message : 'Unknown error'
                        });
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Backend error:', error);
                    Swal.close();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message || 'Failed to connect to server',
                        footer: 'Please check your connection and try again'
                    });
                    
                    displayLastResult({
                        success: false,
                        staffId: decodedText,
                        message: 'Server error: ' + (error.message || 'Unknown error')
                    });
                })
                [funcName](decodedText, currentUser ? currentUser.username : 'Scanner');
        }

        function onScanError(error) {
            // Ignore most errors to prevent console spam
            if (error && !error.includes('NotFoundException')) {
                console.log('Scan error:', error);
            }
        }

        function displayLastResult(result) {
            const container = document.getElementById('lastResult');
            
            if (result.success) {
                container.innerHTML = `
                    <div class="result-title">
                        <i class="fas fa-check-circle"></i> Last Scan - Success
                    </div>
                    <div class="result-details">
                        <div class="result-row">
                            <span class="result-label">Staff ID:</span>
                            <span class="result-value">${result.staffId}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Name:</span>
                            <span class="result-value">${result.staffName || 'N/A'}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Department:</span>
                            <span class="result-value">${result.department || 'N/A'}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Time:</span>
                            <span class="result-value">${result.loginTime || result.logoutTime || 'N/A'}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Status:</span>
                            <span class="result-value">
                                <span style="padding: 2px 8px; border-radius: 3px; background: #d4edda; color: #155724;">
                                    ${result.status || 'Present'}
                                </span>
                            </span>
                        </div>
                    </div>
                `;
                container.className = 'last-result';
            } else {
                container.innerHTML = `
                    <div class="result-title">
                        <i class="fas fa-times-circle"></i> Last Scan - Failed
                    </div>
                    <div class="result-details">
                        <div class="result-row">
                            <span class="result-label">Scanned ID:</span>
                            <span class="result-value">${result.staffId}</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">Message:</span>
                            <span class="result-value" style="color: #e53e3e;">${result.message}</span>
                        </div>
                    </div>
                `;
                container.className = 'last-result error';
            }
            
            container.style.display = 'block';
        }

        // ========== QR GENERATOR FUNCTIONS ==========

        function loadAllStaffForQR() {
            const staffListDiv = document.getElementById('qrStaffList');
            staffListDiv.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Loading staff data...</p></div>';
            
            google.script.run
                .withSuccessHandler(function(staff) {
                    staffData = staff;
                    document.getElementById('qrTotalStaff').textContent = `Total Staff: ${staff.length}`;
                    displayStaffCards(staff);
                })
                .withFailureHandler(function(error) {
                    staffListDiv.innerHTML = `<div class="loading" style="color: #e53e3e;">Error loading staff: ${error.message}</div>`;
                })
                .getAllStaff();
        }

        function displayStaffCards(staff) {
            const container = document.getElementById('qrStaffList');
            container.innerHTML = '';
            
            staff.forEach((staffMember, index) => {
                const card = createStaffCard(staffMember, index);
                container.appendChild(card);
                
                setTimeout(() => {
                    generateQRCodeForStaff(staffMember.staffId, index);
                }, 100 * index);
            });
        }

        function createStaffCard(staff, index) {
            const card = document.createElement('div');
            card.className = 'staff-card';
            card.id = `staff-${staff.staffId}`;
            
            const initial = staff.name ? staff.name.charAt(0).toUpperCase() : '?';
            
            card.innerHTML = `
                <div class="staff-header">
                    <div class="staff-avatar">${initial}</div>
                    <div class="staff-info">
                        <div class="staff-name">${staff.name || 'N/A'}</div>
                        <div class="staff-id">${staff.staffId || 'N/A'}</div>
                    </div>
                </div>
                <div class="staff-details">
                    <div class="staff-detail">
                        <span class="detail-label">Department:</span>
                        <span class="detail-value">${staff.department || 'N/A'}</span>
                    </div>
                    <div class="staff-detail">
                        <span class="detail-label">Designation:</span>
                        <span class="detail-value">${staff.designation || 'N/A'}</span>
                    </div>
                    <div class="staff-detail">
                        <span class="detail-label">Staff Type:</span>
                        <span class="detail-value">
                            <span class="badge ${staff.staffType === 'Teaching' ? 'badge-success' : 'badge-warning'}">
                                ${staff.staffType || 'N/A'}
                            </span>
                        </span>
                    </div>
                </div>
                <div class="qr-code-container" id="qr-container-${staff.staffId}">
                    <div id="qrcode-${staff.staffId}"></div>
                </div>
                <div class="qr-actions no-print">
                    <button class="btn btn-primary btn-sm" onclick="downloadQRCode('${staff.staffId}')">
                        <i class="fas fa-download"></i> Download
                    </button>
                    <button class="btn btn-success btn-sm" onclick="printQRCode('${staff.staffId}')">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            `;
            
            return card;
        }

        function generateQRCodeForStaff(staffId, index) {
            const qrElement = document.getElementById(`qrcode-${staffId}`);
            if (!qrElement) return;
            
            qrElement.innerHTML = '';
            
            try {
                new QRCode(qrElement, {
                    text: staffId,
                    width: 150,
                    height: 150,
                    colorDark: '#001f3f',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                qrCodesGenerated++;
                document.getElementById('qrGeneratedCount').textContent = `Generated: ${qrCodesGenerated}`;
            } catch (error) {
                console.error('QR generation error for', staffId, error);
                qrElement.innerHTML = '<div style="color: #e53e3e; padding: 20px;">Error generating QR code</div>';
            }
        }

        function generateAllQRCodes() {
            Swal.fire({
                title: 'Generate All QR Codes',
                text: `This will generate QR codes for all ${staffData.length} staff members. Continue?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#48bb78',
                cancelButtonColor: '#e53e3e',
                confirmButtonText: 'Yes, generate all'
            }).then((result) => {
                if (result.isConfirmed) {
                    const progressBar = document.getElementById('qrProgressBar');
                    const progressFill = document.getElementById('qrProgressFill');
                    
                    progressBar.style.display = 'block';
                    qrCodesGenerated = 0;
                    
                    staffData.forEach((staff, index) => {
                        setTimeout(() => {
                            generateQRCodeForStaff(staff.staffId, index);
                            
                            const percent = ((index + 1) / staffData.length) * 100;
                            progressFill.style.width = percent + '%';
                            
                            if (index === staffData.length - 1) {
                                setTimeout(() => {
                                    progressBar.style.display = 'none';
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Success!',
                                        text: `Generated ${qrCodesGenerated} QR codes successfully`,
                                        timer: 3000
                                    });
                                }, 500);
                            }
                        }, 100 * index);
                    });
                }
            });
        }

        function downloadQRCode(staffId) {
            const qrElement = document.getElementById(`qrcode-${staffId}`).querySelector('img');
            if (!qrElement) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'QR code not found. Please generate it first.'
                });
                return;
            }
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = qrElement.width;
            canvas.height = qrElement.height;
            ctx.drawImage(qrElement, 0, 0, canvas.width, canvas.height);
            
            const link = document.createElement('a');
            link.download = `QR_${staffId}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function printQRCode(staffId) {
            const card = document.getElementById(`staff-${staffId}`);
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>QR Code - ${staffId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background: white; }
                        .qr-print { text-align: center; padding: 40px; border: 2px solid #e2e8f0; border-radius: 20px; background: white; }
                        .staff-name { font-size: 24px; font-weight: bold; color: #2d3748; margin-bottom: 10px; }
                        .staff-id { font-size: 18px; color: #718096; margin-bottom: 20px; font-family: monospace; }
                        img { max-width: 300px; margin-bottom: 20px; }
                        .footer { font-size: 14px; color: #a0aec0; margin-top: 20px; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="qr-print">
                        <div class="staff-name">${card.querySelector('.staff-name').textContent}</div>
                        <div class="staff-id">${staffId}</div>
                        ${card.querySelector(`#qrcode-${staffId}`).innerHTML}
                        <div class="footer">Scan this QR code to mark attendance</div>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        function printAllQRCodes() {
            const printWindow = window.open('', '_blank');
            
            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>All Staff QR Codes</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; background: white; }
                        .print-header { text-align: center; margin-bottom: 30px; }
                        .print-header h1 { color: #2d3748; margin-bottom: 10px; }
                        .print-header p { color: #718096; }
                        .qr-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
                        .qr-item { text-align: center; padding: 20px; border: 1px solid #e2e8f0; border-radius: 10px; page-break-inside: avoid; }
                        .qr-name { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
                        .qr-id { font-size: 14px; color: #718096; margin-bottom: 15px; font-family: monospace; }
                        .qr-code img { max-width: 150px; }
                        @media print { body { margin: 0; padding: 10px; } .qr-grid { grid-template-columns: repeat(2, 1fr); } }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h1>SUCCESS SCHOOL, INDI</h1>
                        <p>Staff Attendance QR Codes</p>
                    </div>
                    <div class="qr-grid">
            `;
            
            staffData.forEach(staff => {
                const qrElement = document.getElementById(`qrcode-${staff.staffId}`);
                if (qrElement) {
                    const qrImg = qrElement.querySelector('img');
                    if (qrImg) {
                        html += `
                            <div class="qr-item">
                                <div class="qr-name">${staff.name || 'N/A'}</div>
                                <div class="qr-id">${staff.staffId}</div>
                                <div class="qr-code">
                                    <img src="${qrImg.src}" alt="QR Code for ${staff.staffId}">
                                </div>
                            </div>
                        `;
                    }
                }
            });
            
            html += `
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        // ========== ID CARD GENERATOR FUNCTIONS ==========

        function loadAllStaffForIDCards() {
            const idCardGrid = document.getElementById('idCardGrid');
            idCardGrid.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Loading staff data...</p></div>';
            
            google.script.run
                .withSuccessHandler(function(staff) {
                    idCardStaffData = staff;
                    document.getElementById('idTotalStaff').textContent = `Total Staff: ${staff.length}`;
                    displayIDCards(staff);
                })
                .withFailureHandler(function(error) {
                    idCardGrid.innerHTML = `<div class="loading" style="color: #e53e3e;">Error loading staff: ${error.message}</div>`;
                })
                .getAllStaff();
        }

        function displayIDCards(staff) {
            const grid = document.getElementById('idCardGrid');
            grid.innerHTML = '';
            
            staff.forEach((staffMember, index) => {
                const cardWrapper = createIDCard(staffMember, index);
                grid.appendChild(cardWrapper);
                
                setTimeout(() => {
                    generateIDCardQRCode(staffMember.staffId, index);
                }, 100 * index);
            });
        }

function createIDCard(staff, index) {
    const wrapper = document.createElement('div');
    wrapper.className = 'id-card-wrapper';
    wrapper.id = `idcard-${staff.staffId}`;
    
    const staffTypeColor = staff.staffType === 'Teaching' ? '#3498db' : 
                          staff.staffType === 'Non-Teaching' ? '#e74c3c' : '#2ecc71';
    
    const photoHtml = staff.photoUrl 
        ? `<img src="${staff.photoUrl}" alt="${staff.name}" class="id-photo-img" style="width:100%;height:100%;object-fit:cover;">`
        : `<div class="id-photo-placeholder" style="width:100%;height:100%;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold;">${staff.name ? staff.name.charAt(0).toUpperCase() : '?'}</div>`;
    
    wrapper.innerHTML = `
        <div class="id-card-container" style="width: 350px; margin: 0 auto; position: relative; transition: transform 0.6s; transform-style: preserve-3d;">
            <!-- Front Side -->
            <div class="id-card id-card-front" style="width: 350px; background: white; border-radius: 15px; overflow: hidden; border: 1px solid #e0e0e0; box-shadow: 0 10px 20px rgba(0,0,0,0.1); position: relative; backface-visibility: hidden;">
                <!-- Header with Logo and Title - Increased padding for larger logo -->
                <div style="background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); padding: 18px 12px; text-align: center; position: relative;">
                    <!-- Logo - Made significantly bigger -->
                    <img src="https://lh3.googleusercontent.com/d/1stbNALlpjg5CCGlXXX84l29UoolnvrbN" alt="Success School Indi Logo" 
                         style="height: 6rem; width: auto; max-width: 280px; object-fit: contain; filter: drop-shadow(0 6px 8px rgba(0,0,0,0.25));" 
                         onerror="this.onerror=null; this.src='https://lh3.googleusercontent.com/d/1zxgYSP4m3solH4FLbURzIjXmB_OymF3Z';">
                    
                    <!-- "Staff ID Card" text - Now in one line with adjusted width -->
                    <div style="position: absolute; bottom: -14px; left: 50%; transform: translateX(-50%); background: white; padding: 5px 20px; border-radius: 30px; box-shadow: 0 6px 12px rgba(0,0,0,0.15); border: 2px solid ${staffTypeColor}; white-space: nowrap;">
                        <span style="font-size: 15px; font-weight: 700; letter-spacing: 1px; background: linear-gradient(135deg, #2c3e50, #3498db); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">STAFF ID CARD</span>
                    </div>
                </div>
                
                <!-- Staff Photo and Info - Adjusted top padding for larger logo -->
                <div style="padding: 50px 15px 15px 15px;">
                    <div style="display: flex; gap: 15px;">
                        <!-- Photo Container -->
                        <div style="width: 100px; height: 120px; border: 3px solid ${staffTypeColor}; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1); flex-shrink: 0; background: #f8f9fa;">
                            ${photoHtml}
                        </div>
                        
                        <!-- Basic Info - Adjusted to center vertically with image -->
                        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; margin-top: 15px;">
                            <h3 style="margin: 0 0 5px 0; color: #2c3e50; font-size: 16px; font-weight: 700;">${staff.name || 'N/A'}</h3>
                            <p style="margin: 0 0 3px 0; color: #666; font-size: 13px;"><strong>${staff.designation || 'Staff'}</strong></p>
                            <p style="margin: 0; font-size: 12px; color: #888;">ID: ${staff.staffId || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <!-- Details Table - Adjusted margin -->
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 10px; margin-top: 25px;">
                        <table style="width: 100%; font-size: 12px;">
                            <tr>
                                <td style="padding: 4px 0; color: #555;"><strong>Department:</strong></td>
                                <td style="padding: 4px 0; color: #2c3e50;">${staff.department || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px 0; color: #555;"><strong>Staff Type:</strong></td>
                                <td style="padding: 4px 0;">
                                    <span style="background: ${staffTypeColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">${staff.staffType || 'N/A'}</span>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 4px 0; color: #555;"><strong>Join Date:</strong></td>
                                <td style="padding: 4px 0; color: #2c3e50;">${staff.joinDate || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px 0; color: #555;"><strong>Phone:</strong></td>
                                <td style="padding: 4px 0; color: #2c3e50;">${staff.phone || 'N/A'}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- QR Code Section - Adjusted margin -->
                    <div style="display: flex; align-items: center; gap: 15px; margin-top: 20px; padding-top: 10px; border-top: 1px dashed #ddd;">
                        <div id="id-qrcode-${staff.staffId}" style="min-width: 80px; min-height: 80px; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center;"></div>
                        <div style="font-size: 10px; color: #666; line-height: 1.4;">
                            <i class="fas fa-qrcode" style="color: ${staffTypeColor};"></i> 
                            <strong>Scan QR Code</strong><br>
                            for attendance verification
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div style="background: #2c3e50; color: white; text-align: center; padding: 8px; font-size: 10px;">
                    <i class="fas fa-phone"></i> +91-80-12345678 | <i class="fas fa-envelope"></i> info@successschool.edu
                </div>
            </div>
            
            <!-- Back Side - With Additional Information and Attendance Cautions -->
            <div class="id-card id-card-back" style="width: 350px; background: linear-gradient(145deg, #f8f9fa 0%, #ffffff 100%); border-radius: 15px; overflow: hidden; border: 1px solid #e0e0e0; box-shadow: 0 10px 20px rgba(0,0,0,0.1); position: absolute; top: 0; left: 0; backface-visibility: hidden; transform: rotateY(180deg);">
                <div style="padding: 15px; height: 100%; display: flex; flex-direction: column;">
                    <!-- Additional Information Header -->
                    <div style="background: ${staffTypeColor}; color: white; padding: 5px 10px; border-radius: 5px; margin-bottom: 8px; font-size: 11px; font-weight: 600; text-align: center;">
                        <i class="fas fa-id-card"></i> ADDITIONAL INFORMATION
                    </div>
                    
                    <!-- Additional Info Section -->
                    <div style="font-size: 10px; margin-bottom: 8px; background: #f0f0f0; padding: 8px; border-radius: 5px;">
                        <p style="margin-bottom: 5px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-tint" style="color: #e74c3c; width: 14px;"></i> 
                            <strong>Blood Group:</strong> O+
                        </p>
                        <p style="margin-bottom: 5px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-phone-alt" style="color: #3498db; width: 14px;"></i> 
                            <strong>Emergency:</strong> ${staff.phone || 'N/A'}
                        </p>
                        <p style="margin-bottom: 5px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-map-marker-alt" style="color: #e67e22; width: 14px;"></i> 
                            <strong>Address:</strong> Indi, Karnataka - 586209
                        </p>
                        <p style="margin-bottom: 5px; display: flex; align-items: center; gap: 5px;">
                            <i class="fas fa-envelope" style="color: #2ecc71; width: 14px;"></i> 
                            <strong>Email:</strong> ${staff.email || 'N/A'}
                        </p>
                    </div>
                    
                    <!-- Header with Warning Icon -->
                    <div style="background: #fff3cd; color: #856404; padding: 5px; border-radius: 5px; margin-bottom: 8px; font-size: 10px; font-weight: 600; text-align: center; border-left: 4px solid #e74c3c;">
                        <i class="fas fa-exclamation-triangle" style="margin-right: 5px;"></i> 
                        ATTENDANCE RULES & CAUTIONS
                    </div>
                    
                    <!-- Attendance Cautions Section -->
                    <div style="background: #f8f9fa; border-radius: 5px; padding: 6px; margin-bottom: 6px;">
                        <div style="font-size: 10px; font-weight: 600; color: #e74c3c; margin-bottom: 3px;">
                            <i class="fas fa-clock"></i> IMPORTANT TIMINGS:
                        </div>
                        <ul style="margin: 0; padding-left: 12px; font-size: 9px; color: #333; list-style-type: none;">
                            <li style="margin-bottom: 2px;"> <strong>Before 09:30</strong> - Present (P)</li>
                            <li style="margin-bottom: 2px;"> <strong>09:30 - 09:45</strong> - Present with Warning</li>
                            <li style="margin-bottom: 2px;"> <strong>09:45 - 11:30</strong> - Late Coming (L)</li>
                            <li style="margin-bottom: 2px;"> <strong>After 11:30</strong> - Half Day (HD)</li>
                        </ul>
                    </div>
                    
                    <!-- Saturday Special Rule -->
                    <div style="background: #e8f4fd; border-radius: 5px; padding: 6px; margin-bottom: 6px;">
                        <div style="font-size: 10px; font-weight: 600; color: #0056b3; margin-bottom: 2px;">
                            <i class="fas fa-calendar-alt"></i> SATURDAY RULE:
                        </div>
                        <p style="font-size: 9px; margin: 0;">All staff must logout at <strong>1:30 PM only</strong>. Early/late logout affects attendance.</p>
                    </div>
                    
                    <!-- Department Specific Rules -->
                    <div style="background: #f0f0f0; border-radius: 5px; padding: 6px; margin-bottom: 6px;">
                        <div style="font-size: 10px; font-weight: 600; color: #2c3e50; margin-bottom: 2px;">
                            <i class="fas fa-users"></i> DEPARTMENT RULES:
                        </div>
                        <ul style="margin: 0; padding-left: 12px; font-size: 9px; color: #333;">
                            <li><strong>Pre-Primary:</strong> Must logout after 1:30 PM</li>
                            <li><strong>All Others:</strong> Standard logout timing applies</li>
                        </ul>
                    </div>
                    
                    <!-- Penalty Information -->
                    <div style="background: #fee; border-radius: 5px; padding: 6px; margin-bottom: 6px;">
                        <div style="font-size: 10px; font-weight: 600; color: #c00; margin-bottom: 2px;">
                            <i class="fas fa-rupee-sign"></i> PENALTIES:
                        </div>
                        <ul style="margin: 0; padding-left: 12px; font-size: 9px; color: #333;">
                            <li> Late Coming: 10% of per day salary</li>
                            <li> Absent: 110% of per day salary</li>
                            <li> Half Day: 50% deduction</li>
                            <li> >6 full day leaves: No paid leave</li>
                        </ul>
                    </div>
                    
                    <!-- Additional Info -->
                    <div style="margin-top: auto; text-align: center;">
                        <div style="background: #e8f5e8; border-radius: 5px; padding: 4px; border-left: 4px solid #27ae60;">
                            <i class="fas fa-check-circle" style="color: #27ae60; margin-right: 3px;"></i>
                            <span style="font-size: 8px; color: #2c3e50;">QR Attendance is mandatory</span>
                        </div>
                    </div>
                    
                    <!-- Return Notice -->
                    <div style="margin-top: 5px; text-align: center;">
                        <div style="background: #fff3cd; border-radius: 5px; padding: 4px;">
                            <span style="font-size: 8px; color: #856404;">
                                <i class="fas fa-exclamation-triangle"></i>
                                If found, return to: Success School, Indi - 586209
                            </span>
                        </div>
                    </div>
                    
                    <!-- Barcode -->
                    <div style="text-align: center; margin-top: 5px;">
                        <div id="id-barcode-${staff.staffId}" style="height: 15px; margin-bottom: 2px;"></div>
                        <div style="font-size: 7px; font-weight: bold; color: #333;">${staff.staffId}</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="id-card-actions no-print" style="display: flex; gap: 8px; justify-content: center; margin-top: 12px;">
            <button onclick="flipIDCard('${staff.staffId}')" style="padding:6px 12px;font-size:11px;border-radius:20px;background:white;border:1px solid #ddd;cursor:pointer;transition:all 0.3s;">
                <i class="fas fa-sync-alt"></i> Flip
            </button>
            <button onclick="printIDCard('${staff.staffId}')" style="padding:6px 12px;font-size:11px;border-radius:20px;background:white;border:1px solid #ddd;cursor:pointer;transition:all 0.3s;">
                <i class="fas fa-print"></i> Print
            </button>
        </div>
    `;
    
    return wrapper;
}

function generateIDCardQRCode(staffId, index) {
    const qrElement = document.getElementById(`id-qrcode-${staffId}`);
    if (!qrElement) return;
    
    // Clear previous content
    qrElement.innerHTML = '';
    
    try {
        // Create a container for the QR code
        const qrContainer = document.createElement('div');
        qrContainer.style.width = '80px';
        qrContainer.style.height = '80px';
        qrElement.appendChild(qrContainer);
        
        // Generate QR code
        new QRCode(qrContainer, {
            text: staffId,
            width: 80,
            height: 80,
            colorDark: '#2c3e50',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
        });
        
        // Make sure the QR code is visible
        setTimeout(() => {
            const img = qrContainer.querySelector('img');
            if (img) {
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.display = 'block';
            }
        }, 100);
        
        idCardsGenerated++;
        document.getElementById('idGeneratedCount').textContent = `Generated: ${idCardsGenerated}`;
        
        // Generate barcode representation
        const barcodeDiv = document.getElementById(`id-barcode-${staffId}`);
        if (barcodeDiv) {
            barcodeDiv.innerHTML = '';
            const barcodeContainer = document.createElement('div');
            barcodeContainer.style.display = 'flex';
            barcodeContainer.style.gap = '2px';
            barcodeContainer.style.justifyContent = 'center';
            barcodeContainer.style.alignItems = 'center';
            
            // Create simple barcode pattern
            for (let i = 0; i < staffId.length; i++) {
                const charCode = staffId.charCodeAt(i);
                const width = 5 + (charCode % 8);
                const bar = document.createElement('div');
                bar.style.width = width + 'px';
                bar.style.height = '25px';
                bar.style.background = i % 2 === 0 ? '#333' : '#666';
                bar.style.borderRadius = '2px';
                barcodeContainer.appendChild(bar);
            }
            
            barcodeDiv.appendChild(barcodeContainer);
        }
    } catch (error) {
        console.error('QR generation error for', staffId, error);
        qrElement.innerHTML = '<div style="color: #e53e3e; padding: 5px; font-size: 10px;">Error</div>';
    }
}

        function flipIDCard(staffId) {
            const wrapper = document.getElementById(`idcard-${staffId}`);
            wrapper.classList.toggle('flipped');
        }

        function generateAllIDCards() {
            Swal.fire({
                title: 'Generate All ID Cards',
                text: `This will generate professional ID cards for all ${idCardStaffData.length} staff members. Continue?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#48bb78',
                cancelButtonColor: '#e53e3e',
                confirmButtonText: 'Yes, generate all'
            }).then((result) => {
                if (result.isConfirmed) {
                    const progressBar = document.getElementById('idProgressBar');
                    const progressFill = document.getElementById('idProgressFill');
                    
                    progressBar.style.display = 'block';
                    idCardsGenerated = 0;
                    
                    idCardStaffData.forEach((staff, index) => {
                        setTimeout(() => {
                            const wrapper = document.getElementById(`idcard-${staff.staffId}`);
                            if (wrapper) {
                                generateIDCardQRCode(staff.staffId, index);
                            }
                            
                            const percent = ((index + 1) / idCardStaffData.length) * 100;
                            progressFill.style.width = percent + '%';
                            
                            if (index === idCardStaffData.length - 1) {
                                setTimeout(() => {
                                    progressBar.style.display = 'none';
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Success!',
                                        text: `Generated ${idCardsGenerated} ID cards successfully`,
                                        timer: 3000
                                    });
                                }, 500);
                            }
                        }, 100 * index);
                    });
                }
            });
        }

function printIDCard(staffId) {
    const wrapper = document.getElementById(`idcard-${staffId}`);
    if (!wrapper) return;
    
    // Get the staff data
    const staff = idCardStaffData.find(s => s.staffId === staffId);
    if (!staff) return;
    
    const printWindow = window.open('', '_blank');
    
    const staffTypeColor = staff.staffType === 'Teaching' ? '#3498db' : 
                          staff.staffType === 'Non-Teaching' ? '#e74c3c' : '#2ecc71';
    
    // Get photo HTML
    let photoHtml;
    if (staff.photoUrl) {
        photoHtml = `<img src="${staff.photoUrl}" alt="${staff.name}" style="width:100%;height:100%;object-fit:cover;">`;
    } else {
        const initial = staff.name ? staff.name.charAt(0).toUpperCase() : '?';
        photoHtml = `<div style="width:100%;height:100%;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold;">${initial}</div>`;
    }
    
    // Get QR code
    const qrElement = document.getElementById(`id-qrcode-${staffId}`);
    let qrHtml = '';
    if (qrElement) {
        const qrImg = qrElement.querySelector('img');
        if (qrImg) {
            qrHtml = `<img src="${qrImg.src}" alt="QR Code" style="width:80px;height:80px;">`;
        }
    }
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Staff ID Card - ${staffId}</title>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
            <style>
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                body { 
                    font-family: 'Inter', Arial, sans-serif; 
                    display: flex; 
                    justify-content: center; 
                    align-items: center; 
                    min-height: 100vh; 
                    margin: 0; 
                    background: #f5f5f5; 
                    padding: 20px;
                }
                .id-card-container { 
                    width: 350px; 
                    margin: 0 auto; 
                    position: relative;
                }
                .id-card { 
                    width: 350px; 
                    background: white;
                    border-radius: 15px; 
                    overflow: hidden; 
                    border: 2px solid #000; 
                    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
                }
                .id-card-back { 
                    width: 350px; 
                    background: white;
                    border-radius: 15px; 
                    overflow: hidden; 
                    border: 2px solid #000; 
                    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
                    margin-top: 20px;
                }
                img {
                    max-width: 100%;
                    height: auto;
                    display: block;
                }
                ul {
                    list-style-type: none;
                    padding-left: 0;
                }
                li {
                    margin-bottom: 3px;
                    font-size: 10px;
                }
                @media print { 
                    body { 
                        margin: 0; 
                        padding: 10px;
                        background: white;
                        display: block;
                    } 
                    .id-card, .id-card-back {
                        -webkit-print-color-adjust: exact;
                        print-color-adjust: exact;
                        color-adjust: exact;
                        border: 2px solid #000;
                        page-break-inside: avoid;
                        break-inside: avoid;
                        margin-bottom: 20px;
                    }
                    img {
                        -webkit-print-color-adjust: exact;
                        print-color-adjust: exact;
                        color-adjust: exact;
                        display: block !important;
                    }
                    @page {
                        size: portrait;
                        margin: 0.5cm;
                    }
                }
            </style>
        </head>
        <body>
            <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                <!-- FRONT SIDE -->
                <div class="id-card">
                    <!-- Header with Logo and Title - Logo Now Perfectly Centered -->
                    <div style="background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); padding: 20px 12px; text-align: center; position: relative; display: flex; flex-direction: column; align-items: center;">
                        <!-- Logo Container with Flex Center -->
                        <div style="display: flex; justify-content: center; align-items: center; width: 100%;">
                            <img src="https://lh3.googleusercontent.com/d/1stbNALlpjg5CCGlXXX84l29UoolnvrbN" alt="Success School Indi Logo" 
                                 style="height: 6rem; width: auto; max-width: 280px; object-fit: contain; filter: drop-shadow(0 6px 8px rgba(0,0,0,0.25)); margin: 0 auto;" 
                                 onerror="this.onerror=null; this.src='https://lh3.googleusercontent.com/d/1zxgYSP4m3solH4FLbURzIjXmB_OymF3Z';">
                        </div>
                        
                        <div style="position: absolute; bottom: -14px; left: 50%; transform: translateX(-50%); background: white; padding: 5px 20px; border-radius: 30px; box-shadow: 0 6px 12px rgba(0,0,0,0.15); border: 2px solid ${staffTypeColor}; white-space: nowrap; z-index: 10;">
                            <span style="font-size: 15px; font-weight: 700; letter-spacing: 1px; background: linear-gradient(135deg, #2c3e50, #3498db); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">STAFF ID CARD</span>
                        </div>
                    </div>
                    
                    <!-- Staff Photo and Info -->
                    <div style="padding: 50px 15px 15px 15px;">
                        <div style="display: flex; gap: 15px;">
                            <!-- Photo Container -->
                            <div style="width: 100px; height: 120px; border: 3px solid ${staffTypeColor}; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1); flex-shrink: 0; background: #f8f9fa;">
                                ${photoHtml}
                            </div>
                            
                            <!-- Basic Info -->
                            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; margin-top: 15px;">
                                <h3 style="margin: 0 0 5px 0; color: #2c3e50; font-size: 16px; font-weight: 700;">${staff.name || 'N/A'}</h3>
                                <p style="margin: 0 0 3px 0; color: #666; font-size: 13px;"><strong>${staff.designation || 'Staff'}</strong></p>
                                <p style="margin: 0; font-size: 12px; color: #888;">ID: ${staff.staffId || 'N/A'}</p>
                            </div>
                        </div>
                        
                        <!-- Details Table -->
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 10px; margin-top: 25px;">
                            <table style="width: 100%; font-size: 12px;">
                                <tr>
                                    <td style="padding: 4px 0; color: #555;"><strong>Department:</strong></td>
                                    <td style="padding: 4px 0; color: #2c3e50;">${staff.department || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px 0; color: #555;"><strong>Staff Type:</strong></td>
                                    <td style="padding: 4px 0;">
                                        <span style="background: ${staffTypeColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">${staff.staffType || 'N/A'}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px 0; color: #555;"><strong>Join Date:</strong></td>
                                    <td style="padding: 4px 0; color: #2c3e50;">${staff.joinDate || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px 0; color: #555;"><strong>Phone:</strong></td>
                                    <td style="padding: 4px 0; color: #2c3e50;">${staff.phone || 'N/A'}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <!-- QR Code Section -->
                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 20px; padding-top: 10px; border-top: 1px dashed #ddd;">
                            <div style="min-width: 80px; min-height: 80px; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center;">
                                ${qrHtml}
                            </div>
                            <div style="font-size: 10px; color: #666; line-height: 1.4;">
                                <i class="fas fa-qrcode" style="color: ${staffTypeColor};"></i> 
                                <strong>Scan QR Code</strong><br>
                                for attendance verification
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="background: #2c3e50; color: white; text-align: center; padding: 8px; font-size: 10px;">
                        <i class="fas fa-phone"></i> +91-80-12345678 | <i class="fas fa-envelope"></i> info@successschool.edu
                    </div>
                </div>
                
                <!-- BACK SIDE - With Additional Information and Attendance Cautions -->
                <div class="id-card-back">
                    <div style="padding: 15px; height: 100%; display: flex; flex-direction: column;">
                        <!-- Header with Warning Icon -->
                        <div style="background: #fff3cd; color: #856404; padding: 8px; border-radius: 5px; margin-bottom: 12px; font-size: 12px; font-weight: 600; text-align: center; border-left: 4px solid #e74c3c;">
                            <i class="fas fa-exclamation-triangle"></i> 
                            ATTENDANCE RULES & CAUTIONS
                        </div>
                        
                        <!-- Attendance Cautions Section -->
                        <div style="background: #f8f9fa; border-radius: 5px; padding: 8px; margin-bottom: 10px;">
                            <div style="font-size: 11px; font-weight: 600; color: #e74c3c; margin-bottom: 5px;">
                                <i class="fas fa-clock"></i> IMPORTANT TIMINGS:
                            </div>
                            <ul style="margin: 0; padding-left: 15px; font-size: 10px; color: #333;">
                                <li> <strong>Before 09:30</strong> - Present (P)</li>
                                <li> <strong>09:30 - 09:45</strong> - Present with Warning</li>
                                <li> <strong>09:45 - 11:30</strong> - Late Coming (L)</li>
                                <li> <strong>After 11:30</strong> - Half Day (HD)</li>
                            </ul>
                        </div>
                        
                        <!-- Saturday Special Rule -->
                        <div style="background: #e8f4fd; border-radius: 5px; padding: 8px; margin-bottom: 10px;">
                            <div style="font-size: 11px; font-weight: 600; color: #0056b3; margin-bottom: 3px;">
                                <i class="fas fa-calendar-alt"></i> SATURDAY RULE:
                            </div>
                            <p style="font-size: 10px; margin: 0;">All staff must logout at <strong>1:30 PM only</strong>. Early/late logout affects attendance.</p>
                        </div>
                        
                        <!-- Department Specific Rules -->
                        <div style="background: #f0f0f0; border-radius: 5px; padding: 8px; margin-bottom: 10px;">
                            <div style="font-size: 11px; font-weight: 600; color: #2c3e50; margin-bottom: 3px;">
                                <i class="fas fa-users"></i> DEPARTMENT RULES:
                            </div>
                            <ul style="margin: 0; padding-left: 15px; font-size: 9px; color: #333;">
                                <li><strong>Pre-Primary:</strong> Must logout after 1:30 PM</li>
                                <li><strong>All Others:</strong> Standard logout timing applies</li>
                            </ul>
                        </div>
                        
                        <!-- Penalty Information -->
                        <div style="background: #fee; border-radius: 5px; padding: 8px; margin-bottom: 10px;">
                            <div style="font-size: 11px; font-weight: 600; color: #c00; margin-bottom: 3px;">
                                <i class="fas fa-rupee-sign"></i> PENALTIES:
                            </div>
                            <ul style="margin: 0; padding-left: 15px; font-size: 9px; color: #333;">
                                <li> Late Coming: 10% of per day salary</li>
                                <li> Absent: 110% of per day salary</li>
                                <li> Half Day: 50% deduction</li>
                                <li> >6 full day leaves: No paid leave</li>
                            </ul>
                        </div>
                        
                        <!-- Additional Info -->
                        <div style="margin-top: auto; text-align: center;">
                            <div style="background: #e8f5e8; border-radius: 8px; padding: 6px; border-left: 4px solid #27ae60;">
                                <i class="fas fa-check-circle" style="color: #27ae60;"></i>
                                <span style="font-size: 9px; color: #2c3e50;">QR Attendance is mandatory</span>
                            </div>
                        </div>
                        
                        <!-- Return Notice -->
                        <div style="margin-top: 8px; text-align: center;">
                            <div style="background: #fff3cd; border-radius: 5px; padding: 5px;">
                                <span style="font-size: 9px; color: #856404;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    If found, return to: Success School, Indi - 586209
                                </span>
                            </div>
                        </div>
                        
                        <!-- Barcode -->
                        <div style="text-align: center; margin-top: 5px;">
                            <div style="height: 15px; margin-bottom: 2px; display: flex; gap: 2px; justify-content: center; align-items: center;">
                                ${staff.staffId.split('').map((char, i) => {
                                    const charCode = staff.staffId.charCodeAt(i);
                                    const width = 5 + (charCode % 8);
                                    return `<div style="width:${width}px;height:25px;background:${i % 2 === 0 ? '#333' : '#666'};border-radius:2px;"></div>`;
                                }).join('')}
                            </div>
                            <div style="font-size: 7px; font-weight: bold; color: #333;">${staff.staffId}</div>
                        </div>
                    </div>
                </div>
            </div>
            <script>
                window.onload = function() {
                    setTimeout(function() {
                        window.print();
                        setTimeout(function() {
                            window.close();
                        }, 500);
                    }, 500);
                };
            <\/script>
        </body>
        </html>
    `);
    
    printWindow.document.close();
}

function printAllIDCards() {
    const printWindow = window.open('', '_blank');
    
    let allCardsHtml = '';
    
    idCardStaffData.forEach(staff => {
        const staffTypeColor = staff.staffType === 'Teaching' ? '#3498db' : 
                              staff.staffType === 'Non-Teaching' ? '#e74c3c' : '#2ecc71';
        
        // Get photo HTML
        let photoHtml;
        if (staff.photoUrl) {
            photoHtml = `<img src="${staff.photoUrl}" alt="${staff.name}" style="width:100%;height:100%;object-fit:cover;">`;
        } else {
            const initial = staff.name ? staff.name.charAt(0).toUpperCase() : '?';
            photoHtml = `<div style="width:100%;height:100%;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold;">${initial}</div>`;
        }
        
        // Get QR code
        const qrElement = document.getElementById(`id-qrcode-${staff.staffId}`);
        let qrHtml = '';
        if (qrElement) {
            const qrImg = qrElement.querySelector('img');
            if (qrImg) {
                qrHtml = `<img src="${qrImg.src}" alt="QR Code" style="width:80px;height:80px;">`;
            }
        }
        
        allCardsHtml += `
            <div class="staff-card-pair" style="margin-bottom: 40px; page-break-inside: avoid; break-inside: avoid;">
                <!-- FRONT SIDE -->
                <div class="id-card" style="width:350px; background:white; border-radius:15px; overflow:hidden; border:2px solid #000; box-shadow:0 10px 20px rgba(0,0,0,0.1); margin:0 auto 20px auto;">
                    <!-- Header with Logo and Title - Logo Perfectly Centered -->
                    <div style="background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); padding: 20px 12px; text-align: center; position: relative; display: flex; flex-direction: column; align-items: center;">
                        <!-- Logo Container with Flex Center -->
                        <div style="display: flex; justify-content: center; align-items: center; width: 100%;">
                            <img src="https://lh3.googleusercontent.com/d/1stbNALlpjg5CCGlXXX84l29UoolnvrbN" alt="Success School Indi Logo" 
                                 style="height: 6rem; width: auto; max-width: 280px; object-fit: contain; filter: drop-shadow(0 6px 8px rgba(0,0,0,0.25)); margin: 0 auto;" 
                                 onerror="this.onerror=null; this.src='https://lh3.googleusercontent.com/d/1zxgYSP4m3solH4FLbURzIjXmB_OymF3Z';">
                        </div>
                        
                        <div style="position: absolute; bottom: -14px; left: 50%; transform: translateX(-50%); background: white; padding: 5px 20px; border-radius: 30px; box-shadow: 0 6px 12px rgba(0,0,0,0.15); border: 2px solid ${staffTypeColor}; white-space: nowrap; z-index: 10;">
                            <span style="font-size: 15px; font-weight: 700; letter-spacing: 1px; color: #2c3e50;">STAFF ID CARD</span>
                        </div>
                    </div>
                    
                    <!-- Staff Photo and Info -->
                    <div style="padding: 50px 15px 15px 15px;">
                        <div style="display: flex; gap: 15px;">
                            <!-- Photo Container -->
                            <div style="width: 100px; height: 120px; border: 3px solid ${staffTypeColor}; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1); flex-shrink: 0; background: #f8f9fa;">
                                ${photoHtml}
                            </div>
                            
                            <!-- Basic Info -->
                            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; margin-top: 15px;">
                                <h3 style="margin: 0 0 5px 0; color: #2c3e50; font-size: 16px; font-weight: 700;">${staff.name || 'N/A'}</h3>
                                <p style="margin: 0 0 3px 0; color: #666; font-size: 13px;"><strong>${staff.designation || 'Staff'}</strong></p>
                                <p style="margin: 0; font-size: 12px; color: #888;">ID: ${staff.staffId || 'N/A'}</p>
                            </div>
                        </div>
                        
                        <!-- Details Table -->
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 10px; margin-top: 25px;">
                            <table style="width: 100%; font-size: 12px;">
                                <tr>
                                    <td style="padding: 4px 0; color: #555;"><strong>Department:</strong></td>
                                    <td style="padding: 4px 0; color: #2c3e50;">${staff.department || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px 0; color: #555;"><strong>Staff Type:</strong></td>
                                    <td style="padding: 4px 0;">
                                        <span style="background: ${staffTypeColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">${staff.staffType || 'N/A'}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px 0; color: #555;"><strong>Join Date:</strong></td>
                                    <td style="padding: 4px 0; color: #2c3e50;">${staff.joinDate || 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px 0; color: #555;"><strong>Phone:</strong></td>
                                    <td style="padding: 4px 0; color: #2c3e50;">${staff.phone || 'N/A'}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <!-- QR Code Section -->
                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 20px; padding-top: 10px; border-top: 1px dashed #ddd;">
                            <div style="min-width: 80px; min-height: 80px; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center;">
                                ${qrHtml}
                            </div>
                            <div style="font-size: 10px; color: #666; line-height: 1.4;">
                                <i class="fas fa-qrcode" style="color: ${staffTypeColor};"></i> 
                                <strong>Scan QR Code</strong><br>
                                for attendance verification
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="background: #2c3e50; color: white; text-align: center; padding: 8px; font-size: 10px;">
                        <i class="fas fa-phone"></i> +91-80-12345678 | <i class="fas fa-envelope"></i> info@successschool.edu
                    </div>
                </div>
                
                <!-- BACK SIDE - With Additional Information and Attendance Cautions -->
                <div class="id-card-back" style="width:350px; background:white; border-radius:15px; overflow:hidden; border:2px solid #000; box-shadow:0 10px 20px rgba(0,0,0,0.1); margin:0 auto;">
                    <div style="padding: 15px; height: 100%; display: flex; flex-direction: column;">
                        <!-- Header with Warning Icon -->
                        <div style="background: #fff3cd; color: #856404; padding: 8px; border-radius: 5px; margin-bottom: 12px; font-size: 12px; font-weight: 600; text-align: center; border-left: 4px solid #e74c3c;">
                            <i class="fas fa-exclamation-triangle"></i> 
                            ATTENDANCE RULES & CAUTIONS
                        </div>
                        
                        <!-- Attendance Cautions Section -->
                        <div style="background: #f8f9fa; border-radius: 5px; padding: 8px; margin-bottom: 10px;">
                            <div style="font-size: 11px; font-weight: 600; color: #e74c3c; margin-bottom: 5px;">
                                <i class="fas fa-clock"></i> IMPORTANT TIMINGS:
                            </div>
                            <ul style="margin: 0; padding-left: 15px; font-size: 10px; color: #333;">
                                <li> <strong>Before 09:30</strong> - Present (P)</li>
                                <li> <strong>09:30 - 09:45</strong> - Present with Warning</li>
                                <li> <strong>09:45 - 11:30</strong> - Late Coming (L)</li>
                                <li> <strong>After 11:30</strong> - Half Day (HD)</li>
                            </ul>
                        </div>
                        
                        <!-- Saturday Special Rule -->
                        <div style="background: #e8f4fd; border-radius: 5px; padding: 8px; margin-bottom: 10px;">
                            <div style="font-size: 11px; font-weight: 600; color: #0056b3; margin-bottom: 3px;">
                                <i class="fas fa-calendar-alt"></i> SATURDAY RULE:
                            </div>
                            <p style="font-size: 10px; margin: 0;">All staff must logout at <strong>1:30 PM only</strong>. Early/late logout affects attendance.</p>
                        </div>
                        
                        <!-- Department Specific Rules -->
                        <div style="background: #f0f0f0; border-radius: 5px; padding: 8px; margin-bottom: 10px;">
                            <div style="font-size: 11px; font-weight: 600; color: #2c3e50; margin-bottom: 3px;">
                                <i class="fas fa-users"></i> DEPARTMENT RULES:
                            </div>
                            <ul style="margin: 0; padding-left: 15px; font-size: 9px; color: #333;">
                                <li><strong>Pre-Primary:</strong> Must logout after 1:30 PM</li>
                                <li><strong>All Others:</strong> Standard logout timing applies</li>
                            </ul>
                        </div>
                        
                        <!-- Penalty Information -->
                        <div style="background: #fee; border-radius: 5px; padding: 8px; margin-bottom: 10px;">
                            <div style="font-size: 11px; font-weight: 600; color: #c00; margin-bottom: 3px;">
                                <i class="fas fa-rupee-sign"></i> PENALTIES:
                            </div>
                            <ul style="margin: 0; padding-left: 15px; font-size: 9px; color: #333;">
                                <li> Late Coming: 10% of per day salary</li>
                                <li> Absent: 110% of per day salary</li>
                                <li> Half Day: 50% deduction</li>
                                <li> >6 full day leaves: No paid leave</li>
                            </ul>
                        </div>
                        
                        <!-- Additional Info -->
                        <div style="margin-top: auto; text-align: center;">
                            <div style="background: #e8f5e8; border-radius: 8px; padding: 6px; border-left: 4px solid #27ae60;">
                                <i class="fas fa-check-circle" style="color: #27ae60;"></i>
                                <span style="font-size: 9px; color: #2c3e50;">QR Attendance is mandatory</span>
                            </div>
                        </div>
                        
                        <!-- Return Notice -->
                        <div style="margin-top: 8px; text-align: center;">
                            <div style="background: #fff3cd; border-radius: 5px; padding: 5px;">
                                <span style="font-size: 9px; color: #856404;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    If found, return to: Success School, Indi - 586209
                                </span>
                            </div>
                        </div>
                        
                        <!-- Barcode -->
                        <div style="text-align: center; margin-top: 5px;">
                            <div style="height: 15px; margin-bottom: 2px; display: flex; gap: 2px; justify-content: center; align-items: center;">
                                ${staff.staffId.split('').map((char, i) => {
                                    const charCode = staff.staffId.charCodeAt(i);
                                    const width = 5 + (charCode % 8);
                                    return `<div style="width:${width}px;height:25px;background:${i % 2 === 0 ? '#333' : '#666'};border-radius:2px;"></div>`;
                                }).join('')}
                            </div>
                            <div style="font-size: 7px; font-weight: bold; color: #333;">${staff.staffId}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>All Staff ID Cards</title>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
            <style>
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                body { 
                    font-family: 'Inter', Arial, sans-serif; 
                    padding: 30px 20px; 
                    background: white; 
                }
                .print-header { 
                    text-align: center; 
                    margin-bottom: 40px; 
                    padding-bottom: 20px;
                    border-bottom: 2px solid #2c3e50;
                }
                .print-header h1 { 
                    color: #2c3e50; 
                    font-size: 28px;
                    margin-bottom: 5px;
                }
                .print-header p {
                    color: #666;
                    font-size: 14px;
                }
                .print-header .date {
                    color: #999;
                    font-size: 12px;
                    margin-top: 10px;
                }
                .staff-card-pair {
                    margin-bottom: 40px;
                    page-break-inside: avoid;
                    break-inside: avoid;
                }
                .id-card, .id-card-back {
                    page-break-inside: avoid;
                    break-inside: avoid;
                }
                img {
                    max-width: 100%;
                    height: auto;
                    display: block;
                }
                ul {
                    list-style-type: none;
                    padding-left: 0;
                }
                li {
                    margin-bottom: 3px;
                    font-size: 10px;
                }
                @media print { 
                    body { 
                        margin: 0; 
                        padding: 15px; 
                    } 
                    .print-header {
                        margin-bottom: 30px;
                    }
                    .staff-card-pair { 
                        break-inside: avoid; 
                        page-break-inside: avoid;
                        margin-bottom: 30px;
                    }
                    .id-card, .id-card-back {
                        -webkit-print-color-adjust: exact;
                        print-color-adjust: exact;
                        color-adjust: exact;
                        border: 2px solid #000;
                        box-shadow: none;
                        page-break-inside: avoid;
                        break-inside: avoid;
                        margin-bottom: 20px;
                    }
                    img {
                        -webkit-print-color-adjust: exact;
                        print-color-adjust: exact;
                        color-adjust: exact;
                        display: block !important;
                    }
                    @page {
                        size: portrait;
                        margin: 0.5cm;
                    }
                }
            </style>
        </head>
        <body>
            <div class="print-header">
                <h1>SUCCESS SCHOOL, INDI</h1>
                <p>Staff Identification Cards</p>
                <p class="date">Generated on: ${new Date().toLocaleDateString('en-IN', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}</p>
                <p class="date">Total Staff: ${idCardStaffData.length}</p>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center;">
                ${allCardsHtml}
            </div>
            <script>
                window.onload = function() {
                    setTimeout(function() {
                        window.print();
                        setTimeout(function() {
                            window.close();
                        }, 1000);
                    }, 1000);
                };
            <\/script>
        </body>
        </html>
    `);
    
    printWindow.document.close();
}

        function downloadAllIDCards() {
            Swal.fire({
                icon: 'info',
                title: 'Coming Soon',
                text: 'Bulk download feature will be available soon. For now, you can print all cards.',
                confirmButtonColor: '#3498db'
            });
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            stopScanner();
        });

        // Set up periodic updates
        setInterval(updateRealTimeStatus, 30000);

        // Show ID card in dashboard preview
function showMyIDCard() {
    const previewDiv = document.getElementById('staffIDCardPreview');
    previewDiv.style.display = 'block';
    generateSingleIDCard(currentStaff, previewDiv);
}

// Generate single ID card for current staff
function generateSingleIDCard(staff, container) {
    if (!staff) return;
    
    const staffTypeColor = staff.staffType === 'Teaching' ? '#3498db' : 
                          staff.staffType === 'Non-Teaching' ? '#e74c3c' : '#2ecc71';
    
    // Get photo HTML
    let photoHtml;
    if (staff.photoUrl) {
        photoHtml = `<img src="${staff.photoUrl}" alt="${staff.name}" style="width:100%;height:100%;object-fit:cover;">`;
    } else {
        const initial = staff.name ? staff.name.charAt(0).toUpperCase() : '?';
        photoHtml = `<div style="width:100%;height:100%;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold;">${initial}</div>`;
    }
    
    const idCardHtml = `
        <div class="id-card-container" style="width: 350px; margin: 0 auto; position: relative;">
            <!-- Front Side -->
            <div class="id-card id-card-front" style="width: 350px; background: white; border-radius: 15px; overflow: hidden; border: 1px solid #e0e0e0; box-shadow: 0 10px 20px rgba(0,0,0,0.1); position: relative;">
                <!-- Header with Logo and Title -->
                <div style="background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); padding: 18px 12px; text-align: center; position: relative;">
                    <img src="https://lh3.googleusercontent.com/d/1stbNALlpjg5CCGlXXX84l29UoolnvrbN" alt="Success School Indi Logo" 
                         style="height: 6rem; width: auto; max-width: 280px; object-fit: contain; filter: drop-shadow(0 6px 8px rgba(0,0,0,0.25)); margin: 0 auto;" 
                         onerror="this.onerror=null; this.src='https://lh3.googleusercontent.com/d/1zxgYSP4m3solH4FLbURzIjXmB_OymF3Z';">
                    
                    <div style="position: absolute; bottom: -14px; left: 50%; transform: translateX(-50%); background: white; padding: 5px 20px; border-radius: 30px; box-shadow: 0 6px 12px rgba(0,0,0,0.15); border: 2px solid ${staffTypeColor}; white-space: nowrap;">
                        <span style="font-size: 15px; font-weight: 700; letter-spacing: 1px; background: linear-gradient(135deg, #2c3e50, #3498db); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">STAFF ID CARD</span>
                    </div>
                </div>
                
                <!-- Staff Photo and Info -->
                <div style="padding: 50px 15px 15px 15px;">
                    <div style="display: flex; gap: 15px;">
                        <!-- Photo Container -->
                        <div style="width: 100px; height: 120px; border: 3px solid ${staffTypeColor}; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1); flex-shrink: 0; background: #f8f9fa;">
                            ${photoHtml}
                        </div>
                        
                        <!-- Basic Info -->
                        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                            <h3 style="margin: 0 0 5px 0; color: #2c3e50; font-size: 16px; font-weight: 700;">${staff.name || 'N/A'}</h3>
                            <p style="margin: 0 0 3px 0; color: #666; font-size: 13px;"><strong>${staff.designation || 'Staff'}</strong></p>
                            <p style="margin: 0; font-size: 12px; color: #888;">ID: ${staff.staffId || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <!-- Details Table -->
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 10px; margin-top: 15px;">
                        <table style="width: 100%; font-size: 12px;">
                            <tr>
                                <td style="padding: 4px 0; color: #555;"><strong>Department:</strong></td>
                                <td style="padding: 4px 0; color: #2c3e50;">${staff.department || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px 0; color: #555;"><strong>Staff Type:</strong></td>
                                <td style="padding: 4px 0;">
                                    <span style="background: ${staffTypeColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">${staff.staffType || 'N/A'}</span>
                                </td>
                            </tr>
                            <tr>
                                <td style="padding: 4px 0; color: #555;"><strong>Join Date:</strong></td>
                                <td style="padding: 4px 0; color: #2c3e50;">${staff.joinDate || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td style="padding: 4px 0; color: #555;"><strong>Phone:</strong></td>
                                <td style="padding: 4px 0; color: #2c3e50;">${staff.phone || 'N/A'}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- QR Code Section -->
                    <div style="display: flex; align-items: center; gap: 15px; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ddd;">
                        <div id="staff-qrcode-${staff.staffId}" style="min-width: 80px; min-height: 80px; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center;"></div>
                        <div style="font-size: 10px; color: #666; line-height: 1.4;">
                            <i class="fas fa-qrcode" style="color: ${staffTypeColor};"></i> 
                            <strong>Scan QR Code</strong><br>
                            for attendance verification
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div style="background: #2c3e50; color: white; text-align: center; padding: 8px; font-size: 10px;">
                    <i class="fas fa-phone"></i> +91-80-12345678 | <i class="fas fa-envelope"></i> info@successschool.edu
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = idCardHtml;
    
    // Generate QR code after card is added to DOM
    setTimeout(() => {
        generateStaffQRCode(staff.staffId);
    }, 100);
}

// Generate QR code for staff ID card
function generateStaffQRCode(staffId) {
    const qrElement = document.getElementById(`staff-qrcode-${staffId}`);
    if (!qrElement) return;
    
    qrElement.innerHTML = '';
    
    try {
        new QRCode(qrElement, {
            text: staffId,
            width: 80,
            height: 80,
            colorDark: '#2c3e50',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
        });
    } catch (error) {
        console.error('QR generation error:', error);
        qrElement.innerHTML = '<div style="color: #e53e3e; padding: 5px;">Error</div>';
    }
}

// Load staff ID card in dedicated tab
function loadStaffIDCard() {
    if (!currentStaff) return;
    
    const container = document.getElementById('staffPersonalIDCard');
    if (container) {
        generateSingleIDCard(currentStaff, container);
    }
}

// Refresh ID card
function refreshMyIDCard() {
    const container = document.getElementById('staffPersonalIDCard');
    if (container) {
        container.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Refreshing your ID card...</p></div>';
        setTimeout(() => {
            generateSingleIDCard(currentStaff, container);
        }, 500);
    }
}

// Download ID card as image
function downloadMyIDCard() {
    if (!currentStaff) return;
    
    Swal.fire({
        title: 'Download ID Card',
        text: 'Choose format to download',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'As Image (PNG)',
        cancelButtonText: 'As PDF',
        showDenyButton: true,
        denyButtonText: 'Cancel',
        denyButtonColor: '#6c757d'
    }).then((result) => {
        if (result.isConfirmed) {
            downloadIDCardAsImage();
        } else if (result.dismiss === Swal.DismissReason.cancel) {
            downloadIDCardAsPDF();
        }
    });
}

// Download ID card as image
function downloadIDCardAsImage() {
    const cardElement = document.querySelector('#staffPersonalIDCard .id-card-container') || 
                       document.querySelector('#staffIDCardPreview .id-card-container');
    
    if (!cardElement) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'ID card not found. Please view it first.'
        });
        return;
    }
    
    Swal.fire({
        title: 'Preparing download...',
        html: 'Generating your ID card image',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
            
            // Use html2canvas if available, otherwise fallback
            if (typeof html2canvas !== 'undefined') {
                html2canvas(cardElement, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    allowTaint: false,
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    Swal.close();
                    
                    const link = document.createElement('a');
                    link.download = `ID_Card_${currentStaff.staffId}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Downloaded!',
                        text: 'Your ID card has been downloaded.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }).catch(error => {
                    Swal.close();
                    Swal.fire({
                        icon: 'error',
                        title: 'Download Failed',
                        text: 'Could not generate image. Try printing instead.'
                    });
                });
            } else {
                Swal.close();
                Swal.fire({
                    icon: 'info',
                    title: 'Library Missing',
                    text: 'Image download requires html2canvas library. Try printing instead.',
                    footer: '<a href="https://html2canvas.hertzen.com/" target="_blank">Learn more</a>'
                });
            }
        }
    });
}

// Download ID card as PDF
function downloadIDCardAsPDF() {
    printMyIDCard(); // For now, print is the best PDF alternative
}

// Print ID card
function printMyIDCard() {
    if (!currentStaff) return;
    
    const staff = currentStaff;
    const staffTypeColor = staff.staffType === 'Teaching' ? '#3498db' : 
                          staff.staffType === 'Non-Teaching' ? '#e74c3c' : '#2ecc71';
    
    // Get photo HTML
    let photoHtml;
    if (staff.photoUrl) {
        photoHtml = `<img src="${staff.photoUrl}" alt="${staff.name}" style="width:100%;height:100%;object-fit:cover;">`;
    } else {
        const initial = staff.name ? staff.name.charAt(0).toUpperCase() : '?';
        photoHtml = `<div style="width:100%;height:100%;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold;">${initial}</div>`;
    }
    
    // Get QR code image if available
    const qrElement = document.getElementById(`staff-qrcode-${staff.staffId}`);
    let qrHtml = '';
    if (qrElement) {
        const qrImg = qrElement.querySelector('img');
        if (qrImg) {
            qrHtml = `<img src="${qrImg.src}" alt="QR Code" style="width:80px;height:80px;">`;
        }
    }
    
    const printWindow = window.open('', '_blank');
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Staff ID Card - ${staff.staffId}</title>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { 
                    font-family: 'Inter', Arial, sans-serif; 
                    display: flex; 
                    justify-content: center; 
                    align-items: center; 
                    min-height: 100vh; 
                    margin: 0; 
                    background: #f5f5f5; 
                    padding: 20px;
                }
                .id-card-container { width: 350px; margin: 0 auto; }
                .id-card { 
                    width: 350px; 
                    background: white;
                    border-radius: 15px; 
                    overflow: hidden; 
                    border: 2px solid #000; 
                    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
                }
                img { max-width: 100%; height: auto; display: block; }
                @media print { 
                    body { 
                        margin: 0; 
                        padding: 0;
                        background: white;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        min-height: 100vh;
                    } 
                    .id-card {
                        -webkit-print-color-adjust: exact;
                        print-color-adjust: exact;
                        color-adjust: exact;
                        border: 2px solid #000;
                        box-shadow: none;
                    }
                    @page {
                        size: portrait;
                        margin: 0;
                    }
                }
            </style>
        </head>
        <body>
            <div class="id-card-container">
                <!-- FRONT SIDE -->
                <div class="id-card">
                    <!-- Header with Logo and Title -->
                    <div style="background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); padding: 18px 12px; text-align: center; position: relative;">
                        <img src="https://lh3.googleusercontent.com/d/1stbNALlpjg5CCGlXXX84l29UoolnvrbN" alt="Success School Indi Logo" 
                             style="height: 6rem; width: auto; max-width: 280px; object-fit: contain; filter: drop-shadow(0 6px 8px rgba(0,0,0,0.25)); margin: 0 auto;" 
                             onerror="this.onerror=null; this.src='https://lh3.googleusercontent.com/d/1zxgYSP4m3solH4FLbURzIjXmB_OymF3Z';">
                        
                        <div style="position: absolute; bottom: -14px; left: 50%; transform: translateX(-50%); background: white; padding: 5px 20px; border-radius: 30px; box-shadow: 0 6px 12px rgba(0,0,0,0.15); border: 2px solid ${staffTypeColor}; white-space: nowrap;">
                            <span style="font-size: 15px; font-weight: 700; letter-spacing: 1px; color: #2c3e50;">STAFF ID CARD</span>
                        </div>
                    </div>
                    
                    <!-- Staff Photo and Info -->
                    <div style="padding: 50px 15px 15px 15px;">
                        <div style="display: flex; gap: 15px;">
                            <!-- Photo Container -->
                            <div style="width: 100px; height: 120px; border: 3px solid ${staffTypeColor}; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1); flex-shrink: 0; background: #f8f9fa;">
                                ${photoHtml}
                            </div>
                            
                            <!-- Basic Info -->
                            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                                <h3 style="margin: 0 0 5px 0; color: #2c3e50; font-size: 16px; font-weight: 700;">${staff.name || 'N/A'}</h3>
                                <p style="margin: 0 0 3px 0; color: #666; font-size: 13px;"><strong>${staff.designation || 'Staff'}</strong></p>
                                <p style="margin: 0; font-size: 12px; color: #888;">ID: ${staff.staffId || 'N/A'}</p>
                            </div>
                        </div>
                        
                        <!-- Details Table -->
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 10px; margin-top: 15px;">
                            <table style="width: 100%; font-size: 12px;">
                                <tr><td style="padding: 4px 0;"><strong>Department:</strong></td><td>${staff.department || 'N/A'}</td></tr>
                                <tr><td style="padding: 4px 0;"><strong>Staff Type:</strong></td><td><span style="background: ${staffTypeColor}; color: white; padding: 2px 8px; border-radius: 12px;">${staff.staffType || 'N/A'}</span></td></tr>
                                <tr><td style="padding: 4px 0;"><strong>Join Date:</strong></td><td>${staff.joinDate || 'N/A'}</td></tr>
                                <tr><td style="padding: 4px 0;"><strong>Phone:</strong></td><td>${staff.phone || 'N/A'}</td></tr>
                            </table>
                        </div>
                        
                        <!-- QR Code Section -->
                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ddd;">
                            <div style="min-width: 80px; min-height: 80px; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center;">
                                ${qrHtml}
                            </div>
                            <div style="font-size: 10px; color: #666; line-height: 1.4;">
                                <i class="fas fa-qrcode" style="color: ${staffTypeColor};"></i> 
                                <strong>Scan QR Code</strong><br>
                                for attendance verification
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div style="background: #2c3e50; color: white; text-align: center; padding: 8px; font-size: 10px;">
                        <i class="fas fa-phone"></i> +91-80-12345678 | accounts@successschool.edu
                    </div>
                </div>
            </div>
            <script>
                window.onload = function() {
                    setTimeout(function() {
                        window.print();
                        setTimeout(function() {
                            window.close();
                        }, 500);
                    }, 500);
                };
            <\/script>
        </body>
        </html>
    `);
    
    printWindow.document.close();
}

// Add to initializeStaffApp function - Already added above

// ========== DAILY ATTENDANCE DASHBOARD FUNCTIONS ==========

function loadDailyAttendanceDashboard() {
    const dateInput = document.getElementById('dashboardAttendanceDate');
    let date;
    
    if (dateInput && dateInput.value) {
        // Parse the date from input (YYYY-MM-DD format)
        const dateParts = dateInput.value.split('-');
        if (dateParts.length === 3) {
            // Create date in local timezone, not UTC
            date = new Date(
                parseInt(dateParts[0]), 
                parseInt(dateParts[1]) - 1, 
                parseInt(dateParts[2])
            );
        }
    } else {
        // Set default to February 20, 2026
        date = new Date(2026, 1, 20); // Month is 0-based: 1 = February
        if (dateInput) dateInput.value = '2026-02-20';
    }
    
    // Format date as YYYY-MM-DD manually to avoid timezone issues
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const formattedDate = `${year}-${month}-${day}`;
    
    console.log('Loading attendance for date:', formattedDate);
    
    const tableBody = document.getElementById('attendanceDashboardBody');
    tableBody.innerHTML = '<tr><td colspan="11" class="text-center"><div class="loading"><div class="loading-spinner"></div><p>Loading attendance data for ' + formattedDate + '...</p></div></td></tr>';
    
    google.script.run
        .withSuccessHandler(function(response) {
            console.log('Dashboard response received:', response);
            
            if (response && response.success) {
                currentAttendanceData = response;
                displayAttendanceTable(response.staff);
                
                // Update summary cards
                document.getElementById('summaryPresent').textContent = response.summary.present || 0;
                document.getElementById('summaryLate').textContent = response.summary.late || 0;
                document.getElementById('summaryAbsent').textContent = response.summary.absent || 0;
                document.getElementById('summaryLeave').textContent = (response.summary.fullDayLeave || 0) + (response.summary.halfDay || 0);
                document.getElementById('summaryHoliday').textContent = response.summary.holiday || 0;
                
                // Update date info
                document.getElementById('currentDateDisplay').textContent = `${response.date} (${response.dayName})`;
                
                let specialInfo = '';
                if (response.isSunday) {
                    specialInfo = ' Today is Sunday - Holiday';
                } else if (response.isHoliday) {
                    specialInfo = ` Today is Holiday: ${response.holidayName}`;
                } else {
                    specialInfo = 'Regular Working Day';
                }
                document.getElementById('dateSpecialInfo').textContent = specialInfo;
                
            } else {
                tableBody.innerHTML = `<tr><td colspan="11" class="text-center"><div class="message error">${response?.message || 'Error loading attendance data'}</div></td></tr>`;
            }
        })
        .withFailureHandler(function(error) {
            console.error('Dashboard error:', error);
            tableBody.innerHTML = `<tr><td colspan="11" class="text-center"><div class="message error">Error: ${error.message}</div></td></tr>`;
        })
        .getDailyAttendanceDashboard(formattedDate);
}

function displayAttendanceDashboard(data) {
    // Update date display
    document.getElementById('currentDateDisplay').textContent = 
        `${data.date} (${data.dayName})`;
    
    // Update special date info
    let specialInfo = '';
    if (data.isSunday) {
        specialInfo = ' Today is Sunday - Holiday';
    } else if (data.isHoliday) {
        specialInfo = ` Today is Holiday: ${data.holidayName}`;
    } else {
        specialInfo = 'Regular Working Day';
    }
    document.getElementById('dateSpecialInfo').textContent = specialInfo;
    
    // Update summary cards
    document.getElementById('summaryPresent').textContent = data.summary.present || 0;
    document.getElementById('summaryLate').textContent = data.summary.late || 0;
    document.getElementById('summaryAbsent').textContent = data.summary.absent || 0;
    document.getElementById('summaryLeave').textContent = (data.summary.fullDayLeave || 0) + (data.summary.halfDay || 0);
    document.getElementById('summaryHoliday').textContent = data.summary.holiday || 0;
    
    // Display table
    displayAttendanceTable(data.staff);
}

function displayAttendanceTable(staffList) {
    const tbody = document.getElementById('attendanceDashboardBody');
    tbody.innerHTML = '';
    
    if (!staffList || staffList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center"><div class="message info">No staff members found</div></td></tr>';
        return;
    }
    
    staffList.forEach(staff => {
        // Determine row class based on status
        let rowClass = 'staff-attendance-row';
        if (staff.attendanceCode === 'A') rowClass += ' absent';
        else if (staff.attendanceCode === 'L') rowClass += ' late';
        else if (staff.attendanceCode === 'HD') rowClass += ' leave';
        else if (staff.attendanceCode === 'FD') rowClass += ' leave';
        else if (staff.attendanceCode === 'H') rowClass += ' holiday';
        
        // Status badge
        let statusBadge = '';
        if (staff.attendanceCode === 'P') {
            statusBadge = '<span class="status-badge-daily present"><i class="fas fa-check-circle"></i> Present</span>';
        } else if (staff.attendanceCode === 'L') {
            statusBadge = '<span class="status-badge-daily late"><i class="fas fa-clock"></i> Late</span>';
        } else if (staff.attendanceCode === 'A') {
            statusBadge = '<span class="status-badge-daily absent"><i class="fas fa-times-circle"></i> Absent</span>';
        } else if (staff.attendanceCode === 'HD') {
            statusBadge = '<span class="status-badge-daily halfday"><i class="fas fa-adjust"></i> Half Day</span>';
        } else if (staff.attendanceCode === 'FD') {
            statusBadge = '<span class="status-badge-daily leave"><i class="fas fa-umbrella-beach"></i> On Leave</span>';
        } else if (staff.attendanceCode === 'H') {
            statusBadge = '<span class="status-badge-daily holiday"><i class="fas fa-star"></i> Holiday</span>';
        } else {
            statusBadge = '<span class="status-badge-daily absent"><i class="fas fa-question-circle"></i> Not Marked</span>';
        }
        
        // Photo HTML
        const photoHtml = staff.photoUrl 
            ? `<img src="${staff.photoUrl}" alt="${staff.name}" class="staff-photo-thumb" onerror="this.src='https://via.placeholder.com/40'">`
            : '<div class="staff-photo-thumb" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center;"><i class="fas fa-user" style="color: #999;"></i></div>';
        
        const row = document.createElement('tr');
        row.className = rowClass;
        row.setAttribute('data-status', staff.attendanceCode || 'unknown');
        row.setAttribute('data-staff-id', staff.staffId);
        row.setAttribute('data-name', staff.name.toLowerCase());
        row.setAttribute('data-department', staff.department.toLowerCase());
        
        row.innerHTML = `
            <td>${photoHtml}</td>
            <td><strong>${staff.staffId}</strong></td>
            <td>${staff.name}</td>
            <td>${staff.department}</td>
            <td>${staff.designation}</td>
            <td><span class="badge ${staff.staffType === 'Teaching' ? 'badge-success' : 'badge-warning'}">${staff.staffType}</span></td>
            <td>${statusBadge}</td>
            <td class="time-display">${staff.loginTime || '-'}</td>
            <td class="time-display">${staff.logoutTime || '-'}</td>
            <td class="time-display">${staff.totalHours || '-'}</td>
            <td><small>${staff.remarks || '-'}</small></td>
        `;
        
        tbody.appendChild(row);
    });
}

function filterAttendance(filter, button) {
    currentFilter = filter;
    
    // Update active button
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    button.classList.add('active');
    
    const rows = document.querySelectorAll('#attendanceDashboardBody tr');
    const searchTerm = document.getElementById('attendanceSearch').value.toLowerCase();
    
    rows.forEach(row => {
        const status = row.getAttribute('data-status');
        const name = row.getAttribute('data-name');
        const staffId = row.getAttribute('data-staff-id');
        const department = row.getAttribute('data-department');
        
        let matchesFilter = true;
        if (filter === 'present') matchesFilter = status === 'P';
        else if (filter === 'late') matchesFilter = status === 'L';
        else if (filter === 'absent') matchesFilter = status === 'A' || !status;
        else if (filter === 'leave') matchesFilter = status === 'FD' || status === 'HD';
        else if (filter === 'holiday') matchesFilter = status === 'H';
        
        let matchesSearch = true;
        if (searchTerm) {
            matchesSearch = (name && name.includes(searchTerm)) || 
                           (staffId && staffId.includes(searchTerm)) || 
                           (department && department.includes(searchTerm));
        }
        
        row.style.display = matchesFilter && matchesSearch ? '' : 'none';
    });
}

function filterAttendanceTable() {
    const activeFilter = document.querySelector('.filter-btn.active');
    const filter = activeFilter ? activeFilter.textContent.toLowerCase().trim() : 'all';
    filterAttendance(filter, activeFilter);
}

function exportAttendanceToExcel() {
    if (!currentAttendanceData) {
        Swal.fire({
            icon: 'warning',
            title: 'No Data',
            text: 'Please load attendance data first.'
        });
        return;
    }
    
    const date = currentAttendanceData.date;
    let csv = "Staff ID,Name,Department,Designation,Staff Type,Status,Login Time,Logout Time,Total Hours,Remarks\n";
    
    currentAttendanceData.staff.forEach(staff => {
        csv += `"${staff.staffId}","${staff.name}","${staff.department}","${staff.designation}","${staff.staffType}","${staff.status}","${staff.loginTime || ''}","${staff.logoutTime || ''}","${staff.totalHours || ''}","${staff.remarks || ''}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Attendance_${date}.csv`;
    a.click();
    
    Swal.fire({
        icon: 'success',
        title: 'Exported!',
        text: 'Attendance data exported successfully.',
        timer: 2000,
        showConfirmButton: false
    });
}

function printAttendanceReport() {
    if (!currentAttendanceData) {
        Swal.fire({
            icon: 'warning',
            title: 'No Data',
            text: 'Please load attendance data first.'
        });
        return;
    }
    
    const printWindow = window.open('', '_blank');
    
    let tableRows = '';
    currentAttendanceData.staff.forEach(staff => {
        tableRows += `
            <tr>
                <td>${staff.staffId}</td>
                <td>${staff.name}</td>
                <td>${staff.department}</td>
                <td>${staff.designation}</td>
                <td>${staff.staffType}</td>
                <td>${staff.status}</td>
                <td>${staff.loginTime || '-'}</td>
                <td>${staff.logoutTime || '-'}</td>
                <td>${staff.totalHours || '-'}</td>
            </tr>
        `;
    });
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Attendance Report - ${currentAttendanceData.date}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                h1 { color: #2c3e50; text-align: center; }
                h2 { color: #34495e; text-align: center; margin-bottom: 30px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th { background: #3498db; color: white; padding: 10px; text-align: left; }
                td { padding: 8px; border: 1px solid #ddd; }
                tr:nth-child(even) { background: #f9f9f9; }
                .summary { margin: 20px 0; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
                .summary-item { background: #f0f0f0; padding: 10px; border-radius: 5px; text-align: center; }
                .summary-value { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
                .summary-label { font-size: 12px; color: #666; }
                .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; }
                @media print { .no-print { display: none; } }
            </style>
        </head>
        <body>
            <h1>SUCCESS SCHOOL, INDI</h1>
            <h2>Daily Attendance Report - ${currentAttendanceData.date} (${currentAttendanceData.dayName})</h2>
            
            <div class="summary">
                <div class="summary-item"><div class="summary-value">${currentAttendanceData.summary.present}</div><div class="summary-label">Present</div></div>
                <div class="summary-item"><div class="summary-value">${currentAttendanceData.summary.late}</div><div class="summary-label">Late</div></div>
                <div class="summary-item"><div class="summary-value">${currentAttendanceData.summary.absent}</div><div class="summary-label">Absent</div></div>
                <div class="summary-item"><div class="summary-value">${currentAttendanceData.summary.fullDayLeave + currentAttendanceData.summary.halfDay}</div><div class="summary-label">On Leave</div></div>
                <div class="summary-item"><div class="summary-value">${currentAttendanceData.summary.holiday}</div><div class="summary-label">Holiday</div></div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Staff ID</th>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Designation</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Login</th>
                        <th>Logout</th>
                        <th>Total Hours</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
            
            <div class="footer">
                <p>Generated on: ${new Date().toLocaleString()}</p>
                <p>This is an official report from Success School, Indi - Staff Salary Management System</p>
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}

function syncWithQRData() {
    Swal.fire({
        title: 'Sync Attendance',
        text: 'This will sync today\'s attendance with QR scan data. Continue?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, sync'
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Syncing...',
                html: 'Please wait while we sync attendance data',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            setTimeout(() => {
                Swal.close();
                loadDailyAttendanceDashboard();
                Swal.fire({
                    icon: 'success',
                    title: 'Synced!',
                    text: 'Attendance data has been synced with QR scans.',
                    timer: 2000,
                    showConfirmButton: false
                });
            }, 1500);
        }
    });
}

function processEndOfDay() {
    Swal.fire({
        title: 'Process End of Day',
        text: 'This will mark all pending staff as Half Day and process attendance. Continue?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, process'
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Processing...',
                html: 'Please wait while we process end of day attendance',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            google.script.run
                .withSuccessHandler(function(response) {
                    Swal.close();
                    if (response && response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Processed!',
                            text: response.message,
                            timer: 3000,
                            showConfirmButton: false
                        });
                        loadDailyAttendanceDashboard();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response?.message || 'Error processing end of day'
                        });
                    }
                })
                .withFailureHandler(function(error) {
                    Swal.close();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message
                    });
                })
                .processEndOfDayAttendance();
        }
    });
}

function markAllPresentDaily() {
    if (!currentAttendanceData) return;
    
    Swal.fire({
        title: 'Mark All Present',
        text: 'This will mark all staff as Present. Continue?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, mark all'
    }).then((result) => {
        if (result.isConfirmed) {
            // Update display
            currentAttendanceData.staff.forEach(staff => {
                if (!staff.isSunday && !staff.isHoliday && !staff.leaveType) {
                    staff.status = 'Present';
                    staff.attendanceCode = 'P';
                    staff.remarks = 'Marked present by admin';
                }
            });
            
            displayAttendanceTable(currentAttendanceData.staff);
            
            Swal.fire({
                icon: 'success',
                title: 'Updated!',
                text: 'All staff marked as Present',
                timer: 2000,
                showConfirmButton: false
            });
        }
    });
}

function markAllAbsentDaily() {
    if (!currentAttendanceData) return;
    
    Swal.fire({
        title: 'Mark All Absent',
        text: 'This will mark all staff as Absent. Continue?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, mark all'
    }).then((result) => {
        if (result.isConfirmed) {
            // Update display
            currentAttendanceData.staff.forEach(staff => {
                if (!staff.isSunday && !staff.isHoliday && !staff.leaveType) {
                    staff.status = 'Absent';
                    staff.attendanceCode = 'A';
                    staff.remarks = 'Marked absent by admin';
                }
            });
            
            displayAttendanceTable(currentAttendanceData.staff);
            
            Swal.fire({
                icon: 'success',
                title: 'Updated!',
                text: 'All staff marked as Absent',
                timer: 2000,
                showConfirmButton: false
            });
        }
    });
}
    </script>
</body>
</html>